(function(D,C){typeof exports=="object"&&typeof module<"u"?C(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],C):(D=typeof globalThis<"u"?globalThis:D||self,C(D.instantReact={},D.React))})(this,function(D,C){"use strict";function B(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=B(t[n]);for(let i=0;i<r.length;i++)e^=r.charCodeAt(i),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const i=n[r],s=B(i);e^=parseInt(s,16),e*=16777619,e=e>>>0;const o=B(t[i]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return B(String(t))}const N={Remove:"remove",Replace:"replace",Add:"add"},Wn=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),Gi=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),ft=Symbol.iterator,re={mutable:"mutable",immutable:"immutable"},Lt={};function Ve(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function zn(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function Ft(t){return Object.getPrototypeOf(t)===Set.prototype}function Nt(t){return Object.getPrototypeOf(t)===Map.prototype}function ie(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function me(t){return!!k(t)}function k(t){return typeof t!="object"?null:t==null?void 0:t[Wn]}function Kt(t){var e;const n=k(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function ae(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,re))===re.immutable||typeof n=="function")}function Vn(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=k(pe(n,t.key));if(r!==null&&(r==null?void 0:r.original)!==t.original)return null;const i=t.parent.type===3,s=i?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(i&&n.size>s||Ve(n,s)))return null;e.push(s)}if(t.parent)return Vn(t.parent,e);e.reverse();try{Qi(t.copy,e)}catch{return null}return e}function ve(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function pe(t,e){return ve(t)===2?t.get(e):t[e]}function qe(t,e,n){ve(t)===2?t.set(e,n):t[e]=n}function Wt(t,e){const n=k(t);return(n?ie(n):t)[e]}function ye(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function zt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function Se(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function Qi(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=pe(ve(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function Hi(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const Yi=Object.prototype.propertyIsEnumerable;function qn(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!Ft(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!Nt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e!=null&&e.mark&&(n=e.mark(t,re),n!==void 0)&&n!==re.mutable){if(n===re.immutable)return Hi(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),Object.getOwnPropertySymbols(t).forEach(i=>{Yi.call(t,i)&&(r[i]=t[i])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function H(t){t.copy||(t.copy=qn(t.original,t.options))}function Be(t){if(!ae(t))return Kt(t);if(Array.isArray(t))return t.map(Be);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,i])=>[r,Be(i)]);if(!Nt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(Be);if(!Ft(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=Be(t[n]);return e}function lt(t){return me(t)?Be(t):t}function fe(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&fe(t.parent))}function Bn(){throw new Error("Cannot modify frozen object")}function Ie(t,e,n,r,i){{n=n??new WeakMap,r=r??[],i=i??[];const o=n.has(t)?n.get(t):t;if(r.length>0){const a=r.indexOf(o);if(o&&typeof o=="object"&&a!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${i.slice(0,a).map((u,d)=>{if(typeof u=="symbol")return`[${u.toString()}]`;const c=r[d];return typeof u=="object"&&(c instanceof Map||c instanceof Set)?Array.from(c.keys()).indexOf(u):u}).join("/")}`);r.push(o),i.push(e)}else r.push(o)}if(Object.isFrozen(t)||me(t)){r.pop(),i.pop();return}switch(ve(t)){case 2:for(const[a,u]of t)Ie(a,a,n,r,i),Ie(u,a,n,r,i);t.set=t.clear=t.delete=Bn;break;case 3:for(const a of t)Ie(a,a,n,r,i);t.add=t.clear=t.delete=Bn;break;case 1:Object.freeze(t);let o=0;for(const a of t)Ie(a,o,n,r,i),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(a=>{const u=t[a];Ie(u,a,n,r,i)})}r.pop(),i.pop()}function Vt(t,e){const n=ve(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const i of t)e(r,i,t),r+=1}else t.forEach((r,i)=>e(i,r,t))}function Gn(t,e,n){if(me(t)||!ae(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,i=r?new Map:void 0;if(e.add(t),Vt(t,(s,o)=>{var a;if(me(o)){const u=k(o);H(u);const d=!((a=u.assignedMap)===null||a===void 0)&&a.size||u.operated?u.copy:u.original;qe(r?i:t,s,d)}else Gn(o,e,n)}),i){const s=t,o=Array.from(s);s.clear(),o.forEach(a=>{s.add(i.has(a)?i.get(a):a)})}}function Ji(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&Gn(pe(n,e),t.finalities.handledSet,t.options)}function qt(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(Kt(e))}))}function Bt(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const s=Vn(t);s&&e(t,s,n,r)}t.finalized=!0}}function Gt(t,e,n,r){const i=k(n);i&&(i.callbacks||(i.callbacks=[]),i.callbacks.push((s,o)=>{var a;const u=t.type===3?t.setMap:t.copy;if(ye(pe(u,e),n)){let d=i.original;i.copy&&(d=i.copy),qt(t),Bt(t,r,s,o),t.options.enableAutoFreeze&&(t.options.updatedValues=(a=t.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,t.options.updatedValues.set(d,i.original)),qe(u,e,d)}}),t.options.enableAutoFreeze&&i.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),ae(n,t.options)&&t.finalities.draft.push(()=>{const s=t.type===3?t.setMap:t.copy;ye(pe(s,e),n)&&Ji(t,e)})}function Zi(t,e,n,r,i){let{original:s,assignedMap:o,options:a}=t,u=t.copy;u.length<s.length&&([s,u]=[u,s],[n,r]=[r,n]);for(let d=0;d<s.length;d+=1)if(o.get(d.toString())&&u[d]!==s[d]){const c=e.concat([d]),f=Se(c,i);n.push({op:N.Replace,path:f,value:lt(u[d])}),r.push({op:N.Replace,path:f,value:lt(s[d])})}for(let d=s.length;d<u.length;d+=1){const c=e.concat([d]),f=Se(c,i);n.push({op:N.Add,path:f,value:lt(u[d])})}if(s.length<u.length){const{arrayLengthAssignment:d=!0}=a.enablePatches;if(d){const c=e.concat(["length"]),f=Se(c,i);r.push({op:N.Replace,path:f,value:s.length})}else for(let c=u.length;s.length<c;c-=1){const f=e.concat([c-1]),l=Se(f,i);r.push({op:N.Remove,path:l})}}}function Xi({original:t,copy:e,assignedMap:n},r,i,s,o){n.forEach((a,u)=>{const d=pe(t,u),c=lt(pe(e,u)),f=a?Ve(t,u)?N.Replace:N.Add:N.Remove;if(ye(d,c)&&f===N.Replace)return;const l=r.concat(u),p=Se(l,o);i.push(f===N.Remove?{op:f,path:p}:{op:f,path:p,value:c}),s.push(f===N.Add?{op:N.Remove,path:p}:f===N.Remove?{op:N.Add,path:p,value:d}:{op:N.Replace,path:p,value:d})})}function es({original:t,copy:e},n,r,i,s){let o=0;t.forEach(a=>{if(!e.has(a)){const u=n.concat([o]),d=Se(u,s);r.push({op:N.Remove,path:d,value:a}),i.unshift({op:N.Add,path:d,value:a})}o+=1}),o=0,e.forEach(a=>{if(!t.has(a)){const u=n.concat([o]),d=Se(u,s);r.push({op:N.Add,path:d,value:a}),i.unshift({op:N.Remove,path:d,value:a})}o+=1})}function Ge(t,e,n,r){const{pathAsArray:i=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return Xi(t,e,n,r,i);case 1:return Zi(t,e,n,r,i);case 3:return es(t,e,n,r,i)}}const ht=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!ae(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},Qt={get size(){return ie(k(this)).size},has(t){return ie(k(this)).has(t)},set(t,e){const n=k(this),r=ie(n);return(!r.has(t)||!ye(r.get(t),e))&&(H(n),fe(n),n.assignedMap.set(t,!0),n.copy.set(t,e),Gt(n,t,e,Ge)),this},delete(t){if(!this.has(t))return!1;const e=k(this);return H(e),fe(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=k(this);if(this.size){H(t),fe(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=k(this);ie(n).forEach((r,i)=>{t.call(e,this.get(i),i,this)})},get(t){var e,n;const r=k(this),i=ie(r).get(t),s=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,i,re))===re.mutable;if(r.options.strict&&ht(i,r.options,s),s||r.finalized||!ae(i,r.options)||i!==r.original.get(t))return i;const o=Lt.createDraft({original:i,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return H(r),r.copy.set(t,o),o},keys(){return ie(k(this)).keys()},values(){const t=this.keys();return{[ft]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[ft]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[ft](){return this.entries()}},ts=Reflect.ownKeys(Qt),Qn=(t,e,{isValuesIterator:n})=>()=>{var r,i;const s=e.next();if(s.done)return s;const o=s.value;let a=t.setMap.get(o);const u=k(a),d=((i=(r=t.options).mark)===null||i===void 0?void 0:i.call(r,a,re))===re.mutable;if(t.options.strict&&ht(o,t.options,d),!d&&!u&&ae(o,t.options)&&!t.finalized&&t.original.has(o)){const c=Lt.createDraft({original:o,parentDraft:t,key:o,finalities:t.finalities,options:t.options});t.setMap.set(o,c),a=c}else u&&(a=u.proxy);return{done:!1,value:n?a:[a,a]}},pt={get size(){return k(this).setMap.size},has(t){const e=k(this);if(e.setMap.has(t))return!0;H(e);const n=k(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=k(this);return this.has(t)||(H(e),fe(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),Gt(e,t,t,Ge)),this},delete(t){if(!this.has(t))return!1;const e=k(this);H(e),fe(e);const n=k(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=k(this);H(t),fe(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=k(this);H(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Qn(t,e,{isValuesIterator:!0})}},entries(){const t=k(this);H(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Qn(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[ft](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(pt,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const ns=Reflect.ownKeys(pt),Hn=new WeakSet,Yn={get(t,e,n){var r,i;const s=(r=t.copy)===null||r===void 0?void 0:r[e];if(s&&Hn.has(s))return s;if(e===Wn)return t;let o;if(t.options.mark){const d=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(o=t.options.mark(d,re),o===re.mutable)return t.options.strict&&ht(d,t.options,!0),d}const a=ie(t);if(a instanceof Map&&ts.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(Qt,"size").get.call(t.proxy);const d=Qt[e];if(d)return d.bind(t.proxy)}if(a instanceof Set&&ns.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(pt,"size").get.call(t.proxy);const d=pt[e];if(d)return d.bind(t.proxy)}if(!Ve(a,e)){const d=zn(a,e);return d?"value"in d?d.value:(i=d.get)===null||i===void 0?void 0:i.call(t.proxy):void 0}const u=a[e];if(t.options.strict&&ht(u,t.options),t.finalized||!ae(u,t.options))return u;if(u===Wt(t.original,e)){if(H(t),t.copy[e]=Ht({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof o=="function"){const d=k(t.copy[e]);return H(d),fe(d),d.copy}return t.copy[e]}return u},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let i;if(t.type===1&&e!=="length"&&!(Number.isInteger(i=Number(e))&&i>=0&&(e===0||i===0||String(i)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const s=zn(ie(t),e);if(s!=null&&s.set)return s.set.call(t.proxy,n),!0;const o=Wt(ie(t),e),a=k(o);return a&&ye(a.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(ye(n,o)&&(n!==void 0||Ve(t.original,e))||(H(t),fe(t),Ve(t.original,e)&&ye(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,Gt(t,e,n,Ge)),!0)},has(t,e){return e in ie(t)},ownKeys(t){return Reflect.ownKeys(ie(t))},getOwnPropertyDescriptor(t,e){const n=ie(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?Yn.set.call(this,t,e,void 0,t.proxy):(Wt(t.original,e)!==void 0||e in t.original?(H(t),fe(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function Ht(t){const{original:e,parentDraft:n,key:r,finalities:i,options:s}=t,o=ve(e),a={type:o,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:i,options:s,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in t)&&(a.key=r);const{proxy:u,revoke:d}=Proxy.revocable(o===1?Object.assign([],a):a,Yn);if(i.revoke.push(d),Hn.add(u),a.proxy=u,n){const c=n;c.finalities.draft.push((f,l)=>{var p,y;const b=k(u);let g=c.type===3?c.setMap:c.copy;const T=pe(g,r),_=k(T);if(_){let m=_.original;_.operated&&(m=Kt(T)),qt(_),Bt(_,Ge,f,l),c.options.enableAutoFreeze&&(c.options.updatedValues=(p=c.options.updatedValues)!==null&&p!==void 0?p:new WeakMap,c.options.updatedValues.set(m,_.original)),qe(g,r,m)}(y=b.callbacks)===null||y===void 0||y.forEach(m=>{m(f,l)})})}else{const c=k(u);c.finalities.draft.push((f,l)=>{qt(c),Bt(c,Ge,f,l)})}return u}Lt.createDraft=Ht;function rs(t,e,n,r,i){var s;const o=k(t),a=(s=o==null?void 0:o.original)!==null&&s!==void 0?s:t,u=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(n,r);const d=u?e[0]:o?o.operated?o.copy:o.original:t;return o&&zt(o),i&&Ie(d,d,o==null?void 0:o.options.updatedValues),[d,n&&u?[{op:N.Replace,path:[],value:e[0]}]:n,r&&u?[{op:N.Replace,path:[],value:a}]:r]}function is(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet};let i,s;e.enablePatches&&(i=[],s=[]);const a=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,re))===re.mutable||!ae(t,e)?t:Ht({original:t,parentDraft:null,finalities:r,options:e});return[a,(u=[])=>{const[d,c,f]=rs(a,u,i,s,e.enableAutoFreeze);return e.enablePatches?[d,c,f]:d}]}function Yt(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:i=!0}=t;Vt(n,(s,o,a)=>{const u=k(o);if(u&&e&&u.finalities===e.finalities){t.isContainDraft=!0;const d=u.original;if(a instanceof Set){const c=Array.from(a);a.clear(),c.forEach(f=>a.add(s===f?d:f))}else qe(a,s,d)}else typeof o=="object"&&o!==null&&(t.value=o,t.isRoot=!1,Yt(t))}),i&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Jn(t){var e;const n=k(t);if(!ae(t,n==null?void 0:n.options))return t;const r=ve(t);if(n&&!n.operated)return n.original;let i;function s(){i=r===2?Nt(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):qn(t,n==null?void 0:n.options)}if(n){n.finalized=!0;try{s()}finally{n.finalized=!1}}else i=t;if(Vt(i,(o,a)=>{if(n&&ye(pe(n.original,o),a))return;const u=Jn(a);u!==a&&(i===t&&s(),qe(i,o,u))}),r===3){const o=(e=n==null?void 0:n.original)!==null&&e!==void 0?e:i;return Ft(o)?new Set(i):new(Object.getPrototypeOf(o)).constructor(i)}return i}function Zn(t){if(!me(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Jn(t)}const yt=(t=>function e(n,r,i){var s,o,a;if(typeof n=="function"&&typeof r!="function")return function(S,...I){return e(S,U=>n.call(this,U,...I),r)};const u=n,d=r;let c=i;if(typeof r!="function"&&(c=r),c!==void 0&&Object.prototype.toString.call(c)!=="[object Object]")throw new Error(`Invalid options: ${c}, 'options' should be an object.`);c=Object.assign(Object.assign({},t),c);const f=me(u)?Zn(u):u,l=Array.isArray(c.mark)?(S,I)=>{for(const U of c.mark){if(typeof U!="function")throw new Error(`Invalid mark: ${U}, 'mark' should be a function.`);const F=U(S,I);if(F)return F}}:c.mark,p=(s=c.enablePatches)!==null&&s!==void 0?s:!1,y=(o=c.strict)!==null&&o!==void 0?o:!1,g={enableAutoFreeze:(a=c.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:l,strict:y,enablePatches:p};if(!ae(f,g)&&typeof f=="object"&&f!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[T,_]=is(f,g);if(typeof r!="function"){if(!ae(f,g))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[T,_]}let m;try{m=d(T)}catch(S){throw zt(k(T)),S}const O=S=>{const I=k(T);if(!me(S)){if(S!==void 0&&!ye(S,T)&&(I!=null&&I.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const F=S==null?void 0:S[Gi];if(F){const ct=F[0];return g.strict&&typeof S=="object"&&S!==null&&Yt({rootDraft:I,value:S,useRawReturn:!0}),_([ct])}if(S!==void 0)return typeof S=="object"&&S!==null&&Yt({rootDraft:I,value:S}),_([S])}if(S===T||S===void 0)return _([]);const U=k(S);if(g===U.options){if(U.operated)throw new Error("Cannot return a modified child draft.");return _([Zn(S)])}return _([S])};return m instanceof Promise?m.then(O,S=>{throw zt(k(T)),S}):O(m)})();Object.prototype.constructor.toString();function Xn(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(i=>e.hasOwnProperty(i))}function er(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function bt(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:Xn(t,e)?Object.keys(t).every(n=>bt(t[n],e[n])):!1}function Jt(t){if(!Qe(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function tr(t,e){if(!Qe(t)||!Qe(e))return e;const n=Object.assign({},t);for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const i=Qe(t[r])&&Qe(e[r]);n[r]=i?tr(t[r],e[r]):e[r]}return n}function Qe(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function ss(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const o=e[s];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[s+1]=="number"?[]:{}),r=r[o]}const i=e[e.length-1];Array.isArray(r)&&typeof i=="number"?r.splice(i,0,n):r[i]=n}function nr(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let i=0;i<e.length-1;i++){const s=e[i];(!(s in r)||typeof r[s]!="object")&&(r[s]=typeof e[i+1]=="number"?[]:{}),r=r[s]}r[e[e.length-1]]=n}function rr(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}rr(t[n],r),os(t[n])&&delete t[n]}}function os(t){return t&&Object.keys(t).length===0}const ir=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,as={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function us(t){return new Date(t)}function cs(t){return new Date(t+"Z")}const ds=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function fs(t){const e=t.match(ds);if(!e)return null;const[n,r,i,s]=e;return r<=0||i<=0||s<=0?null:r>999?new Date(Date.UTC(r,i-1,s,0,0,0,0)):new Date(Date.UTC(s,r-1,i,0,0,0,0))}function ls(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function hs(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function ps(t){return new Date(t)}function ys(t){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!t.match(e))throw new Error(`Unable to parse \`${t}\` as a date.`);const r=new Date(t+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function bs(t){const e=/^(.+T.+)([+-])(\d{2})$/,n=t.match(e);if(n){const[,r,i,s]=n,o=`${r}${i}${s}:00`;return new Date(o)}return null}function _s(t){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,n=t.match(e);if(n){const[,r,i,s,o,a]=n,u=i.padStart(2,"0"),d=s.padStart(2,"0"),c=`${r}-${u}-${d}T${a}`;return new Date(c)}return null}function gs(t){const[e,n]=t.split(", "),[r,i,s]=e.split("/").map(Number),o=n.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw new Error(`Unable to parse time from: ${t}`);let[,a,u,d,c]=o;return a=Number(a),u=Number(u),d=Number(d),c==="PM"&&a!==12?a+=12:c==="AM"&&a===12&&(a=0),new Date(Date.UTC(s,r-1,i,a,u,d))}function ws(t){switch(t){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function Ts(t){const e=t.match(ir);if(!e)return null;const[n]=e,r=as[n],i=new Date(t.replace(ir,"Z"));return new Date(i.getTime()-r*1e3)}const ms=[fs,hs,ys,gs,ps,cs,bs,ls,us,ws,Ts,_s];function vs(t,e){try{const n=t(e);return n instanceof Date&&!isNaN(n.getTime())?n:null}catch{return null}}function Zt(t){for(const e of ms){const n=vs(e,t);if(n)return n}return null}function Ss(t){try{const e=JSON.parse(t);return typeof e=="string"?Zt(e):null}catch{return null}}function _t(t){if(t!==void 0){if(t===null)return null;if(t instanceof Date)return t;if(typeof t=="string"){const e=Zt(t)||Ss(t)||Zt(t.trim());if(!e)throw new Error(`Unable to parse \`${t}\` as a date.`);return e}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date value \`${t}\`. Expected a date, number, or string, got type ${typeof t}.`)}}class Oe{constructor(e,n){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null,this.attrs=e,this.linkIndex=n}resetAttrIndexes(){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null}addAttr(e){this.attrs[e.id]=e,this.resetAttrIndexes()}deleteAttr(e){delete this.attrs[e],this.resetAttrIndexes()}updateAttr(e){const n=this.attrs[e.id];n&&(this.attrs[e.id]=Object.assign(Object.assign({},n),e),this.resetAttrIndexes())}getAttr(e){return this.attrs[e]}get blobAttrs(){if(this._blobAttrs)return this._blobAttrs;this._blobAttrs=new Map;for(const e of Object.values(this.attrs))if(en(e)){const[n,r,i]=e["forward-identity"];Z(this.blobAttrs,[r,i],e)}return this._blobAttrs}get primaryKeys(){if(this._primaryKeys)return this._primaryKeys;this._primaryKeys=new Map;for(const e of Object.values(this.attrs))if(e["primary?"]){const[n,r]=e["forward-identity"];Z(this._primaryKeys,[r],e)}return this._primaryKeys}get forwardIdents(){if(this._forwardIdents)return this._forwardIdents;this._forwardIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["forward-identity"],[r,i,s]=n;Z(this._forwardIdents,[i,s],e)}return this._forwardIdents}get revIdents(){if(this._revIdents)return this._revIdents;this._revIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["reverse-identity"];if(n){const[r,i,s]=n;Z(this._revIdents,[i,s],e)}}return this._revIdents}toJSON(){return{attrs:this.attrs,linkIndex:this.linkIndex}}}function Os(t){return t.cardinality==="one"}function Xt(t){return t["value-type"]==="ref"}function en(t){return t["value-type"]==="blob"}function Pe(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function ue(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&ue(t.get(n),r)}function Z(t,e,n){let r=t;const i=e.length-1;for(let s=0;s<i;s++){const o=e[s];let a=r.get(o);a===void 0&&(a=new Map,r.set(o,a)),r=a}i>-1&&r.set(e[i],n)}function sr(t,e,n){const r=new Map,i=new Map,s=new Map;for(const o of e){let[a,u,d]=o;const c=t.getAttr(u);if(!c){console.warn("no such attr",u,a);continue}c["checked-data-type"]==="date"&&n&&(d=_t(d),o[2]=d),Xt(c)&&Z(s,[d,u,a],o),Z(r,[a,u,d],o),Z(i,[u,a,d],o)}return{eav:r,aev:i,vae:s}}function or(t){return{triples:X(t.eav,3),cardinalityInference:t.cardinalityInference,useDateObjects:t.useDateObjects,version:1}}function ar(t,e){return He(t,e.triples,e.cardinalityInference,e.useDateObjects)}function ur(t,e){if(t)return new Oe(t.attrs,t.linkIndex);if(e&&"__type"in e)return new Oe(e.attrs,e.linkIndex)}function Es(t,e){return Pe(t.eav,[e])!==void 0}function He(t,e,n,r){const i=sr(t,e,r);return i.cardinalityInference=n,i.useDateObjects=r,i}function Ye(t,e){var n,r;let i;if(Array.isArray(e[0])){const[o,a]=e[0],u=t.aev.get(o);if(!u)return null;i=(n=X(u,2).find(c=>c[2]===a))===null||n===void 0?void 0:n[0]}else i=e[0];if(!i)return null;const s=e[2];if(Array.isArray(s)&&s.length===2&&t.aev.get(s[0])){const[o,a]=s,u=t.aev.get(o);if(!u)return null;const c=(r=X(u,2).find(b=>b[2]===a))===null||r===void 0?void 0:r[0];if(!c)return null;const[f,l,p,...y]=e;return[i,l,c,...y]}else{const[o,...a]=e;return[i,...a]}}function cr(t,e,n){const r=Ye(t,n);if(!r)return;const[i,s,o]=r,a=e.getAttr(s);a&&(ue(t.eav,[i,s,o]),ue(t.aev,[s,i,o]),Xt(a)&&ue(t.vae,[o,s,i]))}let As=0;function dr(t,e,n){const[r,i,s]=n;let o;const a=Pe(t.eav,[r,i,s]);return a&&(o=a[3]),o||Date.now()*10+As++}function fr(t,e,n){var r;const i=Ye(t,n);if(!i)return;let[s,o,a]=i;const u=e.getAttr(o);if(!u)return;u["checked-data-type"]==="date"&&t.useDateObjects&&(a=_t(a));const d=Pe(t.eav,[s,o,a]),c=(r=d==null?void 0:d[3])!==null&&r!==void 0?r:dr(t,u,i),f=[s,o,a,c];Os(u)?(Z(t.eav,[s,o],new Map([[a,f]])),Z(t.aev,[o,s],new Map([[a,f]]))):(Z(t.eav,[s,o,a],f),Z(t.aev,[o,s,a],f)),Xt(u)&&Z(t.vae,[a,o,s],f)}function ks(t,e,n){var r;const i=Ye(t,n);if(!i)return;const[s,o,a]=i,u=e.getAttr(o);if(!u)return;if(!en(u))throw new Error("merge operation is not supported for links");const d=Pe(t.eav,[s,o]);if(!d)return;const c=(r=d.values().next())===null||r===void 0?void 0:r.value;if(!c)return;const f=c[2],l=tr(f,a),p=[s,o,l,dr(t,u,c)];Z(t.eav,[s,o],new Map([[l,p]])),Z(t.aev,[o,s],new Map([[l,p]]))}function tn(t,e,n){var r,i;const[s,o]=n,a=Ye(t,[s]);if(!a)return;const[u]=a,d=t.eav.get(u);if(d){for(const f of d.keys()){const l=e.getAttr(f);l&&l["on-delete-reverse"]==="cascade"&&X(d.get(f),1).forEach(([p,y,b])=>{var g;return tn(t,e,[b,(g=l["reverse-identity"])===null||g===void 0?void 0:g[1]])}),(!o||!l||((r=l["forward-identity"])===null||r===void 0?void 0:r[1])===o)&&(ue(t.aev,[f,u]),ue(t.eav,[u,f]))}d.size===0&&ue(t.eav,[u])}const c=t.vae.get(u)&&X(t.vae.get(u),2);c&&c.forEach(f=>{var l,p,y;const[b,g,T]=f,_=e.getAttr(g);(!o||!_||((l=_["reverse-identity"])===null||l===void 0?void 0:l[1])===o)&&(ue(t.eav,[b,g,T]),ue(t.aev,[g,b,T]),ue(t.vae,[T,g,b])),_&&_["on-delete"]==="cascade"&&((p=_["reverse-identity"])===null||p===void 0?void 0:p[1])===o&&tn(t,e,[b,(y=_["forward-identity"])===null||y===void 0?void 0:y[1]])}),((i=t.vae.get(u))===null||i===void 0?void 0:i.size)===0&&ue(t.vae,[u])}function lr(t,e,n){const r=sr(e,n,t.useDateObjects);Object.keys(r).forEach(i=>{t[i]=r[i]})}function js(t,[e]){t.addAttr(e)}function hr(t){return X(t.eav,3)}function Cs(t,e,[n]){if(!e.getAttr(n))return;const r=hr(t).filter(([i,s])=>s!==n);e.deleteAttr(n),lr(t,e,r)}function Is(t,e,[n]){e.getAttr(n.id)&&(e.updateAttr(n),lr(t,e,hr(t)))}function Ps(t,e,n){const[r,...i]=n;switch(r){case"add-triple":fr(t,e,i);break;case"deep-merge-triple":ks(t,e,i);break;case"retract-triple":cr(t,e,i);break;case"delete-entity":tn(t,e,i);break;case"add-attr":js(e,i);break;case"delete-attr":Cs(t,e,i);break;case"update-attr":Is(t,e,i);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${r}`)}}function X(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())X(r,e-1,n);return n}function gt(t,e,n){var r;const i=[];if(n!=null&&n.hasOwnProperty("$not")){for(const o of e.keys())n.$not!==o&&i.push(e.get(o));return i}if(n!=null&&n.hasOwnProperty("$isNull")){const{attrId:o,isNull:a,reverse:u}=n.$isNull;if(u)for(const d of e.keys()){const c=t.vae.get(d),f=!c||!c.get(o);(a?f:!f)&&i.push(e.get(d))}else{const d=t.aev.get(o);for(const c of e.keys()){const f=!d||((r=d.get(c))===null||r===void 0?void 0:r.get(null))||!d.get(c);(a?f:!f)&&i.push(e.get(c))}}return i}if(n!=null&&n.$comparator)return X(e,1).filter(n.$op);const s=n.in||n.$in||[n];for(const o of s){const a=e.get(o);a&&i.push(a)}return i}function Ms(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function Rs(t,[e,n,r]){var i,s;switch(Ms(e,n,r)){case"e":{const a=t.eav.get(e);return X(a,2)}case"ea":{const a=(i=t.eav.get(e))===null||i===void 0?void 0:i.get(n);return X(a,1)}case"eav":{const a=(s=t.eav.get(e))===null||s===void 0?void 0:s.get(n);return a?gt(t,a,r):[]}case"ev":{const a=t.eav.get(e);if(!a)return[];const u=[];for(const d of a.values())u.push(...gt(t,d,r));return u}case"a":{const a=t.aev.get(n);return X(a,2)}case"av":{const a=t.aev.get(n);if(!a)return[];const u=[];for(const d of a.values())u.push(...gt(t,d,r));return u}case"v":{const a=[];for(const u of t.eav.values())for(const d of u.values())a.push(...gt(t,d,r));return a}default:return X(t.eav,3)}}function xs(t,e,n){var r;const i={};if(!e)return i;for(const[s,o]of e.entries()){const a=(r=t.eav.get(n))===null||r===void 0?void 0:r.get(o.id),u=X(a,1);for(const d of u)i[s]=d[2]}return i}function W(t,e,n){var r;return(r=t.forwardIdents.get(e))===null||r===void 0?void 0:r.get(n)}function Ee(t,e,n){var r;return(r=t.revIdents.get(e))===null||r===void 0?void 0:r.get(n)}function Ds(t,e){return t.blobAttrs.get(e)}function pr(t,e){var n;const r=t.primaryKeys.get(e);return r||((n=t.forwardIdents.get(e))===null||n===void 0?void 0:n.get("id"))}function $s(t,e,n){const r=Ye(t,n);if(!r)return;const[i,s,o]=r;if(e.getAttr(s))return Pe(t.eav,[i,s])}function Us(t,e,n){const r=n.filter(([i,s,o,a,u])=>{if(i!=="add-triple"&&i!=="deep-merge-triple")return!0;const d=u==null?void 0:u.mode;if(d!=="create"&&d!=="update")return!0;let c=!1;const f=e.getAttr(o);if(f){const l=pr(e,f["forward-identity"][1]);c=!!$s(t,e,[s,l==null?void 0:l.id,s])}return!(d==="create"&&c||d==="update"&&!c)});return yt({store:t,attrsStore:e},i=>{r.forEach(s=>{Ps(i.store,i.attrsStore,s)})},{mark:i=>{if(i instanceof Oe)return"immutable"}})}function Ls(t){return typeof t=="string"&&t.startsWith("?")}function Fs(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return br(r,e,n)}return Object.assign(Object.assign({},n),{[t]:e})}function yr(t,e,n){return t===e?n:null}function Ns(t){switch(typeof t){case"string":return t.startsWith("?")?Fs:yr;default:return yr}}const Ks=["in","$in","$not","$isNull","$comparator"];function Ws(t){for(const e of Ks)if(t.hasOwnProperty(e))return!0;return!1}function br(t,e,n){return n?typeof t=="object"?Ws(t)?n:null:Ns(t)(t,e,n):null}function zs(t,e,n){return t.reduce((r,i,s)=>{const o=e[s];return br(i,o,r)},n)}function Vs(t,e,n){return Gs(t,e,n).map(r=>zs(e,r,n)).filter(r=>r)}function qs(t,e,n){return e.or?e.or.patterns.flatMap(r=>nn(t,r,n)):e.and?e.and.patterns.reduce((r,i)=>nn(t,i,r),n):n.flatMap(r=>Vs(t,e,r))}function nn(t,e,n=[{}]){return e.reduce((r,i)=>qs(t,i,r),n)}function rn(t,e){return Array.isArray(e)?e.map(n=>rn(t,n)):Ls(e)?t[e]:e}function Bs(t,{find:e,where:n}){return nn(t,n).map(i=>rn(i,e))}function Gs(t,e,n){return Rs(t,rn(n,e))}const Qs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Me(t){return typeof t=="string"&&Qs.test(t)}const G=[];for(let t=0;t<256;++t)G.push((t+256).toString(16).slice(1));function Hs(t,e=0){return(G[t[e+0]]+G[t[e+1]]+G[t[e+2]]+G[t[e+3]]+"-"+G[t[e+4]]+G[t[e+5]]+"-"+G[t[e+6]]+G[t[e+7]]+"-"+G[t[e+8]]+G[t[e+9]]+"-"+G[t[e+10]]+G[t[e+11]]+G[t[e+12]]+G[t[e+13]]+G[t[e+14]]+G[t[e+15]]).toLowerCase()}let sn;const Ys=new Uint8Array(16);function Js(){if(!sn){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");sn=crypto.getRandomValues.bind(crypto)}return sn(Ys)}const _r={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Zs(t,e,n){var i;if(_r.randomUUID&&!t)return _r.randomUUID();t=t||{};const r=t.random??((i=t.rng)==null?void 0:i.call(t))??Js();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Hs(r)}function gr(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function Xs(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function eo(t,e){return Xs(gr(t),gr(e))}function V(){return Zs()}function to(t,e){return t.localeCompare(e)}function no(){let t=to;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{t=Intl.Collator("en-US").compare}catch{}return t}const ro=no();let io=0;function Je(t){return wt(`_${t}`,io++)}function wt(t,e){return`?${t}-${e}`}class Re extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function so(t,e){const n=pr(t,e);if(!n)throw new Re(`Could not find id attr for ${e}`);return n}function wr(t,e,n,r){return[oo(t,e,n,r)]}function oo(t,e,n,r){return[t(n,r),so(e,n).id,t(n,r),t("time",r)]}function ao(t,e,n){return t.map(r=>r===e?n:r)}function Tr(t,e,n,r,i){const s=W(e,n,i),o=Ee(e,n,i),a=s||o;if(!a)throw new Re(`Could not find attr for ${[n,i]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[u,d]=a["forward-identity"],[c,f]=a["reverse-identity"],l=r+1,p=s?[t(d,r),a.id,t(f,l),Je("time")]:[t(d,l),a.id,t(f,r),Je("time")];return[s?f:d,l,p,a,!!s]}function mr(t,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),i=new RegExp(`^${r}$`,t?void 0:"i");return function(o){return typeof o!="string"?!1:i.test(o)}}function uo(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>new Date(e.$gt)}:function(i){return i[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>=new Date(e.$gte)}:function(i){return i[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<new Date(e.$lt)}:function(i){return i[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<=new Date(e.$lte)}:function(i){return i[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=mr(!0,e.$like);return{$comparator:!0,$op:function(s){return r(s[2])}}}if(e.hasOwnProperty("$ilike")){const r=mr(!1,e.$ilike);return{$comparator:!0,$op:function(s){return r(s[2])}}}return e}function co(t,e,n,r,i,s){const o=W(e,n,i),a=Ee(e,n,i),u=o||a;if(!u)throw new Re(`No attr for etype = ${n} label = ${i}`);if(s!=null&&s.hasOwnProperty("$isNull")){const d=W(e,n,"id");if(!d)throw new Re(`No attr for etype = ${n} label = id`);return[t(n,r),d.id,{$isNull:{attrId:u.id,isNull:s.$isNull,reverse:!o}},Je("time")]}return o?[t(n,r),u.id,uo(u,s),Je("time")]:[s,u.id,t(n,r),Je("time")]}function fo(t,e,n,r,i){const[s,o,a]=i.reduce((u,d)=>{const[c,f,l]=u,[p,y,b]=Tr(t,e,c,f,d);return[p,y,[...l,b]]},[n,r,[]]);return[s,o,a]}function on(t,e,n,r,i,s){const o=i.slice(0,i.length-1),a=i[i.length-1],[u,d,c]=fo(t,e,n,r,o),f=co(t,e,u,d,a,s);return c.concat([f])}function lo(t,e){return e?[e].concat(t):t}function ho([t,e]){return t==="or"&&Array.isArray(e)}function po([t,e]){return t==="and"&&Array.isArray(e)}function yo(t,e,n){return(r,i)=>{const s=t(r,i);return e==s?s:`${s}-${n}`}}function vr(t,e,n,r,i,s){const o=t(r,i),a=s.map((u,d)=>{const c=yo(t,o,d);return Or(c,n,r,i,u)});return{[e]:{patterns:a,joinSym:o}}}function bo(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function Sr(t,e,n,r,i){return bo(i).map(s=>on(t,e,n,r,s,{$isNull:!0}))}function Or(t,e,n,r,i){return Object.entries(i).flatMap(([s,o])=>{if(ho([s,o]))return vr(t,"or",e,n,r,o);if(po([s,o]))return vr(t,"and",e,n,r,o);if(s==="$entityIdStartsWith")return[];const a=s.split(".");if(o!=null&&o.hasOwnProperty("$ne")&&(o=Object.assign(Object.assign({},o),{$not:o.$ne}),delete o.$ne),o!=null&&o.hasOwnProperty("$not")){const u=on(t,e,n,r,a,o),d=Sr(t,e,n,r,a);return[{or:{patterns:[u,...d],joinSym:t(n,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&a.length>1?[{or:{patterns:Sr(t,e,n,r,a),joinSym:t(n,r)}}]:on(t,e,n,r,a,o)})}function _o(t,e,n,r){const i=wt;return r?Or(i,t,e,n,r).concat(wr(i,t,e,n)):wr(i,t,e,n)}function go(t,e,n){return[t(e,n),t("time",n)]}function wo(t,e,n,r,i,s){const[o,a,u,d,c]=Tr(t,e,n,r,i),f=ao(u,t(n,r),s);return[o,a,f,d,c]}function To(t,e,n,{etype:r,level:i,form:s},o){const a=Object.keys(s).filter(u=>u!=="$");return a.length?Object.entries(o).map(function([d,c]){return a.map(function(p){var y,b,g;const T=!!(e.cardinalityInference&&(!((g=(b=(y=n.linkIndex)===null||y===void 0?void 0:y[r])===null||b===void 0?void 0:b[p])===null||g===void 0)&&g.isSingular));try{const[_,m,O]=wo(t,n,r,i,p,d),S=Ar(e,n,{etype:_,level:m,form:s[p],join:O}),I=T?S[0]:S;return{[p]:I}}catch(_){if(_ instanceof Re)return{[p]:T?void 0:[]};throw _}}).reduce(function(p,y){return Object.assign(Object.assign({},p),y)},c)}):Object.values(o)}function mo(t,e,n){return n==="string"?ro(t,e):t>e?1:-1}function Ze(t,e,n,r,i){return e===r||e==null&&r==null?eo(t,n):r==null?1:e==null?-1:mo(e,r,i)}function Tt([t,e],[n,r],i){return Ze(t,e,n,r,i)}function an(t){return t==null?t:new Date(t).getTime()}function vo(t,e,n,r){var i;const[s,o,a,u]=t,d=n==="desc"?1:-1;if(((i=e["forward-identity"])===null||i===void 0?void 0:i[2])==="id")return Tt(r,[s,u],null)===d;const[c,f]=r,l=e["checked-data-type"],p=l==="date"?an(f):f,y=l==="date"?an(a):a;return Tt([c,p],[s,y],l)===d}function So(t,e){const n=e[1];return t.getAttr(n)}function Oo(t,e,n){const r=Object.keys(n)[0];return W(t,e,r)}function Eo(t,e,n,r){if(n)return So(t,n);if(r)return Oo(t,e,r)}function Ao(t,e,n){var r,i;if(!Array.isArray(n.fields))return Ds(t,e);const s=new Map;for(const o of n.fields){const a=W(t,e,o),u=(r=a==null?void 0:a["forward-identity"])===null||r===void 0?void 0:r[2];u&&en(a)&&s.set(u,a)}if(!s.has("id")){const o=W(t,e,"id"),a=(i=o==null?void 0:o["forward-identity"])===null||i===void 0?void 0:i[2];a&&s.set(a,o)}return s}function ko(t,e,{etype:n,pageInfo:r,dq:i,form:s}){var o,a;const u=(o=s==null?void 0:s.$)===null||o===void 0?void 0:o.order,d=Er(s),c=jo(s);let f=Bs(t,i);const l=r==null?void 0:r["start-cursor"],p=Eo(e,n,l,u);if(p&&((a=p==null?void 0:p["forward-identity"])===null||a===void 0?void 0:a[2])!=="id"){const g=p["checked-data-type"]==="date",T=p.id;f=f.map(([_])=>{var m,O,S,I,U;let F=(U=(I=(S=(O=(m=t.eav.get(_))===null||m===void 0?void 0:m.get(T))===null||O===void 0?void 0:O.values())===null||S===void 0?void 0:S.next())===null||I===void 0?void 0:I.value)===null||U===void 0?void 0:U[2];return g&&(F=an(F)),[_,F]})}f.sort(c==="asc"?function(T,_){return Tt(T,_,p==null?void 0:p["checked-data-type"])}:function(T,_){return Tt(_,T,p==null?void 0:p["checked-data-type"])});let y={};const b=Ao(e,n,i);for(const g of f){const[T]=g;if(y[T]||!d&&l&&p&&vo(l,p,c,g))continue;const _=xs(t,b,T);_&&(y[T]=_)}return y}function jo(t){var e;const n=(e=t.$)===null||e===void 0?void 0:e.order;return n&&n[Object.keys(n)[0]]||"asc"}function Er(t){var e,n,r;const i=(e=t.$)===null||e===void 0?void 0:e.offset,s=(n=t.$)===null||n===void 0?void 0:n.before,o=(r=t.$)===null||r===void 0?void 0:r.after;return!i&&!s&&!o}function Co(t,e,{etype:n,level:r,form:i,join:s,pageInfo:o}){var a,u,d,c,f;if(!Er(i)&&(!o||!o["start-cursor"]))return[];const l=lo(_o(e,n,r,(a=i.$)===null||a===void 0?void 0:a.where),s),p=go(wt,n,r),y=(u=i.$)===null||u===void 0?void 0:u.fields,b=ko(t,e,{etype:n,pageInfo:o,form:i,dq:{where:l,find:p,fields:y}}),g=((d=i.$)===null||d===void 0?void 0:d.limit)||((c=i.$)===null||c===void 0?void 0:c.first)||((f=i.$)===null||f===void 0?void 0:f.last);if(g!=null){r>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const T=Object.entries(b);return T.length<=g?b:Object.fromEntries(T.slice(0,g))}return b}function Io(t,e,n){try{return Co(t,e,n)}catch(r){if(r instanceof Re)return{};throw r}}function Ar(t,e,n){const r=Io(t,e,n);return To(wt,t,e,n,r)}function Po(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function kr({store:t,attrsStore:e,pageInfo:n,aggregate:r},i){const o={data:Object.keys(i).reduce(function(u,d){return r!=null&&r[d]||d==="$$ruleParams"||(u[d]=Ar(t,e,{etype:d,form:i[d],level:0,pageInfo:n==null?void 0:n[d]})),u},{})};return n&&(o.pageInfo=Po(n)),r&&(o.aggregate=r),o}function Mo(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Ro=Mo();function un(t,e,n){const r={__etype:t,__ops:n};return new Proxy(r,{get:(i,s)=>{if(s==="__ops")return n;if(s==="__etype")return t;if(Ro.has(s))return(o,a)=>un(t,e,[...n,a?[s,t,e,o,a]:[s,t,e,o]])}})}function xo(t,e){return`lookup__${t}__${JSON.stringify(e)}`}function mt(t){return t.startsWith("lookup__")}function jr(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function Do(t){return new Proxy({__etype:t},{get(e,n){if(n==="__etype")return t;const r=n;return mt(r)?un(t,jr(r),[]):un(t,r,[])}})}function cn(){return new Proxy({},{get(t,e){return Do(e)}})}const $o=cn();function Uo(t){return t.__ops}function Lo(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,i=[];for(const o of e){const a=n[o];if(a)i.push(a);else if(Array.isArray(o)&&o.length==2&&n[o[0]]){const[u,d]=o;i.push([n[u],d])}else i.push(o)}const[s]=e;if((s==="add-triple"||s==="retract-triple")&&r.has(e[2])){const o=i[1];i[1]=i[3],i[3]=o}return i}function Fo(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function No(t,e,n){return n.indexOf(".")!==-1&&!W(t,e,n)}function dn(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function Ko(t,e,n){if(!No(t,e,n))return W(t,e,n);const r=dn(n),i=W(t,e,r)||Ee(t,e,r);if(i&&i["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return i}function fn(t){return typeof t=="string"&&!mt(t)?null:typeof t=="string"&&mt(t)?jr(t):Fo(t)}function ee(t,e,n){const r=fn(n);if(r===null)return n;const[i,s]=r,o=Ko(t,e,i);if(!o||!o["unique?"])throw new Error(`${i} is not a unique attribute.`);return[o.id,s]}function Cr(t,e,n,r){var i;const s=ee(t,e,n);return Array.isArray(s)?[["add-triple",s,(i=W(t,e,"id"))===null||i===void 0?void 0:i.id,s]].concat(r):r}function Wo({attrsStore:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const a=Array.isArray(o)?o:[o],u=W(t,e,s),d=Ee(t,e,s);return a.map(c=>u?["add-triple",ee(t,e,n),u.id,ee(t,u["reverse-identity"][1],c)]:["add-triple",ee(t,d["forward-identity"][1],c),d==null?void 0:d.id,ee(t,e,n)])});return Cr(t,e,n,i)}function zo({attrsStore:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const a=Array.isArray(o)?o:[o],u=W(t,e,s),d=Ee(t,e,s);return a.map(c=>u?["retract-triple",ee(t,e,n),u.id,ee(t,u["reverse-identity"][1],c)]:["retract-triple",ee(t,d["forward-identity"][1],c),d.id,ee(t,e,n)])});return Cr(t,e,n,i)}function Vo(t,e,n,r){var i;if(Array.isArray(r)){const[s,o]=r;for(const a of t||[]){const u=a==null?void 0:a.aev.get(s);if(u){for(const[d,c,f]of X(u,2))if(f===o)return!0}}}else for(const s of t||[]){const o=s==null?void 0:s.eav.get(r);if(o){for(const a of o.keys())if(((i=e.getAttr(a))===null||i===void 0?void 0:i["forward-identity"][1])==n)return!0}}return!1}function Ir({stores:t,attrsStore:e},[n,r,i,s]){return(s==null?void 0:s.upsert)===!1?{mode:"update"}:(s==null?void 0:s.upsert)===!0?null:Vo(t,e,n,r)?{mode:"update"}:null}function qo(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,a=Jt(s),u=ee(n,r,i);return[["id",u]].concat(Object.entries(a)).map(([c,f])=>{const l=W(n,r,c);return l["checked-data-type"]==="date"&&t.useDateObjects&&(f=_t(f)),["add-triple",u,l.id,f,{mode:"create"}]})}function Bo(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,a=Jt(s),u=ee(n,r,i),d=Ir(t,[r,u,s,o]);return[["id",u]].concat(Object.entries(a)).map(([f,l])=>{const p=W(n,r,f);return p["checked-data-type"]==="date"&&t.useDateObjects&&(l=_t(l)),["add-triple",u,p.id,l,...d?[d]:[]]})}function Go({attrsStore:t},[e,n]){return[["delete-entity",ee(t,e,n),e]]}function Qo(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,a=Jt(s),u=ee(n,r,i),d=Ir(t,[r,u,s,o]),c=Object.entries(a).map(([l,p])=>{const y=W(n,r,l);return["deep-merge-triple",u,y.id,p,...d?[d]:[]]});return[["add-triple",u,W(n,r,"id").id,u,...d?[d]:[]]].concat(c)}function Ho({attrsStore:t},[e,n,r]){return[["rule-params",ee(t,e,n),e,r]]}function Yo(t){const[e,n,r,i,s]=t;if(!i)return t;const o=Object.assign({},i);return delete o.id,[e,n,r,o,...s?[s]:[]]}function Jo(t,e){const[n,...r]=Yo(e);switch(n){case"merge":return Qo(t,r);case"create":return qo(t,r);case"update":return Bo(t,r);case"link":return Wo(t,r);case"unlink":return zo(t,r);case"delete":return Go(t,r);case"ruleParams":return Ho(t,r);default:throw new Error(`unsupported action ${n}`)}}function Zo(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function Xo(t,e,n){var r,i;const s=(i=(r=t.entities[e])===null||r===void 0?void 0:r.attrs)===null||i===void 0?void 0:i[n];if(n==="id")return null;if(!s)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:o,indexed:a}=s==null?void 0:s.config,u=Zo(s==null?void 0:s.valueType);return{"index?":a,"unique?":o,"checked-data-type":u}}function vt(t,e,n,r){const i=t?Xo(t,e,n):null,s=V(),a=[V(),e,n];return Object.assign(Object.assign({id:s,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}function ea(t,e,n){return Object.values(t.links).find(s=>s.forward.on===e&&s.forward.label===n||s.reverse.on===e&&s.reverse.label===n)}function ta(t,e,n){const r=ea(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:i,reverse:s}=r;return{"forward-identity":[V(),i.on,i.label],"reverse-identity":[V(),s.on,s.label],cardinality:i.has==="one"?"one":"many","unique?":s.has==="one","on-delete":i.onDelete,"on-delete-reverse":s.onDelete}}function Pr(t,e,n,r){const i=t?ta(t,e,n):null,s=V(),o=[V(),e,n],a=[V(),n,e];return Object.assign(Object.assign({id:s,"forward-identity":o,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}const na=new Set(["create","update","merge","link","unlink"]),ra=new Set(["link","unlink"]),ia=new Set(["create","update","merge"]),sa=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),ln={"unique?":!0,"index?":!0},oa=Object.assign(Object.assign({},ln),{cardinality:"one"});function aa(t){const e=[],[n,r,i,s]=t;if(!sa.has(n))return e;const o=fn(i);if(o&&e.push({etype:r,lookupPair:o}),n==="link")for(const[a,u]of Object.entries(s)){const d=Array.isArray(u)?u:[u];for(const c of d){const f=fn(c);f&&e.push({etype:r,lookupPair:f,linkLabel:a})}}return e}function ua({attrsStore:t,schema:e},n){var r,i;const s=new Set,o=[],a=[];function u(y,b){return W(t,y,b)||o.find(g=>g["forward-identity"][1]===y&&g["forward-identity"][2]===b)}function d(y,b){return Ee(t,y,b)||o.find(g=>{var T,_;return((T=g["reverse-identity"])===null||T===void 0?void 0:T[1])===y&&((_=g["reverse-identity"])===null||_===void 0?void 0:_[2])===b})}function c(y){o.push(y),a.push(["add-attr",y]),s.add(y.id)}function f(y){y&&"isUnsynced"in y&&y.isUnsynced&&!s.has(y.id)&&(o.push(y),a.push(["add-attr",y]),s.add(y.id))}function l(y,b){return b.indexOf(".")!==-1&&!u(y,b)}function p(y,b){const g=u(y,b),T=d(y,b);f(g),f(T),!g&&!T&&c(Pr(e,y,b,oa))}for(const y of n)for(const{etype:b,lookupPair:g,linkLabel:T}of aa(y)){const _=g[0];if(T){p(b,T);const m=u(b,T),O=d(b,T);f(m),f(O);const S=((r=m==null?void 0:m["reverse-identity"])===null||r===void 0?void 0:r[1])||((i=O==null?void 0:O["forward-identity"])===null||i===void 0?void 0:i[1])||T;if(l(S,_))p(S,dn(_));else{const I=u(S,_);I||c(vt(e,S,_,ln)),f(I)}}else if(l(b,_))p(b,dn(_));else{const m=u(b,_);m||c(vt(e,b,_,ln)),f(m)}}for(const y of n){const[b,g,T,_]=y;if(na.has(b)){const m=u(g,"id");f(m),m||c(vt(e,g,"id",{"unique?":!0}));for(const O of Object.keys(_)){const S=u(g,O);if(f(S),ia.has(b)&&(S||c(vt(e,g,O,O==="id"?{"unique?":!0}:null))),ra.has(b)){const I=d(g,O);!S&&!I&&c(Pr(e,g,O)),f(I)}}}}if(o.length){const y=Object.assign({},t.attrs);for(const b of o)y[b.id]=b;return[new Oe(y,t.linkIndex),a]}return[t,a]}function ca(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(u=>Uo(u)),[i,s]=ua(t,r),o=Object.assign(Object.assign({},t),{attrsStore:i}),a=r.flatMap(u=>Jo(o,u));return[...s,...a]}var le=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};function Mr(t,e){typeof requestIdleCallback>"u"?t():requestIdleCallback(t,{timeout:e})}const Xe="__meta";class da{constructor(e,n){}}class hn{constructor(e){var n,r;this._subs=[],this._nextSave=null,this._nextGc=null,this._pendingSaveKeys=new Set,this._loadedKeys=new Set,this._version=0,this._meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0},this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=(n=e.saveThrottleMs)!==null&&n!==void 0?n:100,this._idleCallbackMaxWaitMs=(r=e.idleCallbackMaxWaitMs)!==null&&r!==void 0?r:1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}_initMeta(){return le(this,void 0,void 0,function*(){var e,n,r;this._meta.loadingPromise&&(yield this._meta.loadingPromise);try{const i=this._persister.getItem(Xe);this._meta.loadingPromise=i;const s=yield i;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const o=(n=(e=this._meta.value)===null||e===void 0?void 0:e.objects)!==null&&n!==void 0?n:{},a=s??{},u=(r=a.objects)!==null&&r!==void 0?r:{};this._meta.value=Object.assign(Object.assign({},a),{objects:Object.assign(Object.assign({},o),u)})}catch(i){this._meta.error=i,this._meta.attempts++,this._meta.loadingPromise=null}})}_getMeta(){return le(this,void 0,void 0,function*(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(yield this._meta.loadingPromise,this._meta.value):(this._initMeta(),yield this._meta.loadingPromise,this._meta.value)})}_refreshMeta(){return le(this,void 0,void 0,function*(){return yield this._initMeta(),this._meta.value})}_preloadEntries(e){return le(this,void 0,void 0,function*(){const n=yield this.waitForMetaToLoad();if(!n)return;const r=Object.entries(n.objects);r.sort(([i,s],[o,a])=>a.updatedAt-s.updatedAt);for(const[i]of r.slice(0,e))this._loadKey(i)})}_getFromStorage(e){return le(this,void 0,void 0,function*(){try{const n=yield this._persister.getItem(e);return n&&this.parse(e,n)}catch(n){return console.error(`Unable to read from storage for key=${e}`,n),null}})}waitForKeyToLoad(e){return le(this,void 0,void 0,function*(){return this._loadedKeys.has(e)?this.currentValue[e]:(yield this._loadingKeys[e]||this._loadKey(e),this.currentValue[e])})}waitForMetaToLoad(){return le(this,void 0,void 0,function*(){return this._getMeta()})}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}_loadKey(e){return le(this,void 0,void 0,function*(){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const n=this._getFromStorage(e);this._loadingKeys[e]=n;const r=yield n;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const i=this._merge(e,r,this.currentValue[e]);i&&(this.currentValue[e]=i)}this.onKeyLoaded&&this.onKeyLoaded(e)})}_writeToStorage(e){var n,r;const i=[],s=e==null?void 0:e.skipGc;if(this._meta.isLoading){const p=new Promise((y,b)=>{var g;setTimeout(()=>this._enqueuePersist(e?Object.assign(Object.assign({},e),{attempts:(e.attempts||0)+1}):{attempts:1}).then(y).catch(b),10+((g=e==null?void 0:e.attempts)!==null&&g!==void 0?g:0)*1e3)});return i.push(p),Promise.all(i).then(y=>y.reduce((b,g)=>b+g,0))}const o=this._meta.value;if(!o)return Promise.resolve(0);const a=[],u=[];for(const p of this._pendingSaveKeys)p in this.currentValue?u.push(p):(a.push(p),delete o.objects[p]);for(const p of a){const y=this._persister.removeItem(p);i.push(y.then(()=>1)),this._loadedKeys.delete(p),this._pendingSaveKeys.delete(p)}const d=[],c=[[Xe,o]],f=(n=o.objects)!==null&&n!==void 0?n:{};o.objects=f;for(const p of u)if(this._loadedKeys.has(p)){const y=this.serialize(p,this.currentValue[p]);c.push([p,y]);const b=this._objectSize(y),g=(r=f[p])!==null&&r!==void 0?r:{createdAt:Date.now(),updatedAt:Date.now(),size:b};g.updatedAt=Date.now(),g.size=b,f[p]=g,this._pendingSaveKeys.delete(p)}else d.push(p);const l=this._persister.multiSet(c);i.push(l.then(()=>1));for(const p of d){const y=this._loadKey(p).then(()=>this._enqueuePersist(e));i.push(y)}return s||this.gc(),Promise.all(i).then(p=>p.reduce((y,b)=>y+b,0))}flush(){return le(this,void 0,void 0,function*(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0})}_gc(){return le(this,void 0,void 0,function*(){if(!this._gcOpts)return;const e=new Set(yield this._persister.getAllKeys());e.delete(Xe);const n=new Set(Object.keys(this.currentValue));for(const l of Object.keys(this._loadingKeys))n.add(l);for(const l of this._loadedKeys)n.add(l);const r=yield this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const i=[],s={gcOpts:this._gcOpts,keys:e,sacredKeys:n,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const l of e)n.has(l)||l in r.objects||(this._log.info("Lost track of key in meta",l),i.push(this._persister.removeItem(l)),s.removed.push(l),s.removedMissingCount++);const o=Date.now();for(const[l,p]of Object.entries(r.objects))!n.has(l)&&p.updatedAt<o-this._gcOpts.maxAgeMs&&(i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedOldCount++);const a=Object.entries(r.objects);a.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const u=a.filter(([l])=>!n.has(l));if(a.length>this._gcOpts.maxEntries)for(const[l]of u.slice(0,a.length-this._gcOpts.maxEntries))i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedThresholdCount++;const d=Object.entries(r.objects);d.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const c=d.filter(([l])=>!n.has(l));let f=d.reduce((l,[p,y])=>l+y.size,0);for(;f>0&&f>this._gcOpts.maxSize&&c.length;){const[[l,p]]=c.splice(0,1);f-=p.size,i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedSizeCount++}for(const l of Object.keys(r.objects))!e.has(l)&&!n.has(l)&&delete r.objects[l];return(s.removed.length||s.metaRemoved.length)&&i.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",s),yield Promise.all(i),s})}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{Mr(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((n,r)=>{if(this._nextSave){n(0);return}this._nextSave=setTimeout(()=>{Mr(()=>{this._nextSave=null,this._writeToStorage(e).then(n).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[n,r]=yt(this.currentValue,e,{enablePatches:!0});for(const i of r){const s=i.path[0];s&&typeof s=="string"&&(this._pendingSaveKeys.add(s),this._loadedKeys.has(s)||this._loadKey(s))}this.currentValue=n,this._enqueuePersist();for(const i of this._subs)i(this.currentValue);return n}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}var be=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};const fa=6,la=["kv","querySubs","syncSubs"];function ha(t){return function(n){console.error("Error in IndexedDB event",{source:t,event:n})}}function pa(t){return be(this,void 0,void 0,function*(){return new Promise(e=>{const n=indexedDB.open(t);n.onerror=r=>{e(null)},n.onsuccess=r=>{const s=r.target.result;e(s)},n.onupgradeneeded=r=>{var i;(i=r.target.transaction)===null||i===void 0||i.abort(),e(null)}})})}function ya(t,e,n){return be(this,void 0,void 0,function*(){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const i=new Set;return new Promise((s,o)=>{var a,u,d,c;const f={};for(const[y,b]of Object.entries(r)){const g=typeof b=="string"?JSON.parse(b):b;if(g.lastAccessed){const _={createdAt:g.lastAccessed,updatedAt:g.lastAccessed,size:(c=(d=(u=(a=g.result)===null||a===void 0?void 0:a.store)===null||u===void 0?void 0:u.triples)===null||d===void 0?void 0:d.length)!==null&&c!==void 0?c:0};f[y]=_}const T=n.put(g,y);i.add(T)}const l={objects:f},p=n.put(l,Xe);i.add(p);for(const y of i)y.onsuccess=()=>{i.delete(y),i.size===0&&s()},y.onerror=b=>{o(b)}})})}function Rr(t,e,n){return be(this,void 0,void 0,function*(){const r=n.put(e,t);return new Promise((i,s)=>{r.onsuccess=()=>i(),r.onerror=o=>s(o)})})}function ba(t,e){return be(this,void 0,void 0,function*(){const n=yield pa(`instant_${t}_5`);if(!n)return;const r=yield new Promise((c,f)=>{const y=n.transaction(["kv"],"readonly").objectStore("kv").openCursor();y.onerror=g=>{f(g)};const b=[];y.onsuccess=()=>{const g=y.result;if(g){const T=g.key,_=g.value;b.push([T,_]),g.continue()}else c(b)},y.onerror=g=>{f(g)}}),i=e.transaction(["kv","querySubs"],"readwrite"),s=i.objectStore("kv"),o=i.objectStore("querySubs"),a=[],u={objects:{}};for(const[c,f]of r)switch(c){case"querySubs":{const l=ya(c,f,o);a.push(l);break}default:{const l=Rr(c,f,s);a.push(l);const p={createdAt:Date.now(),updatedAt:Date.now(),size:0};u.objects[c]=p;break}}const d=Rr(Xe,u,s);a.push(d),yield Promise.all(a),yield new Promise((c,f)=>{i.oncomplete=l=>c(l),i.onerror=l=>f(l),i.onabort=l=>f(l)})})}const xr=new Map;class Dr extends da{constructor(e,n){super(e,n),this.dbName=`instant_${e}_${fa}`,this._storeName=n,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{let r=!1;const i=indexedDB.open(this.dbName,1);i.onerror=s=>{n(s)},i.onsuccess=s=>{const a=s.target.result;if(r){const u=ba(this._appId,a).catch(d=>{ha("Error upgrading store from version 5 to 6.")(d)});xr.set(this.dbName,u),u.then(()=>e(a)).catch(()=>e(a))}else{const u=xr.get(this.dbName);u?u.then(()=>e(a)).catch(()=>e(a)):e(a)}},i.onupgradeneeded=s=>{r=!0,this._upgradeStore(s)}})}_upgradeStore(e){const r=e.target.result;for(const i of la)r.objectStoreNames.contains(i)||r.createObjectStore(i)}getItem(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const a=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=u=>{i(u)},a.onsuccess=u=>{a.result?r(a.result):r(null)}})})}setItem(e,n){return be(this,void 0,void 0,function*(){const r=yield this._dbPromise;return new Promise((i,s)=>{const u=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);u.onerror=d=>{s(d)},u.onsuccess=d=>{i()}})})}multiSet(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const s=n.transaction([this._storeName],"readwrite"),o=s.objectStore(this._storeName),a=new Set;for(const[u,d]of e){const c=o.put(d,u);a.add(c)}for(const u of a)u.onerror=d=>{s.abort(),i(d)},u.onsuccess=d=>{a.delete(u),a.size===0&&r()}})})}removeItem(e){return be(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const a=n.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);a.onerror=u=>{i(u)},a.onsuccess=u=>{r()}})})}getAllKeys(){return be(this,void 0,void 0,function*(){const e=yield this._dbPromise;return new Promise((n,r)=>{const o=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();o.onerror=a=>{r(a)},o.onsuccess=a=>{n(o.result.filter(u=>typeof u=="string"))}})})}}var _a=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};class $r{static getIsOnline(){return _a(this,void 0,void 0,function*(){return navigator.onLine})}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}class xe extends Error{constructor(e,n){super(e),this.hint=n;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,xe),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}var ga=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};class et extends xe{constructor(e){var n;const r=((n=e.body)===null||n===void 0?void 0:n.message)||`API Error (${e.status})`;super(r,e.body.hint);const i=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,i),Error.captureStackTrace&&Error.captureStackTrace(this,et),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}function ce(t,e){return ga(this,void 0,void 0,function*(){const n=yield fetch(t,e),r=yield n.json();return n.status===200?Promise.resolve(r):Promise.reject(new et({status:n.status,body:r}))})}var De=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};function wa({apiURI:t,appId:e,email:n}){return ce(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}function Ta(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,email:r,code:i,refreshToken:s}){return yield ce(`${e}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(Object.assign({"app-id":n,email:r,code:i},s?{"refresh-token":s}:{}))})})}function ma(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ce(`${e}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n,"refresh-token":r})})})}function va(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n}){return yield ce(`${e}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n})})})}function Ur(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,code:r,codeVerifier:i,refreshToken:s}){return yield ce(`${e}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,code:r,code_verifier:i,refresh_token:s})})})}function Sa(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,nonce:r,idToken:i,clientName:s,refreshToken:o}){return yield ce(`${e}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,nonce:r,id_token:i,client_name:s,refresh_token:o})})})}function Oa(t){return De(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ce(`${e}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,refresh_token:r})})})}var tt=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};function Ea(t){return tt(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,file:i,refreshToken:s,contentType:o,contentDisposition:a}){const u={app_id:n,path:r,authorization:`Bearer ${s}`,"content-type":o||i.type};return a&&(u["content-disposition"]=a),yield ce(`${e}/storage/upload`,{method:"PUT",headers:u,body:i})})}function Aa(t){return tt(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ce(`${e}/storage/files?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}function ka(t){return tt(this,arguments,void 0,function*({apiURI:e,appId:n,fileName:r,refreshToken:i,metadata:s={}}){const{data:o}=yield ce(`${e}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${i}`},body:JSON.stringify({app_id:n,filename:r})});return o})}function ja(t,e){return tt(this,void 0,void 0,function*(){return(yield fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok})}function Ca(t){return tt(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ce(`${e}/storage/signed-download-url?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}let pn=!1,Lr=!1,Fr=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(pn=!!window.localStorage.getItem("devBackend"),Lr=!!window.localStorage.getItem("__instantLogging"),Fr=!!window.localStorage.getItem("__devtoolLocalDash"));function Nr(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function Ia(t,e,n){var r,i;const s={peers:{}};if(e&&"user"in e?e.user:!0){const a=Nr((r=t.user)!==null&&r!==void 0?r:{},e==null?void 0:e.keys);s.user=Object.assign(Object.assign({},a),{peerId:n})}for(const a of Object.keys((i=t.peers)!==null&&i!==void 0?i:{})){const u=(e==null?void 0:e.peers)===void 0,d=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(a));if(u||d){const c=Nr(t.peers[a],e==null?void 0:e.keys);s.peers[a]=Object.assign(Object.assign({},c),{peerId:a})}}return s}function Pa(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!er(t.user,e.user))||!Xn(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!er(t.peers[r],e.peers[r]))return!0;return!1}class Kr{constructor(){this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function Wr(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":i}=r,{"join-rows":s}=i;for(const o of s)for(const a of o)e.push(a);Wr(n["child-nodes"],e)})}function zr(t){const e=[];return Wr(t,e),e}function Vr(t){return Object.values(t.links).reduce((e,n)=>{var r,i,s,o;return(r=e[s=n.forward.on])!==null&&r!==void 0||(e[s]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},(i=e[o=n.reverse.on])!==null&&i!==void 0||(e[o]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const yn="v0.22.96";function Ma(t,e){return{info:t?(...n)=>console.info(...n,e()):()=>{},debug:t?(...n)=>console.debug(...n,e()):()=>{},error:t?(...n)=>console.error(...n,e()):()=>{}}}class Y{constructor(e,n,r,i={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.isIndexed=r,this.config=i,this.metadata={}}clientRequired(){return new Y(this.valueType,!1,this.isIndexed,this.config)}optional(){return new Y(this.valueType,!1,this.isIndexed,this.config)}unique(){return new Y(this.valueType,this.required,this.isIndexed,Object.assign(Object.assign({},this.config),{unique:!0}))}indexed(){return new Y(this.valueType,this.required,!0,Object.assign(Object.assign({},this.config),{indexed:!0}))}}class St{constructor(e,n){this.attrs=e,this.links=n}asType(){return new St(this.attrs,this.links)}}class Ot{constructor(e,n,r){this.entities=e,this.links=n,this.rooms=r}withRoomSchema(){return new Ot(this.entities,this.links,{})}}class x extends Error{constructor(e,n){const r=n?`At path '${n}': ${e}`:e;super(r),this.name="QueryValidationError"}}const qr=["where","order","limit","last","first","offset","after","before","fields","aggregate"],Ra=t=>t.valueType||"unknown",Br=(t,e,n=!1)=>{if(n||t==null)return!0;switch(e){case"string":return typeof t=="string";case"number":return typeof t=="number"&&!isNaN(t);case"boolean":return typeof t=="boolean";case"date":return t instanceof Date||typeof t=="string"||typeof t=="number";default:return!0}},xa=(t,e,n,r,i,s,o)=>{const a=s.valueType==="json",u=(d,c,f)=>{if(!Br(f,c,a))throw new x(`Invalid value for operator '${d}' on attribute '${r}' in entity '${i}'. Expected ${c}, but received: ${typeof f}`,o)};switch(t){case"in":case"$in":if(!Array.isArray(e))throw new x(`Operator '${t}' for attribute '${r}' in entity '${i}' must be an array, but received: ${typeof e}`,o);for(const d of e)u(t,n,d);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":u(t,n,e);break;case"$like":case"$ilike":if(u(t,"string",e),t==="$ilike"&&!s.isIndexed)throw new x(`Operator '${t}' can only be used with indexed attributes, but '${r}' in entity '${i}' is not indexed`,o);break;case"$isNull":u(t,"boolean",e);break;default:throw new x(`Unknown operator '${t}' for attribute '${r}' in entity '${i}'`,o)}},$e=(t,e,n,r,i)=>{const s=Ra(n),o=n.valueType==="json";if(typeof t=="object"&&t!==null&&!Array.isArray(t)){if(o)return;const u=t;for(const[d,c]of Object.entries(u))xa(d,c,s,e,r,n,`${i}.${d}`)}else if(!Br(t,s,o))throw new x(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${s}, but received: ${typeof t}`,i)},Da=(t,e,n,r,i)=>{const s=t.split(".");if(s.length<2)throw new x(`Invalid dot notation path '${t}'. Must contain at least one dot.`,i);let o=n;for(let c=0;c<s.length-1;c++){const f=s[c],l=r.entities[o];if(!l)throw new x(`Entity '${o}' does not exist in schema while traversing dot notation path '${t}'.`,i);const p=l.links[f];if(!p){const y=Object.keys(l.links);throw new x(`Link '${f}' does not exist on entity '${o}' in dot notation path '${t}'. Available links: ${y.length>0?y.join(", "):"none"}`,i)}o=p.entityName}const a=s[s.length-1],u=r.entities[o];if(!u)throw new x(`Target entity '${o}' does not exist in schema for dot notation path '${t}'.`,i);if(a==="id"){if(typeof e=="string"&&!Me(e))throw new x(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${e}`,i);$e(e,t,new Y("string",!1,!0),n,i);return}const d=u.attrs[a];if(Object.keys(u.links).includes(a)){if(typeof e=="string"&&!Me(e))throw new x(`Invalid value for link '${a}' in entity '${o}'. Expected a UUID, but received: ${e}`,i);$e(e,t,new Y("string",!1,!0),n,i);return}if(!d){const c=Object.keys(u.attrs);throw new x(`Attribute '${a}' does not exist on entity '${o}' in dot notation path '${t}'. Available attributes: ${c.length>0?c.join(", ")+", id":"id"}`,i)}$e(e,t,d,n,i)},Gr=(t,e,n,r)=>{for(const[i,s]of Object.entries(t)){if(i==="or"||i==="and"){if(Array.isArray(s))for(const d of s)typeof d=="object"&&d!==null&&Gr(d,e,n,`${r}.${i}[${d}]`);continue}if(i==="id"){$e(s,"id",new Y("string",!1,!0),e,`${r}.id`);continue}if(i.includes(".")){Da(i,s,e,n,`${r}.${i}`);continue}const o=n.entities[e];if(!o)continue;const a=o.attrs[i],u=o.links[i];if(!a&&!u){const d=Object.keys(o.attrs),c=Object.keys(o.links);throw new x(`Attribute or link '${i}' does not exist on entity '${e}'. Available attributes: ${d.length>0?d.join(", "):"none"}. Available links: ${c.length>0?c.join(", "):"none"}`,`${r}.${i}`)}if(a)$e(s,i,a,e,`${r}.${i}`);else if(u){if(typeof s=="string"&&!Me(s))throw new x(`Invalid value for link '${i}' in entity '${e}'. Expected a UUID, but received: ${s}`,`${r}.${i}`);const d=new Y("string",!1,!0);$e(s,i,d,e,`${r}.${i}`)}}},$a=(t,e,n,r,i=0)=>{for(const o of Object.keys(t))if(!qr.includes(o))throw new x(`Invalid query parameter '${o}' in $ object. Valid parameters are: ${qr.join(", ")}. Found: ${o}`,r);const s=["offset","before","after","first","last"];for(const o of s)if(t[o]!==void 0&&i>0)throw new x(`'${o}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(t.where&&n){if(typeof t.where!="object"||t.where===null)throw new x(`'where' clause must be an object in entity '${e}', but received: ${typeof t.where}`,r?`${r}.where`:void 0);Gr(t.where,e,n,r?`${r}.where`:"where")}},Qr=(t,e,n,r,i=0)=>{var s;if(!t||typeof t!="object")throw new x(`Query part for entity '${e}' must be an object, but received: ${typeof t}`,r);for(const o of Object.keys(t))if(o!=="$"){if(n&&!(o in n.entities[e].links)){const u=Object.keys(n.entities[e].links);throw new x(`Link '${o}' does not exist on entity '${e}'. Available links: ${u.length>0?u.join(", "):"none"}`,`${r}.${o}`)}const a=t[o];if(typeof a=="object"&&a!==null){const u=(s=n==null?void 0:n.entities[e].links[o])===null||s===void 0?void 0:s.entityName;u&&Qr(a,u,n,`${r}.${o}`,i+1)}}else{const a=t[o];if(typeof a!="object"||a===null)throw new x(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof a}`,`${r}.$`);$a(a,e,n,`${r}.$`,i)}},Hr=(t,e)=>{if(typeof t!="object"||t===null)throw new x(`Query must be an object, but received: ${typeof t}${t===null?" (null)":""}`);if(Array.isArray(t))throw new x(`Query must be an object, but received: ${typeof t}`);const n=t;for(const r of Object.keys(n)){if(Array.isArray(t[r]))throw new x(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new x(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const i=Object.keys(e.entities);throw new x(`Entity '${r}' does not exist in schema. Available entities: ${i.length>0?i.join(", "):"none"}`,r)}Qr(n[r],r,e,r,0)}}},Yr=t=>typeof t!="string"?!1:mt(t)?!0:Me(t);class se extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const Jr=t=>t.length>0?t.join(", "):"none",Ua=(t,e)=>new se(`Entity '${t}' does not exist in schema. Available entities: ${Jr(e)}`),Zr={string:t=>typeof t=="string",number:t=>typeof t=="number"&&!isNaN(t),boolean:t=>typeof t=="boolean",date:t=>t instanceof Date||typeof t=="string"||typeof t=="number",json:()=>!0},La=(t,e)=>{var n,r;return t==null?!0:(r=(n=Zr[e.valueType])===null||n===void 0?void 0:n.call(Zr,t))!==null&&r!==void 0?r:!1},Xr=(t,e)=>{const n=e.entities[t];if(!n)throw Ua(t,Object.keys(e.entities));return n},bn=(t,e,n)=>{const r=Xr(t,n);if(typeof e!="object"||e===null)throw new se(`Arguments for data operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(i==="id")continue;const o=r.attrs[i];if(o&&!La(s,o))throw new se(`Invalid value for attribute '${i}' in entity '${t}'. Expected ${o.valueType}, but received: ${typeof s}`)}},ei=(t,e,n)=>{const r=Xr(t,n);if(typeof e!="object"||e===null)throw new se(`Arguments for link operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(!r.links[i]){const a=Object.keys(r.links);throw new se(`Link '${i}' does not exist on entity '${t}'. Available links: ${Jr(a)}`)}if(s!=null){if(Array.isArray(s)){for(const a of s)if(!Yr(a))throw new se(`Invalid entity ID in link '${i}' for entity '${t}'. Expected a UUID or a lookup, but received: ${a}`)}else if(!Yr(s))throw new se(`Invalid UUID in link '${i}' for entity '${t}'. Expected a UUID, but received: ${s}`)}}},Fa={create:bn,update:bn,merge:bn,link:ei,unlink:ei,delete:()=>{}},Na=(t,e)=>{if(!e)return;const[n,r,i,s]=t;if(!Array.isArray(i)&&!Me(i))throw new se(`Invalid id for entity '${r}'. Expected a UUID, but received: ${i}`);if(typeof r!="string")throw new se(`Entity name must be a string, but received: ${typeof r}`);const o=Fa[n];o&&s!==void 0&&o(r,s,e)},Ka=(t,e)=>{const n=Array.isArray(t)?t:[t];for(const r of n){if(!r||typeof r!="object")throw new se(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new se(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const i of r.__ops){if(!Array.isArray(i))throw new se(`Transaction operation must be an array, but received: ${typeof i}`);Na(i,e)}}};var ti=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};let ni=0;class ri{constructor(e){this.type="ws",this.id=`${this.type}_${ni++}`,this.conn=new WebSocket(e),this.conn.onopen=n=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=n=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(n.data.toString())})},this.conn.onclose=n=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=n=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){var e;return this.conn.readyState===((e=WebSocket.OPEN)!==null&&e!==void 0?e:1)}isConnecting(){var e;return this.conn.readyState===((e=WebSocket.CONNECTING)!==null&&e!==void 0?e:0)}send(e){return this.conn.send(JSON.stringify(e))}}class Wa{constructor(e,n){this.type="sse",this.initParams=null,this.sendQueue=[],this.closeFired=!1,this.sseInitTimeout=void 0,this.id=`${this.type}_${ni++}`,this.url=n,this.ES=e,this.conn=new e(n),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const i=JSON.parse(r.data);if(Array.isArray(i))for(const s of i)this.handleMessage(s);else this.handleMessage(i)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}postMessages(e){return ti(this,void 0,void 0,function*(){var n,r,i;try{(yield fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:(n=this.initParams)===null||n===void 0?void 0:n.machineId,session_id:(r=this.initParams)===null||r===void 0?void 0:r.sessionId,sse_token:(i=this.initParams)===null||i===void 0?void 0:i.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}})}flushQueue(){return ti(this,void 0,void 0,function*(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const n=this.postMessages(e);this.sendPromise=n,n.then(()=>{this.sendPromise=null,this.flushQueue()})})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}var ii=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};function za(t,e){const n=t.values;if(n){const r=ur(n.attrsStore,null);if(r){for(const i of n.entities||[])i.store.useDateObjects=e,i.store=ar(r,i.store);n.attrsStore=r}}return t}function Va(t,e){var n;if(e.values){const r=[];for(const i of(n=e.values)===null||n===void 0?void 0:n.entities){const s=or(i.store);r.push(Object.assign(Object.assign({},i),{store:s}))}return Object.assign(Object.assign({},e),{values:{attrsStore:e.values.attrsStore.toJSON(),entities:r}})}else return e}function qa(t,e,n){var r,i;const s=(r=e==null?void 0:e.state)===null||r===void 0?void 0:r.txId,o=(i=n==null?void 0:n.state)===null||i===void 0?void 0:i.txId;return s&&(!o||s>o)?e:o&&(!s||o>s)?n:e||n}function _n(t,e,n){return kr({store:e,attrsStore:n,pageInfo:null,aggregate:null},t.query).data[t.table][0]}function si(t,e,n,r){var i;const s=(i=W(n,t.table,"id"))===null||i===void 0?void 0:i.id;if(!s)return-1;const o=Pe(e.eav,[r,s,r]);return o?o[3]:-1}function oi(t,e,n){for(const{action:r,triple:i}of n)switch(r){case"added":fr(t,e,i);break;case"removed":cr(t,e,i);break}}function Ba(t,e,n){var r,i,s,o;const a={};for(const{action:u,triple:d}of n){const[c,f,l]=d,p=(i=(r=e.getAttr(f))===null||r===void 0?void 0:r["forward-identity"])===null||i===void 0?void 0:i[2];if(!p)continue;const y=(s=a[c])!==null&&s!==void 0?s:{};a[c]=y;const b=(o=y[p])!==null&&o!==void 0?o:{};switch(u){case"added":b.newValue=l;break;case"removed":b.oldValue===void 0&&(b.oldValue=l);break}y[p]=b}for(const[u,d]of Object.entries(a))for(const[c,{oldValue:f,newValue:l}]of Object.entries(d))f===l&&delete d[c];return a}function Et(t,e){return{[t.table]:e.map(n=>n.entity)}}function Ga(t,e){var n;if(t.orderFieldType)return t.orderFieldType;const r=t.orderField==="serverCreatedAt"?"number":(n=W(e(),t.table,t.orderField))===null||n===void 0?void 0:n["checked-data-type"];return t.orderFieldType=r,r}function Qa(t,e,n){const r=e;if(t.orderField==="serverCreatedAt"){n.sort(t.orderDirection==="asc"?function(o,a){return Ze(o.entity.id,o.serverCreatedAt,a.entity.id,a.serverCreatedAt,r)}:function(o,a){return Ze(a.entity.id,a.serverCreatedAt,o.entity.id,o.serverCreatedAt,r)});return}const i=t.orderField;n.sort(t.orderDirection==="asc"?function(o,a){return Ze(o.entity.id,o.entity[i],a.entity.id,a.entity[i],r)}:function(o,a){return Ze(a.entity.id,a.entity[i],o.entity.id,o.entity[i],r)})}D.SyncTableCallbackEventType=void 0,function(t){t.InitialSyncBatch="InitialSyncBatch",t.InitialSyncComplete="InitialSyncComplete",t.LoadFromStorage="LoadFromStorage",t.SyncTransaction="SyncTransaction",t.Error="Error"}(D.SyncTableCallbackEventType||(D.SyncTableCallbackEventType={}));class Ha{constructor(e,n,r,i,s,o){this.callbacks={},this.idToHash={},this.trySend=e,this.config=r,this.log=i,this.createStore=s,this.getAttrs=o,this.subs=new hn({persister:n,merge:qa,serialize:Va,parse:(a,u)=>za(u,this.config.useDateObjects),objectSize:a=>{var u;return((u=a.values)===null||u===void 0?void 0:u.entities.length)||0},logger:i,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,n){const r=B(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(n),this.initSubscription(e,r,n),i=>{this.unsubscribe(r,n,i==null?void 0:i.keepSubscription)}}unsubscribe(e,n,r){const i=(this.callbacks[e]||[]).filter(s=>s!==n);if(this.callbacks[e]=i,!i.length){delete this.callbacks[e];const s=this.subs.currentValue[e];s!=null&&s.state&&this.clearSubscriptionData(s.state.subscriptionId,!!r),r||this.subs.updateInPlace(o=>{delete o[e]})}}sendStart(e){this.trySend(V(),{op:"start-sync",q:e})}sendResync(e,n,r){this.idToHash[n.subscriptionId]=e.hash,this.trySend(n.subscriptionId,{op:"resync-table","subscription-id":n.subscriptionId,"tx-id":r,token:n.token})}sendRemove(e,n){this.trySend(V(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":n})}initSubscription(e,n,r){return ii(this,void 0,void 0,function*(){var i,s,o,a;yield this.subs.waitForKeyToLoad(n);const u=this.subs.currentValue[n];if(u&&u.state&&u.state.txId){this.sendResync(u,u.state,u.state.txId),!((i=u.values)===null||i===void 0)&&i.entities&&r&&r({type:D.SyncTableCallbackEventType.LoadFromStorage,data:Et(u,(s=u.values)===null||s===void 0?void 0:s.entities)});return}const d=Object.keys(e)[0],c=((a=(o=e[d])===null||o===void 0?void 0:o.$)===null||a===void 0?void 0:a.order)||{serverCreatedAt:"asc"},[f,l]=Object.entries(c)[0];this.subs.updateInPlace(p=>{p[n]={query:e,hash:n,table:d,orderDirection:l,orderField:f,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)})}flushPending(){return ii(this,void 0,void 0,function*(){for(const e of Object.keys(this.callbacks)){yield this.subs.waitForKeyToLoad(e);const n=this.subs.currentValue[e];n?yield this.initSubscription(n.query,n.hash):this.log.error("Missing sub for hash in flushPending",e)}})}onStartSyncOk(e){const n=e["subscription-id"],r=e.q,i=B(r);this.idToHash[n]=i,this.subs.updateInPlace(s=>{const o=s[i];if(!o)return this.log.error("Missing sub for hash",i,"subscription-id",n,"query",r),s;o.state={subscriptionId:n,token:e.token}})}notifyCbs(e,n){for(const r of this.callbacks[e]||[])r(n)}onSyncLoadBatch(e){var n;const r=e["subscription-id"],i=e["join-rows"],s=this.idToHash[r];if(!s){this.log.error("Missing hash for subscription",e);return}const o=[],a=this.subs.currentValue[s];if(!a){this.log.error("Missing sub for hash",s,e);return}const u=(n=a.values)!==null&&n!==void 0?n:{entities:[],attrsStore:this.getAttrs()};a.values=u;const d=u.entities;for(const c of i){const f=this.createStore(c),l=_n(a,f,u.attrsStore);d.push({store:f,entity:l,serverCreatedAt:si(a,f,u.attrsStore,l.id)}),o.push(l)}this.subs.updateInPlace(c=>{c[s]=a,c[s].updatedAt=Date.now()}),a.values&&this.notifyCbs(s,{type:D.SyncTableCallbackEventType.InitialSyncBatch,data:Et(a,a.values.entities),batch:o})}onSyncInitFinish(e){var n;const r=e["subscription-id"],i=this.idToHash[r];if(!i){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const a=o[i];if(!a){this.log.error("Missing sub for hash",i,e);return}const u=a.state;if(!u)return this.log.error("Sub never set init, missing result",a,e),o;u.txId=e["tx-id"],a.updatedAt=Date.now()});const s=this.subs.currentValue[i];s&&this.notifyCbs(i,{type:D.SyncTableCallbackEventType.InitialSyncComplete,data:Et(s,((n=s.values)===null||n===void 0?void 0:n.entities)||[])})}onSyncUpdateTriples(e){var n,r,i;const s=e["subscription-id"],o=this.idToHash[s];if(!o){this.log.error("Missing hash for subscription",e);return}const a=this.subs.currentValue[o];if(!a){this.log.error("Missing sub for hash",o,e);return}const u=a.state;if(!u){this.log.error("Missing state for sub",a,e);return}for(const d of e.txes){if(u.txId&&u.txId>=d["tx-id"])continue;u.txId=d["tx-id"];const c=[],f={};for(const _ of d.changes){const m=(n=f[_.triple[0]])!==null&&n!==void 0?n:[];f[_.triple[0]]=m,m.push(_)}const l=(r=a.values)!==null&&r!==void 0?r:{entities:[],attrsStore:this.getAttrs()},p=l.entities;a.values=l;const y=[];e:for(const[_,m]of Object.entries(f))for(let O=0;O<p.length;O++){const S=p[O];if(Es(S.store,_)){oi(S.store,l.attrsStore,m);const I=_n(a,S.store,l.attrsStore),U=Ba(S.store,l.attrsStore,m)[_];I?(y.push({oldEntity:S.entity,newEntity:I,changedFields:U||{}}),S.entity=I):c.push(O),delete f[_];continue e}}const b=[];for(const[_,m]of Object.entries(f)){const O=this.createStore([]);oi(O,l.attrsStore,m);const S=_n(a,O,l.attrsStore);if(!S){this.log.error("No entity found after applying change",{sub:a,changes:m,store:O});continue}p.push({store:O,entity:S,serverCreatedAt:si(a,O,l.attrsStore,S.id)}),b.push(S)}const g=[];for(const _ of c.sort().reverse())g.push(p[_].entity),p.splice(_,1);const T=Ga(a,this.getAttrs);Qa(a,T,p),this.notifyCbs(o,{type:D.SyncTableCallbackEventType.SyncTransaction,data:Et(a,(i=a.values)===null||i===void 0?void 0:i.entities),added:b,removed:g,updated:y})}this.subs.updateInPlace(d=>{d[o]=a,d[o].updatedAt=Date.now()})}clearSubscriptionData(e,n){const r=this.idToHash[e];if(r){delete this.idToHash[e];const i=this.subs.currentValue[r];if(i.state&&this.sendRemove(i.state,n),n?this.subs.unloadKey(r):this.subs.updateInPlace(s=>{delete s[r]}),i)return i}}onStartSyncError(e){const n=B(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},i=Object.keys(e["original-event"].q)[0];this.notifyCbs(n,{type:D.SyncTableCallbackEventType.Error,data:{[i]:[]},error:r})}onResyncError(e){const n=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(n,!1);r&&this.initSubscription(r.query,r.hash)}}var L=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})},ai=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n};const _e={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},Ya=3e4,Ja=3e4,Za=200,Xa=1e3*60,eu={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},gn="_instant_oauth_redirect",nt="currentUser";function tu({transportType:t,appId:e,apiURI:n,wsURI:r,EventSourceImpl:i}){if(!i)return new ri(`${r}?app_id=${e}`);switch(t){case"ws":return new ri(`${r}?app_id=${e}`);case"sse":return new Wa(i,`${n}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+t)}}function nu(){return typeof window<"u"||typeof chrome<"u"}const ui={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function ru(t,e){var n;const r=typeof t=="string"?JSON.parse(t):t;if(!((n=r==null?void 0:r.result)===null||n===void 0)&&n.store){const i=ur(r.result.attrsStore,r.result.store);if(i){const s=r.result.store;r.result.store=ar(i,Object.assign(Object.assign({},s),{useDateObjects:e})),r.result.attrsStore=i}}return r}function iu(t,e){const{result:n}=e,i=ai(e,["result"]);if(n){const s=Object.assign(Object.assign({},n),{store:or(n.store),attrsStore:n.attrsStore.toJSON()});i.result=s}return i}function su(t,e){switch(t){case"pendingMutations":return new Map(typeof e=="string"?JSON.parse(e):e);default:return e}}function ou(t,e){switch(t){case"pendingMutations":return[...e.entries()];default:return e}}function au(t,e,n){const r=e==null?void 0:e.result,i=n==null?void 0:n.result;return r&&!i&&n&&(n.result=r),n||e}function ci(t){return[...t].sort((e,n)=>{const[r,i]=e,[s,o]=n,a=i.order||0,u=o.order||0;return a==u?r<s?-1:r>s?1:0:a-u})}class uu{constructor(e,n=Dr,r=$r,i,s){var o,a,u;if(this._isOnline=!0,this._isShutdown=!1,this.status=_e.CONNECTING,this.queryCbs={},this.queryOnceDfds={},this.authCbs=[],this.attrsCbs=[],this.mutationErrorCbs=[],this.connectionStatusCbs=[],this.mutationDeferredStore=new Map,this._reconnectTimeoutId=null,this._reconnectTimeoutMs=0,this._transportType="ws",this._wsOk=null,this._localIdPromises={},this._errorMessage=null,this._oauthCallbackResponse=null,this._linkIndex=null,this._rooms={},this._roomsPendingLeave={},this._presence={},this._broadcastQueue=[],this._broadcastSubs={},this._currentUserCached={isLoading:!0,error:void 0,user:void 0},this._beforeUnloadCbs=[],this._dataForQueryCache={},this._inFlightMutationEventIds=new Set,this._onMergeKv=(d,c,f)=>{var l,p;switch(d){case"pendingMutations":{const y=(l=c==null?void 0:c.entries())!==null&&l!==void 0?l:[],b=(p=f==null?void 0:f.entries())!==null&&p!==void 0?p:[],g=new Map([...y,...b]);return(c?this._rewriteMutationsSorted(this.attrs,c):[]).forEach(([_,m])=>{var O;!(!((O=f==null?void 0:f.pendingMutations)===null||O===void 0)&&O.has(_))&&!m["tx-id"]&&this._sendMutation(_,m)}),g}default:return f||c}},this.getPreviousResult=d=>{var c;const f=B(d);return(c=this.dataForQuery(f))===null||c===void 0?void 0:c.data},this.notifyOne=d=>{var c,f;const l=(c=this.queryCbs[d])!==null&&c!==void 0?c:[],p=(f=this._dataForQueryCache[d])===null||f===void 0?void 0:f.data,y=this.dataForQuery(d);y!=null&&y.data&&(this._dataForQueryCache[d]=y,!bt(y.data,p)&&l.forEach(b=>b.cb(y.data)))},this.notifyOneQueryOnce=d=>{var c,f;const l=(c=this.queryOnceDfds[d])!==null&&c!==void 0?c:[],p=(f=this.dataForQuery(d))===null||f===void 0?void 0:f.data;l.forEach(y=>{this._completeQueryOnce(y.q,d,y.dfd),y.dfd.resolve(p)})},this.notifyQueryError=(d,c)=>{(this.queryCbs[d]||[]).forEach(l=>l.cb({error:c}))},this.pushTx=d=>{this.config.disableValidation||Ka(d,this.config.schema);try{const c=ca({attrsStore:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(f=>{var l;return(l=f==null?void 0:f.result)===null||l===void 0?void 0:l.store}),useDateObjects:this.config.useDateObjects},d);return this.pushOps(c)}catch(c){return this.pushOps([],c)}},this.pushOps=(d,c)=>{const f=V(),l=[...this._pendingMutations().values()],p=Math.max(0,...l.map(g=>g.order||0))+1,y={op:"transact","tx-steps":d,created:Date.now(),error:c,order:p};this._updatePendingMutations(g=>{g.set(f,y)});const b=new Kr;return this.mutationDeferredStore.set(f,b),this._sendMutation(f,y),this.notifyAll(),b.promise},this._transportOnOpen=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][open]",c.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(_e.OPENED),this.getCurrentUser().then(f=>{var l;this._trySend(V(),{op:"init","app-id":this.config.appId,"refresh-token":(l=f.user)===null||l===void 0?void 0:l.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(f=>{this._log.error("[socket][error]",c.id,f)})},this._transportOnMessage=d=>{const c=d.target,f=d.message;if(this._transport!==c){this._log.info("[socket][message]",c.id,f,"skip; this is no longer the current transport");return}if(!this._wsOk&&c.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(d.message))for(const l of d.message)this._handleReceive(c.id,l);else this._handleReceive(c.id,d.message)},this._transportOnError=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][error]",c.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",c.id,d)},this._scheduleReconnect=()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)},this._transportOnClose=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][close]",c.id,"skip; this is no longer the current transport");return}this._setStatus(_e.CLOSED);for(const f of Object.values(this._rooms))f.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",c.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",c.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()},this._EventSource=s,this.config=Object.assign(Object.assign({},eu),e),this.queryCacheLimit=(o=this.config.queryCacheLimit)!==null&&o!==void 0?o:10,this._pendingTxCleanupTimeout=(a=this.config.pendingTxCleanupTimeout)!==null&&a!==void 0?a:Ja,this._pendingMutationCleanupThreshold=(u=this.config.pendingMutationCleanupThreshold)!==null&&u!==void 0?u:Za,this._log=Ma(e.verbose||pn||Lr,()=>this._reactorStats()),this.versions=Object.assign(Object.assign({},i||{}),{"@instantdb/core":yn}),this.config.schema&&(this._linkIndex=Vr(this.config.schema)),!!nu()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!Me(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",d=>L(this,void 0,void 0,function*(){var c;try{if(((c=d.data)===null||c===void 0?void 0:c.type)==="auth"){const f=yield this.getCurrentUser();this.updateUser(f.user)}}catch(f){this._log.error("[error] handle broadcast channel",f)}}))),this._initStorage(n),this._syncTable=new Ha(this._trySendAuthed.bind(this),new n(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,d=>He(this.ensureAttrs(),d,this.config.enableCardinalityInference,this.config.useDateObjects),()=>this.ensureAttrs()),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser().then(d=>{this.syncUserToEndpoint(d.user)}),setInterval(()=>L(this,void 0,void 0,function*(){const d=yield this.getCurrentUser();this.syncUserToEndpoint(d.user)}),Xa),r.getIsOnline().then(d=>{this._isOnline=d,this._startSocket(),r.listen(c=>{c!==this._isOnline&&(this._log.info("[network] online =",c),this._isOnline=c,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",_e.CLOSED),this._setStatus(_e.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}ensureAttrs(){if(!this.attrs)throw new Error("attrs have not loaded.");return this.attrs}updateSchema(e){this.config=Object.assign(Object.assign({},this.config),{schema:e,cardinalityInference:!!e}),this._linkIndex=e?Vr(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new hn({persister:new e(this.config.appId,"querySubs"),merge:au,serialize:iu,parse:(n,r)=>ru(r,this.config.useDateObjects),objectSize:n=>{var r,i,s,o;return(o=(s=(i=(r=n==null?void 0:n.result)===null||r===void 0?void 0:r.store)===null||i===void 0?void 0:i.triples)===null||s===void 0?void 0:s.length)!==null&&o!==void 0?o:0},logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=n=>this._onQuerySubLoaded(n),this.kv=new hn({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:ou,parse:su,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=n=>{n==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(nt),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,n,r){const i=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const s=e!=="error"&&e!=="timeout";if(!i&&!s&&console.error("Mutation failed",Object.assign({status:e,eventId:n},r)),!!i)if(s)i.resolve({status:e,eventId:n});else if(r!=null&&r.type){const{status:o}=r,a=ai(r,["status"]);i.reject(new et({body:a,status:o??0}))}else i.reject(new xe((r==null?void 0:r.message)||"Unknown error",r==null?void 0:r.hint))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var n,r;const i=(r=(n=this._presence[e])===null||n===void 0?void 0:n.result)===null||r===void 0?void 0:r.user,s=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],i&&this._trySetPresence(e,i),s)for(const o of s){const{topic:a,roomType:u,data:d}=o;this._tryBroadcast(e,u,a,d)}}_addQueryData(e,n,r){if(!this.attrs)throw new Error("Attrs in reactor have not been set");const i=B(e),s=this.ensureAttrs(),o=He(this.attrs,n.triples,r,this.config.useDateObjects);this.querySubs.updateInPlace(a=>{a[i]={result:{store:o,attrsStore:s,pageInfo:n.pageInfo,processedTxId:void 0,isExternal:!0},q:e}}),this._cleanupPendingMutationsQueries(),this.notifyOne(i),this.notifyOneQueryOnce(i),this._cleanupPendingMutationsTimeout()}_handleReceive(e,n){var r,i,s,o,a,u;const d=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(ui[n.op]||this._log.info("[receive]",e,n.op,n),n.op){case"init-ok":{this._setStatus(_e.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const l of Object.keys(this._rooms)){const p=(i=(r=this._presence[l])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.user;this._tryJoinRoom(l,p)}break}case"add-query-exists":{this.notifyOneQueryOnce(B(n.q));break}case"add-query-ok":{const{q:l,result:p}=n,y=B(l);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[y])break;const b=(o=(s=p==null?void 0:p[0])===null||s===void 0?void 0:s.data)===null||o===void 0?void 0:o["page-info"],g=(u=(a=p==null?void 0:p[0])===null||a===void 0?void 0:a.data)===null||u===void 0?void 0:u.aggregate,T=zr(p),_=this.ensureAttrs(),m=He(_,T,d,this.config.useDateObjects);this.querySubs.updateInPlace(O=>{if(!O[y]){this._log.info("Missing value in querySubs",{hash:y,q:l});return}O[y].result={store:m,attrsStore:_,pageInfo:b,aggregate:g,processedTxId:n["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(y),this.notifyOneQueryOnce(y),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(n);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(n);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(n);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(n);break}case"refresh-ok":{const{computations:l,attrs:p}=n,y=n["processed-tx-id"];p&&this._setAttrs(p),this._cleanupPendingMutationsTimeout();const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations(),y);b!==this._pendingMutations()&&this.kv.updateInPlace(_=>{_.pendingMutations=b});const g=ci(b.entries()),T=l.map(_=>{var m,O,S,I;const U=_["instaql-query"],F=_["instaql-result"],ct=B(U),Pt=zr(F),Mt=this.ensureAttrs(),Rn=He(Mt,Pt,d,this.config.useDateObjects),{store:Rt,attrsStore:he}=this._applyOptimisticUpdates(Rn,Mt,g,y),we=(O=(m=F==null?void 0:F[0])===null||m===void 0?void 0:m.data)===null||O===void 0?void 0:O["page-info"],je=(I=(S=F==null?void 0:F[0])===null||S===void 0?void 0:S.data)===null||I===void 0?void 0:I.aggregate;return{q:U,hash:ct,store:Rt,attrsStore:he,pageInfo:we,aggregate:je}});T.forEach(({hash:_,q:m,store:O,attrsStore:S,pageInfo:I,aggregate:U})=>{this.querySubs.updateInPlace(F=>{if(!F[_]){this._log.error("Missing value in querySubs",{hash:_,q:m});return}F[_].result={store:O,attrsStore:S,pageInfo:I,aggregate:U,processedTxId:y}})}),this._cleanupPendingMutationsQueries(),T.forEach(({hash:_})=>{this.notifyOne(_)});break}case"transact-ok":{const{"client-event-id":l,"tx-id":p}=n;this._inFlightMutationEventIds.delete(l);const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations()).get(l);if(!b)break;this._updatePendingMutations(T=>{T.set(l,Object.assign(Object.assign({},T.get(l)),{"tx-id":p,confirmed:Date.now()}))});const g=[];for(const T of b["tx-steps"])if(T[0]==="add-attr"){const _=T[1];g.push(_)}if(g.length){const T=Object.values(this.ensureAttrs().attrs);this._setAttrs([...T,...g])}this._finishTransaction("synced",l),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._patchPresencePeers(l,n.edits),this._notifyPresenceSubs(l);break}case"refresh-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._setPresencePeers(l,n.data),this._notifyPresenceSubs(l);break}case"server-broadcast":{const l=n["room-id"],p=n.topic;this._trySetRoomConnected(l,!0),this._notifyBroadcastSubs(l,p,n);break}case"join-room-ok":{const l=n["room-id"];if(!this._rooms[l]){this._roomsPendingLeave[l]&&(this._tryLeaveRoom(l),delete this._roomsPendingLeave[l]);break}this._trySetRoomConnected(l,!0),this._flushEnqueuedRoomData(l);break}case"leave-room-ok":{const l=n["room-id"];this._trySetRoomConnected(l,!1);break}case"join-room-error":const c=n["room-id"],f=this._rooms[c];f&&(f.error=n.error),this._notifyPresenceSubs(c);break;case"error":this._handleReceiveError(n);break;default:this._log.info("Uknown op",n.op,n);break}}_pendingMutations(){var e;return(e=this.kv.currentValue.pendingMutations)!==null&&e!==void 0?e:new Map}_updatePendingMutations(e){this.kv.updateInPlace(n=>{var r;const i=(r=n.pendingMutations)!==null&&r!==void 0?r:new Map;n.pendingMutations=i,e(i)})}_handleMutationError(e,n,r){const i=this._pendingMutations().get(n);if(i&&(e!=="timeout"||!i["tx-id"])){this._updatePendingMutations(o=>(o.delete(n),o)),this._inFlightMutationEventIds.delete(n);const s={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(s),this._finishTransaction(e,n,r)}}_handleReceiveError(e){var n,r,i,s,o,a,u;console.log("error",e);const d=e["client-event-id"];this._inFlightMutationEventIds.delete(d);const c=this._pendingMutations().get(d),f={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(f.hint=e.hint),c){this._handleMutationError("error",d,e);return}if(!((n=e["original-event"])===null||n===void 0)&&n.hasOwnProperty("q")&&((r=e["original-event"])===null||r===void 0?void 0:r.op)==="add-query"){const y=(i=e["original-event"])===null||i===void 0?void 0:i.q,b=B(y);this.notifyQueryError(B(y),f),this.notifyQueryOnceError(y,b,d,f);return}if(((s=e["original-event"])===null||s===void 0?void 0:s.op)==="init"){if(e.type==="record-not-found"&&((o=e.hint)===null||o===void 0?void 0:o["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(_e.ERRORED,f),this.notifyAll();return}if(((a=e["original-event"])===null||a===void 0?void 0:a.op)==="resync-table"){this._syncTable.onResyncError(e);return}if(((u=e["original-event"])===null||u===void 0?void 0:u.op)==="start-sync"){this._syncTable.onStartSyncError(e);return}const p=Object.assign({},e);delete p.message,delete p.hint,console.error(e.message,p),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,i){var s;const o=(s=this.queryOnceDfds[n])===null||s===void 0?void 0:s.find(a=>a.eventId===r);o&&(o.dfd.reject(i),this._completeQueryOnce(e,n,o.dfd))}_setAttrs(e){this.attrs=new Oe(e.reduce((n,r)=>(n[r.id]=r,n),{}),this._linkIndex),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=V();return this.querySubs.updateInPlace(i=>{i[n]=i[n]||{q:e,result:null,eventId:r},i[n].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,n){return this._syncTable.subscribe(e,n)}subscribeQuery(e,n,r){var i;this.config.disableValidation||Hr(e,this.config.schema),r&&"ruleParams"in r&&(e=Object.assign({$$ruleParams:r.ruleParams},e));const s=B(e),o=this.getPreviousResult(e);return o&&n(o),this.queryCbs[s]=(i=this.queryCbs[s])!==null&&i!==void 0?i:[],this.queryCbs[s].push({q:e,cb:n}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,n)}}queryOnce(e,n){var r;this.config.disableValidation||Hr(e,this.config.schema),n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const i=new Kr;if(!this._isOnline)return i.reject(new Error("We can't run `queryOnce`, because the device is offline.")),i.promise;if(!this.querySubs)return i.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),i.promise;const s=B(e),o=this._startQuerySub(e,s);return this.queryOnceDfds[s]=(r=this.queryOnceDfds[s])!==null&&r!==void 0?r:[],this.queryOnceDfds[s].push({q:e,dfd:i,eventId:o}),setTimeout(()=>i.reject(new Error("Query timed out")),Ya),i.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(i=>i.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(i=>i.cb!==r),this._cleanupQuery(e,n))}_hasQueryListeners(e){var n,r;return!!(!((n=this.queryCbs[e])===null||n===void 0)&&n.length||!((r=this.queryOnceDfds[e])===null||r===void 0)&&r.length)}_cleanupQuery(e,n){this._hasQueryListeners(n)||(delete this.queryCbs[n],delete this.queryOnceDfds[n],delete this._dataForQueryCache[n],this.querySubs.unloadKey(n),this._trySendAuthed(V(),{op:"remove-query",q:e}))}_rewriteMutations(e,n,r){if(!e)return n;if(!n)return new Map;const i=c=>{const[f,l,p]=c["forward-identity"];return W(e,l,p)},s=c=>{const[f,l,p]=c["forward-identity"];return Ee(e,l,p)},o={attrIdMap:{},refSwapAttrIds:new Set};let a=!1;const u=(c,f)=>{const l=[];for(const p of c){const[y]=p;if(y==="add-attr"){const[g,T]=p,_=i(T);if(_&&T.id!==_.id){o.attrIdMap[T.id]=_.id,a=!0;continue}if(T["value-type"]==="ref"){const m=s(T);if(m){o.attrIdMap[T.id]=m.id,o.refSwapAttrIds.add(T.id),a=!0;continue}}}if(r&&f&&r>=f&&y==="add-attr"||y==="update-attr"||y==="delete-attr"){a=!0;continue}const b=a?Lo(o,p):p;l.push(b)}return a?l:c},d=new Map;for(const[c,f]of n.entries())d.set(c,Object.assign(Object.assign({},f),{"tx-steps":u(f["tx-steps"],f["tx-id"])}));return a?d:n}_rewriteMutationsSorted(e,n){return ci(this._rewriteMutations(e,n).entries())}optimisticAttrs(){var e,n;const r=[...this._pendingMutations().values()].flatMap(a=>a["tx-steps"]),i=new Set(r.filter(([a,u])=>a==="delete-attr").map(([a,u])=>u)),s=[];for(const[a,u]of r)if(a==="add-attr")s.push(u);else if(a==="update-attr"&&u.id&&(!((e=this.attrs)===null||e===void 0)&&e.getAttr(u.id))){const d=Object.assign(Object.assign({},this.attrs.getAttr(u.id)),u);s.push(d)}if(!i.size&&!s.length)return this.attrs||new Oe({},this._linkIndex);const o=Object.assign({},((n=this.attrs)===null||n===void 0?void 0:n.attrs)||{});for(const a of s)o[a.id]=a;for(const a of i)delete o[a];return new Oe(o,this._linkIndex)}dataForQuery(e,n=!0){const r=this._errorMessage;if(r)return{error:r};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const i=this.querySubs.version(),s=this.querySubs.currentValue,o=this.kv.version(),a=this._pendingMutations(),{q:u,result:d}=s[e]||{};if(!d)return;const c=this._dataForQueryCache[e];if(c&&i===c.querySubVersion&&o===c.pendingMutationsVersion)return c;let f=d.store,l=d.attrsStore;const{pageInfo:p,aggregate:y,processedTxId:b}=d,g=this._rewriteMutationsSorted(l,a);if(n){const _=this._applyOptimisticUpdates(f,l,g,b);f=_.store,l=_.attrsStore}return{data:kr({store:f,attrsStore:l,pageInfo:p,aggregate:y},u),querySubVersion:i,pendingMutationsVersion:o}}_applyOptimisticUpdates(e,n,r,i){for(const[s,o]of r)if(!o["tx-id"]||i&&o["tx-id"]>i){const a=Us(e,n,o["tx-steps"]);e=a.store,n=a.attrsStore}return{store:e,attrsStore:n}}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}shutdown(){var e;this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,(e=this._transport)===null||e===void 0||e.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{message:n.error.message});return}if(this.status!==_e.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(i=>this.querySubs.currentValue[i]).filter(i=>i).forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),this._rewriteMutationsSorted(this.ensureAttrs(),this._pendingMutations()).forEach(([i,s])=>{s["tx-id"]||this._sendMutation(i,s)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:n}of Object.values(this.querySubs.currentValue))n!=null&&n.processedTxId&&(e=Math.min(e,n==null?void 0:n.processedTxId));this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i["tx-id"]&&i["tx-id"]<=e&&n.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i.confirmed&&i.confirmed+this._pendingTxCleanupTimeout<e&&n.delete(r)})}_trySendAuthed(...e){this.status===_e.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){if(this._transport.isOpen()){switch(ui[n.op]||this._log.info("[send]",this._transport.id,n.op,n),n.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send(Object.assign({"client-event-id":e},n))}}_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=tu({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e!=null&&e.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}getLocalId(e){return L(this,void 0,void 0,function*(){const n=`localToken_${e}`;if(this.kv.currentValue[n])return this.kv.currentValue[n];const r=yield this.kv.waitForKeyToLoad(n);if(r)return r;const i=V();return this.kv.updateInPlace(s=>{s[n]||(s[n]=i)}),yield this.kv.waitForKeyToLoad(n)})}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(gn)){const n=e.toString();e.searchParams.delete(gn),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let i=!1;const s=o=>{var a;i||(i=!0,navigation.removeEventListener("navigate",s),!o.userInitiated&&o.navigationType==="replace"&&((a=o.destination)===null||a===void 0?void 0:a.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",s)}}}_oauthLoginInit(){return L(this,void 0,void 0,function*(){var e,n,r,i;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const s=new URLSearchParams(window.location.search);if(!s.get(gn))return null;const o=s.get("error");if(o)return this._replaceUrlAfterOAuth(),{error:{message:o}};const a=s.get("code");if(!a)return null;this._replaceUrlAfterOAuth();try{const u=yield this._getCurrentUser(),d=(u==null?void 0:u.type)==="guest",{user:c}=yield Ur({apiURI:this.config.apiURI,appId:this.config.appId,code:a,refreshToken:d?u.refresh_token:void 0});return this.setCurrentUser(c),null}catch(u){return((e=u==null?void 0:u.body)===null||e===void 0?void 0:e.type)==="record-not-found"&&((r=(n=u==null?void 0:u.body)===null||n===void 0?void 0:n.hint)===null||r===void 0?void 0:r["record-type"])==="app-oauth-code"&&(yield this._hasCurrentUser())?null:{error:{message:((i=u==null?void 0:u.body)===null||i===void 0?void 0:i.message)||"Error logging in."}}}})}_waitForOAuthCallbackResponse(){return L(this,void 0,void 0,function*(){return yield this._oauthCallbackResponse})}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(i=>{r||bt(i,n)||e(i)}),()=>{r=!0,this.authCbs=this.authCbs.filter(i=>i!==e)}}getAuth(){return L(this,void 0,void 0,function*(){const{user:e,error:n}=yield this.getCurrentUser();if(n)throw new xe("Could not get current user: "+n.message);return e})}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e.attrs))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}setCurrentUser(e){return L(this,void 0,void 0,function*(){this.kv.updateInPlace(n=>{n[nt]=e}),yield this.kv.waitForKeyToLoad(nt)})}getCurrentUserCached(){return this._currentUserCached}_getCurrentUser(){return L(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(nt);return typeof e=="string"?JSON.parse(e):e})}getCurrentUser(){return L(this,void 0,void 0,function*(){const e=yield this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const n={error:e.error,user:void 0};return this._currentUserCached=Object.assign({isLoading:!1},n),n}try{const r={user:yield this._getCurrentUser(),error:void 0};return this._currentUserCached=Object.assign({isLoading:!1},r),r}catch(n){return{user:void 0,isLoading:!1,error:{message:(n==null?void 0:n.message)||"Error loading user"}}}})}_hasCurrentUser(){return L(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(nt);return typeof e=="string"?JSON.parse(e)!=null:e!=null})}changeCurrentUser(e){return L(this,void 0,void 0,function*(){var n;const{user:r}=yield this.getCurrentUser();if(!bt(r,e)){yield this.setCurrentUser(e),this.updateUser(e);try{(n=this._broadcastChannel)===null||n===void 0||n.postMessage({type:"auth"})}catch(i){console.error("Error posting message to broadcast channel",i)}}})}syncUserToEndpoint(e){return L(this,void 0,void 0,function*(){if(this.config.firstPartyPath)try{fetch(this.config.firstPartyPath+"/",{method:"POST",body:JSON.stringify({type:"sync-user",appId:this.config.appId,user:e}),headers:{"Content-Type":"application/json"}})}catch(n){this._log.error("Error syncing user with external endpoint",n)}})}updateUser(e){this.syncUserToEndpoint(e);const n={error:void 0,user:e};this._currentUserCached=Object.assign({isLoading:!1},n),this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(i=>{delete r[i].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return wa({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}signInWithMagicCode(e){return L(this,arguments,void 0,function*({email:n,code:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",a=yield Ta({apiURI:this.config.apiURI,appId:this.config.appId,email:n,code:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}signInWithCustomToken(e){return L(this,void 0,void 0,function*(){const n=yield ma({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return yield this.changeCurrentUser(n.user),n})}signInAsGuest(){return L(this,void 0,void 0,function*(){const e=yield va({apiURI:this.config.apiURI,appId:this.config.appId});return yield this.changeCurrentUser(e.user),e})}potentiallyInvalidateToken(e,n){var r;const i=(r=e==null?void 0:e.user)===null||r===void 0?void 0:r.refresh_token;if(!i)return;if(n.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}Oa({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:i}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}signOut(e){return L(this,void 0,void 0,function*(){const n=yield this.getCurrentUser();this.potentiallyInvalidateToken(n,e),yield this.changeCurrentUser(null)})}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:i}=this.config;return`${r}/runtime/oauth/start?app_id=${i}&client_name=${e}&redirect_uri=${n}`}exchangeCodeForToken(e){return L(this,arguments,void 0,function*({code:n,codeVerifier:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",a=yield Ur({apiURI:this.config.apiURI,appId:this.config.appId,code:n,codeVerifier:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}signInWithIdToken(e){return L(this,arguments,void 0,function*({idToken:n,clientName:r,nonce:i}){var s;const o=yield this.getCurrentUser(),a=(s=o==null?void 0:o.user)===null||s===void 0?void 0:s.refresh_token,u=yield Sa({apiURI:this.config.apiURI,appId:this.config.appId,idToken:n,clientName:r,nonce:i,refreshToken:a});return yield this.changeCurrentUser(u.user),u})}joinRoom(e,n){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const i=this._presence[e].result;return n&&!i&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=n,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,n),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,i,s;if(!(!((r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0)&&r.length)&&!Object.keys((i=this._broadcastSubs[e])!==null&&i!==void 0?i:{}).length){const o=(s=this._rooms[e])===null||s===void 0?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],o?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const i=this._rooms[n],s=this._presence[n];return!i||!s||!s.result?null:Object.assign(Object.assign({},Ia(s.result,r,this._sessionId)),{isLoading:!i.isConnected,error:i.error})}publishPresence(e,n,r){const i=this._rooms[n],s=this._presence[n];if(!i||!s)return;s.result=s.result||{};const o=Object.assign(Object.assign({},s.result.user),r);s.result.user=o,i.isConnected&&(this._trySetPresence(n,o),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(V(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e,n){this._trySendAuthed(V(),{op:"join-room","room-id":e,data:n}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(V(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,n){const r=this._rooms[e];r&&(r.isConnected=n)}subscribePresence(e,n,r,i){const s=this.joinRoom(n,r.initialPresence||r.initialData),o=Object.assign(Object.assign({},r),{roomId:n,cb:i,prev:null});return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(o),this._notifyPresenceSub(n,o),()=>{var a,u,d;this._presence[n].handlers=(d=(u=(a=this._presence[n])===null||a===void 0?void 0:a.handlers)===null||u===void 0?void 0:u.filter(c=>c!==o))!==null&&d!==void 0?d:[],s()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0||r.forEach(i=>{this._notifyPresenceSub(e,i)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!Pa(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){var r,i,s;const o=((i=(r=this._presence[e])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.peers)||{};let a=Object.fromEntries(Object.entries(o).map(([d,c])=>[d,{data:c}]));(s=this._presence[e])===null||s===void 0||s.result;const u=yt(a,d=>{for(let[c,f,l]of n)switch(f){case"+":ss(d,c,l);break;case"r":nr(d,c,l);break;case"-":rr(d,c);break}delete d[this._sessionId]});this._setPresencePeers(e,u)}_setPresencePeers(e,n){const r=Object.assign({},n);delete r[this._sessionId];const i=Object.fromEntries(Object.entries(r).map(([s,o])=>[s,o.data]));this._presence=yt(this._presence,s=>{nr(s,[e,"result","peers"],i)})}publishTopic({roomType:e,roomId:n,topic:r,data:i}){var s;const o=this._rooms[n];if(o){if(!o.isConnected){this._broadcastQueue[n]=(s=this._broadcastQueue[n])!==null&&s!==void 0?s:[],this._broadcastQueue[n].push({topic:r,roomType:e,data:i});return}this._tryBroadcast(n,e,r,i)}}_tryBroadcast(e,n,r,i){this._trySendAuthed(V(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:i})}subscribeTopic(e,n,r){const i=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(s=>s!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],i()}}_notifyBroadcastSubs(e,n,r){var i,s,o;(o=(s=(i=this._broadcastSubs)===null||i===void 0?void 0:i[e])===null||s===void 0?void 0:s[n])===null||o===void 0||o.forEach(a=>{var u,d,c,f,l,p;const y=(u=r.data)===null||u===void 0?void 0:u.data,b=r.data["peer-id"]===this._sessionId?(c=(d=this._presence[e])===null||d===void 0?void 0:d.result)===null||c===void 0?void 0:c.user:(p=(l=(f=this._presence[e])===null||f===void 0?void 0:f.result)===null||l===void 0?void 0:l.peers)===null||p===void 0?void 0:p[r.data["peer-id"]];return a(y,b)})}uploadFile(e,n,r){return L(this,void 0,void 0,function*(){var i;const s=yield this.getCurrentUser(),o=(i=s==null?void 0:s.user)===null||i===void 0?void 0:i.refresh_token;return Ea(Object.assign(Object.assign({},r),{apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:o}))})}deleteFile(e){return L(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield Aa({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}upload(e,n){return L(this,void 0,void 0,function*(){var r;const i=yield this.getCurrentUser(),s=(r=i==null?void 0:i.user)===null||r===void 0?void 0:r.refresh_token,o=e||n.name,a=yield ka({apiURI:this.config.apiURI,appId:this.config.appId,fileName:o,refreshToken:s});return yield ja(a,n)})}getDownloadUrl(e){return L(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield Ca({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}}function cu(t,e){return new Ot(di(t,e),e,void 0)}function du(t){return new St(t,{})}function fu(){return new Y("string",!0,!1)}function lu(){return new Y("number",!0,!1)}function hu(){return new Y("boolean",!0,!1)}function pu(){return new Y("date",!0,!1)}function yu(){return new Y("json",!0,!1)}function bu(){return new Y("json",!0,!1)}function di(t,e){var n,r,i,s;const o={fwd:{},rev:{}};for(const u of Object.values(e))(n=o.fwd)[r=u.forward.on]||(n[r]={}),(i=o.rev)[s=u.reverse.on]||(i[s]={}),o.fwd[u.forward.on][u.forward.label]={entityName:u.reverse.on,cardinality:u.forward.has},o.rev[u.reverse.on][u.reverse.label]={entityName:u.forward.on,cardinality:u.reverse.has};return Object.fromEntries(Object.entries(t).map(([u,d])=>[u,new St(d.attrs,Object.assign(Object.assign({},o.fwd[u]),o.rev[u]))]))}function _u({entities:t,links:e,rooms:n}){const r=e??{},i=n??{};return new Ot(di(t,r),r,i)}const gu={graph:cu,schema:_u,entity:du,string:fu,number:lu,boolean:hu,date:pu,json:yu,any:bu};let At;function wu(t,e){At==null||At.dispose();const n=Eu(e),r=vu(e,a),i=mu(Tu(t));function s(c){var f;c.source===i.element.contentWindow&&((f=c.data)===null||f===void 0?void 0:f.type)==="close"&&n.isVisible()&&a()}function o(c){const f=c.shiftKey&&c.ctrlKey&&c.key==="0",l=c.key==="Escape"||c.key==="Esc";(f||l&&n.isVisible())&&a()}function a(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(i.element)||n.element.appendChild(i.element))}function u(){n.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",s)}function d(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",s),At={dispose:u}}return d()}function Tu(t){return`${pn||Fr?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function mu(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function vu(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,Object.assign(Object.assign({position:"fixed"},Su(t.position)),{height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"})),r.addEventListener("click",e),{element:r}}function Su(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function Ou(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function Eu(t){const e=document.createElement("div");Object.assign(e.style,Object.assign(Object.assign({position:"fixed"},Ou(t.position)),{display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"})),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const Au={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function ku(){var t;return globalThis.__instantDbSchemaHashStore=(t=globalThis.__instantDbSchemaHashStore)!==null&&t!==void 0?t:new WeakMap,globalThis.__instantDbSchemaHashStore}function ju(){var t;return globalThis.__instantDbStore=(t=globalThis.__instantDbStore)!==null&&t!==void 0?t:{},globalThis.__instantDbStore}function wn(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+t.useDateObjects}const Tn=ju(),fi=ku();class Cu{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.signInAsGuest=()=>this.db.signInAsGuest(),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(n={invalidateToken:!0})=>this.db.signOut(n)}}class Iu{constructor(e){this.db=e,this.uploadFile=(n,r,i={})=>this.db.uploadFile(n,r,i),this.delete=n=>this.db.deleteFile(n),this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n)}}function Pu(t){return JSON.parse(JSON.stringify(t))}class Mu{constructor(e){this.tx=cn(),this._reactor=e,this.auth=new Cu(this._reactor),this.storage=new Iu(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(n,r==null?void 0:r.initialPresence),subscribeTopic:(s,o)=>this._reactor.subscribeTopic(n,s,o),subscribePresence:(s,o)=>this._reactor.subscribePresence(e,n,s,o),publishTopic:(s,o)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:s,data:o}),publishPresence:s=>this._reactor.publishPresence(e,n,s),getPresence:s=>this._reactor.getPresence(e,n,s)}}shutdown(){delete Tn[wn(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}_syncTableExperimental(e,n){return this._reactor.subscribeTable(e,n)}}function li(t){if(!t)return"0";const e=fi.get(t);if(e)return e;const n=B(t);return fi.set(t,n),n}function Ru(t,e){return li(t._reactor.config.schema)!==li(e)}function xu(t,e,n,r,i){var s,o;const a=Object.assign(Object.assign({},t),{appId:(s=t.appId)===null||s===void 0?void 0:s.trim(),useDateObjects:(o=t.useDateObjects)!==null&&o!==void 0?o:!1}),u=Tn[wn(a)];if(u)return Ru(u,a.schema)&&u._reactor.updateSchema(a.schema),u;const d=new uu(Object.assign(Object.assign(Object.assign({},Au),a),{cardinalityInference:!!a.schema}),e||Dr,n||$r,Object.assign(Object.assign({},r||{}),{"@instantdb/core":yn}),i),c=new Mu(d);return Tn[wn(a)]=c,Du(a.appId,a.devtool),c}function Du(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n=Object.assign({position:"bottom-right",allowedHosts:["localhost"]},typeof e=="object"?e:{});n.allowedHosts.includes(window.location.hostname)&&wu(t,n)}var mn={exports:{}},rt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var hi;function $u(){if(hi)return rt;hi=1;var t=C,e=Symbol.for("react.element"),n=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,i=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};function o(a,u,d){var c,f={},l=null,p=null;d!==void 0&&(l=""+d),u.key!==void 0&&(l=""+u.key),u.ref!==void 0&&(p=u.ref);for(c in u)r.call(u,c)&&!s.hasOwnProperty(c)&&(f[c]=u[c]);if(a&&a.defaultProps)for(c in u=a.defaultProps,u)f[c]===void 0&&(f[c]=u[c]);return{$$typeof:e,type:a,key:l,ref:p,props:f,_owner:i.current}}return rt.Fragment=n,rt.jsx=o,rt.jsxs=o,rt}var it={},pi;function Uu(){if(pi)return it;pi=1;var t={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */return t.NODE_ENV!=="production"&&function(){var e=C,n=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),o=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),u=Symbol.for("react.context"),d=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),f=Symbol.for("react.suspense_list"),l=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),y=Symbol.for("react.offscreen"),b=Symbol.iterator,g="@@iterator";function T(h){if(h===null||typeof h!="object")return null;var w=b&&h[b]||h[g];return typeof w=="function"?w:null}var _=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function m(h){{for(var w=arguments.length,v=new Array(w>1?w-1:0),E=1;E<w;E++)v[E-1]=arguments[E];O("error",h,v)}}function O(h,w,v){{var E=_.ReactDebugCurrentFrame,M=E.getStackAddendum();M!==""&&(w+="%s",v=v.concat([M]));var R=v.map(function(P){return String(P)});R.unshift("Warning: "+w),Function.prototype.apply.call(console[h],console,R)}}var S=!1,I=!1,U=!1,F=!1,ct=!1,Pt;Pt=Symbol.for("react.module.reference");function Mt(h){return!!(typeof h=="string"||typeof h=="function"||h===i||h===o||ct||h===s||h===c||h===f||F||h===y||S||I||U||typeof h=="object"&&h!==null&&(h.$$typeof===p||h.$$typeof===l||h.$$typeof===a||h.$$typeof===u||h.$$typeof===d||h.$$typeof===Pt||h.getModuleId!==void 0))}function Rn(h,w,v){var E=h.displayName;if(E)return E;var M=w.displayName||w.name||"";return M!==""?v+"("+M+")":v}function Rt(h){return h.displayName||"Context"}function he(h){if(h==null)return null;if(typeof h.tag=="number"&&m("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof h=="function")return h.displayName||h.name||null;if(typeof h=="string")return h;switch(h){case i:return"Fragment";case r:return"Portal";case o:return"Profiler";case s:return"StrictMode";case c:return"Suspense";case f:return"SuspenseList"}if(typeof h=="object")switch(h.$$typeof){case u:var w=h;return Rt(w)+".Consumer";case a:var v=h;return Rt(v._context)+".Provider";case d:return Rn(h,h.render,"ForwardRef");case l:var E=h.displayName||null;return E!==null?E:he(h.type)||"Memo";case p:{var M=h,R=M._payload,P=M._init;try{return he(P(R))}catch{return null}}}return null}var we=Object.assign,je=0,Oi,Ei,Ai,ki,ji,Ci,Ii;function Pi(){}Pi.__reactDisabledLog=!0;function oc(){{if(je===0){Oi=console.log,Ei=console.info,Ai=console.warn,ki=console.error,ji=console.group,Ci=console.groupCollapsed,Ii=console.groupEnd;var h={configurable:!0,enumerable:!0,value:Pi,writable:!0};Object.defineProperties(console,{info:h,log:h,warn:h,error:h,group:h,groupCollapsed:h,groupEnd:h})}je++}}function ac(){{if(je--,je===0){var h={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:we({},h,{value:Oi}),info:we({},h,{value:Ei}),warn:we({},h,{value:Ai}),error:we({},h,{value:ki}),group:we({},h,{value:ji}),groupCollapsed:we({},h,{value:Ci}),groupEnd:we({},h,{value:Ii})})}je<0&&m("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var xn=_.ReactCurrentDispatcher,Dn;function xt(h,w,v){{if(Dn===void 0)try{throw Error()}catch(M){var E=M.stack.trim().match(/\n( *(at )?)/);Dn=E&&E[1]||""}return`
`+Dn+h}}var $n=!1,Dt;{var uc=typeof WeakMap=="function"?WeakMap:Map;Dt=new uc}function Mi(h,w){if(!h||$n)return"";{var v=Dt.get(h);if(v!==void 0)return v}var E;$n=!0;var M=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var R;R=xn.current,xn.current=null,oc();try{if(w){var P=function(){throw Error()};if(Object.defineProperty(P.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(P,[])}catch(ne){E=ne}Reflect.construct(h,[],P)}else{try{P.call()}catch(ne){E=ne}h.call(P.prototype)}}else{try{throw Error()}catch(ne){E=ne}h()}}catch(ne){if(ne&&E&&typeof ne.stack=="string"){for(var j=ne.stack.split(`
`),J=E.stack.split(`
`),K=j.length-1,z=J.length-1;K>=1&&z>=0&&j[K]!==J[z];)z--;for(;K>=1&&z>=0;K--,z--)if(j[K]!==J[z]){if(K!==1||z!==1)do if(K--,z--,z<0||j[K]!==J[z]){var oe=`
`+j[K].replace(" at new "," at ");return h.displayName&&oe.includes("<anonymous>")&&(oe=oe.replace("<anonymous>",h.displayName)),typeof h=="function"&&Dt.set(h,oe),oe}while(K>=1&&z>=0);break}}}finally{$n=!1,xn.current=R,ac(),Error.prepareStackTrace=M}var ze=h?h.displayName||h.name:"",Ce=ze?xt(ze):"";return typeof h=="function"&&Dt.set(h,Ce),Ce}function cc(h,w,v){return Mi(h,!1)}function dc(h){var w=h.prototype;return!!(w&&w.isReactComponent)}function $t(h,w,v){if(h==null)return"";if(typeof h=="function")return Mi(h,dc(h));if(typeof h=="string")return xt(h);switch(h){case c:return xt("Suspense");case f:return xt("SuspenseList")}if(typeof h=="object")switch(h.$$typeof){case d:return cc(h.render);case l:return $t(h.type,w,v);case p:{var E=h,M=E._payload,R=E._init;try{return $t(R(M),w,v)}catch{}}}return""}var dt=Object.prototype.hasOwnProperty,Ri={},xi=_.ReactDebugCurrentFrame;function Ut(h){if(h){var w=h._owner,v=$t(h.type,h._source,w?w.type:null);xi.setExtraStackFrame(v)}else xi.setExtraStackFrame(null)}function fc(h,w,v,E,M){{var R=Function.call.bind(dt);for(var P in h)if(R(h,P)){var j=void 0;try{if(typeof h[P]!="function"){var J=Error((E||"React class")+": "+v+" type `"+P+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof h[P]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw J.name="Invariant Violation",J}j=h[P](w,P,E,v,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(K){j=K}j&&!(j instanceof Error)&&(Ut(M),m("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",E||"React class",v,P,typeof j),Ut(null)),j instanceof Error&&!(j.message in Ri)&&(Ri[j.message]=!0,Ut(M),m("Failed %s type: %s",v,j.message),Ut(null))}}}var lc=Array.isArray;function Un(h){return lc(h)}function hc(h){{var w=typeof Symbol=="function"&&Symbol.toStringTag,v=w&&h[Symbol.toStringTag]||h.constructor.name||"Object";return v}}function pc(h){try{return Di(h),!1}catch{return!0}}function Di(h){return""+h}function $i(h){if(pc(h))return m("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",hc(h)),Di(h)}var Ui=_.ReactCurrentOwner,yc={key:!0,ref:!0,__self:!0,__source:!0},Li,Fi;function bc(h){if(dt.call(h,"ref")){var w=Object.getOwnPropertyDescriptor(h,"ref").get;if(w&&w.isReactWarning)return!1}return h.ref!==void 0}function _c(h){if(dt.call(h,"key")){var w=Object.getOwnPropertyDescriptor(h,"key").get;if(w&&w.isReactWarning)return!1}return h.key!==void 0}function gc(h,w){typeof h.ref=="string"&&Ui.current}function wc(h,w){{var v=function(){Li||(Li=!0,m("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",w))};v.isReactWarning=!0,Object.defineProperty(h,"key",{get:v,configurable:!0})}}function Tc(h,w){{var v=function(){Fi||(Fi=!0,m("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",w))};v.isReactWarning=!0,Object.defineProperty(h,"ref",{get:v,configurable:!0})}}var mc=function(h,w,v,E,M,R,P){var j={$$typeof:n,type:h,key:w,ref:v,props:P,_owner:R};return j._store={},Object.defineProperty(j._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(j,"_self",{configurable:!1,enumerable:!1,writable:!1,value:E}),Object.defineProperty(j,"_source",{configurable:!1,enumerable:!1,writable:!1,value:M}),Object.freeze&&(Object.freeze(j.props),Object.freeze(j)),j};function vc(h,w,v,E,M){{var R,P={},j=null,J=null;v!==void 0&&($i(v),j=""+v),_c(w)&&($i(w.key),j=""+w.key),bc(w)&&(J=w.ref,gc(w,M));for(R in w)dt.call(w,R)&&!yc.hasOwnProperty(R)&&(P[R]=w[R]);if(h&&h.defaultProps){var K=h.defaultProps;for(R in K)P[R]===void 0&&(P[R]=K[R])}if(j||J){var z=typeof h=="function"?h.displayName||h.name||"Unknown":h;j&&wc(P,z),J&&Tc(P,z)}return mc(h,j,J,M,E,Ui.current,P)}}var Ln=_.ReactCurrentOwner,Ni=_.ReactDebugCurrentFrame;function We(h){if(h){var w=h._owner,v=$t(h.type,h._source,w?w.type:null);Ni.setExtraStackFrame(v)}else Ni.setExtraStackFrame(null)}var Fn;Fn=!1;function Nn(h){return typeof h=="object"&&h!==null&&h.$$typeof===n}function Ki(){{if(Ln.current){var h=he(Ln.current.type);if(h)return`

Check the render method of \``+h+"`."}return""}}function Sc(h){return""}var Wi={};function Oc(h){{var w=Ki();if(!w){var v=typeof h=="string"?h:h.displayName||h.name;v&&(w=`

Check the top-level render call using <`+v+">.")}return w}}function zi(h,w){{if(!h._store||h._store.validated||h.key!=null)return;h._store.validated=!0;var v=Oc(w);if(Wi[v])return;Wi[v]=!0;var E="";h&&h._owner&&h._owner!==Ln.current&&(E=" It was passed a child from "+he(h._owner.type)+"."),We(h),m('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',v,E),We(null)}}function Vi(h,w){{if(typeof h!="object")return;if(Un(h))for(var v=0;v<h.length;v++){var E=h[v];Nn(E)&&zi(E,w)}else if(Nn(h))h._store&&(h._store.validated=!0);else if(h){var M=T(h);if(typeof M=="function"&&M!==h.entries)for(var R=M.call(h),P;!(P=R.next()).done;)Nn(P.value)&&zi(P.value,w)}}}function Ec(h){{var w=h.type;if(w==null||typeof w=="string")return;var v;if(typeof w=="function")v=w.propTypes;else if(typeof w=="object"&&(w.$$typeof===d||w.$$typeof===l))v=w.propTypes;else return;if(v){var E=he(w);fc(v,h.props,"prop",E,h)}else if(w.PropTypes!==void 0&&!Fn){Fn=!0;var M=he(w);m("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",M||"Unknown")}typeof w.getDefaultProps=="function"&&!w.getDefaultProps.isReactClassApproved&&m("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Ac(h){{for(var w=Object.keys(h.props),v=0;v<w.length;v++){var E=w[v];if(E!=="children"&&E!=="key"){We(h),m("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",E),We(null);break}}h.ref!==null&&(We(h),m("Invalid attribute `ref` supplied to `React.Fragment`."),We(null))}}var qi={};function Bi(h,w,v,E,M,R){{var P=Mt(h);if(!P){var j="";(h===void 0||typeof h=="object"&&h!==null&&Object.keys(h).length===0)&&(j+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var J=Sc();J?j+=J:j+=Ki();var K;h===null?K="null":Un(h)?K="array":h!==void 0&&h.$$typeof===n?(K="<"+(he(h.type)||"Unknown")+" />",j=" Did you accidentally export a JSX literal instead of a component?"):K=typeof h,m("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",K,j)}var z=vc(h,w,v,M,R);if(z==null)return z;if(P){var oe=w.children;if(oe!==void 0)if(E)if(Un(oe)){for(var ze=0;ze<oe.length;ze++)Vi(oe[ze],h);Object.freeze&&Object.freeze(oe)}else m("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else Vi(oe,h)}if(dt.call(w,"key")){var Ce=he(h),ne=Object.keys(w).filter(function(Mc){return Mc!=="key"}),Kn=ne.length>0?"{key: someKey, "+ne.join(": ..., ")+": ...}":"{key: someKey}";if(!qi[Ce+Kn]){var Pc=ne.length>0?"{"+ne.join(": ..., ")+": ...}":"{}";m(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,Kn,Ce,Pc,Ce),qi[Ce+Kn]=!0}}return h===i?Ac(z):Ec(z),z}}function kc(h,w,v){return Bi(h,w,v,!0)}function jc(h,w,v){return Bi(h,w,v,!1)}var Cc=jc,Ic=kc;it.Fragment=i,it.jsx=Cc,it.jsxs=Ic}(),it}var Lu={};Lu.NODE_ENV==="production"?mn.exports=$u():mn.exports=Uu();var Q=mn.exports;const Fu={isLoading:!0,data:void 0,pageInfo:void 0,error:void 0};function yi(t){return Object.assign({isLoading:!t,data:void 0,pageInfo:void 0,error:void 0},t||{})}function Nu(t,e,n){e&&n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const r=e?Pu(e):null,i=B(r),s=C.useRef(yi(t._reactor.getPreviousResult(r))),o=C.useCallback(u=>(s.current=yi(t._reactor.getPreviousResult(r)),u(),r?t.subscribeQuery(r,c=>{s.current=Object.assign({isLoading:!c,data:void 0,pageInfo:void 0,error:void 0},c),u()}):()=>{}),[i]);return{state:C.useSyncExternalStore(o,()=>s.current,()=>Fu),query:r}}function Ku(){const t=C.useRef(null);C.useEffect(()=>{n()},[]);function e(r,i){n(),t.current=setTimeout(i,r)}function n(){t.current&&clearTimeout(t.current)}return{set:e,clear:n}}const Wu=1e3;function zu(t,e,n){const r=C.useRef(n);r.current=n,C.useEffect(()=>t.core._reactor.subscribeTopic(t.id,e,(s,o)=>{r.current(s,o)}),[t.id,e])}function Vu(t,e){return C.useEffect(()=>t.core._reactor.joinRoom(t.id),[t.id]),C.useCallback(r=>{t.core._reactor.publishTopic({roomType:t.type,roomId:t.id,topic:e,data:r})},[t.id,e])}function qu(t,e={}){var n,r;const[i,s]=C.useState(()=>{var u;return(u=t.core._reactor.getPresence(t.type,t.id,e))!==null&&u!==void 0?u:{peers:{},isLoading:!0}});C.useEffect(()=>t.core._reactor.subscribePresence(t.type,t.id,e,d=>{s(d)}),[t.id,e.user,(n=e.peers)===null||n===void 0?void 0:n.join(),(r=e.keys)===null||r===void 0?void 0:r.join()]);const o=C.useCallback(u=>{t.core._reactor.publishPresence(t.type,t.id,u)},[t.type,t.id]);return C.useMemo(()=>Object.assign(Object.assign({},i),{publishPresence:o}),[i,o])}function Bu(t,e,n){C.useEffect(()=>t.core._reactor.joinRoom(t.id,e),[t.id]),C.useEffect(()=>t.core._reactor.publishPresence(t.type,t.id,e),[t.type,t.id,n??JSON.stringify(e)])}function Gu(t,e,n={}){const r=Ku(),i=Ae.usePresence(t,{keys:[e]}),s=C.useMemo(()=>{var c;const f=t._core._reactor.getPresence(t.type,t.id);return n!=null&&n.writeOnly?[]:Object.values((c=f==null?void 0:f.peers)!==null&&c!==void 0?c:{}).filter(l=>l[e]===!0)},[n==null?void 0:n.writeOnly,i]),o=C.useCallback(c=>{var f;t.core._reactor.publishPresence(t.type,t.id,{[e]:c}),c&&((n==null?void 0:n.timeout)===null||(n==null?void 0:n.timeout)===0||r.set((f=n==null?void 0:n.timeout)!==null&&f!==void 0?f:Wu,()=>{t.core._reactor.publishPresence(t.type,t.id,{[e]:null})}))},[t.type,t.id,e,n==null?void 0:n.timeout,r]),a=C.useCallback(c=>{const l=!((n==null?void 0:n.stopOnEnter)&&c.key==="Enter");o(l)},[n.stopOnEnter,o]),u=C.useCallback(()=>{o(!1)},[o]),d=C.useMemo(()=>({onKeyDown:a,onBlur:u}),[a,u]);return{active:s,setActive:o,inputProps:d}}const Ae={useTopicEffect:zu,usePublishTopic:Vu,usePresence:qu,useSyncPresence:Bu,useTypingIndicator:Gu};class Qu{constructor(e,n,r){this.useTopicEffect=(i,s)=>{Ae.useTopicEffect(this,i,s)},this.usePublishTopic=i=>Ae.usePublishTopic(this,i),this.usePresence=(i={})=>Ae.usePresence(this,i),this.useSyncPresence=(i,s)=>Ae.useSyncPresence(this,i,s),this.useTypingIndicator=(i,s={})=>Ae.useTypingIndicator(this,i,s),this.core=e,this._core=this.core,this.type=n,this.id=r}}var Hu=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(c){try{d(r.next(c))}catch(f){o(f)}}function u(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(a,u)}d((r=r.apply(t,e||[])).next())})};const Yu={isLoading:!0,user:void 0,error:void 0};class bi{constructor(e,n){this.tx=cn(),this.getLocalId=r=>this.core.getLocalId(r),this.useLocalId=r=>{const[i,s]=C.useState(null);return C.useEffect(()=>{Hu(this,void 0,void 0,function*(){const a=yield this.getLocalId(r);s(a)})},[r]),i},this.rooms=Ae,this.transact=r=>this.core.transact(r),this.useQuery=(r,i)=>Nu(this.core,r,i).state,this.useAuth=()=>this._useAuth(),this.useUser=()=>{const{user:r}=this.useAuth();if(!r)throw new xe("useUser must be used within an auth-protected route");return r},this.useConnectionStatus=()=>{const r=C.useRef(this.core._reactor.status),i=C.useCallback(o=>this.core.subscribeConnectionStatus(u=>{u!==r.current&&(r.current=u,o())}),[]);return C.useSyncExternalStore(i,()=>r.current,()=>"connecting")},this.queryOnce=(r,i)=>this.core.queryOnce(r,i),this.SignedIn=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||!i.user?null:Q.jsx(Q.Fragment,{children:r})},this.SignedOut=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||i.user?null:Q.jsx(Q.Fragment,{children:r})},this.core=xu(e,this.constructor.Storage,this.constructor.NetworkListener,n,this.constructor.EventSourceImpl),this._core=this.core,this.auth=this.core.auth,this.storage=this.core.storage}room(e="_defaultRoomType",n="_defaultRoomId"){return new Qu(this.core,e,n)}_useAuth(){const e=C.useRef(this.core._reactor._currentUserCached),n=C.useCallback(i=>this.core.subscribeAuth(o=>{e.current=Object.assign({isLoading:!1},o),i()}),[]);return C.useSyncExternalStore(n,()=>e.current,()=>Yu)}getAuth(){return this.core.getAuth()}}class _i extends Error{constructor(e,n){super(e),this.name="ParseError",this.type=n.type,this.field=n.field,this.value=n.value,this.line=n.line}}function vn(t){}function Ju(t){if(typeof t=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:e=vn,onError:n=vn,onRetry:r=vn,onComment:i}=t;let s="",o=!0,a,u="",d="";function c(b){const g=o?b.replace(/^\xEF\xBB\xBF/,""):b,[T,_]=Zu(`${s}${g}`);for(const m of T)f(m);s=_,o=!1}function f(b){if(b===""){p();return}if(b.startsWith(":")){i&&i(b.slice(b.startsWith(": ")?2:1));return}const g=b.indexOf(":");if(g!==-1){const T=b.slice(0,g),_=b[g+1]===" "?2:1,m=b.slice(g+_);l(T,m,b);return}l(b,"",b)}function l(b,g,T){switch(b){case"event":d=g;break;case"data":u=`${u}${g}
`;break;case"id":a=g.includes("\0")?void 0:g;break;case"retry":/^\d+$/.test(g)?r(parseInt(g,10)):n(new _i(`Invalid \`retry\` value: "${g}"`,{type:"invalid-retry",value:g,line:T}));break;default:n(new _i(`Unknown field "${b.length>20?`${b.slice(0,20)}`:b}"`,{type:"unknown-field",field:b,value:g,line:T}));break}}function p(){u.length>0&&e({id:a,event:d||void 0,data:u.endsWith(`
`)?u.slice(0,-1):u}),a=void 0,u="",d=""}function y(b={}){s&&b.consume&&f(s),o=!0,a=void 0,u="",d="",s=""}return{feed:c,reset:y}}function Zu(t){const e=[];let n="",r=0;for(;r<t.length;){const i=t.indexOf("\r",r),s=t.indexOf(`
`,r);let o=-1;if(i!==-1&&s!==-1?o=Math.min(i,s):i!==-1?o=i:s!==-1&&(o=s),o===-1){n=t.slice(r);break}else{const a=t.slice(r,o);e.push(a),r=o+1,t[r-1]==="\r"&&t[r]===`
`&&r++}}return[e,n]}class gi extends Event{constructor(e,n){var r,i;super(e),this.code=(r=n==null?void 0:n.code)!=null?r:void 0,this.message=(i=n==null?void 0:n.message)!=null?i:void 0}[Symbol.for("nodejs.util.inspect.custom")](e,n,r){return r(wi(this),n)}[Symbol.for("Deno.customInspect")](e,n){return e(wi(this),n)}}function Xu(t){const e=globalThis.DOMException;return typeof e=="function"?new e(t,"SyntaxError"):new SyntaxError(t)}function Sn(t){return t instanceof Error?"errors"in t&&Array.isArray(t.errors)?t.errors.map(Sn).join(", "):"cause"in t&&t.cause instanceof Error?`${t}: ${Sn(t.cause)}`:t.message:`${t}`}function wi(t){return{type:t.type,message:t.message,code:t.code,defaultPrevented:t.defaultPrevented,cancelable:t.cancelable,timeStamp:t.timeStamp}}var Ti=t=>{throw TypeError(t)},On=(t,e,n)=>e.has(t)||Ti("Cannot "+n),A=(t,e,n)=>(On(t,e,"read from private field"),n?n.call(t):e.get(t)),q=(t,e,n)=>e.has(t)?Ti("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),$=(t,e,n,r)=>(On(t,e,"write to private field"),e.set(t,n),n),ge=(t,e,n)=>(On(t,e,"access private method"),n),te,ke,Ue,kt,jt,st,Le,ot,Te,Fe,Ne,Ke,at,de,En,An,kn,mi,jn,Cn,ut,In,Pn;class Ct extends EventTarget{constructor(e,n){var r,i;super(),q(this,de),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,q(this,te),q(this,ke),q(this,Ue),q(this,kt),q(this,jt),q(this,st),q(this,Le),q(this,ot,null),q(this,Te),q(this,Fe),q(this,Ne,null),q(this,Ke,null),q(this,at,null),q(this,An,async s=>{var o;A(this,Fe).reset();const{body:a,redirected:u,status:d,headers:c}=s;if(d===204){ge(this,de,ut).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(u?$(this,Ue,new URL(s.url)):$(this,Ue,void 0),d!==200){ge(this,de,ut).call(this,`Non-200 status code (${d})`,d);return}if(!(c.get("content-type")||"").startsWith("text/event-stream")){ge(this,de,ut).call(this,'Invalid content type, expected "text/event-stream"',d);return}if(A(this,te)===this.CLOSED)return;$(this,te,this.OPEN);const f=new Event("open");if((o=A(this,at))==null||o.call(this,f),this.dispatchEvent(f),typeof a!="object"||!a||!("getReader"in a)){ge(this,de,ut).call(this,"Invalid response body, expected a web ReadableStream",d),this.close();return}const l=new TextDecoder,p=a.getReader();let y=!0;do{const{done:b,value:g}=await p.read();g&&A(this,Fe).feed(l.decode(g,{stream:!b})),b&&(y=!1,A(this,Fe).reset(),ge(this,de,In).call(this))}while(y)}),q(this,kn,s=>{$(this,Te,void 0),!(s.name==="AbortError"||s.type==="aborted")&&ge(this,de,In).call(this,Sn(s))}),q(this,jn,s=>{typeof s.id=="string"&&$(this,ot,s.id);const o=new MessageEvent(s.event||"message",{data:s.data,origin:A(this,Ue)?A(this,Ue).origin:A(this,ke).origin,lastEventId:s.id||""});A(this,Ke)&&(!s.event||s.event==="message")&&A(this,Ke).call(this,o),this.dispatchEvent(o)}),q(this,Cn,s=>{$(this,st,s)}),q(this,Pn,()=>{$(this,Le,void 0),A(this,te)===this.CONNECTING&&ge(this,de,En).call(this)});try{if(e instanceof URL)$(this,ke,e);else if(typeof e=="string")$(this,ke,new URL(e,ec()));else throw new Error("Invalid URL")}catch{throw Xu("An invalid or illegal string was specified")}$(this,Fe,Ju({onEvent:A(this,jn),onRetry:A(this,Cn)})),$(this,te,this.CONNECTING),$(this,st,3e3),$(this,jt,(r=n==null?void 0:n.fetch)!=null?r:globalThis.fetch),$(this,kt,(i=n==null?void 0:n.withCredentials)!=null?i:!1),ge(this,de,En).call(this)}get readyState(){return A(this,te)}get url(){return A(this,ke).href}get withCredentials(){return A(this,kt)}get onerror(){return A(this,Ne)}set onerror(e){$(this,Ne,e)}get onmessage(){return A(this,Ke)}set onmessage(e){$(this,Ke,e)}get onopen(){return A(this,at)}set onopen(e){$(this,at,e)}addEventListener(e,n,r){const i=n;super.addEventListener(e,i,r)}removeEventListener(e,n,r){const i=n;super.removeEventListener(e,i,r)}close(){A(this,Le)&&clearTimeout(A(this,Le)),A(this,te)!==this.CLOSED&&(A(this,Te)&&A(this,Te).abort(),$(this,te,this.CLOSED),$(this,Te,void 0))}}te=new WeakMap,ke=new WeakMap,Ue=new WeakMap,kt=new WeakMap,jt=new WeakMap,st=new WeakMap,Le=new WeakMap,ot=new WeakMap,Te=new WeakMap,Fe=new WeakMap,Ne=new WeakMap,Ke=new WeakMap,at=new WeakMap,de=new WeakSet,En=function(){$(this,te,this.CONNECTING),$(this,Te,new AbortController),A(this,jt)(A(this,ke),ge(this,de,mi).call(this)).then(A(this,An)).catch(A(this,kn))},An=new WeakMap,kn=new WeakMap,mi=function(){var t;const e={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...A(this,ot)?{"Last-Event-ID":A(this,ot)}:void 0},cache:"no-store",signal:(t=A(this,Te))==null?void 0:t.signal};return"window"in globalThis&&(e.credentials=this.withCredentials?"include":"same-origin"),e},jn=new WeakMap,Cn=new WeakMap,ut=function(t,e){var n;A(this,te)!==this.CLOSED&&$(this,te,this.CLOSED);const r=new gi("error",{code:e,message:t});(n=A(this,Ne))==null||n.call(this,r),this.dispatchEvent(r)},In=function(t,e){var n;if(A(this,te)===this.CLOSED)return;$(this,te,this.CONNECTING);const r=new gi("error",{code:e,message:t});(n=A(this,Ne))==null||n.call(this,r),this.dispatchEvent(r),$(this,Le,setTimeout(A(this,Pn),A(this,st)))},Pn=new WeakMap,Ct.CONNECTING=0,Ct.OPEN=1,Ct.CLOSED=2;function ec(){const t="document"in globalThis?globalThis.document:void 0;return t&&typeof t=="object"&&"baseURI"in t&&typeof t.baseURI=="string"?t.baseURI:void 0}const Mn=class Mn extends bi{};Mn.EventSourceImpl=Ct;let It=Mn;function vi(t){const e={...t,useDateObjects:t.useDateObjects??!1};return new It(e,{"@instantdb/react":yn})}const tc=vi;function nc({as:t="div",spaceId:e,room:n,className:r,style:i,userCursorColor:s,children:o,renderCursor:a,propagate:u,zIndex:d}){const c=e||`cursors-space-default--${String(n.type)}-${n.id}`,f=n.usePresence({keys:[c]}),l=n._core._reactor.getPresence(n.type,n.id);function p(_,m){const O=m.clientX,S=m.clientY,I=(O-_.left)/_.width*100,U=(S-_.top)/_.height*100;f.publishPresence({[c]:{x:O,y:S,xPercent:I,yPercent:U,color:s}})}function y(_){u||_.stopPropagation();const m=_.currentTarget.getBoundingClientRect();p(m,_)}function b(_){f.publishPresence({[c]:void 0})}function g(_){if(_.touches.length!==1)return;const m=_.touches[0];if(m.target instanceof Element){u||_.stopPropagation();const O=m.target.getBoundingClientRect();p(O,m)}}function T(_){f.publishPresence({[c]:void 0})}return C.createElement(t,{onMouseMove:y,onMouseOut:b,onTouchMove:g,onTouchEnd:T,className:r,style:{position:"relative",...i}},[o,Q.jsx("div",{style:{...Si,...ic,zIndex:d!==void 0?d:sc},children:Object.entries(f.peers).map(([_,m])=>{const O=m[c];return O?Q.jsx("div",{style:{...Si,transform:`translate(${O.xPercent}%, ${O.yPercent}%)`,transformOrigin:"0 0",transition:"transform 100ms"},children:a?a({color:O.color,presence:l==null?void 0:l.peers[_]}):Q.jsx(rc,{...O})},_):null})},c)])}function rc({color:t}){const n=t||"black";return Q.jsxs("svg",{style:{height:35,width:35},viewBox:"0 0 35 35",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[Q.jsxs("g",{fill:"rgba(0,0,0,.2)",transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[Q.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),Q.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),Q.jsxs("g",{fill:"white",transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[Q.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),Q.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),Q.jsxs("g",{fill:n,transform:"matrix(1, 0, 0, 1, -11.999999046325684, -8.406899452209473)",children:[Q.jsx("path",{d:"m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z"}),Q.jsx("path",{d:"m13 10.814v11.188l2.969-2.866.428-.139h4.768z"})]})]})}const Si={position:"absolute",top:0,left:0,bottom:0,right:0},ic={overflow:"hidden",pointerEvents:"none",userSelect:"none"},sc=99999;D.Cursors=nc,D.InstantAPIError=et,D.InstantReactAbstractDatabase=bi,D.InstantReactWebDatabase=It,D.i=gu,D.id=V,D.init=vi,D.init_experimental=tc,D.lookup=xo,D.tx=$o,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
