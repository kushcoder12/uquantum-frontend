{"version":3,"file":"framework.js","sourceRoot":"","sources":["../../src/framework.ts"],"names":[],"mappings":"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","sourcesContent":["// The FrameworkClient class is a mini version of a query store that allows making queries on both the frontend and backend\n// you can register queries, await their results and serialize them over a server/client boundary.\n// The class is generic so that it can be a good starting off point to make other ssr adapters.\nimport {\n  coerceQuery,\n  InstantCoreDatabase,\n  InstantDBAttr,\n  weakHash,\n} from './index.ts';\nimport * as s from './store.js';\nimport instaql from './instaql.js';\nimport { RuleParams } from './schemaTypes.ts';\nimport { createLinkIndex } from './utils/linkIndex.ts';\n\nexport const isServer = typeof window === 'undefined' || 'Deno' in globalThis;\n\nexport type FrameworkConfig = {\n  token?: string | null;\n  db: InstantCoreDatabase<any, any>;\n};\n\n// represents an eventual result from running a query\n// either via ssr or by using the existing websocket connection.\ntype QueryPromise =\n  | {\n      type: 'http';\n      triples: any;\n      attrs: any;\n      queryHash: any;\n      query: any;\n      pageInfo?: any;\n    }\n  | {\n      type: 'session';\n      queryResult: any;\n    };\n\nexport class FrameworkClient {\n  private params: FrameworkConfig;\n  private db: InstantCoreDatabase<any, any>;\n\n  // stores all of the query promises so that ssr can read them\n  // and send the relevant results alongside the html that resulted in the query resolving\n  public resultMap: Map<\n    string,\n    {\n      status: 'pending' | 'success' | 'error';\n      type: 'http' | 'session';\n      promise?: Promise<QueryPromise> | null;\n      data?: any;\n      error?: any;\n    }\n  > = new Map();\n\n  private queryResolvedCallbacks: ((result: {\n    triples: any;\n    attrs: any;\n    queryHash: any;\n    query: any;\n    pageInfo?: any;\n  }) => void)[] = [];\n\n  constructor(params: FrameworkConfig) {\n    this.params = params;\n    this.db = params.db;\n    this.resultMap = new Map<\n      string,\n      {\n        type: 'http' | 'session';\n        status: 'pending' | 'success' | 'error';\n        promise?: Promise<QueryPromise>;\n        data?: any;\n        error?: any;\n      }\n    >();\n  }\n\n  public subscribe = (\n    callback: (result: {\n      triples: any;\n      attrs: any;\n      queryHash: string;\n      pageInfo?: any;\n    }) => void,\n  ) => {\n    this.queryResolvedCallbacks.push(callback);\n  };\n\n  // Runs on the client when ssr gets html script tags\n  public addQueryResult = (queryKey: string, value: any) => {\n    this.resultMap.set(queryKey, {\n      type: value.type,\n      status: 'success',\n      data: value,\n      promise: null,\n      error: null,\n    });\n    // send the result to the client\n    if (!isServer) {\n      // make sure the attrs are there to create stores\n      if (!this.db._reactor.attrs) {\n        this.db._reactor._setAttrs(value.attrs);\n      }\n      this.db._reactor._addQueryData(\n        value.query,\n        value,\n        !!this.db._reactor.config.schema,\n      );\n    }\n  };\n\n  // creates an entry in the results map\n  // and returns the same thing added to the map\n  public query = (\n    _query: any,\n    opts?: {\n      ruleParams: RuleParams;\n    },\n  ): {\n    type: 'http' | 'session';\n    status: 'pending' | 'success' | 'error';\n    promise?: Promise<QueryPromise>;\n    data?: any;\n    error?: any;\n  } => {\n    const { hash, query } = this.hashQuery(_query, opts);\n\n    if (this.db._reactor.status === 'authenticated') {\n      const promise = this.db.queryOnce(_query, opts);\n      let entry = {\n        status: 'pending' as 'pending' | 'success' | 'error',\n        type: 'session' as 'http' | 'session',\n        data: undefined as any,\n        error: undefined as any,\n        promise: promise as any,\n      };\n      promise.then((result) => {\n        entry.status = 'success';\n        entry.data = result;\n        entry.promise = null;\n      });\n      promise.catch((error) => {\n        entry.status = 'error';\n        entry.error = error;\n        entry.promise = null;\n      });\n      this.resultMap.set(hash, entry);\n      return entry as any;\n    }\n\n    const promise = this.getTriplesAndAttrsForQuery(query);\n    let entry = {\n      status: 'pending' as 'pending' | 'success' | 'error',\n      type: 'http' as 'http' | 'session',\n      data: undefined as any,\n      error: undefined as any,\n      promise: promise as any,\n    };\n\n    promise.then((result) => {\n      entry.status = 'success';\n      entry.data = result;\n      entry.promise = null;\n    });\n    promise.catch((error) => {\n      entry.status = 'error';\n      entry.error = error;\n      entry.promise = null;\n    });\n\n    promise.then((result) => {\n      this.queryResolvedCallbacks.forEach((callback) => {\n        callback({\n          queryHash: hash,\n          query: query,\n          attrs: result.attrs,\n          triples: result.triples,\n          pageInfo: result.pageInfo,\n        });\n      });\n    });\n\n    this.resultMap.set(hash, entry);\n    return entry;\n  };\n\n  public getExistingResultForQuery = (\n    _query: any,\n    opts?: {\n      ruleParams: RuleParams;\n    },\n  ) => {\n    const { hash } = this.hashQuery(_query, opts);\n    return this.resultMap.get(hash);\n  };\n\n  // creates a query result from a set of triples, query, and attrs\n  // can be run server side or client side\n  public completeIsomorphic = (\n    query: any,\n    triples: any[],\n    attrs: InstantDBAttr[],\n    pageInfo?: any,\n  ) => {\n    const attrMap = {};\n    attrs.forEach((attr) => {\n      attrMap[attr.id] = attr;\n    });\n\n    const enableCardinalityInference =\n      Boolean(this.db?._reactor?.config?.schema) &&\n      ('cardinalityInference' in this.db?._reactor?.config\n        ? Boolean(this.db?._reactor.config?.cardinalityInference)\n        : true);\n\n    const attrsStore = new s.AttrsStoreClass(\n      attrs.reduce((acc, attr) => {\n        acc[attr.id] = attr;\n        return acc;\n      }, {}),\n      createLinkIndex(this.db?._reactor.config.schema),\n    );\n\n    const store = s.createStore(\n      attrsStore,\n      triples,\n      enableCardinalityInference,\n      this.params.db._reactor.config.useDateObjects || false,\n    );\n    const resp = instaql(\n      {\n        store: store,\n        attrsStore: attrsStore,\n        pageInfo: pageInfo,\n        aggregate: undefined,\n      },\n      query,\n    );\n    return resp;\n  };\n\n  public hashQuery = (\n    _query: any,\n    opts?: {\n      ruleParams: RuleParams;\n    },\n  ): { hash: string; query: any } => {\n    if (_query && opts && 'ruleParams' in opts) {\n      _query = { $$ruleParams: opts['ruleParams'], ..._query };\n    }\n    const query = _query ? coerceQuery(_query) : null;\n    return { hash: weakHash(query), query: query };\n  };\n\n  // Run by the server to get triples and attrs\n  public getTriplesAndAttrsForQuery = async (\n    query: any,\n  ): Promise<{\n    triples: any[];\n    attrs: InstantDBAttr[];\n    query: any;\n    queryHash: string;\n    type: 'http';\n    pageInfo?: any;\n  }> => {\n    try {\n      const response = await fetch(\n        `${this.db._reactor.config.apiURI}/runtime/framework/query`,\n        {\n          method: 'POST',\n          headers: {\n            'app-id': this.params.db._reactor.config.appId,\n            'Content-Type': 'application/json',\n            Authorization: this.params.token\n              ? `Bearer ${this.params.token}`\n              : undefined,\n          } as Record<string, string>,\n          body: JSON.stringify({\n            query: query,\n          }),\n        },\n      );\n\n      if (!response.ok) {\n        throw new Error('Error getting triples from server');\n      }\n\n      const data = await response.json();\n\n      const attrs = data?.attrs;\n      if (!attrs) {\n        throw new Error('No attrs');\n      }\n\n      // TODO: make safer\n      const triples =\n        data.result?.[0].data?.['datalog-result']?.['join-rows'][0];\n\n      const pageInfo = data.result?.[0]?.data?.['page-info'];\n\n      return {\n        attrs,\n        triples,\n        type: 'http',\n        queryHash: this.hashQuery(query).hash,\n        query,\n        pageInfo,\n      };\n    } catch (err: any) {\n      const errWithMessage = new Error(\n        'Error getting triples from framework client',\n      );\n      // @ts-expect-error pre es2022\n      errWithMessage.cause = err;\n      throw errWithMessage;\n    }\n  };\n}\n"]}