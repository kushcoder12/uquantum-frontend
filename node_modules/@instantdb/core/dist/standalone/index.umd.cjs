(function(A,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(A=typeof globalThis<"u"?globalThis:A||self,v(A.instant={}))})(this,function(A){"use strict";var Ko=Object.defineProperty;var zo=(A,v,I)=>v in A?Ko(A,v,{enumerable:!0,configurable:!0,writable:!0,value:I}):A[v]=I;var T=(A,v,I)=>zo(A,typeof v!="symbol"?v+"":v,I);function v(n){if(typeof n=="number")return(Math.abs(n*2654435761)>>>0).toString(16);if(typeof n=="boolean")return n?"1":"0";if(n===null)return"null";if(n===void 0)return"undefined";if(typeof n=="string"){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(n)){let e=2166136261;for(let t=0;t<n.length;t++){e^=(t+1)*2654435761;const r=v(n[t]);for(let s=0;s<r.length;s++)e^=r.charCodeAt(s),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof n=="object"){let e=2166136261;const t=Object.keys(n).sort();for(let r=0;r<t.length;r++){const s=t[r],i=v(s);e^=parseInt(i,16),e*=16777619,e=e>>>0;const o=v(n[s]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return v(String(n))}const I={Remove:"remove",Replace:"replace",Add:"add"},vt=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),tr=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),Te=Symbol.iterator,N={mutable:"mutable",immutable:"immutable"},Ue={};function ce(n,e){return n instanceof Map?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function kt(n,e){if(e in n){let t=Reflect.getPrototypeOf(n);for(;t;){const r=Reflect.getOwnPropertyDescriptor(t,e);if(r)return r;t=Reflect.getPrototypeOf(t)}}}function xe(n){return Object.getPrototypeOf(n)===Set.prototype}function Le(n){return Object.getPrototypeOf(n)===Map.prototype}function F(n){var e;return(e=n.copy)!==null&&e!==void 0?e:n.original}function Y(n){return!!O(n)}function O(n){return typeof n!="object"?null:n==null?void 0:n[vt]}function Ne(n){var e;const t=O(n);return t?(e=t.copy)!==null&&e!==void 0?e:t.original:n}function z(n,e){if(!n||typeof n!="object")return!1;let t;return Object.getPrototypeOf(n)===Object.prototype||Array.isArray(n)||n instanceof Map||n instanceof Set||!!(e!=null&&e.mark)&&((t=e.mark(n,N))===N.immutable||typeof t=="function")}function Et(n,e=[]){if(Object.hasOwnProperty.call(n,"key")){const t=n.parent.copy,r=O(B(t,n.key));if(r!==null&&(r==null?void 0:r.original)!==n.original)return null;const s=n.parent.type===3,i=s?Array.from(n.parent.setMap.keys()).indexOf(n.key):n.key;if(!(s&&t.size>i||ce(t,i)))return null;e.push(i)}if(n.parent)return Et(n.parent,e);e.reverse();try{nr(n.copy,e)}catch{return null}return e}function Z(n){return Array.isArray(n)?1:n instanceof Map?2:n instanceof Set?3:0}function B(n,e){return Z(n)===2?n.get(e):n[e]}function ue(n,e,t){Z(n)===2?n.set(e,t):n[e]=t}function Fe(n,e){const t=O(n);return(t?F(t):n)[e]}function G(n,e){return n===e?n!==0||1/n===1/e:n!==n&&e!==e}function qe(n){if(n)for(;n.finalities.revoke.length>0;)n.finalities.revoke.pop()()}function X(n,e){return e?n:[""].concat(n).map(t=>{const r=`${t}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function nr(n,e){for(let t=0;t<e.length-1;t+=1){const r=e[t];if(n=B(Z(n)===3?Array.from(n):n,r),typeof n!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return n}function rr(n){const e=Object.create(Object.getPrototypeOf(n));return Reflect.ownKeys(n).forEach(t=>{let r=Reflect.getOwnPropertyDescriptor(n,t);if(r.enumerable&&r.configurable&&r.writable){e[t]=n[t];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:n[t]}),Reflect.defineProperty(e,t,r)}),e}const sr=Object.prototype.propertyIsEnumerable;function It(n,e){let t;if(Array.isArray(n))return Array.prototype.concat.call(n);if(n instanceof Set){if(!xe(n)){const r=Object.getPrototypeOf(n).constructor;return new r(n.values())}return Set.prototype.difference?Set.prototype.difference.call(n,new Set):new Set(n.values())}else if(n instanceof Map){if(!Le(n)){const r=Object.getPrototypeOf(n).constructor;return new r(n)}return new Map(n)}else if(e!=null&&e.mark&&(t=e.mark(n,N),t!==void 0)&&t!==N.mutable){if(t===N.immutable)return rr(n);if(typeof t=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return t()}throw new Error(`Unsupported mark result: ${t}`)}else if(typeof n=="object"&&Object.getPrototypeOf(n)===Object.prototype){const r={};return Object.keys(n).forEach(s=>{r[s]=n[s]}),Object.getOwnPropertySymbols(n).forEach(s=>{sr.call(n,s)&&(r[s]=n[s])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function D(n){n.copy||(n.copy=It(n.original,n.options))}function le(n){if(!z(n))return Ne(n);if(Array.isArray(n))return n.map(le);if(n instanceof Map){const t=Array.from(n.entries()).map(([r,s])=>[r,le(s)]);if(!Le(n)){const r=Object.getPrototypeOf(n).constructor;return new r(t)}return new Map(t)}if(n instanceof Set){const t=Array.from(n).map(le);if(!xe(n)){const r=Object.getPrototypeOf(n).constructor;return new r(t)}return new Set(t)}const e=Object.create(Object.getPrototypeOf(n));for(const t in n)e[t]=le(n[t]);return e}function me(n){return Y(n)?le(n):n}function W(n){var e;n.assignedMap=(e=n.assignedMap)!==null&&e!==void 0?e:new Map,n.operated||(n.operated=!0,n.parent&&W(n.parent))}function Ct(){throw new Error("Cannot modify frozen object")}function te(n,e,t,r,s){{t=t??new WeakMap,r=r??[],s=s??[];const o=t.has(n)?t.get(n):n;if(r.length>0){const a=r.indexOf(o);if(o&&typeof o=="object"&&a!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${s.slice(0,a).map((c,u)=>{if(typeof c=="symbol")return`[${c.toString()}]`;const l=r[u];return typeof c=="object"&&(l instanceof Map||l instanceof Set)?Array.from(l.keys()).indexOf(c):c}).join("/")}`);r.push(o),s.push(e)}else r.push(o)}if(Object.isFrozen(n)||Y(n)){r.pop(),s.pop();return}switch(Z(n)){case 2:for(const[a,c]of n)te(a,a,t,r,s),te(c,a,t,r,s);n.set=n.clear=n.delete=Ct;break;case 3:for(const a of n)te(a,a,t,r,s);n.add=n.clear=n.delete=Ct;break;case 1:Object.freeze(n);let o=0;for(const a of n)te(a,o,t,r,s),o+=1;break;default:Object.freeze(n),Object.keys(n).forEach(a=>{const c=n[a];te(c,a,t,r,s)})}r.pop(),s.pop()}function Ke(n,e){const t=Z(n);if(t===0)Reflect.ownKeys(n).forEach(r=>{e(r,n[r],n)});else if(t===1){let r=0;for(const s of n)e(r,s,n),r+=1}else n.forEach((r,s)=>e(s,r,n))}function Mt(n,e,t){if(Y(n)||!z(n,t)||e.has(n)||Object.isFrozen(n))return;const r=n instanceof Set,s=r?new Map:void 0;if(e.add(n),Ke(n,(i,o)=>{var a;if(Y(o)){const c=O(o);D(c);const u=!((a=c.assignedMap)===null||a===void 0)&&a.size||c.operated?c.copy:c.original;ue(r?s:n,i,u)}else Mt(o,e,t)}),s){const i=n,o=Array.from(i);i.clear(),o.forEach(a=>{i.add(s.has(a)?s.get(a):a)})}}function ir(n,e){const t=n.type===3?n.setMap:n.copy;n.finalities.revoke.length>1&&n.assignedMap.get(e)&&t&&Mt(B(t,e),n.finalities.handledSet,n.options)}function ze(n){n.type===3&&n.copy&&(n.copy.clear(),n.setMap.forEach(e=>{n.copy.add(Ne(e))}))}function Ve(n,e,t,r){if(n.operated&&n.assignedMap&&n.assignedMap.size>0&&!n.finalized){if(t&&r){const i=Et(n);i&&e(n,i,t,r)}n.finalized=!0}}function Qe(n,e,t,r){const s=O(t);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((i,o)=>{var a;const c=n.type===3?n.setMap:n.copy;if(G(B(c,e),t)){let u=s.original;s.copy&&(u=s.copy),ze(n),Ve(n,r,i,o),n.options.enableAutoFreeze&&(n.options.updatedValues=(a=n.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,n.options.updatedValues.set(u,s.original)),ue(c,e,u)}}),n.options.enableAutoFreeze&&s.finalities!==n.finalities&&(n.options.enableAutoFreeze=!1)),z(t,n.options)&&n.finalities.draft.push(()=>{const i=n.type===3?n.setMap:n.copy;G(B(i,e),t)&&ir(n,e)})}function or(n,e,t,r,s){let{original:i,assignedMap:o,options:a}=n,c=n.copy;c.length<i.length&&([i,c]=[c,i],[t,r]=[r,t]);for(let u=0;u<i.length;u+=1)if(o.get(u.toString())&&c[u]!==i[u]){const l=e.concat([u]),d=X(l,s);t.push({op:I.Replace,path:d,value:me(c[u])}),r.push({op:I.Replace,path:d,value:me(i[u])})}for(let u=i.length;u<c.length;u+=1){const l=e.concat([u]),d=X(l,s);t.push({op:I.Add,path:d,value:me(c[u])})}if(i.length<c.length){const{arrayLengthAssignment:u=!0}=a.enablePatches;if(u){const l=e.concat(["length"]),d=X(l,s);r.push({op:I.Replace,path:d,value:i.length})}else for(let l=c.length;i.length<l;l-=1){const d=e.concat([l-1]),f=X(d,s);r.push({op:I.Remove,path:f})}}}function ar({original:n,copy:e,assignedMap:t},r,s,i,o){t.forEach((a,c)=>{const u=B(n,c),l=me(B(e,c)),d=a?ce(n,c)?I.Replace:I.Add:I.Remove;if(G(u,l)&&d===I.Replace)return;const f=r.concat(c),h=X(f,o);s.push(d===I.Remove?{op:d,path:h}:{op:d,path:h,value:l}),i.push(d===I.Add?{op:I.Remove,path:h}:d===I.Remove?{op:I.Add,path:h,value:u}:{op:I.Replace,path:h,value:u})})}function cr({original:n,copy:e},t,r,s,i){let o=0;n.forEach(a=>{if(!e.has(a)){const c=t.concat([o]),u=X(c,i);r.push({op:I.Remove,path:u,value:a}),s.unshift({op:I.Add,path:u,value:a})}o+=1}),o=0,e.forEach(a=>{if(!n.has(a)){const c=t.concat([o]),u=X(c,i);r.push({op:I.Add,path:u,value:a}),s.unshift({op:I.Remove,path:u,value:a})}o+=1})}function de(n,e,t,r){const{pathAsArray:s=!0}=n.options.enablePatches;switch(n.type){case 0:case 2:return ar(n,e,t,r,s);case 1:return or(n,e,t,r,s);case 3:return cr(n,e,t,r,s)}}const Se=(n,e,t=!1)=>{if(typeof n=="object"&&n!==null&&(!z(n,e)||t))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},We={get size(){return F(O(this)).size},has(n){return F(O(this)).has(n)},set(n,e){const t=O(this),r=F(t);return(!r.has(n)||!G(r.get(n),e))&&(D(t),W(t),t.assignedMap.set(n,!0),t.copy.set(n,e),Qe(t,n,e,de)),this},delete(n){if(!this.has(n))return!1;const e=O(this);return D(e),W(e),e.original.has(n)?e.assignedMap.set(n,!1):e.assignedMap.delete(n),e.copy.delete(n),!0},clear(){const n=O(this);if(this.size){D(n),W(n),n.assignedMap=new Map;for(const[e]of n.original)n.assignedMap.set(e,!1);n.copy.clear()}},forEach(n,e){const t=O(this);F(t).forEach((r,s)=>{n.call(e,this.get(s),s,this)})},get(n){var e,t;const r=O(this),s=F(r).get(n),i=((t=(e=r.options).mark)===null||t===void 0?void 0:t.call(e,s,N))===N.mutable;if(r.options.strict&&Se(s,r.options,i),i||r.finalized||!z(s,r.options)||s!==r.original.get(n))return s;const o=Ue.createDraft({original:s,parentDraft:r,key:n,finalities:r.finalities,options:r.options});return D(r),r.copy.set(n,o),o},keys(){return F(O(this)).keys()},values(){const n=this.keys();return{[Te]:()=>this.values(),next:()=>{const e=n.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const n=this.keys();return{[Te]:()=>this.entries(),next:()=>{const e=n.next();if(e.done)return e;const t=this.get(e.value);return{done:!1,value:[e.value,t]}}}},[Te](){return this.entries()}},ur=Reflect.ownKeys(We),Pt=(n,e,{isValuesIterator:t})=>()=>{var r,s;const i=e.next();if(i.done)return i;const o=i.value;let a=n.setMap.get(o);const c=O(a),u=((s=(r=n.options).mark)===null||s===void 0?void 0:s.call(r,a,N))===N.mutable;if(n.options.strict&&Se(o,n.options,u),!u&&!c&&z(o,n.options)&&!n.finalized&&n.original.has(o)){const l=Ue.createDraft({original:o,parentDraft:n,key:o,finalities:n.finalities,options:n.options});n.setMap.set(o,l),a=l}else c&&(a=c.proxy);return{done:!1,value:t?a:[a,a]}},Ae={get size(){return O(this).setMap.size},has(n){const e=O(this);if(e.setMap.has(n))return!0;D(e);const t=O(n);return!!(t&&e.setMap.has(t.original))},add(n){const e=O(this);return this.has(n)||(D(e),W(e),e.assignedMap.set(n,!0),e.setMap.set(n,n),Qe(e,n,n,de)),this},delete(n){if(!this.has(n))return!1;const e=O(this);D(e),W(e);const t=O(n);return t&&e.setMap.has(t.original)?(e.assignedMap.set(t.original,!1),e.setMap.delete(t.original)):(!t&&e.setMap.has(n)?e.assignedMap.set(n,!1):e.assignedMap.delete(n),e.setMap.delete(n))},clear(){if(!this.size)return;const n=O(this);D(n),W(n);for(const e of n.original)n.assignedMap.set(e,!1);n.setMap.clear()},values(){const n=O(this);D(n);const e=n.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Pt(n,e,{isValuesIterator:!0})}},entries(){const n=O(this);D(n);const e=n.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Pt(n,e,{isValuesIterator:!1})}},keys(){return this.values()},[Te](){return this.values()},forEach(n,e){const t=this.values();let r=t.next();for(;!r.done;)n.call(e,r.value,r.value,this),r=t.next()}};Set.prototype.difference&&Object.assign(Ae,{intersection(n){return Set.prototype.intersection.call(new Set(this.values()),n)},union(n){return Set.prototype.union.call(new Set(this.values()),n)},difference(n){return Set.prototype.difference.call(new Set(this.values()),n)},symmetricDifference(n){return Set.prototype.symmetricDifference.call(new Set(this.values()),n)},isSubsetOf(n){return Set.prototype.isSubsetOf.call(new Set(this.values()),n)},isSupersetOf(n){return Set.prototype.isSupersetOf.call(new Set(this.values()),n)},isDisjointFrom(n){return Set.prototype.isDisjointFrom.call(new Set(this.values()),n)}});const lr=Reflect.ownKeys(Ae),jt=new WeakSet,$t={get(n,e,t){var r,s;const i=(r=n.copy)===null||r===void 0?void 0:r[e];if(i&&jt.has(i))return i;if(e===vt)return n;let o;if(n.options.mark){const u=e==="size"&&(n.original instanceof Map||n.original instanceof Set)?Reflect.get(n.original,e):Reflect.get(n.original,e,t);if(o=n.options.mark(u,N),o===N.mutable)return n.options.strict&&Se(u,n.options,!0),u}const a=F(n);if(a instanceof Map&&ur.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(We,"size").get.call(n.proxy);const u=We[e];if(u)return u.bind(n.proxy)}if(a instanceof Set&&lr.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(Ae,"size").get.call(n.proxy);const u=Ae[e];if(u)return u.bind(n.proxy)}if(!ce(a,e)){const u=kt(a,e);return u?"value"in u?u.value:(s=u.get)===null||s===void 0?void 0:s.call(n.proxy):void 0}const c=a[e];if(n.options.strict&&Se(c,n.options),n.finalized||!z(c,n.options))return c;if(c===Fe(n.original,e)){if(D(n),n.copy[e]=Be({original:n.original[e],parentDraft:n,key:n.type===1?Number(e):e,finalities:n.finalities,options:n.options}),typeof o=="function"){const u=O(n.copy[e]);return D(u),W(u),u.copy}return n.copy[e]}return c},set(n,e,t){var r;if(n.type===3||n.type===2)throw new Error("Map/Set draft does not support any property assignment.");let s;if(n.type===1&&e!=="length"&&!(Number.isInteger(s=Number(e))&&s>=0&&(e===0||s===0||String(s)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const i=kt(F(n),e);if(i!=null&&i.set)return i.set.call(n.proxy,t),!0;const o=Fe(F(n),e),a=O(o);return a&&G(a.original,t)?(n.copy[e]=t,n.assignedMap=(r=n.assignedMap)!==null&&r!==void 0?r:new Map,n.assignedMap.set(e,!1),!0):(G(t,o)&&(t!==void 0||ce(n.original,e))||(D(n),W(n),ce(n.original,e)&&G(t,n.original[e])?n.assignedMap.delete(e):n.assignedMap.set(e,!0),n.copy[e]=t,Qe(n,e,t,de)),!0)},has(n,e){return e in F(n)},ownKeys(n){return Reflect.ownKeys(F(n))},getOwnPropertyDescriptor(n,e){const t=F(n),r=Reflect.getOwnPropertyDescriptor(t,e);return r&&{writable:!0,configurable:n.type!==1||e!=="length",enumerable:r.enumerable,value:t[e]}},getPrototypeOf(n){return Reflect.getPrototypeOf(n.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(n,e){var t;return n.type===1?$t.set.call(this,n,e,void 0,n.proxy):(Fe(n.original,e)!==void 0||e in n.original?(D(n),W(n),n.assignedMap.set(e,!1)):(n.assignedMap=(t=n.assignedMap)!==null&&t!==void 0?t:new Map,n.assignedMap.delete(e)),n.copy&&delete n.copy[e],!0)}};function Be(n){const{original:e,parentDraft:t,key:r,finalities:s,options:i}=n,o=Z(e),a={type:o,finalized:!1,parent:t,original:e,copy:null,proxy:null,finalities:s,options:i,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in n)&&(a.key=r);const{proxy:c,revoke:u}=Proxy.revocable(o===1?Object.assign([],a):a,$t);if(s.revoke.push(u),jt.add(c),a.proxy=c,t){const l=t;l.finalities.draft.push((d,f)=>{var h,p;const b=O(c);let _=l.type===3?l.setMap:l.copy;const g=B(_,r),y=O(g);if(y){let w=y.original;y.operated&&(w=Ne(g)),ze(y),Ve(y,de,d,f),l.options.enableAutoFreeze&&(l.options.updatedValues=(h=l.options.updatedValues)!==null&&h!==void 0?h:new WeakMap,l.options.updatedValues.set(w,y.original)),ue(_,r,w)}(p=b.callbacks)===null||p===void 0||p.forEach(w=>{w(d,f)})})}else{const l=O(c);l.finalities.draft.push((d,f)=>{ze(l),Ve(l,de,d,f)})}return c}Ue.createDraft=Be;function dr(n,e,t,r,s){var i;const o=O(n),a=(i=o==null?void 0:o.original)!==null&&i!==void 0?i:n,c=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(t,r);const u=c?e[0]:o?o.operated?o.copy:o.original:n;return o&&qe(o),s&&te(u,u,o==null?void 0:o.options.updatedValues),[u,t&&c?[{op:I.Replace,path:[],value:e[0]}]:t,r&&c?[{op:I.Replace,path:[],value:a}]:r]}function fr(n,e){var t;const r={draft:[],revoke:[],handledSet:new WeakSet};let s,i;e.enablePatches&&(s=[],i=[]);const a=((t=e.mark)===null||t===void 0?void 0:t.call(e,n,N))===N.mutable||!z(n,e)?n:Be({original:n,parentDraft:null,finalities:r,options:e});return[a,(c=[])=>{const[u,l,d]=dr(a,c,s,i,e.enableAutoFreeze);return e.enablePatches?[u,l,d]:u}]}function Ge(n){const{rootDraft:e,value:t,useRawReturn:r=!1,isRoot:s=!0}=n;Ke(t,(i,o,a)=>{const c=O(o);if(c&&e&&c.finalities===e.finalities){n.isContainDraft=!0;const u=c.original;if(a instanceof Set){const l=Array.from(a);a.clear(),l.forEach(d=>a.add(i===d?u:d))}else ue(a,i,u)}else typeof o=="object"&&o!==null&&(n.value=o,n.isRoot=!1,Ge(n))}),s&&(n.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Dt(n){var e;const t=O(n);if(!z(n,t==null?void 0:t.options))return n;const r=Z(n);if(t&&!t.operated)return t.original;let s;function i(){s=r===2?Le(n)?new Map(n):new(Object.getPrototypeOf(n)).constructor(n):r===3?Array.from(t.setMap.values()):It(n,t==null?void 0:t.options)}if(t){t.finalized=!0;try{i()}finally{t.finalized=!1}}else s=n;if(Ke(s,(o,a)=>{if(t&&G(B(t.original,o),a))return;const c=Dt(a);c!==a&&(s===n&&i(),ue(s,o,c))}),r===3){const o=(e=t==null?void 0:t.original)!==null&&e!==void 0?e:s;return xe(o)?new Set(s):new(Object.getPrototypeOf(o)).constructor(s)}return s}function Rt(n){if(!Y(n))throw new Error(`current() is only used for Draft, parameter: ${n}`);return Dt(n)}const Oe=(n=>function e(t,r,s){var i,o,a;if(typeof t=="function"&&typeof r!="function")return function(m,...E){return e(m,k=>t.call(this,k,...E),r)};const c=t,u=r;let l=s;if(typeof r!="function"&&(l=r),l!==void 0&&Object.prototype.toString.call(l)!=="[object Object]")throw new Error(`Invalid options: ${l}, 'options' should be an object.`);l=Object.assign(Object.assign({},n),l);const d=Y(c)?Rt(c):c,f=Array.isArray(l.mark)?(m,E)=>{for(const k of l.mark){if(typeof k!="function")throw new Error(`Invalid mark: ${k}, 'mark' should be a function.`);const K=k(m,E);if(K)return K}}:l.mark,h=(i=l.enablePatches)!==null&&i!==void 0?i:!1,p=(o=l.strict)!==null&&o!==void 0?o:!1,_={enableAutoFreeze:(a=l.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:f,strict:p,enablePatches:h};if(!z(d,_)&&typeof d=="object"&&d!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[g,y]=fr(d,_);if(typeof r!="function"){if(!z(d,_))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[g,y]}let w;try{w=u(g)}catch(m){throw qe(O(g)),m}const S=m=>{const E=O(g);if(!Y(m)){if(m!==void 0&&!G(m,g)&&(E!=null&&E.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const K=m==null?void 0:m[tr];if(K){const Ot=K[0];return _.strict&&typeof m=="object"&&m!==null&&Ge({rootDraft:E,value:m,useRawReturn:!0}),y([Ot])}if(m!==void 0)return typeof m=="object"&&m!==null&&Ge({rootDraft:E,value:m}),y([m])}if(m===g||m===void 0)return y([]);const k=O(m);if(_===k.options){if(k.operated)throw new Error("Cannot return a modified child draft.");return y([Rt(m)])}return y([m])};return w instanceof Promise?w.then(S,m=>{throw qe(O(g)),m}):S(w)})();Object.prototype.constructor.toString();function Ut(n,e){const t=Object.keys(n),r=Object.keys(e);return t.length===r.length&&Object.keys(n).every(s=>e.hasOwnProperty(s))}function xt(n,e){return Object.keys(n).length===Object.keys(e).length&&Object.keys(n).every(t=>e.hasOwnProperty(t)&&n[t]===e[t])}function ve(n,e){return typeof n!="object"||typeof e!="object"||n===null||e===null?n===e:Ut(n,e)?Object.keys(n).every(t=>ve(n[t],e[t])):!1}function He(n){if(!fe(n))return n;const e={};for(const[t,r]of Object.entries(n))r!==void 0&&(e[t]=r);return e}function Lt(n,e){if(!fe(n)||!fe(e))return e;const t={...n};for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete t[r];continue}const s=fe(n[r])&&fe(e[r]);t[r]=s?Lt(n[r],e[r]):e[r]}return t}function fe(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function hr(n,e,t){if(!n||e.length===0)return;let r=n||{};for(let i=0;i<e.length-1;i++){const o=e[i];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[i+1]=="number"?[]:{}),r=r[o]}const s=e[e.length-1];Array.isArray(r)&&typeof s=="number"?r.splice(s,0,t):r[s]=t}function Nt(n,e,t){if(!n||e.length===0)return;let r=n||{};for(let s=0;s<e.length-1;s++){const i=e[s];(!(i in r)||typeof r[i]!="object")&&(r[i]=typeof e[s+1]=="number"?[]:{}),r=r[i]}r[e[e.length-1]]=t}function Ft(n,e){if(!n||e.length===0)return;const[t,...r]=e;if(t in n){if(r.length===0){Array.isArray(n)?n.splice(t,1):delete n[t];return}Ft(n[t],r),pr(n[t])&&delete n[t]}}function pr(n){return n&&Object.keys(n).length===0}const qt=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,yr={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function br(n){return new Date(n)}function gr(n){return new Date(n+"Z")}const _r=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function wr(n){const e=n.match(_r);if(!e)return null;const[t,r,s,i]=e;return r<=0||s<=0||i<=0?null:r>999?new Date(Date.UTC(r,s-1,i,0,0,0,0)):new Date(Date.UTC(i,r-1,s,0,0,0,0))}function Tr(n){const[e,t]=n.split(" ");return new Date(e+"T"+t+"Z")}function mr(n){const[e,t]=n.split(" ");return new Date(e+"T"+t+"Z")}function Sr(n){return new Date(n)}function Ar(n){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!n.match(e))throw new Error(`Unable to parse \`${n}\` as a date.`);const r=new Date(n+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function Or(n){const e=/^(.+T.+)([+-])(\d{2})$/,t=n.match(e);if(t){const[,r,s,i]=t,o=`${r}${s}${i}:00`;return new Date(o)}return null}function vr(n){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,t=n.match(e);if(t){const[,r,s,i,o,a]=t,c=s.padStart(2,"0"),u=i.padStart(2,"0"),l=`${r}-${c}-${u}T${a}`;return new Date(l)}return null}function kr(n){const[e,t]=n.split(", "),[r,s,i]=e.split("/").map(Number),o=t.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw new Error(`Unable to parse time from: ${n}`);let[,a,c,u,l]=o;return a=Number(a),c=Number(c),u=Number(u),l==="PM"&&a!==12?a+=12:l==="AM"&&a===12&&(a=0),new Date(Date.UTC(i,r-1,s,a,c,u))}function Er(n){switch(n){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function Ir(n){const e=n.match(qt);if(!e)return null;const[t]=e,r=yr[t],s=new Date(n.replace(qt,"Z"));return new Date(s.getTime()-r*1e3)}const Cr=[wr,mr,Ar,kr,Sr,gr,Or,Tr,br,Er,Ir,vr];function Mr(n,e){try{const t=n(e);return t instanceof Date&&!isNaN(t.getTime())?t:null}catch{return null}}function Je(n){for(const e of Cr){const t=Mr(e,n);if(t)return t}return null}function Pr(n){try{const e=JSON.parse(n);return typeof e=="string"?Je(e):null}catch{return null}}function he(n){if(n!==void 0){if(n===null)return null;if(n instanceof Date)return n;if(typeof n=="string"){const e=Je(n)||Pr(n)||Je(n.trim());if(!e)throw new Error(`Unable to parse \`${n}\` as a date.`);return e}else if(typeof n=="number")return new Date(n);throw new Error(`Invalid date value \`${n}\`. Expected a date, number, or string, got type ${typeof n}.`)}}class J{constructor(e,t){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null,this.attrs=e,this.linkIndex=t}resetAttrIndexes(){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null}addAttr(e){this.attrs[e.id]=e,this.resetAttrIndexes()}deleteAttr(e){delete this.attrs[e],this.resetAttrIndexes()}updateAttr(e){const t=this.attrs[e.id];t&&(this.attrs[e.id]={...t,...e},this.resetAttrIndexes())}getAttr(e){return this.attrs[e]}get blobAttrs(){if(this._blobAttrs)return this._blobAttrs;this._blobAttrs=new Map;for(const e of Object.values(this.attrs))if(Ze(e)){const[t,r,s]=e["forward-identity"];U(this.blobAttrs,[r,s],e)}return this._blobAttrs}get primaryKeys(){if(this._primaryKeys)return this._primaryKeys;this._primaryKeys=new Map;for(const e of Object.values(this.attrs))if(e["primary?"]){const[t,r]=e["forward-identity"];U(this._primaryKeys,[r],e)}return this._primaryKeys}get forwardIdents(){if(this._forwardIdents)return this._forwardIdents;this._forwardIdents=new Map;for(const e of Object.values(this.attrs)){const t=e["forward-identity"],[r,s,i]=t;U(this._forwardIdents,[s,i],e)}return this._forwardIdents}get revIdents(){if(this._revIdents)return this._revIdents;this._revIdents=new Map;for(const e of Object.values(this.attrs)){const t=e["reverse-identity"];if(t){const[r,s,i]=t;U(this._revIdents,[s,i],e)}}return this._revIdents}toJSON(){return{attrs:this.attrs,linkIndex:this.linkIndex}}}function jr(n){return n.cardinality==="one"}function Ye(n){return n["value-type"]==="ref"}function Ze(n){return n["value-type"]==="blob"}function ne(n,e){return e.reduce((t,r)=>t&&t.get(r),n)}function V(n,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){n.delete(e[0]);return}const[t,...r]=e;n.has(t)&&V(n.get(t),r)}function U(n,e,t){let r=n;const s=e.length-1;for(let i=0;i<s;i++){const o=e[i];let a=r.get(o);a===void 0&&(a=new Map,r.set(o,a)),r=a}s>-1&&r.set(e[s],t)}function Kt(n,e,t){const r=new Map,s=new Map,i=new Map;for(const o of e){let[a,c,u]=o;const l=n.getAttr(c);if(!l){console.warn("no such attr",c,a);continue}l["checked-data-type"]==="date"&&t&&(u=he(u),o[2]=u),Ye(l)&&U(i,[u,c,a],o),U(r,[a,c,u],o),U(s,[c,a,u],o)}return{eav:r,aev:s,vae:i}}function zt(n){return{triples:x(n.eav,3),cardinalityInference:n.cardinalityInference,useDateObjects:n.useDateObjects,version:1}}function Vt(n,e){return re(n,e.triples,e.cardinalityInference,e.useDateObjects)}function Qt(n,e){if(n)return new J(n.attrs,n.linkIndex);if(e&&"__type"in e)return new J(e.attrs,e.linkIndex)}function $r(n,e){return ne(n.eav,[e])!==void 0}function re(n,e,t,r){const s=Kt(n,e,r);return s.cardinalityInference=t,s.useDateObjects=r,s}function pe(n,e){var s,i;let t;if(Array.isArray(e[0])){const[o,a]=e[0],c=n.aev.get(o);if(!c)return null;t=(s=x(c,2).find(l=>l[2]===a))==null?void 0:s[0]}else t=e[0];if(!t)return null;const r=e[2];if(Array.isArray(r)&&r.length===2&&n.aev.get(r[0])){const[o,a]=r,c=n.aev.get(o);if(!c)return null;const l=(i=x(c,2).find(b=>b[2]===a))==null?void 0:i[0];if(!l)return null;const[d,f,h,...p]=e;return[t,f,l,...p]}else{const[o,...a]=e;return[t,...a]}}function Wt(n,e,t){const r=pe(n,t);if(!r)return;const[s,i,o]=r,a=e.getAttr(i);a&&(V(n.eav,[s,i,o]),V(n.aev,[i,s,o]),Ye(a)&&V(n.vae,[o,i,s]))}let Dr=0;function Bt(n,e,t){const[r,s,i]=t;let o;const a=ne(n.eav,[r,s,i]);return a&&(o=a[3]),o||Date.now()*10+Dr++}function Gt(n,e,t){const r=pe(n,t);if(!r)return;let[s,i,o]=r;const a=e.getAttr(i);if(!a)return;a["checked-data-type"]==="date"&&n.useDateObjects&&(o=he(o));const c=ne(n.eav,[s,i,o]),u=(c==null?void 0:c[3])??Bt(n,a,r),l=[s,i,o,u];jr(a)?(U(n.eav,[s,i],new Map([[o,l]])),U(n.aev,[i,s],new Map([[o,l]]))):(U(n.eav,[s,i,o],l),U(n.aev,[i,s,o],l)),Ye(a)&&U(n.vae,[o,i,s],l)}function Rr(n,e,t){var h;const r=pe(n,t);if(!r)return;const[s,i,o]=r,a=e.getAttr(i);if(!a)return;if(!Ze(a))throw new Error("merge operation is not supported for links");const c=ne(n.eav,[s,i]);if(!c)return;const u=(h=c.values().next())==null?void 0:h.value;if(!u)return;const l=u[2],d=Lt(l,o),f=[s,i,d,Bt(n,a,u)];U(n.eav,[s,i],new Map([[d,f]])),U(n.aev,[i,s],new Map([[d,f]]))}function Xe(n,e,t){var u,l;const[r,s]=t,i=pe(n,[r]);if(!i)return;const[o]=i,a=n.eav.get(o);if(a){for(const d of a.keys()){const f=e.getAttr(d);f&&f["on-delete-reverse"]==="cascade"&&x(a.get(d),1).forEach(([h,p,b])=>{var _;return Xe(n,e,[b,(_=f["reverse-identity"])==null?void 0:_[1]])}),(!s||!f||((u=f["forward-identity"])==null?void 0:u[1])===s)&&(V(n.aev,[d,o]),V(n.eav,[o,d]))}a.size===0&&V(n.eav,[o])}const c=n.vae.get(o)&&x(n.vae.get(o),2);c&&c.forEach(d=>{var _,g,y;const[f,h,p]=d,b=e.getAttr(h);(!s||!b||((_=b["reverse-identity"])==null?void 0:_[1])===s)&&(V(n.eav,[f,h,p]),V(n.aev,[h,f,p]),V(n.vae,[p,h,f])),b&&b["on-delete"]==="cascade"&&((g=b["reverse-identity"])==null?void 0:g[1])===s&&Xe(n,e,[f,(y=b["forward-identity"])==null?void 0:y[1]])}),((l=n.vae.get(o))==null?void 0:l.size)===0&&V(n.vae,[o])}function Ht(n,e,t){const r=Kt(e,t,n.useDateObjects);Object.keys(r).forEach(s=>{n[s]=r[s]})}function Ur(n,[e]){n.addAttr(e)}function Jt(n){return x(n.eav,3)}function xr(n,e,[t]){if(!e.getAttr(t))return;const r=Jt(n).filter(([s,i])=>i!==t);e.deleteAttr(t),Ht(n,e,r)}function Lr(n,e,[t]){e.getAttr(t.id)&&(e.updateAttr(t),Ht(n,e,Jt(n)))}function Nr(n,e,t){const[r,...s]=t;switch(r){case"add-triple":Gt(n,e,s);break;case"deep-merge-triple":Rr(n,e,s);break;case"retract-triple":Wt(n,e,s);break;case"delete-entity":Xe(n,e,s);break;case"add-attr":Ur(e,s);break;case"delete-attr":xr(n,e,s);break;case"update-attr":Lr(n,e,s);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${r}`)}}function x(n,e,t=[]){if(!n||e===0)return t;if(e===1){for(const r of n.values())t.push(r);return t}for(const r of n.values())x(r,e-1,t);return t}function ke(n,e,t){var i;const r=[];if(t!=null&&t.hasOwnProperty("$not")){for(const o of e.keys())t.$not!==o&&r.push(e.get(o));return r}if(t!=null&&t.hasOwnProperty("$isNull")){const{attrId:o,isNull:a,reverse:c}=t.$isNull;if(c)for(const u of e.keys()){const l=n.vae.get(u),d=!l||!l.get(o);(a?d:!d)&&r.push(e.get(u))}else{const u=n.aev.get(o);for(const l of e.keys()){const d=!u||((i=u.get(l))==null?void 0:i.get(null))||!u.get(l);(a?d:!d)&&r.push(e.get(l))}}return r}if(t!=null&&t.$comparator)return x(e,1).filter(t.$op);const s=t.in||t.$in||[t];for(const o of s){const a=e.get(o);a&&r.push(a)}return r}function Fr(n,e,t){let r="";return n!==void 0&&(r+="e"),e!==void 0&&(r+="a"),t!==void 0&&(r+="v"),r}function qr(n,[e,t,r]){var i,o;switch(Fr(e,t,r)){case"e":{const a=n.eav.get(e);return x(a,2)}case"ea":{const a=(i=n.eav.get(e))==null?void 0:i.get(t);return x(a,1)}case"eav":{const a=(o=n.eav.get(e))==null?void 0:o.get(t);return a?ke(n,a,r):[]}case"ev":{const a=n.eav.get(e);if(!a)return[];const c=[];for(const u of a.values())c.push(...ke(n,u,r));return c}case"a":{const a=n.aev.get(t);return x(a,2)}case"av":{const a=n.aev.get(t);if(!a)return[];const c=[];for(const u of a.values())c.push(...ke(n,u,r));return c}case"v":{const a=[];for(const c of n.eav.values())for(const u of c.values())a.push(...ke(n,u,r));return a}default:return x(n.eav,3)}}function Kr(n,e,t){var s;const r={};if(!e)return r;for(const[i,o]of e.entries()){const a=(s=n.eav.get(t))==null?void 0:s.get(o.id),c=x(a,1);for(const u of c)r[i]=u[2]}return r}function P(n,e,t){var r;return(r=n.forwardIdents.get(e))==null?void 0:r.get(t)}function ee(n,e,t){var r;return(r=n.revIdents.get(e))==null?void 0:r.get(t)}function zr(n,e){return n.blobAttrs.get(e)}function Yt(n,e){var r;const t=n.primaryKeys.get(e);return t||((r=n.forwardIdents.get(e))==null?void 0:r.get("id"))}function Vr(n,e,t){const r=pe(n,t);if(!r)return;const[s,i,o]=r;if(e.getAttr(i))return ne(n.eav,[s,i])}function Qr(n,e,t){const r=t.filter(([s,i,o,a,c])=>{if(s!=="add-triple"&&s!=="deep-merge-triple")return!0;const u=c==null?void 0:c.mode;if(u!=="create"&&u!=="update")return!0;let l=!1;const d=e.getAttr(o);if(d){const f=Yt(e,d["forward-identity"][1]);l=!!Vr(n,e,[i,f==null?void 0:f.id,i])}return!(u==="create"&&l||u==="update"&&!l)});return Oe({store:n,attrsStore:e},s=>{r.forEach(i=>{Nr(s.store,s.attrsStore,i)})},{mark:s=>{if(s instanceof J)return"immutable"}})}function Wr(n){return typeof n=="string"&&n.startsWith("?")}function Br(n,e,t){if(t.hasOwnProperty(n)){const r=t[n];return Xt(r,e,t)}return{...t,[n]:e}}function Zt(n,e,t){return n===e?t:null}function Gr(n){switch(typeof n){case"string":return n.startsWith("?")?Br:Zt;default:return Zt}}const Hr=["in","$in","$not","$isNull","$comparator"];function Jr(n){for(const e of Hr)if(n.hasOwnProperty(e))return!0;return!1}function Xt(n,e,t){return t?typeof n=="object"?Jr(n)?t:null:Gr(n)(n,e,t):null}function Yr(n,e,t){return n.reduce((r,s,i)=>{const o=e[i];return Xt(s,o,r)},t)}function Zr(n,e,t){return ts(n,e,t).map(r=>Yr(e,r,t)).filter(r=>r)}function Xr(n,e,t){return e.or?e.or.patterns.flatMap(r=>et(n,r,t)):e.and?e.and.patterns.reduce((r,s)=>et(n,s,r),t):t.flatMap(r=>Zr(n,e,r))}function et(n,e,t=[{}]){return e.reduce((r,s)=>Xr(n,s,r),t)}function tt(n,e){return Array.isArray(e)?e.map(t=>tt(n,t)):Wr(e)?n[e]:e}function es(n,{find:e,where:t}){return et(n,t).map(s=>tt(s,e))}function ts(n,e,t){return qr(n,tt(t,e))}const ns=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function se(n){return typeof n=="string"&&ns.test(n)}const $=[];for(let n=0;n<256;++n)$.push((n+256).toString(16).slice(1));function rs(n,e=0){return($[n[e+0]]+$[n[e+1]]+$[n[e+2]]+$[n[e+3]]+"-"+$[n[e+4]]+$[n[e+5]]+"-"+$[n[e+6]]+$[n[e+7]]+"-"+$[n[e+8]]+$[n[e+9]]+"-"+$[n[e+10]]+$[n[e+11]]+$[n[e+12]]+$[n[e+13]]+$[n[e+14]]+$[n[e+15]]).toLowerCase()}let nt;const ss=new Uint8Array(16);function is(){if(!nt){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");nt=crypto.getRandomValues.bind(crypto)}return nt(ss)}const en={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function os(n,e,t){var s;if(en.randomUUID&&!n)return en.randomUUID();n=n||{};const r=n.random??((s=n.rng)==null?void 0:s.call(n))??is();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,rs(r)}function tn(n){const e=n.replace(/-/g,""),t=[];for(let r=0;r<e.length;r+=2)t.push(parseInt(e.substring(r,r+2),16));return t}function as(n,e){for(let t=0;t<n.length;t++){if(n[t]<e[t])return-1;if(n[t]>e[t])return 1}return 0}function cs(n,e){return as(tn(n),tn(e))}function j(){return os()}function us(n,e){return n.localeCompare(e)}function ls(){let n=us;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{n=Intl.Collator("en-US").compare}catch{}return n}const ds=ls();let fs=0;function ye(n){return Ee(`_${n}`,fs++)}function Ee(n,e){return`?${n}-${e}`}class ie extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function hs(n,e){const t=Yt(n,e);if(!t)throw new ie(`Could not find id attr for ${e}`);return t}function nn(n,e,t,r){return[ps(n,e,t,r)]}function ps(n,e,t,r){return[n(t,r),hs(e,t).id,n(t,r),n("time",r)]}function ys(n,e,t){return n.map(r=>r===e?t:r)}function rn(n,e,t,r,s){const i=P(e,t,s),o=ee(e,t,s),a=i||o;if(!a)throw new ie(`Could not find attr for ${[t,s]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[c,u]=a["forward-identity"],[l,d]=a["reverse-identity"],f=r+1,h=i?[n(u,r),a.id,n(d,f),ye("time")]:[n(u,f),a.id,n(d,r),ye("time")];return[i?d:u,f,h,a,!!i]}function sn(n,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),s=new RegExp(`^${r}$`,n?void 0:"i");return function(o){return typeof o!="string"?!1:s.test(o)}}function bs(n,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const t=n["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:t?function(s){return new Date(s[2])>new Date(e.$gt)}:function(s){return s[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:t?function(s){return new Date(s[2])>=new Date(e.$gte)}:function(s){return s[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:t?function(s){return new Date(s[2])<new Date(e.$lt)}:function(s){return s[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:t?function(s){return new Date(s[2])<=new Date(e.$lte)}:function(s){return s[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=sn(!0,e.$like);return{$comparator:!0,$op:function(i){return r(i[2])}}}if(e.hasOwnProperty("$ilike")){const r=sn(!1,e.$ilike);return{$comparator:!0,$op:function(i){return r(i[2])}}}return e}function gs(n,e,t,r,s,i){const o=P(e,t,s),a=ee(e,t,s),c=o||a;if(!c)throw new ie(`No attr for etype = ${t} label = ${s}`);if(i!=null&&i.hasOwnProperty("$isNull")){const u=P(e,t,"id");if(!u)throw new ie(`No attr for etype = ${t} label = id`);return[n(t,r),u.id,{$isNull:{attrId:c.id,isNull:i.$isNull,reverse:!o}},ye("time")]}return o?[n(t,r),c.id,bs(c,i),ye("time")]:[i,c.id,n(t,r),ye("time")]}function _s(n,e,t,r,s){const[i,o,a]=s.reduce((c,u)=>{const[l,d,f]=c,[h,p,b]=rn(n,e,l,d,u);return[h,p,[...f,b]]},[t,r,[]]);return[i,o,a]}function rt(n,e,t,r,s,i){const o=s.slice(0,s.length-1),a=s[s.length-1],[c,u,l]=_s(n,e,t,r,o),d=gs(n,e,c,u,a,i);return l.concat([d])}function ws(n,e){return e?[e].concat(n):n}function Ts([n,e]){return n==="or"&&Array.isArray(e)}function ms([n,e]){return n==="and"&&Array.isArray(e)}function Ss(n,e,t){return(r,s)=>{const i=n(r,s);return e==i?i:`${i}-${t}`}}function on(n,e,t,r,s,i){const o=n(r,s),a=i.map((c,u)=>{const l=Ss(n,o,u);return cn(l,t,r,s,c)});return{[e]:{patterns:a,joinSym:o}}}function As(n){const e=[];for(let t=1;t<=n.length;t++)e.push(n.slice(0,t));return e}function an(n,e,t,r,s){return As(s).map(i=>rt(n,e,t,r,i,{$isNull:!0}))}function cn(n,e,t,r,s){return Object.entries(s).flatMap(([i,o])=>{if(Ts([i,o]))return on(n,"or",e,t,r,o);if(ms([i,o]))return on(n,"and",e,t,r,o);if(i==="$entityIdStartsWith")return[];const a=i.split(".");if(o!=null&&o.hasOwnProperty("$ne")&&(o={...o,$not:o.$ne},delete o.$ne),o!=null&&o.hasOwnProperty("$not")){const c=rt(n,e,t,r,a,o),u=an(n,e,t,r,a);return[{or:{patterns:[c,...u],joinSym:n(t,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&a.length>1?[{or:{patterns:an(n,e,t,r,a),joinSym:n(t,r)}}]:rt(n,e,t,r,a,o)})}function Os(n,e,t,r){const s=Ee;return r?cn(s,n,e,t,r).concat(nn(s,n,e,t)):nn(s,n,e,t)}function vs(n,e,t){return[n(e,t),n("time",t)]}function ks(n,e,t,r,s,i){const[o,a,c,u,l]=rn(n,e,t,r,s),d=ys(c,n(t,r),i);return[o,a,d,u,l]}function Es(n,e,t,{etype:r,level:s,form:i},o){const a=Object.keys(i).filter(c=>c!=="$");return a.length?Object.entries(o).map(function([u,l]){return a.map(function(h){var b,_,g;const p=!!(e.cardinalityInference&&((g=(_=(b=t.linkIndex)==null?void 0:b[r])==null?void 0:_[h])!=null&&g.isSingular));try{const[y,w,S]=ks(n,t,r,s,h,u),m=ln(e,t,{etype:y,level:w,form:i[h],join:S}),E=p?m[0]:m;return{[h]:E}}catch(y){if(y instanceof ie)return{[h]:p?void 0:[]};throw y}}).reduce(function(h,p){return{...h,...p}},l)}):Object.values(o)}function Is(n,e,t){return t==="string"?ds(n,e):n>e?1:-1}function be(n,e,t,r,s){return e===r||e==null&&r==null?cs(n,t):r==null?1:e==null?-1:Is(e,r,s)}function Ie([n,e],[t,r],s){return be(n,e,t,r,s)}function st(n){return n==null?n:new Date(n).getTime()}function Cs(n,e,t,r){var p;const[s,i,o,a]=n,c=t==="desc"?1:-1;if(((p=e["forward-identity"])==null?void 0:p[2])==="id")return Ie(r,[s,a],null)===c;const[u,l]=r,d=e["checked-data-type"],f=d==="date"?st(l):l,h=d==="date"?st(o):o;return Ie([u,f],[s,h],d)===c}function Ms(n,e){const t=e[1];return n.getAttr(t)}function Ps(n,e,t){const r=Object.keys(t)[0];return P(n,e,r)}function js(n,e,t,r){if(t)return Ms(n,t);if(r)return Ps(n,e,r)}function $s(n,e,t){var s,i;if(!Array.isArray(t.fields))return zr(n,e);const r=new Map;for(const o of t.fields){const a=P(n,e,o),c=(s=a==null?void 0:a["forward-identity"])==null?void 0:s[2];c&&Ze(a)&&r.set(c,a)}if(!r.has("id")){const o=P(n,e,"id"),a=(i=o==null?void 0:o["forward-identity"])==null?void 0:i[2];a&&r.set(a,o)}return r}function Ds(n,e,{etype:t,pageInfo:r,dq:s,form:i}){var p,b;const o=(p=i==null?void 0:i.$)==null?void 0:p.order,a=un(i),c=Rs(i);let u=es(n,s);const l=r==null?void 0:r["start-cursor"],d=js(e,t,l,o);if(d&&((b=d==null?void 0:d["forward-identity"])==null?void 0:b[2])!=="id"){const _=d["checked-data-type"]==="date",g=d.id;u=u.map(([y])=>{var S,m,E,k,K;let w=(K=(k=(E=(m=(S=n.eav.get(y))==null?void 0:S.get(g))==null?void 0:m.values())==null?void 0:E.next())==null?void 0:k.value)==null?void 0:K[2];return _&&(w=st(w)),[y,w]})}u.sort(c==="asc"?function(g,y){return Ie(g,y,d==null?void 0:d["checked-data-type"])}:function(g,y){return Ie(y,g,d==null?void 0:d["checked-data-type"])});let f={};const h=$s(e,t,s);for(const _ of u){const[g]=_;if(f[g]||!a&&l&&d&&Cs(l,d,c,_))continue;const y=Kr(n,h,g);y&&(f[g]=y)}return f}function Rs(n){var t;const e=(t=n.$)==null?void 0:t.order;return e&&e[Object.keys(e)[0]]||"asc"}function un(n){var s,i,o;const e=(s=n.$)==null?void 0:s.offset,t=(i=n.$)==null?void 0:i.before,r=(o=n.$)==null?void 0:o.after;return!e&&!t&&!r}function Us(n,e,{etype:t,level:r,form:s,join:i,pageInfo:o}){var f,h,p,b,_;if(!un(s)&&(!o||!o["start-cursor"]))return[];const a=ws(Os(e,t,r,(f=s.$)==null?void 0:f.where),i),c=vs(Ee,t,r),u=(h=s.$)==null?void 0:h.fields,l=Ds(n,e,{etype:t,pageInfo:o,form:s,dq:{where:a,find:c,fields:u}}),d=((p=s.$)==null?void 0:p.limit)||((b=s.$)==null?void 0:b.first)||((_=s.$)==null?void 0:_.last);if(d!=null){r>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const g=Object.entries(l);return g.length<=d?l:Object.fromEntries(g.slice(0,d))}return l}function xs(n,e,t){try{return Us(n,e,t)}catch(r){if(r instanceof ie)return{};throw r}}function ln(n,e,t){const r=xs(n,e,t);return Es(Ee,n,e,t,r)}function Ls(n){const e={};for(const[t,r]of Object.entries(n))e[t]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function it({store:n,attrsStore:e,pageInfo:t,aggregate:r},s){const o={data:Object.keys(s).reduce(function(c,u){return r!=null&&r[u]||u==="$$ruleParams"||(c[u]=ln(n,e,{etype:u,form:s[u],level:0,pageInfo:t==null?void 0:t[u]})),c},{})};return t&&(o.pageInfo=Ls(t)),r&&(o.aggregate=r),o}function Ns(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Fs=Ns();function ot(n,e,t){const r={__etype:n,__ops:t};return new Proxy(r,{get:(s,i)=>{if(i==="__ops")return t;if(i==="__etype")return n;if(Fs.has(i))return(o,a)=>ot(n,e,[...t,a?[i,n,e,o,a]:[i,n,e,o]])}})}function qs(n,e){return`lookup__${n}__${JSON.stringify(e)}`}function Ce(n){return n.startsWith("lookup__")}function dn(n){const[e,t,...r]=n.split("__");return[t,JSON.parse(r.join("__"))]}function Ks(n){return new Proxy({__etype:n},{get(e,t){if(t==="__etype")return n;const r=t;return Ce(r)?ot(n,dn(r),[]):ot(n,r,[])}})}function at(){return new Proxy({},{get(n,e){return Ks(e)}})}const zs=at();function fn(n){return n.__ops}function Vs(n,e){const{attrIdMap:t,refSwapAttrIds:r}=n,s=[];for(const o of e){const a=t[o];if(a)s.push(a);else if(Array.isArray(o)&&o.length==2&&t[o[0]]){const[c,u]=o;s.push([t[c],u])}else s.push(o)}const[i]=e;if((i==="add-triple"||i==="retract-triple")&&r.has(e[2])){const o=s[1];s[1]=s[3],s[3]=o}return s}function Qs(n){if(Array.isArray(n))return n;const e=Object.entries(n);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function Ws(n,e,t){return t.indexOf(".")!==-1&&!P(n,e,t)}function ct(n){const[e,t,...r]=n.split(".");if(r.length>0||t!=="id")throw new Error(`${n} is not a valid lookup attribute.`);return e}function Bs(n,e,t){if(!Ws(n,e,t))return P(n,e,t);const r=ct(t),s=P(n,e,r)||ee(n,e,r);if(s&&s["value-type"]!=="ref")throw new Error(`${t} does not reference a valid link attribute.`);return s}function ut(n){return typeof n=="string"&&!Ce(n)?null:typeof n=="string"&&Ce(n)?dn(n):Qs(n)}function L(n,e,t){const r=ut(t);if(r===null)return t;const[s,i]=r,o=Bs(n,e,s);if(!o||!o["unique?"])throw new Error(`${s} is not a unique attribute.`);return[o.id,i]}function hn(n,e,t,r){var o;const s=L(n,e,t);return Array.isArray(s)?[["add-triple",s,(o=P(n,e,"id"))==null?void 0:o.id,s]].concat(r):r}function Gs({attrsStore:n},[e,t,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=P(n,e,i),u=ee(n,e,i);return a.map(l=>c?["add-triple",L(n,e,t),c.id,L(n,c["reverse-identity"][1],l)]:["add-triple",L(n,u["forward-identity"][1],l),u==null?void 0:u.id,L(n,e,t)])});return hn(n,e,t,s)}function Hs({attrsStore:n},[e,t,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=P(n,e,i),u=ee(n,e,i);return a.map(l=>c?["retract-triple",L(n,e,t),c.id,L(n,c["reverse-identity"][1],l)]:["retract-triple",L(n,u["forward-identity"][1],l),u.id,L(n,e,t)])});return hn(n,e,t,s)}function Js(n,e,t,r){var s;if(Array.isArray(r)){const[i,o]=r;for(const a of n||[]){const c=a==null?void 0:a.aev.get(i);if(c){for(const[u,l,d]of x(c,2))if(d===o)return!0}}}else for(const i of n||[]){const o=i==null?void 0:i.eav.get(r);if(o){for(const a of o.keys())if(((s=e.getAttr(a))==null?void 0:s["forward-identity"][1])==t)return!0}}return!1}function pn({stores:n,attrsStore:e},[t,r,s,i]){return(i==null?void 0:i.upsert)===!1?{mode:"update"}:(i==null?void 0:i.upsert)===!0?null:Js(n,e,t,r)?{mode:"update"}:null}function Ys(n,e){const{attrsStore:t}=n,[r,s,i,o]=e,a=He(i),c=L(t,r,s);return[["id",c]].concat(Object.entries(a)).map(([l,d])=>{const f=P(t,r,l);return f["checked-data-type"]==="date"&&n.useDateObjects&&(d=he(d)),["add-triple",c,f.id,d,{mode:"create"}]})}function Zs(n,e){const{attrsStore:t}=n,[r,s,i,o]=e,a=He(i),c=L(t,r,s),u=pn(n,[r,c,i,o]);return[["id",c]].concat(Object.entries(a)).map(([d,f])=>{const h=P(t,r,d);return h["checked-data-type"]==="date"&&n.useDateObjects&&(f=he(f)),["add-triple",c,h.id,f,...u?[u]:[]]})}function Xs({attrsStore:n},[e,t]){return[["delete-entity",L(n,e,t),e]]}function ei(n,e){const{attrsStore:t}=n,[r,s,i,o]=e,a=He(i),c=L(t,r,s),u=pn(n,[r,c,i,o]),l=Object.entries(a).map(([f,h])=>{const p=P(t,r,f);return["deep-merge-triple",c,p.id,h,...u?[u]:[]]});return[["add-triple",c,P(t,r,"id").id,c,...u?[u]:[]]].concat(l)}function ti({attrsStore:n},[e,t,r]){return[["rule-params",L(n,e,t),e,r]]}function ni(n){const[e,t,r,s,i]=n;if(!s)return n;const o={...s};return delete o.id,[e,t,r,o,...i?[i]:[]]}function ri(n,e){const[t,...r]=ni(e);switch(t){case"merge":return ei(n,r);case"create":return Ys(n,r);case"update":return Zs(n,r);case"link":return Gs(n,r);case"unlink":return Hs(n,r);case"delete":return Xs(n,r);case"ruleParams":return ti(n,r);default:throw new Error(`unsupported action ${t}`)}}function si(n){switch(n){case"string":case"date":case"boolean":case"number":return n;default:return}}function ii(n,e,t){var a,c;const r=(c=(a=n.entities[e])==null?void 0:a.attrs)==null?void 0:c[t];if(t==="id")return null;if(!r)throw new Error(`${e}.${t} does not exist in your schema`);const{unique:s,indexed:i}=r==null?void 0:r.config,o=si(r==null?void 0:r.valueType);return{"index?":i,"unique?":s,"checked-data-type":o}}function Me(n,e,t,r){const s=n?ii(n,e,t):null,i=j(),a=[j(),e,t];return{id:i,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}function oi(n,e,t){return Object.values(n.links).find(i=>i.forward.on===e&&i.forward.label===t||i.reverse.on===e&&i.reverse.label===t)}function ai(n,e,t){const r=oi(n,e,t);if(!r)throw new Error(`Couldn't find the link ${e}.${t} in your schema`);const{forward:s,reverse:i}=r;return{"forward-identity":[j(),s.on,s.label],"reverse-identity":[j(),i.on,i.label],cardinality:s.has==="one"?"one":"many","unique?":i.has==="one","on-delete":s.onDelete,"on-delete-reverse":i.onDelete}}function yn(n,e,t,r){const s=n?ai(n,e,t):null,i=j(),o=[j(),e,t],a=[j(),t,e];return{id:i,"forward-identity":o,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}const ci=new Set(["create","update","merge","link","unlink"]),ui=new Set(["link","unlink"]),li=new Set(["create","update","merge"]),di=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),lt={"unique?":!0,"index?":!0},fi={...lt,cardinality:"one"};function hi(n){const e=[],[t,r,s,i]=n;if(!di.has(t))return e;const o=ut(s);if(o&&e.push({etype:r,lookupPair:o}),t==="link")for(const[a,c]of Object.entries(i)){const u=Array.isArray(c)?c:[c];for(const l of u){const d=ut(l);d&&e.push({etype:r,lookupPair:d,linkLabel:a})}}return e}function pi({attrsStore:n,schema:e},t){var f,h;const r=new Set,s=[],i=[];function o(p,b){return P(n,p,b)||s.find(_=>_["forward-identity"][1]===p&&_["forward-identity"][2]===b)}function a(p,b){return ee(n,p,b)||s.find(_=>{var g,y;return((g=_["reverse-identity"])==null?void 0:g[1])===p&&((y=_["reverse-identity"])==null?void 0:y[2])===b})}function c(p){s.push(p),i.push(["add-attr",p]),r.add(p.id)}function u(p){p&&"isUnsynced"in p&&p.isUnsynced&&!r.has(p.id)&&(s.push(p),i.push(["add-attr",p]),r.add(p.id))}function l(p,b){return b.indexOf(".")!==-1&&!o(p,b)}function d(p,b){const _=o(p,b),g=a(p,b);u(_),u(g),!_&&!g&&c(yn(e,p,b,fi))}for(const p of t)for(const{etype:b,lookupPair:_,linkLabel:g}of hi(p)){const y=_[0];if(g){d(b,g);const w=o(b,g),S=a(b,g);u(w),u(S);const m=((f=w==null?void 0:w["reverse-identity"])==null?void 0:f[1])||((h=S==null?void 0:S["forward-identity"])==null?void 0:h[1])||g;if(l(m,y))d(m,ct(y));else{const E=o(m,y);E||c(Me(e,m,y,lt)),u(E)}}else if(l(b,y))d(b,ct(y));else{const w=o(b,y);w||c(Me(e,b,y,lt)),u(w)}}for(const p of t){const[b,_,g,y]=p;if(ci.has(b)){const w=o(_,"id");u(w),w||c(Me(e,_,"id",{"unique?":!0}));for(const S of Object.keys(y)){const m=o(_,S);if(u(m),li.has(b)&&(m||c(Me(e,_,S,S==="id"?{"unique?":!0}:null))),ui.has(b)){const E=a(_,S);!m&&!E&&c(yn(e,_,S)),u(E)}}}}if(s.length){const p={...n.attrs};for(const b of s)p[b.id]=b;return[new J(p,n.linkIndex),i]}return[n,i]}function yi(n,e){const r=(Array.isArray(e)?e:[e]).flatMap(c=>fn(c)),[s,i]=pi(n,r),o={...n,attrsStore:s},a=r.flatMap(c=>ri(o,c));return[...i,...a]}function bn(n,e){typeof requestIdleCallback>"u"?n():requestIdleCallback(n,{timeout:e})}const ge="__meta";class gn{constructor(e,t){}}class dt{constructor(e){this._subs=[],this._nextSave=null,this._nextGc=null,this._pendingSaveKeys=new Set,this._loadedKeys=new Set,this._version=0,this._meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0},this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=e.saveThrottleMs??100,this._idleCallbackMaxWaitMs=e.idleCallbackMaxWaitMs??1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}async _initMeta(){var e;this._meta.loadingPromise&&await this._meta.loadingPromise;try{const t=this._persister.getItem(ge);this._meta.loadingPromise=t;const r=await t;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const s=((e=this._meta.value)==null?void 0:e.objects)??{},i=r??{},o=i.objects??{};this._meta.value={...i,objects:{...s,...o}}}catch(t){this._meta.error=t,this._meta.attempts++,this._meta.loadingPromise=null}}async _getMeta(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(await this._meta.loadingPromise,this._meta.value):(this._initMeta(),await this._meta.loadingPromise,this._meta.value)}async _refreshMeta(){return await this._initMeta(),this._meta.value}async _preloadEntries(e){const t=await this.waitForMetaToLoad();if(!t)return;const r=Object.entries(t.objects);r.sort(([s,i],[o,a])=>a.updatedAt-i.updatedAt);for(const[s]of r.slice(0,e))this._loadKey(s)}async _getFromStorage(e){try{const t=await this._persister.getItem(e);return t&&this.parse(e,t)}catch(t){return console.error(`Unable to read from storage for key=${e}`,t),null}}async waitForKeyToLoad(e){return this._loadedKeys.has(e)?this.currentValue[e]:(await(this._loadingKeys[e]||this._loadKey(e)),this.currentValue[e])}async waitForMetaToLoad(){return this._getMeta()}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}async _loadKey(e){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const t=this._getFromStorage(e);this._loadingKeys[e]=t;const r=await t;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const s=this._merge(e,r,this.currentValue[e]);s&&(this.currentValue[e]=s)}this.onKeyLoaded&&this.onKeyLoaded(e)}_writeToStorage(e){const t=[],r=e==null?void 0:e.skipGc;if(this._meta.isLoading){const d=new Promise((f,h)=>{setTimeout(()=>this._enqueuePersist(e?{...e,attempts:(e.attempts||0)+1}:{attempts:1}).then(f).catch(h),10+((e==null?void 0:e.attempts)??0)*1e3)});return t.push(d),Promise.all(t).then(f=>f.reduce((h,p)=>h+p,0))}const s=this._meta.value;if(!s)return Promise.resolve(0);const i=[],o=[];for(const d of this._pendingSaveKeys)d in this.currentValue?o.push(d):(i.push(d),delete s.objects[d]);for(const d of i){const f=this._persister.removeItem(d);t.push(f.then(()=>1)),this._loadedKeys.delete(d),this._pendingSaveKeys.delete(d)}const a=[],c=[[ge,s]],u=s.objects??{};s.objects=u;for(const d of o)if(this._loadedKeys.has(d)){const f=this.serialize(d,this.currentValue[d]);c.push([d,f]);const h=this._objectSize(f),p=u[d]??{createdAt:Date.now(),updatedAt:Date.now(),size:h};p.updatedAt=Date.now(),p.size=h,u[d]=p,this._pendingSaveKeys.delete(d)}else a.push(d);const l=this._persister.multiSet(c);t.push(l.then(()=>1));for(const d of a){const f=this._loadKey(d).then(()=>this._enqueuePersist(e));t.push(f)}return r||this.gc(),Promise.all(t).then(d=>d.reduce((f,h)=>f+h,0))}async flush(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0}async _gc(){if(!this._gcOpts)return;const e=new Set(await this._persister.getAllKeys());e.delete(ge);const t=new Set(Object.keys(this.currentValue));for(const f of Object.keys(this._loadingKeys))t.add(f);for(const f of this._loadedKeys)t.add(f);const r=await this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const s=[],i={gcOpts:this._gcOpts,keys:e,sacredKeys:t,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const f of e)t.has(f)||f in r.objects||(this._log.info("Lost track of key in meta",f),s.push(this._persister.removeItem(f)),i.removed.push(f),i.removedMissingCount++);const o=Date.now();for(const[f,h]of Object.entries(r.objects))!t.has(f)&&h.updatedAt<o-this._gcOpts.maxAgeMs&&(s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedOldCount++);const a=Object.entries(r.objects);a.sort(([f,h],[p,b])=>h.updatedAt-b.updatedAt);const c=a.filter(([f])=>!t.has(f));if(a.length>this._gcOpts.maxEntries)for(const[f]of c.slice(0,a.length-this._gcOpts.maxEntries))s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedThresholdCount++;const u=Object.entries(r.objects);u.sort(([f,h],[p,b])=>h.updatedAt-b.updatedAt);const l=u.filter(([f])=>!t.has(f));let d=u.reduce((f,[h,p])=>f+p.size,0);for(;d>0&&d>this._gcOpts.maxSize&&l.length;){const[[f,h]]=l.splice(0,1);d-=h.size,s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedSizeCount++}for(const f of Object.keys(r.objects))!e.has(f)&&!t.has(f)&&delete r.objects[f];return(i.removed.length||i.metaRemoved.length)&&s.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",i),await Promise.all(s),i}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{bn(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((t,r)=>{if(this._nextSave){t(0);return}this._nextSave=setTimeout(()=>{bn(()=>{this._nextSave=null,this._writeToStorage(e).then(t).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[t,r]=Oe(this.currentValue,e,{enablePatches:!0});for(const s of r){const i=s.path[0];i&&typeof i=="string"&&(this._pendingSaveKeys.add(i),this._loadedKeys.has(i)||this._loadKey(i))}this.currentValue=t,this._enqueuePersist();for(const s of this._subs)s(this.currentValue);return t}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(t=>t!==e)}}}const bi=6,gi=["kv","querySubs","syncSubs"];function _i(n){return function(t){console.error("Error in IndexedDB event",{source:n,event:t})}}async function wi(n){return new Promise(e=>{const t=indexedDB.open(n);t.onerror=r=>{e(null)},t.onsuccess=r=>{const i=r.target.result;e(i)},t.onupgradeneeded=r=>{var i;(i=r.target.transaction)==null||i.abort(),e(null)}})}async function Ti(n,e,t){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const s=new Set;return new Promise((i,o)=>{var l,d,f;const a={};for(const[h,p]of Object.entries(r)){const b=typeof p=="string"?JSON.parse(p):p;if(b.lastAccessed){const g={createdAt:b.lastAccessed,updatedAt:b.lastAccessed,size:((f=(d=(l=b.result)==null?void 0:l.store)==null?void 0:d.triples)==null?void 0:f.length)??0};a[h]=g}const _=t.put(b,h);s.add(_)}const c={objects:a},u=t.put(c,ge);s.add(u);for(const h of s)h.onsuccess=()=>{s.delete(h),s.size===0&&i()},h.onerror=p=>{o(p)}})}async function _n(n,e,t){const r=t.put(e,n);return new Promise((s,i)=>{r.onsuccess=()=>s(),r.onerror=o=>i(o)})}async function mi(n,e){const t=await wi(`instant_${n}_5`);if(!t)return;const r=await new Promise((l,d)=>{const p=t.transaction(["kv"],"readonly").objectStore("kv").openCursor();p.onerror=_=>{d(_)};const b=[];p.onsuccess=()=>{const _=p.result;if(_){const g=_.key,y=_.value;b.push([g,y]),_.continue()}else l(b)},p.onerror=_=>{d(_)}}),s=e.transaction(["kv","querySubs"],"readwrite"),i=s.objectStore("kv"),o=s.objectStore("querySubs"),a=[],c={objects:{}};for(const[l,d]of r)switch(l){case"querySubs":{const f=Ti(l,d,o);a.push(f);break}default:{const f=_n(l,d,i);a.push(f);const h={createdAt:Date.now(),updatedAt:Date.now(),size:0};c.objects[l]=h;break}}const u=_n(ge,c,i);a.push(u),await Promise.all(a),await new Promise((l,d)=>{s.oncomplete=f=>l(f),s.onerror=f=>d(f),s.onabort=f=>d(f)})}const wn=new Map;class ft extends gn{constructor(e,t){super(e,t),this.dbName=`instant_${e}_${bi}`,this._storeName=t,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,t)=>{let r=!1;const s=indexedDB.open(this.dbName,1);s.onerror=i=>{t(i)},s.onsuccess=i=>{const a=i.target.result;if(r){const c=mi(this._appId,a).catch(u=>{_i("Error upgrading store from version 5 to 6.")(u)});wn.set(this.dbName,c),c.then(()=>e(a)).catch(()=>e(a))}else{const c=wn.get(this.dbName);c?c.then(()=>e(a)).catch(()=>e(a)):e(a)}},s.onupgradeneeded=i=>{r=!0,this._upgradeStore(i)}})}_upgradeStore(e){const r=e.target.result;for(const s of gi)r.objectStoreNames.contains(s)||r.createObjectStore(s)}async getItem(e){const t=await this._dbPromise;return new Promise((r,s)=>{const a=t.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{a.result?r(a.result):r(null)}})}async setItem(e,t){const r=await this._dbPromise;return new Promise((s,i)=>{const c=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(t,e);c.onerror=u=>{i(u)},c.onsuccess=u=>{s()}})}async multiSet(e){const t=await this._dbPromise;return new Promise((r,s)=>{const i=t.transaction([this._storeName],"readwrite"),o=i.objectStore(this._storeName),a=new Set;for(const[c,u]of e){const l=o.put(u,c);a.add(l)}for(const c of a)c.onerror=u=>{i.abort(),s(u)},c.onsuccess=u=>{a.delete(c),a.size===0&&r()}})}async removeItem(e){const t=await this._dbPromise;return new Promise((r,s)=>{const a=t.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{r()}})}async getAllKeys(){const e=await this._dbPromise;return new Promise((t,r)=>{const o=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();o.onerror=a=>{r(a)},o.onsuccess=a=>{t(o.result.filter(c=>typeof c=="string"))}})}}class ht{static async getIsOnline(){return navigator.onLine}static listen(e){const t=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",t),addEventListener("offline",r),()=>{removeEventListener("online",t),removeEventListener("offline",r)}}}class oe extends Error{constructor(e,t){super(e),this.hint=t;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,oe),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}class _e extends oe{constructor(e){var s;const t=((s=e.body)==null?void 0:s.message)||`API Error (${e.status})`;super(t,e.body.hint);const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,_e),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}async function Q(n,e){const t=await fetch(n,e),r=await t.json();return t.status===200?Promise.resolve(r):Promise.reject(new _e({status:t.status,body:r}))}function Si({apiURI:n,appId:e,email:t}){return Q(`${n}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:t})})}async function Ai({apiURI:n,appId:e,email:t,code:r,refreshToken:s}){return await Q(`${n}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:t,code:r,...s?{"refresh-token":s}:{}})})}async function Oi({apiURI:n,appId:e,refreshToken:t}){return await Q(`${n}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,"refresh-token":t})})}async function vi({apiURI:n,appId:e}){return await Q(`${n}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e})})}async function Tn({apiURI:n,appId:e,code:t,codeVerifier:r,refreshToken:s}){return await Q(`${n}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,code:t,code_verifier:r,refresh_token:s})})}async function ki({apiURI:n,appId:e,nonce:t,idToken:r,clientName:s,refreshToken:i}){return await Q(`${n}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,nonce:t,id_token:r,client_name:s,refresh_token:i})})}async function Ei({apiURI:n,appId:e,refreshToken:t}){return await Q(`${n}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,refresh_token:t})})}async function Ii({apiURI:n,appId:e,path:t,file:r,refreshToken:s,contentType:i,contentDisposition:o}){const a={app_id:e,path:t,authorization:`Bearer ${s}`,"content-type":i||r.type};return o&&(a["content-disposition"]=o),await Q(`${n}/storage/upload`,{method:"PUT",headers:a,body:r})}async function Ci({apiURI:n,appId:e,path:t,refreshToken:r}){const{data:s}=await Q(`${n}/storage/files?app_id=${e}&filename=${encodeURIComponent(t)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}async function Mi({apiURI:n,appId:e,fileName:t,refreshToken:r,metadata:s={}}){const{data:i}=await Q(`${n}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${r}`},body:JSON.stringify({app_id:e,filename:t})});return i}async function Pi(n,e){return(await fetch(n,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok}async function ji({apiURI:n,appId:e,path:t,refreshToken:r}){const{data:s}=await Q(`${n}/storage/signed-download-url?app_id=${e}&filename=${encodeURIComponent(t)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}let pt=!1,mn=!1,Sn=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(pt=!!window.localStorage.getItem("devBackend"),mn=!!window.localStorage.getItem("__instantLogging"),Sn=!!window.localStorage.getItem("__devtoolLocalDash"));function An(n,e){if(!e)return n;const t={};return e.forEach(r=>{t[r]=n[r]}),t}function $i(n,e,t){const r={peers:{}};if(e&&"user"in e?e.user:!0){const i=An(n.user??{},e==null?void 0:e.keys);r.user={...i,peerId:t}}for(const i of Object.keys(n.peers??{})){const o=(e==null?void 0:e.peers)===void 0,a=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(i));if(o||a){const c=An(n.peers[i],e==null?void 0:e.keys);r.peers[i]={...c,peerId:i}}}return r}function Di(n,e){if(n.isLoading!==e.isLoading||n.error!==e.error||(n.user||e.user)&&(!n.user||!e.user||!xt(n.user,e.user))||!Ut(n.peers,e.peers))return!0;for(const r of Object.keys(n.peers))if(!xt(n.peers[r],e.peers[r]))return!0;return!1}class On{constructor(){T(this,"promise");T(this,"_resolve");T(this,"_reject");this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function vn(n,e=[]){n.forEach(t=>{const{data:r}=t,{"datalog-result":s}=r,{"join-rows":i}=s;for(const o of i)for(const a of o)e.push(a);vn(t["child-nodes"],e)})}function kn(n){const e=[];return vn(n,e),e}function yt(n){return Object.values(n.links).reduce((e,t)=>{var r,s;return e[r=t.forward.on]??(e[r]={}),e[t.forward.on][t.forward.label]={isForward:!0,isSingular:t.forward.has==="one",link:t},e[s=t.reverse.on]??(e[s]={}),e[t.reverse.on][t.reverse.label]={isForward:!1,isSingular:t.reverse.has==="one",link:t},e},{})}const bt="v0.22.96";function Ri(n,e){return{info:n?(...t)=>console.info(...t,e()):()=>{},debug:n?(...t)=>console.debug(...t,e()):()=>{},error:n?(...t)=>console.error(...t,e()):()=>{}}}class R{constructor(e,t,r,s={indexed:!1,unique:!1}){this.valueType=e,this.required=t,this.isIndexed=r,this.config=s,this.metadata={}}clientRequired(){return new R(this.valueType,!1,this.isIndexed,this.config)}optional(){return new R(this.valueType,!1,this.isIndexed,this.config)}unique(){return new R(this.valueType,this.required,this.isIndexed,{...this.config,unique:!0})}indexed(){return new R(this.valueType,this.required,!0,{...this.config,indexed:!0})}}class Pe{constructor(e,t){this.attrs=e,this.links=t}asType(){return new Pe(this.attrs,this.links)}}class je{constructor(e,t,r){this.entities=e,this.links=t,this.rooms=r}withRoomSchema(){return new je(this.entities,this.links,{})}}class C extends Error{constructor(e,t){const r=t?`At path '${t}': ${e}`:e;super(r),this.name="QueryValidationError"}}const En=["where","order","limit","last","first","offset","after","before","fields","aggregate"],Ui=n=>n.valueType||"unknown",In=(n,e,t=!1)=>{if(t||n==null)return!0;switch(e){case"string":return typeof n=="string";case"number":return typeof n=="number"&&!isNaN(n);case"boolean":return typeof n=="boolean";case"date":return n instanceof Date||typeof n=="string"||typeof n=="number";default:return!0}},xi=(n,e,t,r,s,i,o)=>{const a=i.valueType==="json",c=(u,l,d)=>{if(!In(d,l,a))throw new C(`Invalid value for operator '${u}' on attribute '${r}' in entity '${s}'. Expected ${l}, but received: ${typeof d}`,o)};switch(n){case"in":case"$in":if(!Array.isArray(e))throw new C(`Operator '${n}' for attribute '${r}' in entity '${s}' must be an array, but received: ${typeof e}`,o);for(const u of e)c(n,t,u);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":c(n,t,e);break;case"$like":case"$ilike":if(c(n,"string",e),n==="$ilike"&&!i.isIndexed)throw new C(`Operator '${n}' can only be used with indexed attributes, but '${r}' in entity '${s}' is not indexed`,o);break;case"$isNull":c(n,"boolean",e);break;default:throw new C(`Unknown operator '${n}' for attribute '${r}' in entity '${s}'`,o)}},ae=(n,e,t,r,s)=>{const i=Ui(t),o=t.valueType==="json";if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(o)return;const c=n;for(const[u,l]of Object.entries(c))xi(u,l,i,e,r,t,`${s}.${u}`)}else if(!In(n,i,o))throw new C(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${i}, but received: ${typeof n}`,s)},Li=(n,e,t,r,s)=>{const i=n.split(".");if(i.length<2)throw new C(`Invalid dot notation path '${n}'. Must contain at least one dot.`,s);let o=t;for(let l=0;l<i.length-1;l++){const d=i[l],f=r.entities[o];if(!f)throw new C(`Entity '${o}' does not exist in schema while traversing dot notation path '${n}'.`,s);const h=f.links[d];if(!h){const p=Object.keys(f.links);throw new C(`Link '${d}' does not exist on entity '${o}' in dot notation path '${n}'. Available links: ${p.length>0?p.join(", "):"none"}`,s)}o=h.entityName}const a=i[i.length-1],c=r.entities[o];if(!c)throw new C(`Target entity '${o}' does not exist in schema for dot notation path '${n}'.`,s);if(a==="id"){if(typeof e=="string"&&!se(e))throw new C(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${e}`,s);ae(e,n,new R("string",!1,!0),t,s);return}const u=c.attrs[a];if(Object.keys(c.links).includes(a)){if(typeof e=="string"&&!se(e))throw new C(`Invalid value for link '${a}' in entity '${o}'. Expected a UUID, but received: ${e}`,s);ae(e,n,new R("string",!1,!0),t,s);return}if(!u){const l=Object.keys(c.attrs);throw new C(`Attribute '${a}' does not exist on entity '${o}' in dot notation path '${n}'. Available attributes: ${l.length>0?l.join(", ")+", id":"id"}`,s)}ae(e,n,u,t,s)},Cn=(n,e,t,r)=>{for(const[s,i]of Object.entries(n)){if(s==="or"||s==="and"){if(Array.isArray(i))for(const u of i)typeof u=="object"&&u!==null&&Cn(u,e,t,`${r}.${s}[${u}]`);continue}if(s==="id"){ae(i,"id",new R("string",!1,!0),e,`${r}.id`);continue}if(s.includes(".")){Li(s,i,e,t,`${r}.${s}`);continue}const o=t.entities[e];if(!o)continue;const a=o.attrs[s],c=o.links[s];if(!a&&!c){const u=Object.keys(o.attrs),l=Object.keys(o.links);throw new C(`Attribute or link '${s}' does not exist on entity '${e}'. Available attributes: ${u.length>0?u.join(", "):"none"}. Available links: ${l.length>0?l.join(", "):"none"}`,`${r}.${s}`)}if(a)ae(i,s,a,e,`${r}.${s}`);else if(c){if(typeof i=="string"&&!se(i))throw new C(`Invalid value for link '${s}' in entity '${e}'. Expected a UUID, but received: ${i}`,`${r}.${s}`);const u=new R("string",!1,!0);ae(i,s,u,e,`${r}.${s}`)}}},Ni=(n,e,t,r,s=0)=>{for(const o of Object.keys(n))if(!En.includes(o))throw new C(`Invalid query parameter '${o}' in $ object. Valid parameters are: ${En.join(", ")}. Found: ${o}`,r);const i=["offset","before","after","first","last"];for(const o of i)if(n[o]!==void 0&&s>0)throw new C(`'${o}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(n.where&&t){if(typeof n.where!="object"||n.where===null)throw new C(`'where' clause must be an object in entity '${e}', but received: ${typeof n.where}`,r?`${r}.where`:void 0);Cn(n.where,e,t,r?`${r}.where`:"where")}},Mn=(n,e,t,r,s=0)=>{var i;if(!n||typeof n!="object")throw new C(`Query part for entity '${e}' must be an object, but received: ${typeof n}`,r);for(const o of Object.keys(n))if(o!=="$"){if(t&&!(o in t.entities[e].links)){const c=Object.keys(t.entities[e].links);throw new C(`Link '${o}' does not exist on entity '${e}'. Available links: ${c.length>0?c.join(", "):"none"}`,`${r}.${o}`)}const a=n[o];if(typeof a=="object"&&a!==null){const c=(i=t==null?void 0:t.entities[e].links[o])==null?void 0:i.entityName;c&&Mn(a,c,t,`${r}.${o}`,s+1)}}else{const a=n[o];if(typeof a!="object"||a===null)throw new C(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof a}`,`${r}.$`);Ni(a,e,t,`${r}.$`,s)}},gt=(n,e)=>{if(typeof n!="object"||n===null)throw new C(`Query must be an object, but received: ${typeof n}${n===null?" (null)":""}`);if(Array.isArray(n))throw new C(`Query must be an object, but received: ${typeof n}`);const t=n;for(const r of Object.keys(t)){if(Array.isArray(n[r]))throw new C(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new C(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const s=Object.keys(e.entities);throw new C(`Entity '${r}' does not exist in schema. Available entities: ${s.length>0?s.join(", "):"none"}`,r)}Mn(t[r],r,e,r,0)}}},Pn=n=>typeof n!="string"?!1:Ce(n)?!0:se(n);class q extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const jn=n=>n.length>0?n.join(", "):"none",Fi=(n,e)=>new q(`Entity '${n}' does not exist in schema. Available entities: ${jn(e)}`),_t={string:n=>typeof n=="string",number:n=>typeof n=="number"&&!isNaN(n),boolean:n=>typeof n=="boolean",date:n=>n instanceof Date||typeof n=="string"||typeof n=="number",json:()=>!0},qi=(n,e)=>{var t;return n==null?!0:((t=_t[e.valueType])==null?void 0:t.call(_t,n))??!1},$n=(n,e)=>{const t=e.entities[n];if(!t)throw Fi(n,Object.keys(e.entities));return t},wt=(n,e,t)=>{const r=$n(n,t);if(typeof e!="object"||e===null)throw new q(`Arguments for data operation on entity '${n}' must be an object, but received: ${typeof e}`);for(const[s,i]of Object.entries(e)){if(s==="id")continue;const o=r.attrs[s];if(o&&!qi(i,o))throw new q(`Invalid value for attribute '${s}' in entity '${n}'. Expected ${o.valueType}, but received: ${typeof i}`)}},Dn=(n,e,t)=>{const r=$n(n,t);if(typeof e!="object"||e===null)throw new q(`Arguments for link operation on entity '${n}' must be an object, but received: ${typeof e}`);for(const[s,i]of Object.entries(e)){if(!r.links[s]){const a=Object.keys(r.links);throw new q(`Link '${s}' does not exist on entity '${n}'. Available links: ${jn(a)}`)}if(i!=null){if(Array.isArray(i)){for(const a of i)if(!Pn(a))throw new q(`Invalid entity ID in link '${s}' for entity '${n}'. Expected a UUID or a lookup, but received: ${a}`)}else if(!Pn(i))throw new q(`Invalid UUID in link '${s}' for entity '${n}'. Expected a UUID, but received: ${i}`)}}},Ki={create:wt,update:wt,merge:wt,link:Dn,unlink:Dn,delete:()=>{}},zi=(n,e)=>{if(!e)return;const[t,r,s,i]=n;if(!Array.isArray(s)&&!se(s))throw new q(`Invalid id for entity '${r}'. Expected a UUID, but received: ${s}`);if(typeof r!="string")throw new q(`Entity name must be a string, but received: ${typeof r}`);const o=Ki[t];o&&i!==void 0&&o(r,i,e)},Rn=(n,e)=>{const t=Array.isArray(n)?n:[n];for(const r of t){if(!r||typeof r!="object")throw new q(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new q(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const s of r.__ops){if(!Array.isArray(s))throw new q(`Transaction operation must be an array, but received: ${typeof s}`);zi(s,e)}}};let Un=0;class xn{constructor(e){this.type="ws",this.id=`${this.type}_${Un++}`,this.conn=new WebSocket(e),this.conn.onopen=t=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=t=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(t.data.toString())})},this.conn.onclose=t=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=t=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){return this.conn.readyState===(WebSocket.OPEN??1)}isConnecting(){return this.conn.readyState===(WebSocket.CONNECTING??0)}send(e){return this.conn.send(JSON.stringify(e))}}class Vi{constructor(e,t){this.type="sse",this.initParams=null,this.sendQueue=[],this.closeFired=!1,this.sseInitTimeout=void 0,this.id=`${this.type}_${Un++}`,this.url=t,this.ES=e,this.conn=new e(t),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const s=JSON.parse(r.data);if(Array.isArray(s))for(const i of s)this.handleMessage(i);else this.handleMessage(s)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}async postMessages(e){var t,r,s;try{(await fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:(t=this.initParams)==null?void 0:t.machineId,session_id:(r=this.initParams)==null?void 0:r.sessionId,sse_token:(s=this.initParams)==null?void 0:s.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}}async flushQueue(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const t=this.postMessages(e);this.sendPromise=t,t.then(()=>{this.sendPromise=null,this.flushQueue()})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}function Qi(n,e){const t=n.values;if(t){const r=Qt(t.attrsStore,null);if(r){for(const s of t.entities||[])s.store.useDateObjects=e,s.store=Vt(r,s.store);t.attrsStore=r}}return n}function Wi(n,e){var t;if(e.values){const r=[];for(const s of(t=e.values)==null?void 0:t.entities){const i=zt(s.store);r.push({...s,store:i})}return{...e,values:{attrsStore:e.values.attrsStore.toJSON(),entities:r}}}else return e}function Bi(n,e,t){var i,o;const r=(i=e==null?void 0:e.state)==null?void 0:i.txId,s=(o=t==null?void 0:t.state)==null?void 0:o.txId;return r&&(!s||r>s)?e:s&&(!r||s>r)?t:e||t}function Tt(n,e,t){return it({store:e,attrsStore:t,pageInfo:null,aggregate:null},n.query).data[n.table][0]}function Ln(n,e,t,r){var o;const s=(o=P(t,n.table,"id"))==null?void 0:o.id;if(!s)return-1;const i=ne(e.eav,[r,s,r]);return i?i[3]:-1}function Nn(n,e,t){for(const{action:r,triple:s}of t)switch(r){case"added":Gt(n,e,s);break;case"removed":Wt(n,e,s);break}}function Gi(n,e,t){var s,i;const r={};for(const{action:o,triple:a}of t){const[c,u,l]=a,d=(i=(s=e.getAttr(u))==null?void 0:s["forward-identity"])==null?void 0:i[2];if(!d)continue;const f=r[c]??{};r[c]=f;const h=f[d]??{};switch(o){case"added":h.newValue=l;break;case"removed":h.oldValue===void 0&&(h.oldValue=l);break}f[d]=h}for(const[o,a]of Object.entries(r))for(const[c,{oldValue:u,newValue:l}]of Object.entries(a))u===l&&delete a[c];return r}function $e(n,e){return{[n.table]:e.map(t=>t.entity)}}function Hi(n,e){var r;if(n.orderFieldType)return n.orderFieldType;const t=n.orderField==="serverCreatedAt"?"number":(r=P(e(),n.table,n.orderField))==null?void 0:r["checked-data-type"];return n.orderFieldType=t,t}function Ji(n,e,t){const r=e;if(n.orderField==="serverCreatedAt"){t.sort(n.orderDirection==="asc"?function(o,a){return be(o.entity.id,o.serverCreatedAt,a.entity.id,a.serverCreatedAt,r)}:function(o,a){return be(a.entity.id,a.serverCreatedAt,o.entity.id,o.serverCreatedAt,r)});return}const s=n.orderField;t.sort(n.orderDirection==="asc"?function(o,a){return be(o.entity.id,o.entity[s],a.entity.id,a.entity[s],r)}:function(o,a){return be(a.entity.id,a.entity[s],o.entity.id,o.entity[s],r)})}var Fn=(n=>(n.InitialSyncBatch="InitialSyncBatch",n.InitialSyncComplete="InitialSyncComplete",n.LoadFromStorage="LoadFromStorage",n.SyncTransaction="SyncTransaction",n.Error="Error",n))(Fn||{});class Yi{constructor(e,t,r,s,i,o){this.callbacks={},this.idToHash={},this.trySend=e,this.config=r,this.log=s,this.createStore=i,this.getAttrs=o,this.subs=new dt({persister:t,merge:Bi,serialize:Wi,parse:(a,c)=>Qi(c,this.config.useDateObjects),objectSize:a=>{var c;return((c=a.values)==null?void 0:c.entities.length)||0},logger:s,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,t){const r=v(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(t),this.initSubscription(e,r,t),s=>{this.unsubscribe(r,t,s==null?void 0:s.keepSubscription)}}unsubscribe(e,t,r){const s=(this.callbacks[e]||[]).filter(i=>i!==t);if(this.callbacks[e]=s,!s.length){delete this.callbacks[e];const i=this.subs.currentValue[e];i!=null&&i.state&&this.clearSubscriptionData(i.state.subscriptionId,!!r),r||this.subs.updateInPlace(o=>{delete o[e]})}}sendStart(e){this.trySend(j(),{op:"start-sync",q:e})}sendResync(e,t,r){this.idToHash[t.subscriptionId]=e.hash,this.trySend(t.subscriptionId,{op:"resync-table","subscription-id":t.subscriptionId,"tx-id":r,token:t.token})}sendRemove(e,t){this.trySend(j(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":t})}async initSubscription(e,t,r){var u,l,d,f;await this.subs.waitForKeyToLoad(t);const s=this.subs.currentValue[t];if(s&&s.state&&s.state.txId){this.sendResync(s,s.state,s.state.txId),(u=s.values)!=null&&u.entities&&r&&r({type:"LoadFromStorage",data:$e(s,(l=s.values)==null?void 0:l.entities)});return}const i=Object.keys(e)[0],o=((f=(d=e[i])==null?void 0:d.$)==null?void 0:f.order)||{serverCreatedAt:"asc"},[a,c]=Object.entries(o)[0];this.subs.updateInPlace(h=>{h[t]={query:e,hash:t,table:i,orderDirection:c,orderField:a,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)}async flushPending(){for(const e of Object.keys(this.callbacks)){await this.subs.waitForKeyToLoad(e);const t=this.subs.currentValue[e];t?await this.initSubscription(t.query,t.hash):this.log.error("Missing sub for hash in flushPending",e)}}onStartSyncOk(e){const t=e["subscription-id"],r=e.q,s=v(r);this.idToHash[t]=s,this.subs.updateInPlace(i=>{const o=i[s];if(!o)return this.log.error("Missing sub for hash",s,"subscription-id",t,"query",r),i;o.state={subscriptionId:t,token:e.token}})}notifyCbs(e,t){for(const r of this.callbacks[e]||[])r(t)}onSyncLoadBatch(e){const t=e["subscription-id"],r=e["join-rows"],s=this.idToHash[t];if(!s){this.log.error("Missing hash for subscription",e);return}const i=[],o=this.subs.currentValue[s];if(!o){this.log.error("Missing sub for hash",s,e);return}const a=o.values??{entities:[],attrsStore:this.getAttrs()};o.values=a;const c=a.entities;for(const u of r){const l=this.createStore(u),d=Tt(o,l,a.attrsStore);c.push({store:l,entity:d,serverCreatedAt:Ln(o,l,a.attrsStore,d.id)}),i.push(d)}this.subs.updateInPlace(u=>{u[s]=o,u[s].updatedAt=Date.now()}),o.values&&this.notifyCbs(s,{type:"InitialSyncBatch",data:$e(o,o.values.entities),batch:i})}onSyncInitFinish(e){var i;const t=e["subscription-id"],r=this.idToHash[t];if(!r){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const a=o[r];if(!a){this.log.error("Missing sub for hash",r,e);return}const c=a.state;if(!c)return this.log.error("Sub never set init, missing result",a,e),o;c.txId=e["tx-id"],a.updatedAt=Date.now()});const s=this.subs.currentValue[r];s&&this.notifyCbs(r,{type:"InitialSyncComplete",data:$e(s,((i=s.values)==null?void 0:i.entities)||[])})}onSyncUpdateTriples(e){var o;const t=e["subscription-id"],r=this.idToHash[t];if(!r){this.log.error("Missing hash for subscription",e);return}const s=this.subs.currentValue[r];if(!s){this.log.error("Missing sub for hash",r,e);return}const i=s.state;if(!i){this.log.error("Missing state for sub",s,e);return}for(const a of e.txes){if(i.txId&&i.txId>=a["tx-id"])continue;i.txId=a["tx-id"];const c=[],u={};for(const _ of a.changes){const g=u[_.triple[0]]??[];u[_.triple[0]]=g,g.push(_)}const l=s.values??{entities:[],attrsStore:this.getAttrs()},d=l.entities;s.values=l;const f=[];e:for(const[_,g]of Object.entries(u))for(let y=0;y<d.length;y++){const w=d[y];if($r(w.store,_)){Nn(w.store,l.attrsStore,g);const S=Tt(s,w.store,l.attrsStore),m=Gi(w.store,l.attrsStore,g)[_];S?(f.push({oldEntity:w.entity,newEntity:S,changedFields:m||{}}),w.entity=S):c.push(y),delete u[_];continue e}}const h=[];for(const[_,g]of Object.entries(u)){const y=this.createStore([]);Nn(y,l.attrsStore,g);const w=Tt(s,y,l.attrsStore);if(!w){this.log.error("No entity found after applying change",{sub:s,changes:g,store:y});continue}d.push({store:y,entity:w,serverCreatedAt:Ln(s,y,l.attrsStore,w.id)}),h.push(w)}const p=[];for(const _ of c.sort().reverse())p.push(d[_].entity),d.splice(_,1);const b=Hi(s,this.getAttrs);Ji(s,b,d),this.notifyCbs(r,{type:"SyncTransaction",data:$e(s,(o=s.values)==null?void 0:o.entities),added:h,removed:p,updated:f})}this.subs.updateInPlace(a=>{a[r]=s,a[r].updatedAt=Date.now()})}clearSubscriptionData(e,t){const r=this.idToHash[e];if(r){delete this.idToHash[e];const s=this.subs.currentValue[r];if(s.state&&this.sendRemove(s.state,t),t?this.subs.unloadKey(r):this.subs.updateInPlace(i=>{delete i[r]}),s)return s}}onStartSyncError(e){const t=v(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},s=Object.keys(e["original-event"].q)[0];this.notifyCbs(t,{type:"Error",data:{[s]:[]},error:r})}onResyncError(e){const t=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(t,!1);r&&this.initSubscription(r.query,r.hash)}}const H={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},Zi=3e4,Xi=3e4,eo=200,to=1e3*60,no={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},mt="_instant_oauth_redirect",we="currentUser";function ro({transportType:n,appId:e,apiURI:t,wsURI:r,EventSourceImpl:s}){if(!s)return new xn(`${r}?app_id=${e}`);switch(n){case"ws":return new xn(`${r}?app_id=${e}`);case"sse":return new Vi(s,`${t}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+n)}}function so(){return typeof window<"u"||typeof chrome<"u"}const qn={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function io(n,e){var r;const t=typeof n=="string"?JSON.parse(n):n;if((r=t==null?void 0:t.result)!=null&&r.store){const s=Qt(t.result.attrsStore,t.result.store);if(s){const i=t.result.store;t.result.store=Vt(s,{...i,useDateObjects:e}),t.result.attrsStore=s}}return t}function oo(n,e){const{result:t,...r}=e,s=r;if(t){const i={...t,store:zt(t.store),attrsStore:t.attrsStore.toJSON()};s.result=i}return s}function ao(n,e){switch(n){case"pendingMutations":return new Map(typeof e=="string"?JSON.parse(e):e);default:return e}}function co(n,e){switch(n){case"pendingMutations":return[...e.entries()];default:return e}}function uo(n,e,t){const r=e==null?void 0:e.result,s=t==null?void 0:t.result;return r&&!s&&t&&(t.result=r),t||e}function Kn(n){return[...n].sort((e,t)=>{const[r,s]=e,[i,o]=t,a=s.order||0,c=o.order||0;return a==c?r<i?-1:r>i?1:0:a-c})}class lo{constructor(e,t=ft,r=ht,s,i){T(this,"attrs");T(this,"_isOnline",!0);T(this,"_isShutdown",!1);T(this,"status",H.CONNECTING);T(this,"querySubs");T(this,"kv");T(this,"_syncTable");T(this,"queryCbs",{});T(this,"queryOnceDfds",{});T(this,"authCbs",[]);T(this,"attrsCbs",[]);T(this,"mutationErrorCbs",[]);T(this,"connectionStatusCbs",[]);T(this,"config");T(this,"mutationDeferredStore",new Map);T(this,"_reconnectTimeoutId",null);T(this,"_reconnectTimeoutMs",0);T(this,"_transport");T(this,"_transportType","ws");T(this,"_EventSource");T(this,"_wsOk",null);T(this,"_localIdPromises",{});T(this,"_errorMessage",null);T(this,"_oauthCallbackResponse",null);T(this,"_linkIndex",null);T(this,"_broadcastChannel");T(this,"_rooms",{});T(this,"_roomsPendingLeave",{});T(this,"_presence",{});T(this,"_broadcastQueue",[]);T(this,"_broadcastSubs",{});T(this,"_currentUserCached",{isLoading:!0,error:void 0,user:void 0});T(this,"_beforeUnloadCbs",[]);T(this,"_dataForQueryCache",{});T(this,"_log");T(this,"_pendingTxCleanupTimeout");T(this,"_pendingMutationCleanupThreshold");T(this,"_inFlightMutationEventIds",new Set);T(this,"_onMergeKv",(e,t,r)=>{switch(e){case"pendingMutations":{const s=(t==null?void 0:t.entries())??[],i=(r==null?void 0:r.entries())??[],o=new Map([...s,...i]);return(t?this._rewriteMutationsSorted(this.attrs,t):[]).forEach(([c,u])=>{var l;!((l=r==null?void 0:r.pendingMutations)!=null&&l.has(c))&&!u["tx-id"]&&this._sendMutation(c,u)}),o}default:return r||t}});T(this,"getPreviousResult",e=>{var r;const t=v(e);return(r=this.dataForQuery(t))==null?void 0:r.data});T(this,"notifyOne",e=>{var i;const t=this.queryCbs[e]??[],r=(i=this._dataForQueryCache[e])==null?void 0:i.data,s=this.dataForQuery(e);s!=null&&s.data&&(this._dataForQueryCache[e]=s,!ve(s.data,r)&&t.forEach(o=>o.cb(s.data)))});T(this,"notifyOneQueryOnce",e=>{var s;const t=this.queryOnceDfds[e]??[],r=(s=this.dataForQuery(e))==null?void 0:s.data;t.forEach(i=>{this._completeQueryOnce(i.q,e,i.dfd),i.dfd.resolve(r)})});T(this,"notifyQueryError",(e,t)=>{(this.queryCbs[e]||[]).forEach(s=>s.cb({error:t}))});T(this,"pushTx",e=>{this.config.disableValidation||Rn(e,this.config.schema);try{const t=yi({attrsStore:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(r=>{var s;return(s=r==null?void 0:r.result)==null?void 0:s.store}),useDateObjects:this.config.useDateObjects},e);return this.pushOps(t)}catch(t){return this.pushOps([],t)}});T(this,"pushOps",(e,t)=>{const r=j(),s=[...this._pendingMutations().values()],i=Math.max(0,...s.map(c=>c.order||0))+1,o={op:"transact","tx-steps":e,created:Date.now(),error:t,order:i};this._updatePendingMutations(c=>{c.set(r,o)});const a=new On;return this.mutationDeferredStore.set(r,a),this._sendMutation(r,o),this.notifyAll(),a.promise});T(this,"_transportOnOpen",e=>{const t=e.target;if(this._transport!==t){this._log.info("[socket][open]",t.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(H.OPENED),this.getCurrentUser().then(r=>{var s;this._trySend(j(),{op:"init","app-id":this.config.appId,"refresh-token":(s=r.user)==null?void 0:s.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(r=>{this._log.error("[socket][error]",t.id,r)})});T(this,"_transportOnMessage",e=>{const t=e.target,r=e.message;if(this._transport!==t){this._log.info("[socket][message]",t.id,r,"skip; this is no longer the current transport");return}if(!this._wsOk&&t.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(e.message))for(const s of e.message)this._handleReceive(t.id,s);else this._handleReceive(t.id,e.message)});T(this,"_transportOnError",e=>{const t=e.target;if(this._transport!==t){this._log.info("[socket][error]",t.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",t.id,e)});T(this,"_scheduleReconnect",()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)});T(this,"_transportOnClose",e=>{const t=e.target;if(this._transport!==t){this._log.info("[socket][close]",t.id,"skip; this is no longer the current transport");return}this._setStatus(H.CLOSED);for(const r of Object.values(this._rooms))r.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",t.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",t.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()});if(this._EventSource=i,this.config={...no,...e},this.queryCacheLimit=this.config.queryCacheLimit??10,this._pendingTxCleanupTimeout=this.config.pendingTxCleanupTimeout??Xi,this._pendingMutationCleanupThreshold=this.config.pendingMutationCleanupThreshold??eo,this._log=Ri(e.verbose||pt||mn,()=>this._reactorStats()),this.versions={...s||{},"@instantdb/core":bt},this.config.schema&&(this._linkIndex=yt(this.config.schema)),!!so()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!se(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",async o=>{var a;try{if(((a=o.data)==null?void 0:a.type)==="auth"){const c=await this.getCurrentUser();this.updateUser(c.user)}}catch(c){this._log.error("[error] handle broadcast channel",c)}})),this._initStorage(t),this._syncTable=new Yi(this._trySendAuthed.bind(this),new t(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,o=>re(this.ensureAttrs(),o,this.config.enableCardinalityInference,this.config.useDateObjects),()=>this.ensureAttrs()),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser().then(o=>{this.syncUserToEndpoint(o.user)}),setInterval(async()=>{const o=await this.getCurrentUser();this.syncUserToEndpoint(o.user)},to),r.getIsOnline().then(o=>{this._isOnline=o,this._startSocket(),r.listen(a=>{a!==this._isOnline&&(this._log.info("[network] online =",a),this._isOnline=a,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",H.CLOSED),this._setStatus(H.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}ensureAttrs(){if(!this.attrs)throw new Error("attrs have not loaded.");return this.attrs}updateSchema(e){this.config={...this.config,schema:e,cardinalityInference:!!e},this._linkIndex=e?yt(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new dt({persister:new e(this.config.appId,"querySubs"),merge:uo,serialize:oo,parse:(t,r)=>io(r,this.config.useDateObjects),objectSize:t=>{var r,s,i;return((i=(s=(r=t==null?void 0:t.result)==null?void 0:r.store)==null?void 0:s.triples)==null?void 0:i.length)??0},logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=t=>this._onQuerySubLoaded(t),this.kv=new dt({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:co,parse:ao,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=t=>{t==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(we),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,t,r){const s=this.mutationDeferredStore.get(t);this.mutationDeferredStore.delete(t);const i=e!=="error"&&e!=="timeout";if(!s&&!i&&console.error("Mutation failed",{status:e,eventId:t,...r}),!!s)if(i)s.resolve({status:e,eventId:t});else if(r!=null&&r.type){const{status:o,...a}=r;s.reject(new _e({body:a,status:o??0}))}else s.reject(new oe((r==null?void 0:r.message)||"Unknown error",r==null?void 0:r.hint))}_setStatus(e,t){this.status=e,this._errorMessage=t,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var s,i;const t=(i=(s=this._presence[e])==null?void 0:s.result)==null?void 0:i.user,r=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],t&&this._trySetPresence(e,t),r)for(const o of r){const{topic:a,roomType:c,data:u}=o;this._tryBroadcast(e,c,a,u)}}_addQueryData(e,t,r){if(!this.attrs)throw new Error("Attrs in reactor have not been set");const s=v(e),i=this.ensureAttrs(),o=re(this.attrs,t.triples,r,this.config.useDateObjects);this.querySubs.updateInPlace(a=>{a[s]={result:{store:o,attrsStore:i,pageInfo:t.pageInfo,processedTxId:void 0,isExternal:!0},q:e}}),this._cleanupPendingMutationsQueries(),this.notifyOne(s),this.notifyOneQueryOnce(s),this._cleanupPendingMutationsTimeout()}_handleReceive(e,t){var s,i,o,a,c,u;const r=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(qn[t.op]||this._log.info("[receive]",e,t.op,t),t.op){case"init-ok":{this._setStatus(H.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(t.attrs),this._flushPendingMessages(),this._sessionId=t["session-id"];for(const f of Object.keys(this._rooms)){const h=(i=(s=this._presence[f])==null?void 0:s.result)==null?void 0:i.user;this._tryJoinRoom(f,h)}break}case"add-query-exists":{this.notifyOneQueryOnce(v(t.q));break}case"add-query-ok":{const{q:f,result:h}=t,p=v(f);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[p])break;const b=(a=(o=h==null?void 0:h[0])==null?void 0:o.data)==null?void 0:a["page-info"],_=(u=(c=h==null?void 0:h[0])==null?void 0:c.data)==null?void 0:u.aggregate,g=kn(h),y=this.ensureAttrs(),w=re(y,g,r,this.config.useDateObjects);this.querySubs.updateInPlace(S=>{if(!S[p]){this._log.info("Missing value in querySubs",{hash:p,q:f});return}S[p].result={store:w,attrsStore:y,pageInfo:b,aggregate:_,processedTxId:t["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(p),this.notifyOneQueryOnce(p),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(t);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(t);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(t);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(t);break}case"refresh-ok":{const{computations:f,attrs:h}=t,p=t["processed-tx-id"];h&&this._setAttrs(h),this._cleanupPendingMutationsTimeout();const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations(),p);b!==this._pendingMutations()&&this.kv.updateInPlace(y=>{y.pendingMutations=b});const _=Kn(b.entries()),g=f.map(y=>{var Yn,Zn,Xn,er;const w=y["instaql-query"],S=y["instaql-result"],m=v(w),E=kn(S),k=this.ensureAttrs(),K=re(k,E,r,this.config.useDateObjects),{store:Ot,attrsStore:No}=this._applyOptimisticUpdates(K,k,_,p),Fo=(Zn=(Yn=S==null?void 0:S[0])==null?void 0:Yn.data)==null?void 0:Zn["page-info"],qo=(er=(Xn=S==null?void 0:S[0])==null?void 0:Xn.data)==null?void 0:er.aggregate;return{q:w,hash:m,store:Ot,attrsStore:No,pageInfo:Fo,aggregate:qo}});g.forEach(({hash:y,q:w,store:S,attrsStore:m,pageInfo:E,aggregate:k})=>{this.querySubs.updateInPlace(K=>{if(!K[y]){this._log.error("Missing value in querySubs",{hash:y,q:w});return}K[y].result={store:S,attrsStore:m,pageInfo:E,aggregate:k,processedTxId:p}})}),this._cleanupPendingMutationsQueries(),g.forEach(({hash:y})=>{this.notifyOne(y)});break}case"transact-ok":{const{"client-event-id":f,"tx-id":h}=t;this._inFlightMutationEventIds.delete(f);const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations()).get(f);if(!b)break;this._updatePendingMutations(g=>{g.set(f,{...g.get(f),"tx-id":h,confirmed:Date.now()})});const _=[];for(const g of b["tx-steps"])if(g[0]==="add-attr"){const y=g[1];_.push(y)}if(_.length){const g=Object.values(this.ensureAttrs().attrs);this._setAttrs([...g,..._])}this._finishTransaction("synced",f),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const f=t["room-id"];this._trySetRoomConnected(f,!0),this._patchPresencePeers(f,t.edits),this._notifyPresenceSubs(f);break}case"refresh-presence":{const f=t["room-id"];this._trySetRoomConnected(f,!0),this._setPresencePeers(f,t.data),this._notifyPresenceSubs(f);break}case"server-broadcast":{const f=t["room-id"],h=t.topic;this._trySetRoomConnected(f,!0),this._notifyBroadcastSubs(f,h,t);break}case"join-room-ok":{const f=t["room-id"];if(!this._rooms[f]){this._roomsPendingLeave[f]&&(this._tryLeaveRoom(f),delete this._roomsPendingLeave[f]);break}this._trySetRoomConnected(f,!0),this._flushEnqueuedRoomData(f);break}case"leave-room-ok":{const f=t["room-id"];this._trySetRoomConnected(f,!1);break}case"join-room-error":const l=t["room-id"],d=this._rooms[l];d&&(d.error=t.error),this._notifyPresenceSubs(l);break;case"error":this._handleReceiveError(t);break;default:this._log.info("Uknown op",t.op,t);break}}_pendingMutations(){return this.kv.currentValue.pendingMutations??new Map}_updatePendingMutations(e){this.kv.updateInPlace(t=>{const r=t.pendingMutations??new Map;t.pendingMutations=r,e(r)})}_handleMutationError(e,t,r){const s=this._pendingMutations().get(t);if(s&&(e!=="timeout"||!s["tx-id"])){this._updatePendingMutations(o=>(o.delete(t),o)),this._inFlightMutationEventIds.delete(t);const i={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(i),this._finishTransaction(e,t,r)}}_handleReceiveError(e){var a,c,u,l,d,f,h;console.log("error",e);const t=e["client-event-id"];this._inFlightMutationEventIds.delete(t);const r=this._pendingMutations().get(t),s={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(s.hint=e.hint),r){this._handleMutationError("error",t,e);return}if((a=e["original-event"])!=null&&a.hasOwnProperty("q")&&((c=e["original-event"])==null?void 0:c.op)==="add-query"){const p=(u=e["original-event"])==null?void 0:u.q,b=v(p);this.notifyQueryError(v(p),s),this.notifyQueryOnceError(p,b,t,s);return}if(((l=e["original-event"])==null?void 0:l.op)==="init"){if(e.type==="record-not-found"&&((d=e.hint)==null?void 0:d["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(H.ERRORED,s),this.notifyAll();return}if(((f=e["original-event"])==null?void 0:f.op)==="resync-table"){this._syncTable.onResyncError(e);return}if(((h=e["original-event"])==null?void 0:h.op)==="start-sync"){this._syncTable.onStartSyncError(e);return}const o={...e};delete o.message,delete o.hint,console.error(e.message,o),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,t,r,s){var o;const i=(o=this.queryOnceDfds[t])==null?void 0:o.find(a=>a.eventId===r);i&&(i.dfd.reject(s),this._completeQueryOnce(e,t,i.dfd))}_setAttrs(e){this.attrs=new J(e.reduce((t,r)=>(t[r.id]=r,t),{}),this._linkIndex),this.notifyAttrsSubs()}_startQuerySub(e,t){const r=j();return this.querySubs.updateInPlace(s=>{s[t]=s[t]||{q:e,result:null,eventId:r},s[t].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,t){return this._syncTable.subscribe(e,t)}subscribeQuery(e,t,r){this.config.disableValidation||gt(e,this.config.schema),r&&"ruleParams"in r&&(e={$$ruleParams:r.ruleParams,...e});const s=v(e),i=this.getPreviousResult(e);return i&&t(i),this.queryCbs[s]=this.queryCbs[s]??[],this.queryCbs[s].push({q:e,cb:t}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,t)}}queryOnce(e,t){this.config.disableValidation||gt(e,this.config.schema),t&&"ruleParams"in t&&(e={$$ruleParams:t.ruleParams,...e});const r=new On;if(!this._isOnline)return r.reject(new Error("We can't run `queryOnce`, because the device is offline.")),r.promise;if(!this.querySubs)return r.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),r.promise;const s=v(e),i=this._startQuerySub(e,s);return this.queryOnceDfds[s]=this.queryOnceDfds[s]??[],this.queryOnceDfds[s].push({q:e,dfd:r,eventId:i}),setTimeout(()=>r.reject(new Error("Query timed out")),Zi),r.promise}_completeQueryOnce(e,t,r){this.queryOnceDfds[t]&&(this.queryOnceDfds[t]=this.queryOnceDfds[t].filter(s=>s.dfd!==r),this._cleanupQuery(e,t))}_unsubQuery(e,t,r){this.queryCbs[t]&&(this.queryCbs[t]=this.queryCbs[t].filter(s=>s.cb!==r),this._cleanupQuery(e,t))}_hasQueryListeners(e){var t,r;return!!((t=this.queryCbs[e])!=null&&t.length||(r=this.queryOnceDfds[e])!=null&&r.length)}_cleanupQuery(e,t){this._hasQueryListeners(t)||(delete this.queryCbs[t],delete this.queryOnceDfds[t],delete this._dataForQueryCache[t],this.querySubs.unloadKey(t),this._trySendAuthed(j(),{op:"remove-query",q:e}))}_rewriteMutations(e,t,r){if(!e)return t;if(!t)return new Map;const s=l=>{const[d,f,h]=l["forward-identity"];return P(e,f,h)},i=l=>{const[d,f,h]=l["forward-identity"];return ee(e,f,h)},o={attrIdMap:{},refSwapAttrIds:new Set};let a=!1;const c=(l,d)=>{const f=[];for(const h of l){const[p]=h;if(p==="add-attr"){const[_,g]=h,y=s(g);if(y&&g.id!==y.id){o.attrIdMap[g.id]=y.id,a=!0;continue}if(g["value-type"]==="ref"){const w=i(g);if(w){o.attrIdMap[g.id]=w.id,o.refSwapAttrIds.add(g.id),a=!0;continue}}}if(r&&d&&r>=d&&p==="add-attr"||p==="update-attr"||p==="delete-attr"){a=!0;continue}const b=a?Vs(o,h):h;f.push(b)}return a?f:l},u=new Map;for(const[l,d]of t.entries())u.set(l,{...d,"tx-steps":c(d["tx-steps"],d["tx-id"])});return a?u:t}_rewriteMutationsSorted(e,t){return Kn(this._rewriteMutations(e,t).entries())}optimisticAttrs(){var i,o;const e=[...this._pendingMutations().values()].flatMap(a=>a["tx-steps"]),t=new Set(e.filter(([a,c])=>a==="delete-attr").map(([a,c])=>c)),r=[];for(const[a,c]of e)if(a==="add-attr")r.push(c);else if(a==="update-attr"&&c.id&&((i=this.attrs)!=null&&i.getAttr(c.id))){const u={...this.attrs.getAttr(c.id),...c};r.push(u)}if(!t.size&&!r.length)return this.attrs||new J({},this._linkIndex);const s={...((o=this.attrs)==null?void 0:o.attrs)||{}};for(const a of r)s[a.id]=a;for(const a of t)delete s[a];return new J(s,this._linkIndex)}dataForQuery(e,t=!0){const r=this._errorMessage;if(r)return{error:r};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const s=this.querySubs.version(),i=this.querySubs.currentValue,o=this.kv.version(),a=this._pendingMutations(),{q:c,result:u}=i[e]||{};if(!u)return;const l=this._dataForQueryCache[e];if(l&&s===l.querySubVersion&&o===l.pendingMutationsVersion)return l;let d=u.store,f=u.attrsStore;const{pageInfo:h,aggregate:p,processedTxId:b}=u,_=this._rewriteMutationsSorted(f,a);if(t){const y=this._applyOptimisticUpdates(d,f,_,b);d=y.store,f=y.attrsStore}return{data:it({store:d,attrsStore:f,pageInfo:h,aggregate:p},c),querySubVersion:s,pendingMutationsVersion:o}}_applyOptimisticUpdates(e,t,r,s){for(const[i,o]of r)if(!o["tx-id"]||s&&o["tx-id"]>s){const a=Qr(e,t,o["tx-steps"]);e=a.store,t=a.attrsStore}return{store:e,attrsStore:t}}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}shutdown(){var e;this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,(e=this._transport)==null||e.close()}_sendMutation(e,t){if(t.error){this._handleMutationError("error",e,{message:t.error.message});return}if(this.status!==H.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,t),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(s=>this.querySubs.currentValue[s]).filter(s=>s).forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),this._rewriteMutationsSorted(this.ensureAttrs(),this._pendingMutations()).forEach(([s,i])=>{i["tx-id"]||this._sendMutation(s,i)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:t}of Object.values(this.querySubs.currentValue))t!=null&&t.processedTxId&&(e=Math.min(e,t==null?void 0:t.processedTxId));this._updatePendingMutations(t=>{for(const[r,s]of Array.from(t.entries()))s["tx-id"]&&s["tx-id"]<=e&&t.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(t=>{for(const[r,s]of Array.from(t.entries()))s.confirmed&&s.confirmed+this._pendingTxCleanupTimeout<e&&t.delete(r)})}_trySendAuthed(...e){this.status===H.AUTHENTICATED&&this._trySend(...e)}_trySend(e,t,r){if(this._transport.isOpen()){switch(qn[t.op]||this._log.info("[send]",this._transport.id,t.op,t),t.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send({"client-event-id":e,...t})}}_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=ro({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e!=null&&e.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}async getLocalId(e){const t=`localToken_${e}`;if(this.kv.currentValue[t])return this.kv.currentValue[t];const r=await this.kv.waitForKeyToLoad(t);if(r)return r;const s=j();return this.kv.updateInPlace(i=>{i[t]||(i[t]=s)}),await this.kv.waitForKeyToLoad(t)}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(mt)){const t=e.toString();e.searchParams.delete(mt),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let s=!1;const i=o=>{var a;s||(s=!0,navigation.removeEventListener("navigate",i),!o.userInitiated&&o.navigationType==="replace"&&((a=o.destination)==null?void 0:a.url)===t&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",i)}}}async _oauthLoginInit(){var s,i,o,a;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const e=new URLSearchParams(window.location.search);if(!e.get(mt))return null;const t=e.get("error");if(t)return this._replaceUrlAfterOAuth(),{error:{message:t}};const r=e.get("code");if(!r)return null;this._replaceUrlAfterOAuth();try{const c=await this._getCurrentUser(),u=(c==null?void 0:c.type)==="guest",{user:l}=await Tn({apiURI:this.config.apiURI,appId:this.config.appId,code:r,refreshToken:u?c.refresh_token:void 0});return this.setCurrentUser(l),null}catch(c){return((s=c==null?void 0:c.body)==null?void 0:s.type)==="record-not-found"&&((o=(i=c==null?void 0:c.body)==null?void 0:i.hint)==null?void 0:o["record-type"])==="app-oauth-code"&&await this._hasCurrentUser()?null:{error:{message:((a=c==null?void 0:c.body)==null?void 0:a.message)||"Error logging in."}}}}async _waitForOAuthCallbackResponse(){return await this._oauthCallbackResponse}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(t=>t!==e)}}subscribeAuth(e){this.authCbs.push(e);const t=this._currentUserCached;t.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(s=>{r||ve(s,t)||e(s)}),()=>{r=!0,this.authCbs=this.authCbs.filter(s=>s!==e)}}async getAuth(){const{user:e,error:t}=await this.getCurrentUser();if(t)throw new oe("Could not get current user: "+t.message);return e}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(t=>t!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(t=>t!==e)}}notifyAuthSubs(e){this.authCbs.forEach(t=>t(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(t=>t(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(t=>t(e.attrs))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(t=>t(e))}async setCurrentUser(e){this.kv.updateInPlace(t=>{t[we]=e}),await this.kv.waitForKeyToLoad(we)}getCurrentUserCached(){return this._currentUserCached}async _getCurrentUser(){const e=await this.kv.waitForKeyToLoad(we);return typeof e=="string"?JSON.parse(e):e}async getCurrentUser(){const e=await this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const t={error:e.error,user:void 0};return this._currentUserCached={isLoading:!1,...t},t}try{const r={user:await this._getCurrentUser(),error:void 0};return this._currentUserCached={isLoading:!1,...r},r}catch(t){return{user:void 0,isLoading:!1,error:{message:(t==null?void 0:t.message)||"Error loading user"}}}}async _hasCurrentUser(){const e=await this.kv.waitForKeyToLoad(we);return typeof e=="string"?JSON.parse(e)!=null:e!=null}async changeCurrentUser(e){var r;const{user:t}=await this.getCurrentUser();if(!ve(t,e)){await this.setCurrentUser(e),this.updateUser(e);try{(r=this._broadcastChannel)==null||r.postMessage({type:"auth"})}catch(s){console.error("Error posting message to broadcast channel",s)}}}async syncUserToEndpoint(e){if(this.config.firstPartyPath)try{fetch(this.config.firstPartyPath+"/",{method:"POST",body:JSON.stringify({type:"sync-user",appId:this.config.appId,user:e}),headers:{"Content-Type":"application/json"}})}catch(t){this._log.error("Error syncing user with external endpoint",t)}}updateUser(e){this.syncUserToEndpoint(e);const t={error:void 0,user:e};this._currentUserCached={isLoading:!1,...t},this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(s=>{delete r[s].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(t)}sendMagicCode({email:e}){return Si({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}async signInWithMagicCode({email:e,code:t}){var o;const r=await this.getCurrentUser(),s=((o=r==null?void 0:r.user)==null?void 0:o.type)==="guest",i=await Ai({apiURI:this.config.apiURI,appId:this.config.appId,email:e,code:t,refreshToken:s?r.user.refresh_token:void 0});return await this.changeCurrentUser(i.user),i}async signInWithCustomToken(e){const t=await Oi({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return await this.changeCurrentUser(t.user),t}async signInAsGuest(){const e=await vi({apiURI:this.config.apiURI,appId:this.config.appId});return await this.changeCurrentUser(e.user),e}potentiallyInvalidateToken(e,t){var i;const r=(i=e==null?void 0:e.user)==null?void 0:i.refresh_token;if(!r)return;if(t.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}Ei({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:r}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}async signOut(e){const t=await this.getCurrentUser();this.potentiallyInvalidateToken(t,e),await this.changeCurrentUser(null)}createAuthorizationURL({clientName:e,redirectURL:t}){const{apiURI:r,appId:s}=this.config;return`${r}/runtime/oauth/start?app_id=${s}&client_name=${e}&redirect_uri=${t}`}async exchangeCodeForToken({code:e,codeVerifier:t}){var o;const r=await this.getCurrentUser(),s=((o=r==null?void 0:r.user)==null?void 0:o.type)==="guest",i=await Tn({apiURI:this.config.apiURI,appId:this.config.appId,code:e,codeVerifier:t,refreshToken:s?r.user.refresh_token:void 0});return await this.changeCurrentUser(i.user),i}issuerURI(){const{apiURI:e,appId:t}=this.config;return`${e}/runtime/${t}`}async signInWithIdToken({idToken:e,clientName:t,nonce:r}){var a;const s=await this.getCurrentUser(),i=(a=s==null?void 0:s.user)==null?void 0:a.refresh_token,o=await ki({apiURI:this.config.apiURI,appId:this.config.appId,idToken:e,clientName:t,nonce:r,refreshToken:i});return await this.changeCurrentUser(o.user),o}joinRoom(e,t){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const s=this._presence[e].result;return t&&!s&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=t,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,t),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var t,r,s;if(!((r=(t=this._presence[e])==null?void 0:t.handlers)!=null&&r.length)&&!Object.keys(this._broadcastSubs[e]??{}).length){const i=(s=this._rooms[e])==null?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],i?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,t,r={}){const s=this._rooms[t],i=this._presence[t];return!s||!i||!i.result?null:{...$i(i.result,r,this._sessionId),isLoading:!s.isConnected,error:s.error}}publishPresence(e,t,r){const s=this._rooms[t],i=this._presence[t];if(!s||!i)return;i.result=i.result||{};const o={...i.result.user,...r};i.result.user=o,s.isConnected&&(this._trySetPresence(t,o),this._notifyPresenceSubs(t))}_trySetPresence(e,t){this._trySendAuthed(j(),{op:"set-presence","room-id":e,data:t})}_tryJoinRoom(e,t){this._trySendAuthed(j(),{op:"join-room","room-id":e,data:t}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(j(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,t){const r=this._rooms[e];r&&(r.isConnected=t)}subscribePresence(e,t,r,s){const i=this.joinRoom(t,r.initialPresence||r.initialData),o={...r,roomId:t,cb:s,prev:null};return this._presence[t]=this._presence[t]||{},this._presence[t].handlers=this._presence[t].handlers||[],this._presence[t].handlers.push(o),this._notifyPresenceSub(t,o),()=>{var a,c;this._presence[t].handlers=((c=(a=this._presence[t])==null?void 0:a.handlers)==null?void 0:c.filter(u=>u!==o))??[],i()}}_notifyPresenceSubs(e){var t,r;(r=(t=this._presence[e])==null?void 0:t.handlers)==null||r.forEach(s=>{this._notifyPresenceSub(e,s)})}_notifyPresenceSub(e,t){const r=this.getPresence("",e,t);r&&(t.prev&&!Di(r,t.prev)||(t.prev=r,t.cb(r)))}_patchPresencePeers(e,t){var o,a,c;const r=((a=(o=this._presence[e])==null?void 0:o.result)==null?void 0:a.peers)||{};let s=Object.fromEntries(Object.entries(r).map(([u,l])=>[u,{data:l}]));(c=this._presence[e])==null||c.result;const i=Oe(s,u=>{for(let[l,d,f]of t)switch(d){case"+":hr(u,l,f);break;case"r":Nt(u,l,f);break;case"-":Ft(u,l);break}delete u[this._sessionId]});this._setPresencePeers(e,i)}_setPresencePeers(e,t){const r={...t};delete r[this._sessionId];const s=Object.fromEntries(Object.entries(r).map(([i,o])=>[i,o.data]));this._presence=Oe(this._presence,i=>{Nt(i,[e,"result","peers"],s)})}publishTopic({roomType:e,roomId:t,topic:r,data:s}){const i=this._rooms[t];if(i){if(!i.isConnected){this._broadcastQueue[t]=this._broadcastQueue[t]??[],this._broadcastQueue[t].push({topic:r,roomType:e,data:s});return}this._tryBroadcast(t,e,r,s)}}_tryBroadcast(e,t,r,s){this._trySendAuthed(j(),{op:"client-broadcast","room-id":e,roomType:t,topic:r,data:s})}subscribeTopic(e,t,r){const s=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][t]=this._broadcastSubs[e][t]||[],this._broadcastSubs[e][t].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][t]=this._broadcastSubs[e][t].filter(i=>i!==r),this._broadcastSubs[e][t].length||delete this._broadcastSubs[e][t],s()}}_notifyBroadcastSubs(e,t,r){var s,i,o;(o=(i=(s=this._broadcastSubs)==null?void 0:s[e])==null?void 0:i[t])==null||o.forEach(a=>{var l,d,f,h,p,b;const c=(l=r.data)==null?void 0:l.data,u=r.data["peer-id"]===this._sessionId?(f=(d=this._presence[e])==null?void 0:d.result)==null?void 0:f.user:(b=(p=(h=this._presence[e])==null?void 0:h.result)==null?void 0:p.peers)==null?void 0:b[r.data["peer-id"]];return a(c,u)})}async uploadFile(e,t,r){var o;const s=await this.getCurrentUser(),i=(o=s==null?void 0:s.user)==null?void 0:o.refresh_token;return Ii({...r,apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:t,refreshToken:i})}async deleteFile(e){var i;const t=await this.getCurrentUser(),r=(i=t==null?void 0:t.user)==null?void 0:i.refresh_token;return await Ci({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}async upload(e,t){var c;const r=await this.getCurrentUser(),s=(c=r==null?void 0:r.user)==null?void 0:c.refresh_token,i=e||t.name,o=await Mi({apiURI:this.config.apiURI,appId:this.config.appId,fileName:i,refreshToken:s});return await Pi(o,t)}async getDownloadUrl(e){var i;const t=await this.getCurrentUser(),r=(i=t==null?void 0:t.user)==null?void 0:i.refresh_token;return await ji({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}}function fo(n,e){return new je(zn(n,e),e,void 0)}function ho(n){return new Pe(n,{})}function po(){return new R("string",!0,!1)}function yo(){return new R("number",!0,!1)}function bo(){return new R("boolean",!0,!1)}function go(){return new R("date",!0,!1)}function _o(){return new R("json",!0,!1)}function wo(){return new R("json",!0,!1)}function zn(n,e){var s,i,o,a;const t={fwd:{},rev:{}};for(const c of Object.values(e))(s=t.fwd)[i=c.forward.on]||(s[i]={}),(o=t.rev)[a=c.reverse.on]||(o[a]={}),t.fwd[c.forward.on][c.forward.label]={entityName:c.reverse.on,cardinality:c.forward.has},t.rev[c.reverse.on][c.reverse.label]={entityName:c.forward.on,cardinality:c.reverse.has};return Object.fromEntries(Object.entries(n).map(([c,u])=>[c,new Pe(u.attrs,{...t.fwd[c],...t.rev[c]})]))}function To({entities:n,links:e,rooms:t}){const r=e??{},s=t??{};return new je(zn(n,r),r,s)}const M={graph:fo,schema:To,entity:ho,string:po,number:yo,boolean:bo,date:go,json:_o,any:wo};let De;function mo(n,e){De==null||De.dispose();const t=Eo(e),r=Oo(e,a),s=Ao(So(n));function i(l){var d;l.source===s.element.contentWindow&&((d=l.data)==null?void 0:d.type)==="close"&&t.isVisible()&&a()}function o(l){const d=l.shiftKey&&l.ctrlKey&&l.key==="0",f=l.key==="Escape"||l.key==="Esc";(d||f&&t.isVisible())&&a()}function a(){t.isVisible()?t.element.style.display="none":(t.element.style.display="block",t.element.contains(s.element)||t.element.appendChild(s.element))}function c(){t.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",i)}function u(){document.body.appendChild(t.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",i),De={dispose:c}}return u()}function So(n){return`${pt||Sn?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${n}`}function Ao(n){const e=document.createElement("iframe");return e.src=n,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function Oo(n,e){const t=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=t,r.className="instant-devtool-toggler",Object.assign(r.style,{position:"fixed",...vo(n.position),height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"}),r.addEventListener("click",e),{element:r}}function vo(n){switch(n){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function ko(n){switch(n){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function Eo(n){const e=document.createElement("div");Object.assign(e.style,{position:"fixed",...ko(n.position),display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"}),e.style.display="none",e.className="instant-devtool-container";function t(){return e.style.display!=="none"}return{element:e,isVisible:t}}function Io(n,e){return e&&e.refresh_token?new Response(JSON.stringify({ok:!0}),{headers:{"Content-Type":"application/json","Set-Cookie":`instant_user_${n.appId}=${JSON.stringify(e)}; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=604800`}}):new Response(JSON.stringify({ok:!0}),{headers:{"Content-Type":"application/json","Set-Cookie":`instant_user_${n.appId}=; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=-1`}})}function Re(n,e){return new Response(JSON.stringify({ok:!1,error:e}),{status:n,headers:{"Content-Type":"application/json"}})}const Co=n=>({POST:async e=>{let t;try{t=await e.json()}catch{return Re(400,"Invalid JSON body")}if(!t.type)return Re(400,'Missing "type" field');if(t.appId!==n.appId)return Re(403,"App ID mismatch");switch(t.type){case"sync-user":return Io(n,t.user??null);default:return Re(400,`Unknown type: ${t.type}`)}}}),Mo=n=>{var i,o,a,c,u,l;const e={};for(const[d,f]of Object.entries(n.entities)){const h=f,p={};for(const[b,_]of Object.entries(h.attrs)){const g=_;let y;switch(g.valueType){case"string":y=M.string();break;case"number":y=M.number();break;case"boolean":y=M.boolean();break;case"date":y=M.date();break;case"json":y=M.json();break;default:y=M.json()}g.required||(y=y.optional()),(i=g.config)!=null&&i.indexed&&(y=y.indexed()),(o=g.config)!=null&&o.unique&&(y=y.unique()),p[b]=y}e[d]=M.entity(p)}const t=n.links||{},r={};if(n.rooms)for(const[d,f]of Object.entries(n.rooms)){const h=f,p={};for(const[_,g]of Object.entries(h.presence.attrs)){const y=g;let w;switch(y.valueType){case"string":w=M.string();break;case"number":w=M.number();break;case"boolean":w=M.boolean();break;case"date":w=M.date();break;case"json":w=M.json();break;default:w=M.json()}y.required||(w=w.optional()),(a=y.config)!=null&&a.indexed&&(w=w.indexed()),(c=y.config)!=null&&c.unique&&(w=w.unique()),p[_]=w}const b={};if(h.topics)for(const[_,g]of Object.entries(h.topics)){const y=g,w={};for(const[S,m]of Object.entries(y.attrs)){const E=m;let k;switch(E.valueType){case"string":k=M.string();break;case"number":k=M.number();break;case"boolean":k=M.boolean();break;case"date":k=M.date();break;case"json":k=M.json();break;default:k=M.json()}E.required||(k=k.optional()),(u=E.config)!=null&&u.indexed&&(k=k.indexed()),(l=E.config)!=null&&l.unique&&(k=k.unique()),w[S]=k}b[_]=M.entity(w)}r[d]={presence:M.entity(p),topics:b}}return M.schema({entities:e,links:t,rooms:r})},Po=typeof window>"u"||"Deno"in globalThis;class jo{constructor(e){this.resultMap=new Map,this.queryResolvedCallbacks=[],this.subscribe=t=>{this.queryResolvedCallbacks.push(t)},this.addQueryResult=(t,r)=>{this.resultMap.set(t,{type:r.type,status:"success",data:r,promise:null,error:null}),Po||(this.db._reactor.attrs||this.db._reactor._setAttrs(r.attrs),this.db._reactor._addQueryData(r.query,r,!!this.db._reactor.config.schema))},this.query=(t,r)=>{const{hash:s,query:i}=this.hashQuery(t,r);if(this.db._reactor.status==="authenticated"){const c=this.db.queryOnce(t,r);let u={status:"pending",type:"session",data:void 0,error:void 0,promise:c};return c.then(l=>{u.status="success",u.data=l,u.promise=null}),c.catch(l=>{u.status="error",u.error=l,u.promise=null}),this.resultMap.set(s,u),u}const o=this.getTriplesAndAttrsForQuery(i);let a={status:"pending",type:"http",data:void 0,error:void 0,promise:o};return o.then(c=>{a.status="success",a.data=c,a.promise=null}),o.catch(c=>{a.status="error",a.error=c,a.promise=null}),o.then(c=>{this.queryResolvedCallbacks.forEach(u=>{u({queryHash:s,query:i,attrs:c.attrs,triples:c.triples,pageInfo:c.pageInfo})})}),this.resultMap.set(s,a),a},this.getExistingResultForQuery=(t,r)=>{const{hash:s}=this.hashQuery(t,r);return this.resultMap.get(s)},this.completeIsomorphic=(t,r,s,i)=>{var d,f,h,p,b,_,g,y;const o={};s.forEach(w=>{o[w.id]=w});const a=!!((h=(f=(d=this.db)==null?void 0:d._reactor)==null?void 0:f.config)!=null&&h.schema)&&("cardinalityInference"in((b=(p=this.db)==null?void 0:p._reactor)==null?void 0:b.config)?!!((g=(_=this.db)==null?void 0:_._reactor.config)!=null&&g.cardinalityInference):!0),c=new J(s.reduce((w,S)=>(w[S.id]=S,w),{}),yt((y=this.db)==null?void 0:y._reactor.config.schema)),u=re(c,r,a,this.params.db._reactor.config.useDateObjects||!1);return it({store:u,attrsStore:c,pageInfo:i,aggregate:void 0},t)},this.hashQuery=(t,r)=>{t&&r&&"ruleParams"in r&&(t={$$ruleParams:r.ruleParams,...t});const s=t?Bn(t):null;return{hash:v(s),query:s}},this.getTriplesAndAttrsForQuery=async t=>{var r,s,i,o,a,c;try{const u=await fetch(`${this.db._reactor.config.apiURI}/runtime/framework/query`,{method:"POST",headers:{"app-id":this.params.db._reactor.config.appId,"Content-Type":"application/json",Authorization:this.params.token?`Bearer ${this.params.token}`:void 0},body:JSON.stringify({query:t})});if(!u.ok)throw new Error("Error getting triples from server");const l=await u.json(),d=l==null?void 0:l.attrs;if(!d)throw new Error("No attrs");const f=(i=(s=(r=l.result)==null?void 0:r[0].data)==null?void 0:s["datalog-result"])==null?void 0:i["join-rows"][0],h=(c=(a=(o=l.result)==null?void 0:o[0])==null?void 0:a.data)==null?void 0:c["page-info"];return{attrs:d,triples:f,type:"http",queryHash:this.hashQuery(t).hash,query:t,pageInfo:h}}catch(u){const l=new Error("Error getting triples from framework client");throw l.cause=u,l}},this.params=e,this.db=e.db,this.resultMap=new Map}}const $o={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function Do(){return globalThis.__instantDbSchemaHashStore=globalThis.__instantDbSchemaHashStore??new WeakMap,globalThis.__instantDbSchemaHashStore}function Ro(){return globalThis.__instantDbStore=globalThis.__instantDbStore??{},globalThis.__instantDbStore}function St(n){const e=n.__adminToken;return n.appId+"_"+(n.websocketURI||"default_ws_uri")+"_"+(n.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+n.useDateObjects}const At=Ro(),Vn=Do();class Qn{constructor(e){this.db=e,this.sendMagicCode=t=>this.db.sendMagicCode(t),this.signInWithMagicCode=t=>this.db.signInWithMagicCode(t),this.signInWithToken=t=>this.db.signInWithCustomToken(t),this.signInAsGuest=()=>this.db.signInAsGuest(),this.createAuthorizationURL=t=>this.db.createAuthorizationURL(t),this.signInWithIdToken=t=>this.db.signInWithIdToken(t),this.exchangeOAuthCode=t=>this.db.exchangeCodeForToken(t),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(t={invalidateToken:!0})=>this.db.signOut(t)}}class Wn{constructor(e){this.db=e,this.uploadFile=(t,r,s={})=>this.db.uploadFile(t,r,s),this.delete=t=>this.db.deleteFile(t),this.upload=(t,r)=>this.db.upload(t,r),this.put=this.upload,this.getDownloadUrl=t=>this.db.getDownloadUrl(t)}}function Bn(n){return JSON.parse(JSON.stringify(n))}class Gn{constructor(e){this.tx=at(),this._reactor=e,this.auth=new Qn(this._reactor),this.storage=new Wn(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,t,r){return this._reactor.subscribeQuery(e,t,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",t="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(t,r==null?void 0:r.initialPresence),subscribeTopic:(i,o)=>this._reactor.subscribeTopic(t,i,o),subscribePresence:(i,o)=>this._reactor.subscribePresence(e,t,i,o),publishTopic:(i,o)=>this._reactor.publishTopic({roomType:e,roomId:t,topic:i,data:o}),publishPresence:i=>this._reactor.publishPresence(e,t,i),getPresence:i=>this._reactor.getPresence(e,t,i)}}shutdown(){delete At[St(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,t){return this._reactor.queryOnce(e,t)}_syncTableExperimental(e,t){return this._reactor.subscribeTable(e,t)}}function Hn(n){if(!n)return"0";const e=Vn.get(n);if(e)return e;const t=v(n);return Vn.set(n,t),t}function Uo(n,e){return Hn(n._reactor.config.schema)!==Hn(e)}function Jn(n,e,t,r,s){var u;const i={...n,appId:(u=n.appId)==null?void 0:u.trim(),useDateObjects:n.useDateObjects??!1},o=At[St(i)];if(o)return Uo(o,i.schema)&&o._reactor.updateSchema(i.schema),o;const a=new lo({...$o,...i,cardinalityInference:!!i.schema},e||ft,t||ht,{...r||{},"@instantdb/core":bt},s),c=new Gn(a);return At[St(i)]=c,xo(i.appId,i.devtool),c}function xo(n,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const t={position:"bottom-right",allowedHosts:["localhost"],...typeof e=="object"?e:{}};t.allowedHosts.includes(window.location.hostname)&&mo(n,t)}const Lo=Jn;A.Auth=Qn,A.FrameworkClient=jo,A.IndexedDBStorage=ft,A.InstantAPIError=_e,A.InstantCoreDatabase=Gn,A.InstantError=oe,A.QueryValidationError=C,A.Storage=Wn,A.StorageInterface=gn,A.SyncTableCallbackEventType=Fn,A.TransactionValidationError=q,A.WindowNetworkListener=ht,A.coerceQuery=Bn,A.coerceToDate=he,A.createInstantRouteHandler=Co,A.getOps=fn,A.i=M,A.id=j,A.init=Jn,A.init_experimental=Lo,A.lookup=qs,A.parseSchemaFromJSON=Mo,A.tx=zs,A.txInit=at,A.validateQuery=gt,A.validateTransactions=Rn,A.version=bt,A.weakHash=v,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
