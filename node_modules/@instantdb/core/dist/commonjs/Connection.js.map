{"version":3,"file":"Connection.js","sourceRoot":"","sources":["../../src/Connection.ts"],"names":[],"mappings":"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","sourcesContent":["export interface EventSourceType {\n  readonly url: string;\n  readonly readyState: number;\n\n  onopen: ((this: EventSourceType, ev: Event) => any) | null;\n  onmessage: ((this: EventSourceType, ev: MessageEvent) => any) | null;\n  onerror: ((this: EventSourceType, ev: Event) => any) | null;\n\n  close(): void;\n}\n\nexport interface EventSourceConstructor {\n  OPEN: number;\n  CONNECTING: number;\n  CLOSED: number;\n  new (url: string): EventSourceType;\n}\n\nlet _connId = 0;\n\ntype Conn = EventSourceType | WebSocket;\n\ntype OpenEvent<T extends Conn> = {\n  target: Connection<T>;\n};\n\ntype MessageData = {\n  op: string;\n  [key: string]: any;\n};\n\ntype SendMessageData = {\n  'client-event-id': string;\n  [key: string]: any;\n};\n\ntype MsgEvent<T extends Conn> = {\n  target: Connection<T>;\n  message: MessageData | MessageData[];\n};\n\ntype CloseEvent<T extends Conn> = {\n  target: Connection<T>;\n};\n\ninterface ErrorEvent<T extends Conn> {\n  target: Connection<T>;\n}\n\nexport type TransportType = 'ws' | 'sse';\n\nexport interface Connection<T extends Conn> {\n  conn: T;\n  type: 'ws' | 'sse';\n  id: string;\n  close(): void;\n  isOpen(): boolean;\n  isConnecting(): boolean;\n  send(msg: SendMessageData): void;\n  onopen: ((event: OpenEvent<T>) => void) | null;\n  onmessage: ((event: MsgEvent<T>) => void) | null;\n  onclose: ((event: CloseEvent<T>) => void) | null;\n  onerror: ((event: ErrorEvent<T>) => void) | null;\n}\n\nexport class WSConnection implements Connection<WebSocket> {\n  type: TransportType = 'ws';\n  conn: WebSocket;\n  id: string;\n  onopen: (event: OpenEvent<WebSocket>) => void;\n  onmessage: (event: MsgEvent<WebSocket>) => void;\n  onclose: (event: CloseEvent<WebSocket>) => void;\n  onerror: (event: ErrorEvent<WebSocket>) => void;\n  constructor(url: string) {\n    this.id = `${this.type}_${_connId++}`;\n    this.conn = new WebSocket(url);\n    this.conn.onopen = (_e) => {\n      if (this.onopen) {\n        this.onopen({ target: this });\n      }\n    };\n    this.conn.onmessage = (e) => {\n      if (this.onmessage) {\n        this.onmessage({\n          target: this,\n          message: JSON.parse(e.data.toString()),\n        });\n      }\n    };\n    this.conn.onclose = (_e) => {\n      if (this.onclose) {\n        this.onclose({ target: this });\n      }\n    };\n    this.conn.onerror = (_e) => {\n      if (this.onerror) {\n        this.onerror({ target: this });\n      }\n    };\n  }\n\n  close() {\n    this.conn.close();\n  }\n\n  isOpen(): boolean {\n    return this.conn.readyState === (WebSocket.OPEN ?? 1);\n  }\n\n  isConnecting(): boolean {\n    return this.conn.readyState === (WebSocket.CONNECTING ?? 0);\n  }\n\n  send(msg: SendMessageData) {\n    return this.conn.send(JSON.stringify(msg));\n  }\n}\n\ntype SSEInitParams = {\n  machineId: string;\n  sessionId: string;\n  sseToken: string;\n};\n\nexport class SSEConnection implements Connection<EventSourceType> {\n  type: TransportType = 'sse';\n  private initParams: SSEInitParams | null = null;\n  private sendQueue: any[] = [];\n  private sendPromise: Promise<void> | null;\n  private closeFired: boolean = false;\n  private sseInitTimeout: ReturnType<typeof setTimeout> | undefined = undefined;\n  private ES: EventSourceConstructor;\n  conn: EventSourceType;\n  url: string;\n  id: string;\n  onopen: (event: OpenEvent<EventSourceType>) => void;\n  onmessage: (event: MsgEvent<EventSourceType>) => void;\n  onclose: (event: CloseEvent<EventSourceType>) => void;\n  onerror: (event: ErrorEvent<EventSourceType>) => void;\n\n  constructor(ES: EventSourceConstructor, url: string) {\n    this.id = `${this.type}_${_connId++}`;\n    this.url = url;\n    this.ES = ES;\n    this.conn = new ES(url);\n\n    // Close the connection if we didn't get an init within 10 seconds\n    this.sseInitTimeout = setTimeout(() => {\n      if (!this.initParams) {\n        this.handleError();\n      }\n    }, 10000);\n\n    this.conn.onmessage = (e) => {\n      const message = JSON.parse(e.data);\n      if (Array.isArray(message)) {\n        for (const msg of message) {\n          this.handleMessage(msg);\n        }\n      } else {\n        this.handleMessage(message);\n      }\n    };\n\n    this.conn.onerror = (e) => {\n      this.handleError();\n    };\n  }\n\n  private handleMessage(msg: MessageData) {\n    if (msg.op === 'sse-init') {\n      this.initParams = {\n        machineId: msg['machine-id'],\n        sessionId: msg['session-id'],\n        sseToken: msg['sse-token'],\n      };\n      if (this.onopen) {\n        this.onopen({ target: this });\n      }\n      clearTimeout(this.sseInitTimeout);\n      return;\n    }\n    if (this.onmessage) {\n      this.onmessage({\n        target: this,\n        message: msg,\n      });\n    }\n  }\n\n  // Runs the onerror and closes the connection\n  private handleError() {\n    try {\n      if (this.onerror) {\n        this.onerror({ target: this });\n      }\n    } finally {\n      this.handleClose();\n    }\n  }\n\n  private handleClose() {\n    this.conn.close();\n    if (this.onclose && !this.closeFired) {\n      this.closeFired = true;\n      this.onclose({ target: this });\n    }\n  }\n\n  private async postMessages(messages: any[]): Promise<void> {\n    try {\n      const resp = await fetch(this.url, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          machine_id: this.initParams?.machineId,\n          session_id: this.initParams?.sessionId,\n          sse_token: this.initParams?.sseToken,\n          messages,\n        }),\n      });\n      if (!resp.ok) {\n        this.handleError();\n      }\n    } catch (e) {\n      this.handleError();\n    }\n  }\n\n  private async flushQueue() {\n    if (this.sendPromise || !this.sendQueue.length) return;\n\n    const messages = this.sendQueue;\n    this.sendQueue = [];\n    const sendPromise = this.postMessages(messages);\n    this.sendPromise = sendPromise;\n    sendPromise.then(() => {\n      this.sendPromise = null;\n      this.flushQueue();\n    });\n  }\n\n  send(msg: SendMessageData) {\n    if (!this.isOpen() || !this.initParams) {\n      if (this.isConnecting()) {\n        throw new Error(\n          `Failed to execute 'send' on 'EventSource': Still in CONNECTING state.`,\n        );\n      }\n      if (this.conn.readyState === this.ES.CLOSED) {\n        throw new Error(`EventSource is already in CLOSING or CLOSED state.`);\n      }\n      throw new Error(`EventSource is in invalid state.`);\n    }\n    this.sendQueue.push(msg);\n    this.flushQueue();\n  }\n\n  isOpen(): boolean {\n    return this.conn.readyState === this.ES.OPEN && this.initParams !== null;\n  }\n\n  isConnecting(): boolean {\n    return (\n      this.conn.readyState === this.ES.CONNECTING ||\n      (this.conn.readyState === this.ES.OPEN && this.initParams === null)\n    );\n  }\n\n  close() {\n    this.handleClose();\n  }\n}\n"]}