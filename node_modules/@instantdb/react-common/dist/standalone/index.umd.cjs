(function(le,j){typeof exports=="object"&&typeof module<"u"?j(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],j):(le=typeof globalThis<"u"?globalThis:le||self,j(le.instantReact={},le.React))})(this,function(le,j){"use strict";var bt={exports:{}},Pe={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var an;function si(){if(an)return Pe;an=1;var t=j,e=Symbol.for("react.element"),n=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,i=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};function o(u,a,d){var c,f={},l=null,p=null;d!==void 0&&(l=""+d),a.key!==void 0&&(l=""+a.key),a.ref!==void 0&&(p=a.ref);for(c in a)r.call(a,c)&&!s.hasOwnProperty(c)&&(f[c]=a[c]);if(u&&u.defaultProps)for(c in a=u.defaultProps,a)f[c]===void 0&&(f[c]=a[c]);return{$$typeof:e,type:u,key:l,ref:p,props:f,_owner:i.current}}return Pe.Fragment=n,Pe.jsx=o,Pe.jsxs=o,Pe}var Me={},cn;function oi(){if(cn)return Me;cn=1;var t={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */return t.NODE_ENV!=="production"&&function(){var e=j,n=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),o=Symbol.for("react.profiler"),u=Symbol.for("react.provider"),a=Symbol.for("react.context"),d=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),f=Symbol.for("react.suspense_list"),l=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),y=Symbol.for("react.offscreen"),b=Symbol.iterator,g="@@iterator";function w(h){if(h===null||typeof h!="object")return null;var T=b&&h[b]||h[g];return typeof T=="function"?T:null}var _=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function v(h){{for(var T=arguments.length,m=new Array(T>1?T-1:0),O=1;O<T;O++)m[O-1]=arguments[O];A("error",h,m)}}function A(h,T,m){{var O=_.ReactDebugCurrentFrame,P=O.getStackAddendum();P!==""&&(T+="%s",m=m.concat([P]));var M=m.map(function(C){return String(C)});M.unshift("Warning: "+T),Function.prototype.apply.call(console[h],console,M)}}var S=!1,I=!1,U=!1,D=!1,We=!1,ct;ct=Symbol.for("react.module.reference");function dt(h){return!!(typeof h=="string"||typeof h=="function"||h===i||h===o||We||h===s||h===c||h===f||D||h===y||S||I||U||typeof h=="object"&&h!==null&&(h.$$typeof===p||h.$$typeof===l||h.$$typeof===u||h.$$typeof===a||h.$$typeof===d||h.$$typeof===ct||h.getModuleId!==void 0))}function Zt(h,T,m){var O=h.displayName;if(O)return O;var P=T.displayName||T.name||"";return P!==""?m+"("+P+")":m}function ft(h){return h.displayName||"Context"}function se(h){if(h==null)return null;if(typeof h.tag=="number"&&v("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof h=="function")return h.displayName||h.name||null;if(typeof h=="string")return h;switch(h){case i:return"Fragment";case r:return"Portal";case o:return"Profiler";case s:return"StrictMode";case c:return"Suspense";case f:return"SuspenseList"}if(typeof h=="object")switch(h.$$typeof){case a:var T=h;return ft(T)+".Consumer";case u:var m=h;return ft(m._context)+".Provider";case d:return Zt(h,h.render,"ForwardRef");case l:var O=h.displayName||null;return O!==null?O:se(h.type)||"Memo";case p:{var P=h,M=P._payload,C=P._init;try{return se(C(M))}catch{return null}}}return null}var fe=Object.assign,we=0,$r,Ur,Lr,Fr,Nr,Kr,zr;function Vr(){}Vr.__reactDisabledLog=!0;function Ju(){{if(we===0){$r=console.log,Ur=console.info,Lr=console.warn,Fr=console.error,Nr=console.group,Kr=console.groupCollapsed,zr=console.groupEnd;var h={configurable:!0,enumerable:!0,value:Vr,writable:!0};Object.defineProperties(console,{info:h,log:h,warn:h,error:h,group:h,groupCollapsed:h,groupEnd:h})}we++}}function Zu(){{if(we--,we===0){var h={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:fe({},h,{value:$r}),info:fe({},h,{value:Ur}),warn:fe({},h,{value:Lr}),error:fe({},h,{value:Fr}),group:fe({},h,{value:Nr}),groupCollapsed:fe({},h,{value:Kr}),groupEnd:fe({},h,{value:zr})})}we<0&&v("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var Xt=_.ReactCurrentDispatcher,en;function lt(h,T,m){{if(en===void 0)try{throw Error()}catch(P){var O=P.stack.trim().match(/\n( *(at )?)/);en=O&&O[1]||""}return`
`+en+h}}var tn=!1,ht;{var Xu=typeof WeakMap=="function"?WeakMap:Map;ht=new Xu}function qr(h,T){if(!h||tn)return"";{var m=ht.get(h);if(m!==void 0)return m}var O;tn=!0;var P=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var M;M=Xt.current,Xt.current=null,Ju();try{if(T){var C=function(){throw Error()};if(Object.defineProperty(C.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(C,[])}catch(H){O=H}Reflect.construct(h,[],C)}else{try{C.call()}catch(H){O=H}h.call(C.prototype)}}else{try{throw Error()}catch(H){O=H}h()}}catch(H){if(H&&O&&typeof H.stack=="string"){for(var k=H.stack.split(`
`),W=O.stack.split(`
`),L=k.length-1,N=W.length-1;L>=1&&N>=0&&k[L]!==W[N];)N--;for(;L>=1&&N>=0;L--,N--)if(k[L]!==W[N]){if(L!==1||N!==1)do if(L--,N--,N<0||k[L]!==W[N]){var X=`
`+k[L].replace(" at new "," at ");return h.displayName&&X.includes("<anonymous>")&&(X=X.replace("<anonymous>",h.displayName)),typeof h=="function"&&ht.set(h,X),X}while(L>=1&&N>=0);break}}}finally{tn=!1,Xt.current=M,Zu(),Error.prepareStackTrace=P}var Ie=h?h.displayName||h.name:"",me=Ie?lt(Ie):"";return typeof h=="function"&&ht.set(h,me),me}function ea(h,T,m){return qr(h,!1)}function ta(h){var T=h.prototype;return!!(T&&T.isReactComponent)}function pt(h,T,m){if(h==null)return"";if(typeof h=="function")return qr(h,ta(h));if(typeof h=="string")return lt(h);switch(h){case c:return lt("Suspense");case f:return lt("SuspenseList")}if(typeof h=="object")switch(h.$$typeof){case d:return ea(h.render);case l:return pt(h.type,T,m);case p:{var O=h,P=O._payload,M=O._init;try{return pt(M(P),T,m)}catch{}}}return""}var Qe=Object.prototype.hasOwnProperty,Wr={},Qr=_.ReactDebugCurrentFrame;function yt(h){if(h){var T=h._owner,m=pt(h.type,h._source,T?T.type:null);Qr.setExtraStackFrame(m)}else Qr.setExtraStackFrame(null)}function na(h,T,m,O,P){{var M=Function.call.bind(Qe);for(var C in h)if(M(h,C)){var k=void 0;try{if(typeof h[C]!="function"){var W=Error((O||"React class")+": "+m+" type `"+C+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof h[C]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw W.name="Invariant Violation",W}k=h[C](T,C,O,m,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(L){k=L}k&&!(k instanceof Error)&&(yt(P),v("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",O||"React class",m,C,typeof k),yt(null)),k instanceof Error&&!(k.message in Wr)&&(Wr[k.message]=!0,yt(P),v("Failed %s type: %s",m,k.message),yt(null))}}}var ra=Array.isArray;function nn(h){return ra(h)}function ia(h){{var T=typeof Symbol=="function"&&Symbol.toStringTag,m=T&&h[Symbol.toStringTag]||h.constructor.name||"Object";return m}}function sa(h){try{return Br(h),!1}catch{return!0}}function Br(h){return""+h}function Gr(h){if(sa(h))return v("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",ia(h)),Br(h)}var Hr=_.ReactCurrentOwner,oa={key:!0,ref:!0,__self:!0,__source:!0},Yr,Jr;function ua(h){if(Qe.call(h,"ref")){var T=Object.getOwnPropertyDescriptor(h,"ref").get;if(T&&T.isReactWarning)return!1}return h.ref!==void 0}function aa(h){if(Qe.call(h,"key")){var T=Object.getOwnPropertyDescriptor(h,"key").get;if(T&&T.isReactWarning)return!1}return h.key!==void 0}function ca(h,T){typeof h.ref=="string"&&Hr.current}function da(h,T){{var m=function(){Yr||(Yr=!0,v("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",T))};m.isReactWarning=!0,Object.defineProperty(h,"key",{get:m,configurable:!0})}}function fa(h,T){{var m=function(){Jr||(Jr=!0,v("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",T))};m.isReactWarning=!0,Object.defineProperty(h,"ref",{get:m,configurable:!0})}}var la=function(h,T,m,O,P,M,C){var k={$$typeof:n,type:h,key:T,ref:m,props:C,_owner:M};return k._store={},Object.defineProperty(k._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(k,"_self",{configurable:!1,enumerable:!1,writable:!1,value:O}),Object.defineProperty(k,"_source",{configurable:!1,enumerable:!1,writable:!1,value:P}),Object.freeze&&(Object.freeze(k.props),Object.freeze(k)),k};function ha(h,T,m,O,P){{var M,C={},k=null,W=null;m!==void 0&&(Gr(m),k=""+m),aa(T)&&(Gr(T.key),k=""+T.key),ua(T)&&(W=T.ref,ca(T,P));for(M in T)Qe.call(T,M)&&!oa.hasOwnProperty(M)&&(C[M]=T[M]);if(h&&h.defaultProps){var L=h.defaultProps;for(M in L)C[M]===void 0&&(C[M]=L[M])}if(k||W){var N=typeof h=="function"?h.displayName||h.name||"Unknown":h;k&&da(C,N),W&&fa(C,N)}return la(h,k,W,P,O,Hr.current,C)}}var rn=_.ReactCurrentOwner,Zr=_.ReactDebugCurrentFrame;function Ce(h){if(h){var T=h._owner,m=pt(h.type,h._source,T?T.type:null);Zr.setExtraStackFrame(m)}else Zr.setExtraStackFrame(null)}var sn;sn=!1;function on(h){return typeof h=="object"&&h!==null&&h.$$typeof===n}function Xr(){{if(rn.current){var h=se(rn.current.type);if(h)return`

Check the render method of \``+h+"`."}return""}}function pa(h){return""}var ei={};function ya(h){{var T=Xr();if(!T){var m=typeof h=="string"?h:h.displayName||h.name;m&&(T=`

Check the top-level render call using <`+m+">.")}return T}}function ti(h,T){{if(!h._store||h._store.validated||h.key!=null)return;h._store.validated=!0;var m=ya(T);if(ei[m])return;ei[m]=!0;var O="";h&&h._owner&&h._owner!==rn.current&&(O=" It was passed a child from "+se(h._owner.type)+"."),Ce(h),v('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',m,O),Ce(null)}}function ni(h,T){{if(typeof h!="object")return;if(nn(h))for(var m=0;m<h.length;m++){var O=h[m];on(O)&&ti(O,T)}else if(on(h))h._store&&(h._store.validated=!0);else if(h){var P=w(h);if(typeof P=="function"&&P!==h.entries)for(var M=P.call(h),C;!(C=M.next()).done;)on(C.value)&&ti(C.value,T)}}}function ba(h){{var T=h.type;if(T==null||typeof T=="string")return;var m;if(typeof T=="function")m=T.propTypes;else if(typeof T=="object"&&(T.$$typeof===d||T.$$typeof===l))m=T.propTypes;else return;if(m){var O=se(T);na(m,h.props,"prop",O,h)}else if(T.PropTypes!==void 0&&!sn){sn=!0;var P=se(T);v("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",P||"Unknown")}typeof T.getDefaultProps=="function"&&!T.getDefaultProps.isReactClassApproved&&v("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function _a(h){{for(var T=Object.keys(h.props),m=0;m<T.length;m++){var O=T[m];if(O!=="children"&&O!=="key"){Ce(h),v("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",O),Ce(null);break}}h.ref!==null&&(Ce(h),v("Invalid attribute `ref` supplied to `React.Fragment`."),Ce(null))}}var ri={};function ii(h,T,m,O,P,M){{var C=dt(h);if(!C){var k="";(h===void 0||typeof h=="object"&&h!==null&&Object.keys(h).length===0)&&(k+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var W=pa();W?k+=W:k+=Xr();var L;h===null?L="null":nn(h)?L="array":h!==void 0&&h.$$typeof===n?(L="<"+(se(h.type)||"Unknown")+" />",k=" Did you accidentally export a JSX literal instead of a component?"):L=typeof h,v("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",L,k)}var N=ha(h,T,m,P,M);if(N==null)return N;if(C){var X=T.children;if(X!==void 0)if(O)if(nn(X)){for(var Ie=0;Ie<X.length;Ie++)ni(X[Ie],h);Object.freeze&&Object.freeze(X)}else v("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else ni(X,h)}if(Qe.call(T,"key")){var me=se(h),H=Object.keys(T).filter(function(Sa){return Sa!=="key"}),un=H.length>0?"{key: someKey, "+H.join(": ..., ")+": ...}":"{key: someKey}";if(!ri[me+un]){var va=H.length>0?"{"+H.join(": ..., ")+": ...}":"{}";v(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,un,me,va,me),ri[me+un]=!0}}return h===i?_a(N):ba(N),N}}function ga(h,T,m){return ii(h,T,m,!0)}function Ta(h,T,m){return ii(h,T,m,!1)}var wa=Ta,ma=ga;Me.Fragment=i,Me.jsx=wa,Me.jsxs=ma}(),Me}var ui={};ui.NODE_ENV==="production"?bt.exports=si():bt.exports=oi();var Be=bt.exports;function K(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=K(t[n]);for(let i=0;i<r.length;i++)e^=r.charCodeAt(i),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const i=n[r],s=K(i);e^=parseInt(s,16),e*=16777619,e=e>>>0;const o=K(t[i]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return K(String(t))}const $={Remove:"remove",Replace:"replace",Add:"add"},dn=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),ai=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),Ge=Symbol.iterator,Y={mutable:"mutable",immutable:"immutable"},_t={};function Re(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function fn(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function gt(t){return Object.getPrototypeOf(t)===Set.prototype}function Tt(t){return Object.getPrototypeOf(t)===Map.prototype}function J(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function he(t){return!!E(t)}function E(t){return typeof t!="object"?null:t==null?void 0:t[dn]}function wt(t){var e;const n=E(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function ee(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,Y))===Y.immutable||typeof n=="function")}function ln(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=E(oe(n,t.key));if(r!==null&&(r==null?void 0:r.original)!==t.original)return null;const i=t.parent.type===3,s=i?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(i&&n.size>s||Re(n,s)))return null;e.push(s)}if(t.parent)return ln(t.parent,e);e.reverse();try{ci(t.copy,e)}catch{return null}return e}function pe(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function oe(t,e){return pe(t)===2?t.get(e):t[e]}function xe(t,e,n){pe(t)===2?t.set(e,n):t[e]=n}function mt(t,e){const n=E(t);return(n?J(n):t)[e]}function ue(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function vt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function ye(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function ci(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=oe(pe(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function di(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const fi=Object.prototype.propertyIsEnumerable;function hn(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!gt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!Tt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e!=null&&e.mark&&(n=e.mark(t,Y),n!==void 0)&&n!==Y.mutable){if(n===Y.immutable)return di(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),Object.getOwnPropertySymbols(t).forEach(i=>{fi.call(t,i)&&(r[i]=t[i])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function q(t){t.copy||(t.copy=hn(t.original,t.options))}function De(t){if(!ee(t))return wt(t);if(Array.isArray(t))return t.map(De);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,i])=>[r,De(i)]);if(!Tt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(De);if(!gt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=De(t[n]);return e}function He(t){return he(t)?De(t):t}function re(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&re(t.parent))}function pn(){throw new Error("Cannot modify frozen object")}function ve(t,e,n,r,i){{n=n??new WeakMap,r=r??[],i=i??[];const o=n.has(t)?n.get(t):t;if(r.length>0){const u=r.indexOf(o);if(o&&typeof o=="object"&&u!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${i.slice(0,u).map((a,d)=>{if(typeof a=="symbol")return`[${a.toString()}]`;const c=r[d];return typeof a=="object"&&(c instanceof Map||c instanceof Set)?Array.from(c.keys()).indexOf(a):a}).join("/")}`);r.push(o),i.push(e)}else r.push(o)}if(Object.isFrozen(t)||he(t)){r.pop(),i.pop();return}switch(pe(t)){case 2:for(const[u,a]of t)ve(u,u,n,r,i),ve(a,u,n,r,i);t.set=t.clear=t.delete=pn;break;case 3:for(const u of t)ve(u,u,n,r,i);t.add=t.clear=t.delete=pn;break;case 1:Object.freeze(t);let o=0;for(const u of t)ve(u,o,n,r,i),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(u=>{const a=t[u];ve(a,u,n,r,i)})}r.pop(),i.pop()}function St(t,e){const n=pe(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const i of t)e(r,i,t),r+=1}else t.forEach((r,i)=>e(i,r,t))}function yn(t,e,n){if(he(t)||!ee(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,i=r?new Map:void 0;if(e.add(t),St(t,(s,o)=>{var u;if(he(o)){const a=E(o);q(a);const d=!((u=a.assignedMap)===null||u===void 0)&&u.size||a.operated?a.copy:a.original;xe(r?i:t,s,d)}else yn(o,e,n)}),i){const s=t,o=Array.from(s);s.clear(),o.forEach(u=>{s.add(i.has(u)?i.get(u):u)})}}function li(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&yn(oe(n,e),t.finalities.handledSet,t.options)}function Ot(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(wt(e))}))}function At(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const s=ln(t);s&&e(t,s,n,r)}t.finalized=!0}}function Et(t,e,n,r){const i=E(n);i&&(i.callbacks||(i.callbacks=[]),i.callbacks.push((s,o)=>{var u;const a=t.type===3?t.setMap:t.copy;if(ue(oe(a,e),n)){let d=i.original;i.copy&&(d=i.copy),Ot(t),At(t,r,s,o),t.options.enableAutoFreeze&&(t.options.updatedValues=(u=t.options.updatedValues)!==null&&u!==void 0?u:new WeakMap,t.options.updatedValues.set(d,i.original)),xe(a,e,d)}}),t.options.enableAutoFreeze&&i.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),ee(n,t.options)&&t.finalities.draft.push(()=>{const s=t.type===3?t.setMap:t.copy;ue(oe(s,e),n)&&li(t,e)})}function hi(t,e,n,r,i){let{original:s,assignedMap:o,options:u}=t,a=t.copy;a.length<s.length&&([s,a]=[a,s],[n,r]=[r,n]);for(let d=0;d<s.length;d+=1)if(o.get(d.toString())&&a[d]!==s[d]){const c=e.concat([d]),f=ye(c,i);n.push({op:$.Replace,path:f,value:He(a[d])}),r.push({op:$.Replace,path:f,value:He(s[d])})}for(let d=s.length;d<a.length;d+=1){const c=e.concat([d]),f=ye(c,i);n.push({op:$.Add,path:f,value:He(a[d])})}if(s.length<a.length){const{arrayLengthAssignment:d=!0}=u.enablePatches;if(d){const c=e.concat(["length"]),f=ye(c,i);r.push({op:$.Replace,path:f,value:s.length})}else for(let c=a.length;s.length<c;c-=1){const f=e.concat([c-1]),l=ye(f,i);r.push({op:$.Remove,path:l})}}}function pi({original:t,copy:e,assignedMap:n},r,i,s,o){n.forEach((u,a)=>{const d=oe(t,a),c=He(oe(e,a)),f=u?Re(t,a)?$.Replace:$.Add:$.Remove;if(ue(d,c)&&f===$.Replace)return;const l=r.concat(a),p=ye(l,o);i.push(f===$.Remove?{op:f,path:p}:{op:f,path:p,value:c}),s.push(f===$.Add?{op:$.Remove,path:p}:f===$.Remove?{op:$.Add,path:p,value:d}:{op:$.Replace,path:p,value:d})})}function yi({original:t,copy:e},n,r,i,s){let o=0;t.forEach(u=>{if(!e.has(u)){const a=n.concat([o]),d=ye(a,s);r.push({op:$.Remove,path:d,value:u}),i.unshift({op:$.Add,path:d,value:u})}o+=1}),o=0,e.forEach(u=>{if(!t.has(u)){const a=n.concat([o]),d=ye(a,s);r.push({op:$.Add,path:d,value:u}),i.unshift({op:$.Remove,path:d,value:u})}o+=1})}function $e(t,e,n,r){const{pathAsArray:i=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return pi(t,e,n,r,i);case 1:return hi(t,e,n,r,i);case 3:return yi(t,e,n,r,i)}}const Ye=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!ee(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},kt={get size(){return J(E(this)).size},has(t){return J(E(this)).has(t)},set(t,e){const n=E(this),r=J(n);return(!r.has(t)||!ue(r.get(t),e))&&(q(n),re(n),n.assignedMap.set(t,!0),n.copy.set(t,e),Et(n,t,e,$e)),this},delete(t){if(!this.has(t))return!1;const e=E(this);return q(e),re(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=E(this);if(this.size){q(t),re(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=E(this);J(n).forEach((r,i)=>{t.call(e,this.get(i),i,this)})},get(t){var e,n;const r=E(this),i=J(r).get(t),s=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,i,Y))===Y.mutable;if(r.options.strict&&Ye(i,r.options,s),s||r.finalized||!ee(i,r.options)||i!==r.original.get(t))return i;const o=_t.createDraft({original:i,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return q(r),r.copy.set(t,o),o},keys(){return J(E(this)).keys()},values(){const t=this.keys();return{[Ge]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[Ge]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[Ge](){return this.entries()}},bi=Reflect.ownKeys(kt),bn=(t,e,{isValuesIterator:n})=>()=>{var r,i;const s=e.next();if(s.done)return s;const o=s.value;let u=t.setMap.get(o);const a=E(u),d=((i=(r=t.options).mark)===null||i===void 0?void 0:i.call(r,u,Y))===Y.mutable;if(t.options.strict&&Ye(o,t.options,d),!d&&!a&&ee(o,t.options)&&!t.finalized&&t.original.has(o)){const c=_t.createDraft({original:o,parentDraft:t,key:o,finalities:t.finalities,options:t.options});t.setMap.set(o,c),u=c}else a&&(u=a.proxy);return{done:!1,value:n?u:[u,u]}},Je={get size(){return E(this).setMap.size},has(t){const e=E(this);if(e.setMap.has(t))return!0;q(e);const n=E(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=E(this);return this.has(t)||(q(e),re(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),Et(e,t,t,$e)),this},delete(t){if(!this.has(t))return!1;const e=E(this);q(e),re(e);const n=E(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=E(this);q(t),re(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=E(this);q(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:bn(t,e,{isValuesIterator:!0})}},entries(){const t=E(this);q(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:bn(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[Ge](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(Je,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const _i=Reflect.ownKeys(Je),_n=new WeakSet,gn={get(t,e,n){var r,i;const s=(r=t.copy)===null||r===void 0?void 0:r[e];if(s&&_n.has(s))return s;if(e===dn)return t;let o;if(t.options.mark){const d=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(o=t.options.mark(d,Y),o===Y.mutable)return t.options.strict&&Ye(d,t.options,!0),d}const u=J(t);if(u instanceof Map&&bi.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(kt,"size").get.call(t.proxy);const d=kt[e];if(d)return d.bind(t.proxy)}if(u instanceof Set&&_i.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(Je,"size").get.call(t.proxy);const d=Je[e];if(d)return d.bind(t.proxy)}if(!Re(u,e)){const d=fn(u,e);return d?"value"in d?d.value:(i=d.get)===null||i===void 0?void 0:i.call(t.proxy):void 0}const a=u[e];if(t.options.strict&&Ye(a,t.options),t.finalized||!ee(a,t.options))return a;if(a===mt(t.original,e)){if(q(t),t.copy[e]=jt({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof o=="function"){const d=E(t.copy[e]);return q(d),re(d),d.copy}return t.copy[e]}return a},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let i;if(t.type===1&&e!=="length"&&!(Number.isInteger(i=Number(e))&&i>=0&&(e===0||i===0||String(i)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const s=fn(J(t),e);if(s!=null&&s.set)return s.set.call(t.proxy,n),!0;const o=mt(J(t),e),u=E(o);return u&&ue(u.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(ue(n,o)&&(n!==void 0||Re(t.original,e))||(q(t),re(t),Re(t.original,e)&&ue(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,Et(t,e,n,$e)),!0)},has(t,e){return e in J(t)},ownKeys(t){return Reflect.ownKeys(J(t))},getOwnPropertyDescriptor(t,e){const n=J(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?gn.set.call(this,t,e,void 0,t.proxy):(mt(t.original,e)!==void 0||e in t.original?(q(t),re(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function jt(t){const{original:e,parentDraft:n,key:r,finalities:i,options:s}=t,o=pe(e),u={type:o,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:i,options:s,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in t)&&(u.key=r);const{proxy:a,revoke:d}=Proxy.revocable(o===1?Object.assign([],u):u,gn);if(i.revoke.push(d),_n.add(a),u.proxy=a,n){const c=n;c.finalities.draft.push((f,l)=>{var p,y;const b=E(a);let g=c.type===3?c.setMap:c.copy;const w=oe(g,r),_=E(w);if(_){let v=_.original;_.operated&&(v=wt(w)),Ot(_),At(_,$e,f,l),c.options.enableAutoFreeze&&(c.options.updatedValues=(p=c.options.updatedValues)!==null&&p!==void 0?p:new WeakMap,c.options.updatedValues.set(v,_.original)),xe(g,r,v)}(y=b.callbacks)===null||y===void 0||y.forEach(v=>{v(f,l)})})}else{const c=E(a);c.finalities.draft.push((f,l)=>{Ot(c),At(c,$e,f,l)})}return a}_t.createDraft=jt;function gi(t,e,n,r,i){var s;const o=E(t),u=(s=o==null?void 0:o.original)!==null&&s!==void 0?s:t,a=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(n,r);const d=a?e[0]:o?o.operated?o.copy:o.original:t;return o&&vt(o),i&&ve(d,d,o==null?void 0:o.options.updatedValues),[d,n&&a?[{op:$.Replace,path:[],value:e[0]}]:n,r&&a?[{op:$.Replace,path:[],value:u}]:r]}function Ti(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet};let i,s;e.enablePatches&&(i=[],s=[]);const u=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,Y))===Y.mutable||!ee(t,e)?t:jt({original:t,parentDraft:null,finalities:r,options:e});return[u,(a=[])=>{const[d,c,f]=gi(u,a,i,s,e.enableAutoFreeze);return e.enablePatches?[d,c,f]:d}]}function Ct(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:i=!0}=t;St(n,(s,o,u)=>{const a=E(o);if(a&&e&&a.finalities===e.finalities){t.isContainDraft=!0;const d=a.original;if(u instanceof Set){const c=Array.from(u);u.clear(),c.forEach(f=>u.add(s===f?d:f))}else xe(u,s,d)}else typeof o=="object"&&o!==null&&(t.value=o,t.isRoot=!1,Ct(t))}),i&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Tn(t){var e;const n=E(t);if(!ee(t,n==null?void 0:n.options))return t;const r=pe(t);if(n&&!n.operated)return n.original;let i;function s(){i=r===2?Tt(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):hn(t,n==null?void 0:n.options)}if(n){n.finalized=!0;try{s()}finally{n.finalized=!1}}else i=t;if(St(i,(o,u)=>{if(n&&ue(oe(n.original,o),u))return;const a=Tn(u);a!==u&&(i===t&&s(),xe(i,o,a))}),r===3){const o=(e=n==null?void 0:n.original)!==null&&e!==void 0?e:i;return gt(o)?new Set(i):new(Object.getPrototypeOf(o)).constructor(i)}return i}function wn(t){if(!he(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Tn(t)}const Ze=(t=>function e(n,r,i){var s,o,u;if(typeof n=="function"&&typeof r!="function")return function(S,...I){return e(S,U=>n.call(this,U,...I),r)};const a=n,d=r;let c=i;if(typeof r!="function"&&(c=r),c!==void 0&&Object.prototype.toString.call(c)!=="[object Object]")throw new Error(`Invalid options: ${c}, 'options' should be an object.`);c=Object.assign(Object.assign({},t),c);const f=he(a)?wn(a):a,l=Array.isArray(c.mark)?(S,I)=>{for(const U of c.mark){if(typeof U!="function")throw new Error(`Invalid mark: ${U}, 'mark' should be a function.`);const D=U(S,I);if(D)return D}}:c.mark,p=(s=c.enablePatches)!==null&&s!==void 0?s:!1,y=(o=c.strict)!==null&&o!==void 0?o:!1,g={enableAutoFreeze:(u=c.enableAutoFreeze)!==null&&u!==void 0?u:!1,mark:l,strict:y,enablePatches:p};if(!ee(f,g)&&typeof f=="object"&&f!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[w,_]=Ti(f,g);if(typeof r!="function"){if(!ee(f,g))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[w,_]}let v;try{v=d(w)}catch(S){throw vt(E(w)),S}const A=S=>{const I=E(w);if(!he(S)){if(S!==void 0&&!ue(S,w)&&(I!=null&&I.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const D=S==null?void 0:S[ai];if(D){const We=D[0];return g.strict&&typeof S=="object"&&S!==null&&Ct({rootDraft:I,value:S,useRawReturn:!0}),_([We])}if(S!==void 0)return typeof S=="object"&&S!==null&&Ct({rootDraft:I,value:S}),_([S])}if(S===w||S===void 0)return _([]);const U=E(S);if(g===U.options){if(U.operated)throw new Error("Cannot return a modified child draft.");return _([wn(S)])}return _([S])};return v instanceof Promise?v.then(A,S=>{throw vt(E(w)),S}):A(v)})();Object.prototype.constructor.toString();function mn(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(i=>e.hasOwnProperty(i))}function vn(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function Xe(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:mn(t,e)?Object.keys(t).every(n=>Xe(t[n],e[n])):!1}function It(t){if(!Ue(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function Sn(t,e){if(!Ue(t)||!Ue(e))return e;const n=Object.assign({},t);for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const i=Ue(t[r])&&Ue(e[r]);n[r]=i?Sn(t[r],e[r]):e[r]}return n}function Ue(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function wi(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const o=e[s];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[s+1]=="number"?[]:{}),r=r[o]}const i=e[e.length-1];Array.isArray(r)&&typeof i=="number"?r.splice(i,0,n):r[i]=n}function On(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let i=0;i<e.length-1;i++){const s=e[i];(!(s in r)||typeof r[s]!="object")&&(r[s]=typeof e[i+1]=="number"?[]:{}),r=r[s]}r[e[e.length-1]]=n}function An(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}An(t[n],r),mi(t[n])&&delete t[n]}}function mi(t){return t&&Object.keys(t).length===0}const En=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,vi={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function Si(t){return new Date(t)}function Oi(t){return new Date(t+"Z")}const Ai=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function Ei(t){const e=t.match(Ai);if(!e)return null;const[n,r,i,s]=e;return r<=0||i<=0||s<=0?null:r>999?new Date(Date.UTC(r,i-1,s,0,0,0,0)):new Date(Date.UTC(s,r-1,i,0,0,0,0))}function ki(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function ji(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function Ci(t){return new Date(t)}function Ii(t){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!t.match(e))throw new Error(`Unable to parse \`${t}\` as a date.`);const r=new Date(t+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function Pi(t){const e=/^(.+T.+)([+-])(\d{2})$/,n=t.match(e);if(n){const[,r,i,s]=n,o=`${r}${i}${s}:00`;return new Date(o)}return null}function Mi(t){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,n=t.match(e);if(n){const[,r,i,s,o,u]=n,a=i.padStart(2,"0"),d=s.padStart(2,"0"),c=`${r}-${a}-${d}T${u}`;return new Date(c)}return null}function Ri(t){const[e,n]=t.split(", "),[r,i,s]=e.split("/").map(Number),o=n.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw new Error(`Unable to parse time from: ${t}`);let[,u,a,d,c]=o;return u=Number(u),a=Number(a),d=Number(d),c==="PM"&&u!==12?u+=12:c==="AM"&&u===12&&(u=0),new Date(Date.UTC(s,r-1,i,u,a,d))}function xi(t){switch(t){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function Di(t){const e=t.match(En);if(!e)return null;const[n]=e,r=vi[n],i=new Date(t.replace(En,"Z"));return new Date(i.getTime()-r*1e3)}const $i=[Ei,ji,Ii,Ri,Ci,Oi,Pi,ki,Si,xi,Di,Mi];function Ui(t,e){try{const n=t(e);return n instanceof Date&&!isNaN(n.getTime())?n:null}catch{return null}}function Pt(t){for(const e of $i){const n=Ui(e,t);if(n)return n}return null}function Li(t){try{const e=JSON.parse(t);return typeof e=="string"?Pt(e):null}catch{return null}}function et(t){if(t!==void 0){if(t===null)return null;if(t instanceof Date)return t;if(typeof t=="string"){const e=Pt(t)||Li(t)||Pt(t.trim());if(!e)throw new Error(`Unable to parse \`${t}\` as a date.`);return e}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date value \`${t}\`. Expected a date, number, or string, got type ${typeof t}.`)}}class be{constructor(e,n){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null,this.attrs=e,this.linkIndex=n}resetAttrIndexes(){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null}addAttr(e){this.attrs[e.id]=e,this.resetAttrIndexes()}deleteAttr(e){delete this.attrs[e],this.resetAttrIndexes()}updateAttr(e){const n=this.attrs[e.id];n&&(this.attrs[e.id]=Object.assign(Object.assign({},n),e),this.resetAttrIndexes())}getAttr(e){return this.attrs[e]}get blobAttrs(){if(this._blobAttrs)return this._blobAttrs;this._blobAttrs=new Map;for(const e of Object.values(this.attrs))if(Rt(e)){const[n,r,i]=e["forward-identity"];Q(this.blobAttrs,[r,i],e)}return this._blobAttrs}get primaryKeys(){if(this._primaryKeys)return this._primaryKeys;this._primaryKeys=new Map;for(const e of Object.values(this.attrs))if(e["primary?"]){const[n,r]=e["forward-identity"];Q(this._primaryKeys,[r],e)}return this._primaryKeys}get forwardIdents(){if(this._forwardIdents)return this._forwardIdents;this._forwardIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["forward-identity"],[r,i,s]=n;Q(this._forwardIdents,[i,s],e)}return this._forwardIdents}get revIdents(){if(this._revIdents)return this._revIdents;this._revIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["reverse-identity"];if(n){const[r,i,s]=n;Q(this._revIdents,[i,s],e)}}return this._revIdents}toJSON(){return{attrs:this.attrs,linkIndex:this.linkIndex}}}function Fi(t){return t.cardinality==="one"}function Mt(t){return t["value-type"]==="ref"}function Rt(t){return t["value-type"]==="blob"}function Se(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function te(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&te(t.get(n),r)}function Q(t,e,n){let r=t;const i=e.length-1;for(let s=0;s<i;s++){const o=e[s];let u=r.get(o);u===void 0&&(u=new Map,r.set(o,u)),r=u}i>-1&&r.set(e[i],n)}function kn(t,e,n){const r=new Map,i=new Map,s=new Map;for(const o of e){let[u,a,d]=o;const c=t.getAttr(a);if(!c){console.warn("no such attr",a,u);continue}c["checked-data-type"]==="date"&&n&&(d=et(d),o[2]=d),Mt(c)&&Q(s,[d,a,u],o),Q(r,[u,a,d],o),Q(i,[a,u,d],o)}return{eav:r,aev:i,vae:s}}function jn(t){return{triples:B(t.eav,3),cardinalityInference:t.cardinalityInference,useDateObjects:t.useDateObjects,version:1}}function Cn(t,e){return Le(t,e.triples,e.cardinalityInference,e.useDateObjects)}function In(t,e){if(t)return new be(t.attrs,t.linkIndex);if(e&&"__type"in e)return new be(e.attrs,e.linkIndex)}function Ni(t,e){return Se(t.eav,[e])!==void 0}function Le(t,e,n,r){const i=kn(t,e,r);return i.cardinalityInference=n,i.useDateObjects=r,i}function Fe(t,e){var n,r;let i;if(Array.isArray(e[0])){const[o,u]=e[0],a=t.aev.get(o);if(!a)return null;i=(n=B(a,2).find(c=>c[2]===u))===null||n===void 0?void 0:n[0]}else i=e[0];if(!i)return null;const s=e[2];if(Array.isArray(s)&&s.length===2&&t.aev.get(s[0])){const[o,u]=s,a=t.aev.get(o);if(!a)return null;const c=(r=B(a,2).find(b=>b[2]===u))===null||r===void 0?void 0:r[0];if(!c)return null;const[f,l,p,...y]=e;return[i,l,c,...y]}else{const[o,...u]=e;return[i,...u]}}function Pn(t,e,n){const r=Fe(t,n);if(!r)return;const[i,s,o]=r,u=e.getAttr(s);u&&(te(t.eav,[i,s,o]),te(t.aev,[s,i,o]),Mt(u)&&te(t.vae,[o,s,i]))}let Ki=0;function Mn(t,e,n){const[r,i,s]=n;let o;const u=Se(t.eav,[r,i,s]);return u&&(o=u[3]),o||Date.now()*10+Ki++}function Rn(t,e,n){var r;const i=Fe(t,n);if(!i)return;let[s,o,u]=i;const a=e.getAttr(o);if(!a)return;a["checked-data-type"]==="date"&&t.useDateObjects&&(u=et(u));const d=Se(t.eav,[s,o,u]),c=(r=d==null?void 0:d[3])!==null&&r!==void 0?r:Mn(t,a,i),f=[s,o,u,c];Fi(a)?(Q(t.eav,[s,o],new Map([[u,f]])),Q(t.aev,[o,s],new Map([[u,f]]))):(Q(t.eav,[s,o,u],f),Q(t.aev,[o,s,u],f)),Mt(a)&&Q(t.vae,[u,o,s],f)}function zi(t,e,n){var r;const i=Fe(t,n);if(!i)return;const[s,o,u]=i,a=e.getAttr(o);if(!a)return;if(!Rt(a))throw new Error("merge operation is not supported for links");const d=Se(t.eav,[s,o]);if(!d)return;const c=(r=d.values().next())===null||r===void 0?void 0:r.value;if(!c)return;const f=c[2],l=Sn(f,u),p=[s,o,l,Mn(t,a,c)];Q(t.eav,[s,o],new Map([[l,p]])),Q(t.aev,[o,s],new Map([[l,p]]))}function xt(t,e,n){var r,i;const[s,o]=n,u=Fe(t,[s]);if(!u)return;const[a]=u,d=t.eav.get(a);if(d){for(const f of d.keys()){const l=e.getAttr(f);l&&l["on-delete-reverse"]==="cascade"&&B(d.get(f),1).forEach(([p,y,b])=>{var g;return xt(t,e,[b,(g=l["reverse-identity"])===null||g===void 0?void 0:g[1]])}),(!o||!l||((r=l["forward-identity"])===null||r===void 0?void 0:r[1])===o)&&(te(t.aev,[f,a]),te(t.eav,[a,f]))}d.size===0&&te(t.eav,[a])}const c=t.vae.get(a)&&B(t.vae.get(a),2);c&&c.forEach(f=>{var l,p,y;const[b,g,w]=f,_=e.getAttr(g);(!o||!_||((l=_["reverse-identity"])===null||l===void 0?void 0:l[1])===o)&&(te(t.eav,[b,g,w]),te(t.aev,[g,b,w]),te(t.vae,[w,g,b])),_&&_["on-delete"]==="cascade"&&((p=_["reverse-identity"])===null||p===void 0?void 0:p[1])===o&&xt(t,e,[b,(y=_["forward-identity"])===null||y===void 0?void 0:y[1]])}),((i=t.vae.get(a))===null||i===void 0?void 0:i.size)===0&&te(t.vae,[a])}function xn(t,e,n){const r=kn(e,n,t.useDateObjects);Object.keys(r).forEach(i=>{t[i]=r[i]})}function Vi(t,[e]){t.addAttr(e)}function Dn(t){return B(t.eav,3)}function qi(t,e,[n]){if(!e.getAttr(n))return;const r=Dn(t).filter(([i,s])=>s!==n);e.deleteAttr(n),xn(t,e,r)}function Wi(t,e,[n]){e.getAttr(n.id)&&(e.updateAttr(n),xn(t,e,Dn(t)))}function Qi(t,e,n){const[r,...i]=n;switch(r){case"add-triple":Rn(t,e,i);break;case"deep-merge-triple":zi(t,e,i);break;case"retract-triple":Pn(t,e,i);break;case"delete-entity":xt(t,e,i);break;case"add-attr":Vi(e,i);break;case"delete-attr":qi(t,e,i);break;case"update-attr":Wi(t,e,i);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${r}`)}}function B(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())B(r,e-1,n);return n}function tt(t,e,n){var r;const i=[];if(n!=null&&n.hasOwnProperty("$not")){for(const o of e.keys())n.$not!==o&&i.push(e.get(o));return i}if(n!=null&&n.hasOwnProperty("$isNull")){const{attrId:o,isNull:u,reverse:a}=n.$isNull;if(a)for(const d of e.keys()){const c=t.vae.get(d),f=!c||!c.get(o);(u?f:!f)&&i.push(e.get(d))}else{const d=t.aev.get(o);for(const c of e.keys()){const f=!d||((r=d.get(c))===null||r===void 0?void 0:r.get(null))||!d.get(c);(u?f:!f)&&i.push(e.get(c))}}return i}if(n!=null&&n.$comparator)return B(e,1).filter(n.$op);const s=n.in||n.$in||[n];for(const o of s){const u=e.get(o);u&&i.push(u)}return i}function Bi(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function Gi(t,[e,n,r]){var i,s;switch(Bi(e,n,r)){case"e":{const u=t.eav.get(e);return B(u,2)}case"ea":{const u=(i=t.eav.get(e))===null||i===void 0?void 0:i.get(n);return B(u,1)}case"eav":{const u=(s=t.eav.get(e))===null||s===void 0?void 0:s.get(n);return u?tt(t,u,r):[]}case"ev":{const u=t.eav.get(e);if(!u)return[];const a=[];for(const d of u.values())a.push(...tt(t,d,r));return a}case"a":{const u=t.aev.get(n);return B(u,2)}case"av":{const u=t.aev.get(n);if(!u)return[];const a=[];for(const d of u.values())a.push(...tt(t,d,r));return a}case"v":{const u=[];for(const a of t.eav.values())for(const d of a.values())u.push(...tt(t,d,r));return u}default:return B(t.eav,3)}}function Hi(t,e,n){var r;const i={};if(!e)return i;for(const[s,o]of e.entries()){const u=(r=t.eav.get(n))===null||r===void 0?void 0:r.get(o.id),a=B(u,1);for(const d of a)i[s]=d[2]}return i}function F(t,e,n){var r;return(r=t.forwardIdents.get(e))===null||r===void 0?void 0:r.get(n)}function _e(t,e,n){var r;return(r=t.revIdents.get(e))===null||r===void 0?void 0:r.get(n)}function Yi(t,e){return t.blobAttrs.get(e)}function $n(t,e){var n;const r=t.primaryKeys.get(e);return r||((n=t.forwardIdents.get(e))===null||n===void 0?void 0:n.get("id"))}function Ji(t,e,n){const r=Fe(t,n);if(!r)return;const[i,s,o]=r;if(e.getAttr(s))return Se(t.eav,[i,s])}function Zi(t,e,n){const r=n.filter(([i,s,o,u,a])=>{if(i!=="add-triple"&&i!=="deep-merge-triple")return!0;const d=a==null?void 0:a.mode;if(d!=="create"&&d!=="update")return!0;let c=!1;const f=e.getAttr(o);if(f){const l=$n(e,f["forward-identity"][1]);c=!!Ji(t,e,[s,l==null?void 0:l.id,s])}return!(d==="create"&&c||d==="update"&&!c)});return Ze({store:t,attrsStore:e},i=>{r.forEach(s=>{Qi(i.store,i.attrsStore,s)})},{mark:i=>{if(i instanceof be)return"immutable"}})}function Xi(t){return typeof t=="string"&&t.startsWith("?")}function es(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return Ln(r,e,n)}return Object.assign(Object.assign({},n),{[t]:e})}function Un(t,e,n){return t===e?n:null}function ts(t){switch(typeof t){case"string":return t.startsWith("?")?es:Un;default:return Un}}const ns=["in","$in","$not","$isNull","$comparator"];function rs(t){for(const e of ns)if(t.hasOwnProperty(e))return!0;return!1}function Ln(t,e,n){return n?typeof t=="object"?rs(t)?n:null:ts(t)(t,e,n):null}function is(t,e,n){return t.reduce((r,i,s)=>{const o=e[s];return Ln(i,o,r)},n)}function ss(t,e,n){return as(t,e,n).map(r=>is(e,r,n)).filter(r=>r)}function os(t,e,n){return e.or?e.or.patterns.flatMap(r=>Dt(t,r,n)):e.and?e.and.patterns.reduce((r,i)=>Dt(t,i,r),n):n.flatMap(r=>ss(t,e,r))}function Dt(t,e,n=[{}]){return e.reduce((r,i)=>os(t,i,r),n)}function $t(t,e){return Array.isArray(e)?e.map(n=>$t(t,n)):Xi(e)?t[e]:e}function us(t,{find:e,where:n}){return Dt(t,n).map(i=>$t(i,e))}function as(t,e,n){return Gi(t,$t(n,e))}const cs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Oe(t){return typeof t=="string"&&cs.test(t)}const V=[];for(let t=0;t<256;++t)V.push((t+256).toString(16).slice(1));function ds(t,e=0){return(V[t[e+0]]+V[t[e+1]]+V[t[e+2]]+V[t[e+3]]+"-"+V[t[e+4]]+V[t[e+5]]+"-"+V[t[e+6]]+V[t[e+7]]+"-"+V[t[e+8]]+V[t[e+9]]+"-"+V[t[e+10]]+V[t[e+11]]+V[t[e+12]]+V[t[e+13]]+V[t[e+14]]+V[t[e+15]]).toLowerCase()}let Ut;const fs=new Uint8Array(16);function ls(){if(!Ut){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ut=crypto.getRandomValues.bind(crypto)}return Ut(fs)}const Fn={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function hs(t,e,n){var i;if(Fn.randomUUID&&!t)return Fn.randomUUID();t=t||{};const r=t.random??((i=t.rng)==null?void 0:i.call(t))??ls();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ds(r)}function Nn(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function ps(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function ys(t,e){return ps(Nn(t),Nn(e))}function z(){return hs()}function bs(t,e){return t.localeCompare(e)}function _s(){let t=bs;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{t=Intl.Collator("en-US").compare}catch{}return t}const gs=_s();let Ts=0;function Ne(t){return nt(`_${t}`,Ts++)}function nt(t,e){return`?${t}-${e}`}class Ae extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function ws(t,e){const n=$n(t,e);if(!n)throw new Ae(`Could not find id attr for ${e}`);return n}function Kn(t,e,n,r){return[ms(t,e,n,r)]}function ms(t,e,n,r){return[t(n,r),ws(e,n).id,t(n,r),t("time",r)]}function vs(t,e,n){return t.map(r=>r===e?n:r)}function zn(t,e,n,r,i){const s=F(e,n,i),o=_e(e,n,i),u=s||o;if(!u)throw new Ae(`Could not find attr for ${[n,i]}`);if(u["value-type"]!=="ref")throw new Error(`Attr ${u.id} is not a ref`);const[a,d]=u["forward-identity"],[c,f]=u["reverse-identity"],l=r+1,p=s?[t(d,r),u.id,t(f,l),Ne("time")]:[t(d,l),u.id,t(f,r),Ne("time")];return[s?f:d,l,p,u,!!s]}function Vn(t,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),i=new RegExp(`^${r}$`,t?void 0:"i");return function(o){return typeof o!="string"?!1:i.test(o)}}function Ss(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>new Date(e.$gt)}:function(i){return i[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])>=new Date(e.$gte)}:function(i){return i[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<new Date(e.$lt)}:function(i){return i[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(i){return new Date(i[2])<=new Date(e.$lte)}:function(i){return i[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=Vn(!0,e.$like);return{$comparator:!0,$op:function(s){return r(s[2])}}}if(e.hasOwnProperty("$ilike")){const r=Vn(!1,e.$ilike);return{$comparator:!0,$op:function(s){return r(s[2])}}}return e}function Os(t,e,n,r,i,s){const o=F(e,n,i),u=_e(e,n,i),a=o||u;if(!a)throw new Ae(`No attr for etype = ${n} label = ${i}`);if(s!=null&&s.hasOwnProperty("$isNull")){const d=F(e,n,"id");if(!d)throw new Ae(`No attr for etype = ${n} label = id`);return[t(n,r),d.id,{$isNull:{attrId:a.id,isNull:s.$isNull,reverse:!o}},Ne("time")]}return o?[t(n,r),a.id,Ss(a,s),Ne("time")]:[s,a.id,t(n,r),Ne("time")]}function As(t,e,n,r,i){const[s,o,u]=i.reduce((a,d)=>{const[c,f,l]=a,[p,y,b]=zn(t,e,c,f,d);return[p,y,[...l,b]]},[n,r,[]]);return[s,o,u]}function Lt(t,e,n,r,i,s){const o=i.slice(0,i.length-1),u=i[i.length-1],[a,d,c]=As(t,e,n,r,o),f=Os(t,e,a,d,u,s);return c.concat([f])}function Es(t,e){return e?[e].concat(t):t}function ks([t,e]){return t==="or"&&Array.isArray(e)}function js([t,e]){return t==="and"&&Array.isArray(e)}function Cs(t,e,n){return(r,i)=>{const s=t(r,i);return e==s?s:`${s}-${n}`}}function qn(t,e,n,r,i,s){const o=t(r,i),u=s.map((a,d)=>{const c=Cs(t,o,d);return Qn(c,n,r,i,a)});return{[e]:{patterns:u,joinSym:o}}}function Is(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function Wn(t,e,n,r,i){return Is(i).map(s=>Lt(t,e,n,r,s,{$isNull:!0}))}function Qn(t,e,n,r,i){return Object.entries(i).flatMap(([s,o])=>{if(ks([s,o]))return qn(t,"or",e,n,r,o);if(js([s,o]))return qn(t,"and",e,n,r,o);if(s==="$entityIdStartsWith")return[];const u=s.split(".");if(o!=null&&o.hasOwnProperty("$ne")&&(o=Object.assign(Object.assign({},o),{$not:o.$ne}),delete o.$ne),o!=null&&o.hasOwnProperty("$not")){const a=Lt(t,e,n,r,u,o),d=Wn(t,e,n,r,u);return[{or:{patterns:[a,...d],joinSym:t(n,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&u.length>1?[{or:{patterns:Wn(t,e,n,r,u),joinSym:t(n,r)}}]:Lt(t,e,n,r,u,o)})}function Ps(t,e,n,r){const i=nt;return r?Qn(i,t,e,n,r).concat(Kn(i,t,e,n)):Kn(i,t,e,n)}function Ms(t,e,n){return[t(e,n),t("time",n)]}function Rs(t,e,n,r,i,s){const[o,u,a,d,c]=zn(t,e,n,r,i),f=vs(a,t(n,r),s);return[o,u,f,d,c]}function xs(t,e,n,{etype:r,level:i,form:s},o){const u=Object.keys(s).filter(a=>a!=="$");return u.length?Object.entries(o).map(function([d,c]){return u.map(function(p){var y,b,g;const w=!!(e.cardinalityInference&&(!((g=(b=(y=n.linkIndex)===null||y===void 0?void 0:y[r])===null||b===void 0?void 0:b[p])===null||g===void 0)&&g.isSingular));try{const[_,v,A]=Rs(t,n,r,i,p,d),S=Gn(e,n,{etype:_,level:v,form:s[p],join:A}),I=w?S[0]:S;return{[p]:I}}catch(_){if(_ instanceof Ae)return{[p]:w?void 0:[]};throw _}}).reduce(function(p,y){return Object.assign(Object.assign({},p),y)},c)}):Object.values(o)}function Ds(t,e,n){return n==="string"?gs(t,e):t>e?1:-1}function Ke(t,e,n,r,i){return e===r||e==null&&r==null?ys(t,n):r==null?1:e==null?-1:Ds(e,r,i)}function rt([t,e],[n,r],i){return Ke(t,e,n,r,i)}function Ft(t){return t==null?t:new Date(t).getTime()}function $s(t,e,n,r){var i;const[s,o,u,a]=t,d=n==="desc"?1:-1;if(((i=e["forward-identity"])===null||i===void 0?void 0:i[2])==="id")return rt(r,[s,a],null)===d;const[c,f]=r,l=e["checked-data-type"],p=l==="date"?Ft(f):f,y=l==="date"?Ft(u):u;return rt([c,p],[s,y],l)===d}function Us(t,e){const n=e[1];return t.getAttr(n)}function Ls(t,e,n){const r=Object.keys(n)[0];return F(t,e,r)}function Fs(t,e,n,r){if(n)return Us(t,n);if(r)return Ls(t,e,r)}function Ns(t,e,n){var r,i;if(!Array.isArray(n.fields))return Yi(t,e);const s=new Map;for(const o of n.fields){const u=F(t,e,o),a=(r=u==null?void 0:u["forward-identity"])===null||r===void 0?void 0:r[2];a&&Rt(u)&&s.set(a,u)}if(!s.has("id")){const o=F(t,e,"id"),u=(i=o==null?void 0:o["forward-identity"])===null||i===void 0?void 0:i[2];u&&s.set(u,o)}return s}function Ks(t,e,{etype:n,pageInfo:r,dq:i,form:s}){var o,u;const a=(o=s==null?void 0:s.$)===null||o===void 0?void 0:o.order,d=Bn(s),c=zs(s);let f=us(t,i);const l=r==null?void 0:r["start-cursor"],p=Fs(e,n,l,a);if(p&&((u=p==null?void 0:p["forward-identity"])===null||u===void 0?void 0:u[2])!=="id"){const g=p["checked-data-type"]==="date",w=p.id;f=f.map(([_])=>{var v,A,S,I,U;let D=(U=(I=(S=(A=(v=t.eav.get(_))===null||v===void 0?void 0:v.get(w))===null||A===void 0?void 0:A.values())===null||S===void 0?void 0:S.next())===null||I===void 0?void 0:I.value)===null||U===void 0?void 0:U[2];return g&&(D=Ft(D)),[_,D]})}f.sort(c==="asc"?function(w,_){return rt(w,_,p==null?void 0:p["checked-data-type"])}:function(w,_){return rt(_,w,p==null?void 0:p["checked-data-type"])});let y={};const b=Ns(e,n,i);for(const g of f){const[w]=g;if(y[w]||!d&&l&&p&&$s(l,p,c,g))continue;const _=Hi(t,b,w);_&&(y[w]=_)}return y}function zs(t){var e;const n=(e=t.$)===null||e===void 0?void 0:e.order;return n&&n[Object.keys(n)[0]]||"asc"}function Bn(t){var e,n,r;const i=(e=t.$)===null||e===void 0?void 0:e.offset,s=(n=t.$)===null||n===void 0?void 0:n.before,o=(r=t.$)===null||r===void 0?void 0:r.after;return!i&&!s&&!o}function Vs(t,e,{etype:n,level:r,form:i,join:s,pageInfo:o}){var u,a,d,c,f;if(!Bn(i)&&(!o||!o["start-cursor"]))return[];const l=Es(Ps(e,n,r,(u=i.$)===null||u===void 0?void 0:u.where),s),p=Ms(nt,n,r),y=(a=i.$)===null||a===void 0?void 0:a.fields,b=Ks(t,e,{etype:n,pageInfo:o,form:i,dq:{where:l,find:p,fields:y}}),g=((d=i.$)===null||d===void 0?void 0:d.limit)||((c=i.$)===null||c===void 0?void 0:c.first)||((f=i.$)===null||f===void 0?void 0:f.last);if(g!=null){r>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const w=Object.entries(b);return w.length<=g?b:Object.fromEntries(w.slice(0,g))}return b}function qs(t,e,n){try{return Vs(t,e,n)}catch(r){if(r instanceof Ae)return{};throw r}}function Gn(t,e,n){const r=qs(t,e,n);return xs(nt,t,e,n,r)}function Ws(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function Hn({store:t,attrsStore:e,pageInfo:n,aggregate:r},i){const o={data:Object.keys(i).reduce(function(a,d){return r!=null&&r[d]||d==="$$ruleParams"||(a[d]=Gn(t,e,{etype:d,form:i[d],level:0,pageInfo:n==null?void 0:n[d]})),a},{})};return n&&(o.pageInfo=Ws(n)),r&&(o.aggregate=r),o}function Qs(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Bs=Qs();function Nt(t,e,n){const r={__etype:t,__ops:n};return new Proxy(r,{get:(i,s)=>{if(s==="__ops")return n;if(s==="__etype")return t;if(Bs.has(s))return(o,u)=>Nt(t,e,[...n,u?[s,t,e,o,u]:[s,t,e,o]])}})}function it(t){return t.startsWith("lookup__")}function Yn(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function Gs(t){return new Proxy({__etype:t},{get(e,n){if(n==="__etype")return t;const r=n;return it(r)?Nt(t,Yn(r),[]):Nt(t,r,[])}})}function Kt(){return new Proxy({},{get(t,e){return Gs(e)}})}Kt();function Hs(t){return t.__ops}function Ys(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,i=[];for(const o of e){const u=n[o];if(u)i.push(u);else if(Array.isArray(o)&&o.length==2&&n[o[0]]){const[a,d]=o;i.push([n[a],d])}else i.push(o)}const[s]=e;if((s==="add-triple"||s==="retract-triple")&&r.has(e[2])){const o=i[1];i[1]=i[3],i[3]=o}return i}function Js(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function Zs(t,e,n){return n.indexOf(".")!==-1&&!F(t,e,n)}function zt(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function Xs(t,e,n){if(!Zs(t,e,n))return F(t,e,n);const r=zt(n),i=F(t,e,r)||_e(t,e,r);if(i&&i["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return i}function Vt(t){return typeof t=="string"&&!it(t)?null:typeof t=="string"&&it(t)?Yn(t):Js(t)}function G(t,e,n){const r=Vt(n);if(r===null)return n;const[i,s]=r,o=Xs(t,e,i);if(!o||!o["unique?"])throw new Error(`${i} is not a unique attribute.`);return[o.id,s]}function Jn(t,e,n,r){var i;const s=G(t,e,n);return Array.isArray(s)?[["add-triple",s,(i=F(t,e,"id"))===null||i===void 0?void 0:i.id,s]].concat(r):r}function eo({attrsStore:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const u=Array.isArray(o)?o:[o],a=F(t,e,s),d=_e(t,e,s);return u.map(c=>a?["add-triple",G(t,e,n),a.id,G(t,a["reverse-identity"][1],c)]:["add-triple",G(t,d["forward-identity"][1],c),d==null?void 0:d.id,G(t,e,n)])});return Jn(t,e,n,i)}function to({attrsStore:t},[e,n,r]){const i=Object.entries(r).flatMap(([s,o])=>{const u=Array.isArray(o)?o:[o],a=F(t,e,s),d=_e(t,e,s);return u.map(c=>a?["retract-triple",G(t,e,n),a.id,G(t,a["reverse-identity"][1],c)]:["retract-triple",G(t,d["forward-identity"][1],c),d.id,G(t,e,n)])});return Jn(t,e,n,i)}function no(t,e,n,r){var i;if(Array.isArray(r)){const[s,o]=r;for(const u of t||[]){const a=u==null?void 0:u.aev.get(s);if(a){for(const[d,c,f]of B(a,2))if(f===o)return!0}}}else for(const s of t||[]){const o=s==null?void 0:s.eav.get(r);if(o){for(const u of o.keys())if(((i=e.getAttr(u))===null||i===void 0?void 0:i["forward-identity"][1])==n)return!0}}return!1}function Zn({stores:t,attrsStore:e},[n,r,i,s]){return(s==null?void 0:s.upsert)===!1?{mode:"update"}:(s==null?void 0:s.upsert)===!0?null:no(t,e,n,r)?{mode:"update"}:null}function ro(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,u=It(s),a=G(n,r,i);return[["id",a]].concat(Object.entries(u)).map(([c,f])=>{const l=F(n,r,c);return l["checked-data-type"]==="date"&&t.useDateObjects&&(f=et(f)),["add-triple",a,l.id,f,{mode:"create"}]})}function io(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,u=It(s),a=G(n,r,i),d=Zn(t,[r,a,s,o]);return[["id",a]].concat(Object.entries(u)).map(([f,l])=>{const p=F(n,r,f);return p["checked-data-type"]==="date"&&t.useDateObjects&&(l=et(l)),["add-triple",a,p.id,l,...d?[d]:[]]})}function so({attrsStore:t},[e,n]){return[["delete-entity",G(t,e,n),e]]}function oo(t,e){const{attrsStore:n}=t,[r,i,s,o]=e,u=It(s),a=G(n,r,i),d=Zn(t,[r,a,s,o]),c=Object.entries(u).map(([l,p])=>{const y=F(n,r,l);return["deep-merge-triple",a,y.id,p,...d?[d]:[]]});return[["add-triple",a,F(n,r,"id").id,a,...d?[d]:[]]].concat(c)}function uo({attrsStore:t},[e,n,r]){return[["rule-params",G(t,e,n),e,r]]}function ao(t){const[e,n,r,i,s]=t;if(!i)return t;const o=Object.assign({},i);return delete o.id,[e,n,r,o,...s?[s]:[]]}function co(t,e){const[n,...r]=ao(e);switch(n){case"merge":return oo(t,r);case"create":return ro(t,r);case"update":return io(t,r);case"link":return eo(t,r);case"unlink":return to(t,r);case"delete":return so(t,r);case"ruleParams":return uo(t,r);default:throw new Error(`unsupported action ${n}`)}}function fo(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function lo(t,e,n){var r,i;const s=(i=(r=t.entities[e])===null||r===void 0?void 0:r.attrs)===null||i===void 0?void 0:i[n];if(n==="id")return null;if(!s)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:o,indexed:u}=s==null?void 0:s.config,a=fo(s==null?void 0:s.valueType);return{"index?":u,"unique?":o,"checked-data-type":a}}function st(t,e,n,r){const i=t?lo(t,e,n):null,s=z(),u=[z(),e,n];return Object.assign(Object.assign({id:s,"forward-identity":u,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}function ho(t,e,n){return Object.values(t.links).find(s=>s.forward.on===e&&s.forward.label===n||s.reverse.on===e&&s.reverse.label===n)}function po(t,e,n){const r=ho(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:i,reverse:s}=r;return{"forward-identity":[z(),i.on,i.label],"reverse-identity":[z(),s.on,s.label],cardinality:i.has==="one"?"one":"many","unique?":s.has==="one","on-delete":i.onDelete,"on-delete-reverse":s.onDelete}}function Xn(t,e,n,r){const i=t?po(t,e,n):null,s=z(),o=[z(),e,n],u=[z(),n,e];return Object.assign(Object.assign({id:s,"forward-identity":o,"reverse-identity":u,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0},i||{}),r||{})}const yo=new Set(["create","update","merge","link","unlink"]),bo=new Set(["link","unlink"]),_o=new Set(["create","update","merge"]),go=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),qt={"unique?":!0,"index?":!0},To=Object.assign(Object.assign({},qt),{cardinality:"one"});function wo(t){const e=[],[n,r,i,s]=t;if(!go.has(n))return e;const o=Vt(i);if(o&&e.push({etype:r,lookupPair:o}),n==="link")for(const[u,a]of Object.entries(s)){const d=Array.isArray(a)?a:[a];for(const c of d){const f=Vt(c);f&&e.push({etype:r,lookupPair:f,linkLabel:u})}}return e}function mo({attrsStore:t,schema:e},n){var r,i;const s=new Set,o=[],u=[];function a(y,b){return F(t,y,b)||o.find(g=>g["forward-identity"][1]===y&&g["forward-identity"][2]===b)}function d(y,b){return _e(t,y,b)||o.find(g=>{var w,_;return((w=g["reverse-identity"])===null||w===void 0?void 0:w[1])===y&&((_=g["reverse-identity"])===null||_===void 0?void 0:_[2])===b})}function c(y){o.push(y),u.push(["add-attr",y]),s.add(y.id)}function f(y){y&&"isUnsynced"in y&&y.isUnsynced&&!s.has(y.id)&&(o.push(y),u.push(["add-attr",y]),s.add(y.id))}function l(y,b){return b.indexOf(".")!==-1&&!a(y,b)}function p(y,b){const g=a(y,b),w=d(y,b);f(g),f(w),!g&&!w&&c(Xn(e,y,b,To))}for(const y of n)for(const{etype:b,lookupPair:g,linkLabel:w}of wo(y)){const _=g[0];if(w){p(b,w);const v=a(b,w),A=d(b,w);f(v),f(A);const S=((r=v==null?void 0:v["reverse-identity"])===null||r===void 0?void 0:r[1])||((i=A==null?void 0:A["forward-identity"])===null||i===void 0?void 0:i[1])||w;if(l(S,_))p(S,zt(_));else{const I=a(S,_);I||c(st(e,S,_,qt)),f(I)}}else if(l(b,_))p(b,zt(_));else{const v=a(b,_);v||c(st(e,b,_,qt)),f(v)}}for(const y of n){const[b,g,w,_]=y;if(yo.has(b)){const v=a(g,"id");f(v),v||c(st(e,g,"id",{"unique?":!0}));for(const A of Object.keys(_)){const S=a(g,A);if(f(S),_o.has(b)&&(S||c(st(e,g,A,A==="id"?{"unique?":!0}:null))),bo.has(b)){const I=d(g,A);!S&&!I&&c(Xn(e,g,A)),f(I)}}}}if(o.length){const y=Object.assign({},t.attrs);for(const b of o)y[b.id]=b;return[new be(y,t.linkIndex),u]}return[t,u]}function vo(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(a=>Hs(a)),[i,s]=mo(t,r),o=Object.assign(Object.assign({},t),{attrsStore:i}),u=r.flatMap(a=>co(o,a));return[...s,...u]}var ie=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};function er(t,e){typeof requestIdleCallback>"u"?t():requestIdleCallback(t,{timeout:e})}const ze="__meta";class So{constructor(e,n){}}class Wt{constructor(e){var n,r;this._subs=[],this._nextSave=null,this._nextGc=null,this._pendingSaveKeys=new Set,this._loadedKeys=new Set,this._version=0,this._meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0},this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=(n=e.saveThrottleMs)!==null&&n!==void 0?n:100,this._idleCallbackMaxWaitMs=(r=e.idleCallbackMaxWaitMs)!==null&&r!==void 0?r:1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}_initMeta(){return ie(this,void 0,void 0,function*(){var e,n,r;this._meta.loadingPromise&&(yield this._meta.loadingPromise);try{const i=this._persister.getItem(ze);this._meta.loadingPromise=i;const s=yield i;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const o=(n=(e=this._meta.value)===null||e===void 0?void 0:e.objects)!==null&&n!==void 0?n:{},u=s??{},a=(r=u.objects)!==null&&r!==void 0?r:{};this._meta.value=Object.assign(Object.assign({},u),{objects:Object.assign(Object.assign({},o),a)})}catch(i){this._meta.error=i,this._meta.attempts++,this._meta.loadingPromise=null}})}_getMeta(){return ie(this,void 0,void 0,function*(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(yield this._meta.loadingPromise,this._meta.value):(this._initMeta(),yield this._meta.loadingPromise,this._meta.value)})}_refreshMeta(){return ie(this,void 0,void 0,function*(){return yield this._initMeta(),this._meta.value})}_preloadEntries(e){return ie(this,void 0,void 0,function*(){const n=yield this.waitForMetaToLoad();if(!n)return;const r=Object.entries(n.objects);r.sort(([i,s],[o,u])=>u.updatedAt-s.updatedAt);for(const[i]of r.slice(0,e))this._loadKey(i)})}_getFromStorage(e){return ie(this,void 0,void 0,function*(){try{const n=yield this._persister.getItem(e);return n&&this.parse(e,n)}catch(n){return console.error(`Unable to read from storage for key=${e}`,n),null}})}waitForKeyToLoad(e){return ie(this,void 0,void 0,function*(){return this._loadedKeys.has(e)?this.currentValue[e]:(yield this._loadingKeys[e]||this._loadKey(e),this.currentValue[e])})}waitForMetaToLoad(){return ie(this,void 0,void 0,function*(){return this._getMeta()})}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}_loadKey(e){return ie(this,void 0,void 0,function*(){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const n=this._getFromStorage(e);this._loadingKeys[e]=n;const r=yield n;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const i=this._merge(e,r,this.currentValue[e]);i&&(this.currentValue[e]=i)}this.onKeyLoaded&&this.onKeyLoaded(e)})}_writeToStorage(e){var n,r;const i=[],s=e==null?void 0:e.skipGc;if(this._meta.isLoading){const p=new Promise((y,b)=>{var g;setTimeout(()=>this._enqueuePersist(e?Object.assign(Object.assign({},e),{attempts:(e.attempts||0)+1}):{attempts:1}).then(y).catch(b),10+((g=e==null?void 0:e.attempts)!==null&&g!==void 0?g:0)*1e3)});return i.push(p),Promise.all(i).then(y=>y.reduce((b,g)=>b+g,0))}const o=this._meta.value;if(!o)return Promise.resolve(0);const u=[],a=[];for(const p of this._pendingSaveKeys)p in this.currentValue?a.push(p):(u.push(p),delete o.objects[p]);for(const p of u){const y=this._persister.removeItem(p);i.push(y.then(()=>1)),this._loadedKeys.delete(p),this._pendingSaveKeys.delete(p)}const d=[],c=[[ze,o]],f=(n=o.objects)!==null&&n!==void 0?n:{};o.objects=f;for(const p of a)if(this._loadedKeys.has(p)){const y=this.serialize(p,this.currentValue[p]);c.push([p,y]);const b=this._objectSize(y),g=(r=f[p])!==null&&r!==void 0?r:{createdAt:Date.now(),updatedAt:Date.now(),size:b};g.updatedAt=Date.now(),g.size=b,f[p]=g,this._pendingSaveKeys.delete(p)}else d.push(p);const l=this._persister.multiSet(c);i.push(l.then(()=>1));for(const p of d){const y=this._loadKey(p).then(()=>this._enqueuePersist(e));i.push(y)}return s||this.gc(),Promise.all(i).then(p=>p.reduce((y,b)=>y+b,0))}flush(){return ie(this,void 0,void 0,function*(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0})}_gc(){return ie(this,void 0,void 0,function*(){if(!this._gcOpts)return;const e=new Set(yield this._persister.getAllKeys());e.delete(ze);const n=new Set(Object.keys(this.currentValue));for(const l of Object.keys(this._loadingKeys))n.add(l);for(const l of this._loadedKeys)n.add(l);const r=yield this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const i=[],s={gcOpts:this._gcOpts,keys:e,sacredKeys:n,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const l of e)n.has(l)||l in r.objects||(this._log.info("Lost track of key in meta",l),i.push(this._persister.removeItem(l)),s.removed.push(l),s.removedMissingCount++);const o=Date.now();for(const[l,p]of Object.entries(r.objects))!n.has(l)&&p.updatedAt<o-this._gcOpts.maxAgeMs&&(i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedOldCount++);const u=Object.entries(r.objects);u.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const a=u.filter(([l])=>!n.has(l));if(u.length>this._gcOpts.maxEntries)for(const[l]of a.slice(0,u.length-this._gcOpts.maxEntries))i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedThresholdCount++;const d=Object.entries(r.objects);d.sort(([l,p],[y,b])=>p.updatedAt-b.updatedAt);const c=d.filter(([l])=>!n.has(l));let f=d.reduce((l,[p,y])=>l+y.size,0);for(;f>0&&f>this._gcOpts.maxSize&&c.length;){const[[l,p]]=c.splice(0,1);f-=p.size,i.push(this._persister.removeItem(l)),delete r.objects[l],s.removed.push(l),s.removedSizeCount++}for(const l of Object.keys(r.objects))!e.has(l)&&!n.has(l)&&delete r.objects[l];return(s.removed.length||s.metaRemoved.length)&&i.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",s),yield Promise.all(i),s})}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{er(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((n,r)=>{if(this._nextSave){n(0);return}this._nextSave=setTimeout(()=>{er(()=>{this._nextSave=null,this._writeToStorage(e).then(n).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[n,r]=Ze(this.currentValue,e,{enablePatches:!0});for(const i of r){const s=i.path[0];s&&typeof s=="string"&&(this._pendingSaveKeys.add(s),this._loadedKeys.has(s)||this._loadKey(s))}this.currentValue=n,this._enqueuePersist();for(const i of this._subs)i(this.currentValue);return n}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}var ae=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};const Oo=6,Ao=["kv","querySubs","syncSubs"];function Eo(t){return function(n){console.error("Error in IndexedDB event",{source:t,event:n})}}function ko(t){return ae(this,void 0,void 0,function*(){return new Promise(e=>{const n=indexedDB.open(t);n.onerror=r=>{e(null)},n.onsuccess=r=>{const s=r.target.result;e(s)},n.onupgradeneeded=r=>{var i;(i=r.target.transaction)===null||i===void 0||i.abort(),e(null)}})})}function jo(t,e,n){return ae(this,void 0,void 0,function*(){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const i=new Set;return new Promise((s,o)=>{var u,a,d,c;const f={};for(const[y,b]of Object.entries(r)){const g=typeof b=="string"?JSON.parse(b):b;if(g.lastAccessed){const _={createdAt:g.lastAccessed,updatedAt:g.lastAccessed,size:(c=(d=(a=(u=g.result)===null||u===void 0?void 0:u.store)===null||a===void 0?void 0:a.triples)===null||d===void 0?void 0:d.length)!==null&&c!==void 0?c:0};f[y]=_}const w=n.put(g,y);i.add(w)}const l={objects:f},p=n.put(l,ze);i.add(p);for(const y of i)y.onsuccess=()=>{i.delete(y),i.size===0&&s()},y.onerror=b=>{o(b)}})})}function tr(t,e,n){return ae(this,void 0,void 0,function*(){const r=n.put(e,t);return new Promise((i,s)=>{r.onsuccess=()=>i(),r.onerror=o=>s(o)})})}function Co(t,e){return ae(this,void 0,void 0,function*(){const n=yield ko(`instant_${t}_5`);if(!n)return;const r=yield new Promise((c,f)=>{const y=n.transaction(["kv"],"readonly").objectStore("kv").openCursor();y.onerror=g=>{f(g)};const b=[];y.onsuccess=()=>{const g=y.result;if(g){const w=g.key,_=g.value;b.push([w,_]),g.continue()}else c(b)},y.onerror=g=>{f(g)}}),i=e.transaction(["kv","querySubs"],"readwrite"),s=i.objectStore("kv"),o=i.objectStore("querySubs"),u=[],a={objects:{}};for(const[c,f]of r)switch(c){case"querySubs":{const l=jo(c,f,o);u.push(l);break}default:{const l=tr(c,f,s);u.push(l);const p={createdAt:Date.now(),updatedAt:Date.now(),size:0};a.objects[c]=p;break}}const d=tr(ze,a,s);u.push(d),yield Promise.all(u),yield new Promise((c,f)=>{i.oncomplete=l=>c(l),i.onerror=l=>f(l),i.onabort=l=>f(l)})})}const nr=new Map;class rr extends So{constructor(e,n){super(e,n),this.dbName=`instant_${e}_${Oo}`,this._storeName=n,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{let r=!1;const i=indexedDB.open(this.dbName,1);i.onerror=s=>{n(s)},i.onsuccess=s=>{const u=s.target.result;if(r){const a=Co(this._appId,u).catch(d=>{Eo("Error upgrading store from version 5 to 6.")(d)});nr.set(this.dbName,a),a.then(()=>e(u)).catch(()=>e(u))}else{const a=nr.get(this.dbName);a?a.then(()=>e(u)).catch(()=>e(u)):e(u)}},i.onupgradeneeded=s=>{r=!0,this._upgradeStore(s)}})}_upgradeStore(e){const r=e.target.result;for(const i of Ao)r.objectStoreNames.contains(i)||r.createObjectStore(i)}getItem(e){return ae(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const u=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);u.onerror=a=>{i(a)},u.onsuccess=a=>{u.result?r(u.result):r(null)}})})}setItem(e,n){return ae(this,void 0,void 0,function*(){const r=yield this._dbPromise;return new Promise((i,s)=>{const a=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);a.onerror=d=>{s(d)},a.onsuccess=d=>{i()}})})}multiSet(e){return ae(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const s=n.transaction([this._storeName],"readwrite"),o=s.objectStore(this._storeName),u=new Set;for(const[a,d]of e){const c=o.put(d,a);u.add(c)}for(const a of u)a.onerror=d=>{s.abort(),i(d)},a.onsuccess=d=>{u.delete(a),u.size===0&&r()}})})}removeItem(e){return ae(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,i)=>{const u=n.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);u.onerror=a=>{i(a)},u.onsuccess=a=>{r()}})})}getAllKeys(){return ae(this,void 0,void 0,function*(){const e=yield this._dbPromise;return new Promise((n,r)=>{const o=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();o.onerror=u=>{r(u)},o.onsuccess=u=>{n(o.result.filter(a=>typeof a=="string"))}})})}}var Io=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};class ir{static getIsOnline(){return Io(this,void 0,void 0,function*(){return navigator.onLine})}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}class Ee extends Error{constructor(e,n){super(e),this.hint=n;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,Ee),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}var Po=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};class ot extends Ee{constructor(e){var n;const r=((n=e.body)===null||n===void 0?void 0:n.message)||`API Error (${e.status})`;super(r,e.body.hint);const i=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,i),Error.captureStackTrace&&Error.captureStackTrace(this,ot),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}function ne(t,e){return Po(this,void 0,void 0,function*(){const n=yield fetch(t,e),r=yield n.json();return n.status===200?Promise.resolve(r):Promise.reject(new ot({status:n.status,body:r}))})}var ke=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};function Mo({apiURI:t,appId:e,email:n}){return ne(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}function Ro(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n,email:r,code:i,refreshToken:s}){return yield ne(`${e}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(Object.assign({"app-id":n,email:r,code:i},s?{"refresh-token":s}:{}))})})}function xo(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ne(`${e}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n,"refresh-token":r})})})}function Do(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n}){return yield ne(`${e}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n})})})}function sr(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n,code:r,codeVerifier:i,refreshToken:s}){return yield ne(`${e}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,code:r,code_verifier:i,refresh_token:s})})})}function $o(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n,nonce:r,idToken:i,clientName:s,refreshToken:o}){return yield ne(`${e}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,nonce:r,id_token:i,client_name:s,refresh_token:o})})})}function Uo(t){return ke(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield ne(`${e}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,refresh_token:r})})})}var Ve=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};function Lo(t){return Ve(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,file:i,refreshToken:s,contentType:o,contentDisposition:u}){const a={app_id:n,path:r,authorization:`Bearer ${s}`,"content-type":o||i.type};return u&&(a["content-disposition"]=u),yield ne(`${e}/storage/upload`,{method:"PUT",headers:a,body:i})})}function Fo(t){return Ve(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ne(`${e}/storage/files?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}function No(t){return Ve(this,arguments,void 0,function*({apiURI:e,appId:n,fileName:r,refreshToken:i,metadata:s={}}){const{data:o}=yield ne(`${e}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${i}`},body:JSON.stringify({app_id:n,filename:r})});return o})}function Ko(t,e){return Ve(this,void 0,void 0,function*(){return(yield fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok})}function zo(t){return Ve(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:i}){const{data:s}=yield ne(`${e}/storage/signed-download-url?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${i}`}});return s})}let Qt=!1,or=!1,ur=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(Qt=!!window.localStorage.getItem("devBackend"),or=!!window.localStorage.getItem("__instantLogging"),ur=!!window.localStorage.getItem("__devtoolLocalDash"));function ar(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function Vo(t,e,n){var r,i;const s={peers:{}};if(e&&"user"in e?e.user:!0){const u=ar((r=t.user)!==null&&r!==void 0?r:{},e==null?void 0:e.keys);s.user=Object.assign(Object.assign({},u),{peerId:n})}for(const u of Object.keys((i=t.peers)!==null&&i!==void 0?i:{})){const a=(e==null?void 0:e.peers)===void 0,d=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(u));if(a||d){const c=ar(t.peers[u],e==null?void 0:e.keys);s.peers[u]=Object.assign(Object.assign({},c),{peerId:u})}}return s}function qo(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!vn(t.user,e.user))||!mn(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!vn(t.peers[r],e.peers[r]))return!0;return!1}class cr{constructor(){this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function dr(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":i}=r,{"join-rows":s}=i;for(const o of s)for(const u of o)e.push(u);dr(n["child-nodes"],e)})}function fr(t){const e=[];return dr(t,e),e}function lr(t){return Object.values(t.links).reduce((e,n)=>{var r,i,s,o;return(r=e[s=n.forward.on])!==null&&r!==void 0||(e[s]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},(i=e[o=n.reverse.on])!==null&&i!==void 0||(e[o]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const hr="v0.22.96";function Wo(t,e){return{info:t?(...n)=>console.info(...n,e()):()=>{},debug:t?(...n)=>console.debug(...n,e()):()=>{},error:t?(...n)=>console.error(...n,e()):()=>{}}}class ce{constructor(e,n,r,i={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.isIndexed=r,this.config=i,this.metadata={}}clientRequired(){return new ce(this.valueType,!1,this.isIndexed,this.config)}optional(){return new ce(this.valueType,!1,this.isIndexed,this.config)}unique(){return new ce(this.valueType,this.required,this.isIndexed,Object.assign(Object.assign({},this.config),{unique:!0}))}indexed(){return new ce(this.valueType,this.required,!0,Object.assign(Object.assign({},this.config),{indexed:!0}))}}class R extends Error{constructor(e,n){const r=n?`At path '${n}': ${e}`:e;super(r),this.name="QueryValidationError"}}const pr=["where","order","limit","last","first","offset","after","before","fields","aggregate"],Qo=t=>t.valueType||"unknown",yr=(t,e,n=!1)=>{if(n||t==null)return!0;switch(e){case"string":return typeof t=="string";case"number":return typeof t=="number"&&!isNaN(t);case"boolean":return typeof t=="boolean";case"date":return t instanceof Date||typeof t=="string"||typeof t=="number";default:return!0}},Bo=(t,e,n,r,i,s,o)=>{const u=s.valueType==="json",a=(d,c,f)=>{if(!yr(f,c,u))throw new R(`Invalid value for operator '${d}' on attribute '${r}' in entity '${i}'. Expected ${c}, but received: ${typeof f}`,o)};switch(t){case"in":case"$in":if(!Array.isArray(e))throw new R(`Operator '${t}' for attribute '${r}' in entity '${i}' must be an array, but received: ${typeof e}`,o);for(const d of e)a(t,n,d);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":a(t,n,e);break;case"$like":case"$ilike":if(a(t,"string",e),t==="$ilike"&&!s.isIndexed)throw new R(`Operator '${t}' can only be used with indexed attributes, but '${r}' in entity '${i}' is not indexed`,o);break;case"$isNull":a(t,"boolean",e);break;default:throw new R(`Unknown operator '${t}' for attribute '${r}' in entity '${i}'`,o)}},je=(t,e,n,r,i)=>{const s=Qo(n),o=n.valueType==="json";if(typeof t=="object"&&t!==null&&!Array.isArray(t)){if(o)return;const a=t;for(const[d,c]of Object.entries(a))Bo(d,c,s,e,r,n,`${i}.${d}`)}else if(!yr(t,s,o))throw new R(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${s}, but received: ${typeof t}`,i)},Go=(t,e,n,r,i)=>{const s=t.split(".");if(s.length<2)throw new R(`Invalid dot notation path '${t}'. Must contain at least one dot.`,i);let o=n;for(let c=0;c<s.length-1;c++){const f=s[c],l=r.entities[o];if(!l)throw new R(`Entity '${o}' does not exist in schema while traversing dot notation path '${t}'.`,i);const p=l.links[f];if(!p){const y=Object.keys(l.links);throw new R(`Link '${f}' does not exist on entity '${o}' in dot notation path '${t}'. Available links: ${y.length>0?y.join(", "):"none"}`,i)}o=p.entityName}const u=s[s.length-1],a=r.entities[o];if(!a)throw new R(`Target entity '${o}' does not exist in schema for dot notation path '${t}'.`,i);if(u==="id"){if(typeof e=="string"&&!Oe(e))throw new R(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${e}`,i);je(e,t,new ce("string",!1,!0),n,i);return}const d=a.attrs[u];if(Object.keys(a.links).includes(u)){if(typeof e=="string"&&!Oe(e))throw new R(`Invalid value for link '${u}' in entity '${o}'. Expected a UUID, but received: ${e}`,i);je(e,t,new ce("string",!1,!0),n,i);return}if(!d){const c=Object.keys(a.attrs);throw new R(`Attribute '${u}' does not exist on entity '${o}' in dot notation path '${t}'. Available attributes: ${c.length>0?c.join(", ")+", id":"id"}`,i)}je(e,t,d,n,i)},br=(t,e,n,r)=>{for(const[i,s]of Object.entries(t)){if(i==="or"||i==="and"){if(Array.isArray(s))for(const d of s)typeof d=="object"&&d!==null&&br(d,e,n,`${r}.${i}[${d}]`);continue}if(i==="id"){je(s,"id",new ce("string",!1,!0),e,`${r}.id`);continue}if(i.includes(".")){Go(i,s,e,n,`${r}.${i}`);continue}const o=n.entities[e];if(!o)continue;const u=o.attrs[i],a=o.links[i];if(!u&&!a){const d=Object.keys(o.attrs),c=Object.keys(o.links);throw new R(`Attribute or link '${i}' does not exist on entity '${e}'. Available attributes: ${d.length>0?d.join(", "):"none"}. Available links: ${c.length>0?c.join(", "):"none"}`,`${r}.${i}`)}if(u)je(s,i,u,e,`${r}.${i}`);else if(a){if(typeof s=="string"&&!Oe(s))throw new R(`Invalid value for link '${i}' in entity '${e}'. Expected a UUID, but received: ${s}`,`${r}.${i}`);const d=new ce("string",!1,!0);je(s,i,d,e,`${r}.${i}`)}}},Ho=(t,e,n,r,i=0)=>{for(const o of Object.keys(t))if(!pr.includes(o))throw new R(`Invalid query parameter '${o}' in $ object. Valid parameters are: ${pr.join(", ")}. Found: ${o}`,r);const s=["offset","before","after","first","last"];for(const o of s)if(t[o]!==void 0&&i>0)throw new R(`'${o}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(t.where&&n){if(typeof t.where!="object"||t.where===null)throw new R(`'where' clause must be an object in entity '${e}', but received: ${typeof t.where}`,r?`${r}.where`:void 0);br(t.where,e,n,r?`${r}.where`:"where")}},_r=(t,e,n,r,i=0)=>{var s;if(!t||typeof t!="object")throw new R(`Query part for entity '${e}' must be an object, but received: ${typeof t}`,r);for(const o of Object.keys(t))if(o!=="$"){if(n&&!(o in n.entities[e].links)){const a=Object.keys(n.entities[e].links);throw new R(`Link '${o}' does not exist on entity '${e}'. Available links: ${a.length>0?a.join(", "):"none"}`,`${r}.${o}`)}const u=t[o];if(typeof u=="object"&&u!==null){const a=(s=n==null?void 0:n.entities[e].links[o])===null||s===void 0?void 0:s.entityName;a&&_r(u,a,n,`${r}.${o}`,i+1)}}else{const u=t[o];if(typeof u!="object"||u===null)throw new R(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof u}`,`${r}.$`);Ho(u,e,n,`${r}.$`,i)}},gr=(t,e)=>{if(typeof t!="object"||t===null)throw new R(`Query must be an object, but received: ${typeof t}${t===null?" (null)":""}`);if(Array.isArray(t))throw new R(`Query must be an object, but received: ${typeof t}`);const n=t;for(const r of Object.keys(n)){if(Array.isArray(t[r]))throw new R(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new R(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const i=Object.keys(e.entities);throw new R(`Entity '${r}' does not exist in schema. Available entities: ${i.length>0?i.join(", "):"none"}`,r)}_r(n[r],r,e,r,0)}}},Tr=t=>typeof t!="string"?!1:it(t)?!0:Oe(t);class Z extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const wr=t=>t.length>0?t.join(", "):"none",Yo=(t,e)=>new Z(`Entity '${t}' does not exist in schema. Available entities: ${wr(e)}`),mr={string:t=>typeof t=="string",number:t=>typeof t=="number"&&!isNaN(t),boolean:t=>typeof t=="boolean",date:t=>t instanceof Date||typeof t=="string"||typeof t=="number",json:()=>!0},Jo=(t,e)=>{var n,r;return t==null?!0:(r=(n=mr[e.valueType])===null||n===void 0?void 0:n.call(mr,t))!==null&&r!==void 0?r:!1},vr=(t,e)=>{const n=e.entities[t];if(!n)throw Yo(t,Object.keys(e.entities));return n},Bt=(t,e,n)=>{const r=vr(t,n);if(typeof e!="object"||e===null)throw new Z(`Arguments for data operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(i==="id")continue;const o=r.attrs[i];if(o&&!Jo(s,o))throw new Z(`Invalid value for attribute '${i}' in entity '${t}'. Expected ${o.valueType}, but received: ${typeof s}`)}},Sr=(t,e,n)=>{const r=vr(t,n);if(typeof e!="object"||e===null)throw new Z(`Arguments for link operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[i,s]of Object.entries(e)){if(!r.links[i]){const u=Object.keys(r.links);throw new Z(`Link '${i}' does not exist on entity '${t}'. Available links: ${wr(u)}`)}if(s!=null){if(Array.isArray(s)){for(const u of s)if(!Tr(u))throw new Z(`Invalid entity ID in link '${i}' for entity '${t}'. Expected a UUID or a lookup, but received: ${u}`)}else if(!Tr(s))throw new Z(`Invalid UUID in link '${i}' for entity '${t}'. Expected a UUID, but received: ${s}`)}}},Zo={create:Bt,update:Bt,merge:Bt,link:Sr,unlink:Sr,delete:()=>{}},Xo=(t,e)=>{if(!e)return;const[n,r,i,s]=t;if(!Array.isArray(i)&&!Oe(i))throw new Z(`Invalid id for entity '${r}'. Expected a UUID, but received: ${i}`);if(typeof r!="string")throw new Z(`Entity name must be a string, but received: ${typeof r}`);const o=Zo[n];o&&s!==void 0&&o(r,s,e)},eu=(t,e)=>{const n=Array.isArray(t)?t:[t];for(const r of n){if(!r||typeof r!="object")throw new Z(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new Z(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const i of r.__ops){if(!Array.isArray(i))throw new Z(`Transaction operation must be an array, but received: ${typeof i}`);Xo(i,e)}}};var Or=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};let Ar=0;class Er{constructor(e){this.type="ws",this.id=`${this.type}_${Ar++}`,this.conn=new WebSocket(e),this.conn.onopen=n=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=n=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(n.data.toString())})},this.conn.onclose=n=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=n=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){var e;return this.conn.readyState===((e=WebSocket.OPEN)!==null&&e!==void 0?e:1)}isConnecting(){var e;return this.conn.readyState===((e=WebSocket.CONNECTING)!==null&&e!==void 0?e:0)}send(e){return this.conn.send(JSON.stringify(e))}}class tu{constructor(e,n){this.type="sse",this.initParams=null,this.sendQueue=[],this.closeFired=!1,this.sseInitTimeout=void 0,this.id=`${this.type}_${Ar++}`,this.url=n,this.ES=e,this.conn=new e(n),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const i=JSON.parse(r.data);if(Array.isArray(i))for(const s of i)this.handleMessage(s);else this.handleMessage(i)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}postMessages(e){return Or(this,void 0,void 0,function*(){var n,r,i;try{(yield fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:(n=this.initParams)===null||n===void 0?void 0:n.machineId,session_id:(r=this.initParams)===null||r===void 0?void 0:r.sessionId,sse_token:(i=this.initParams)===null||i===void 0?void 0:i.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}})}flushQueue(){return Or(this,void 0,void 0,function*(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const n=this.postMessages(e);this.sendPromise=n,n.then(()=>{this.sendPromise=null,this.flushQueue()})})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}var kr=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})};function nu(t,e){const n=t.values;if(n){const r=In(n.attrsStore,null);if(r){for(const i of n.entities||[])i.store.useDateObjects=e,i.store=Cn(r,i.store);n.attrsStore=r}}return t}function ru(t,e){var n;if(e.values){const r=[];for(const i of(n=e.values)===null||n===void 0?void 0:n.entities){const s=jn(i.store);r.push(Object.assign(Object.assign({},i),{store:s}))}return Object.assign(Object.assign({},e),{values:{attrsStore:e.values.attrsStore.toJSON(),entities:r}})}else return e}function iu(t,e,n){var r,i;const s=(r=e==null?void 0:e.state)===null||r===void 0?void 0:r.txId,o=(i=n==null?void 0:n.state)===null||i===void 0?void 0:i.txId;return s&&(!o||s>o)?e:o&&(!s||o>s)?n:e||n}function Gt(t,e,n){return Hn({store:e,attrsStore:n,pageInfo:null,aggregate:null},t.query).data[t.table][0]}function jr(t,e,n,r){var i;const s=(i=F(n,t.table,"id"))===null||i===void 0?void 0:i.id;if(!s)return-1;const o=Se(e.eav,[r,s,r]);return o?o[3]:-1}function Cr(t,e,n){for(const{action:r,triple:i}of n)switch(r){case"added":Rn(t,e,i);break;case"removed":Pn(t,e,i);break}}function su(t,e,n){var r,i,s,o;const u={};for(const{action:a,triple:d}of n){const[c,f,l]=d,p=(i=(r=e.getAttr(f))===null||r===void 0?void 0:r["forward-identity"])===null||i===void 0?void 0:i[2];if(!p)continue;const y=(s=u[c])!==null&&s!==void 0?s:{};u[c]=y;const b=(o=y[p])!==null&&o!==void 0?o:{};switch(a){case"added":b.newValue=l;break;case"removed":b.oldValue===void 0&&(b.oldValue=l);break}y[p]=b}for(const[a,d]of Object.entries(u))for(const[c,{oldValue:f,newValue:l}]of Object.entries(d))f===l&&delete d[c];return u}function ut(t,e){return{[t.table]:e.map(n=>n.entity)}}function ou(t,e){var n;if(t.orderFieldType)return t.orderFieldType;const r=t.orderField==="serverCreatedAt"?"number":(n=F(e(),t.table,t.orderField))===null||n===void 0?void 0:n["checked-data-type"];return t.orderFieldType=r,r}function uu(t,e,n){const r=e;if(t.orderField==="serverCreatedAt"){n.sort(t.orderDirection==="asc"?function(o,u){return Ke(o.entity.id,o.serverCreatedAt,u.entity.id,u.serverCreatedAt,r)}:function(o,u){return Ke(u.entity.id,u.serverCreatedAt,o.entity.id,o.serverCreatedAt,r)});return}const i=t.orderField;n.sort(t.orderDirection==="asc"?function(o,u){return Ke(o.entity.id,o.entity[i],u.entity.id,u.entity[i],r)}:function(o,u){return Ke(u.entity.id,u.entity[i],o.entity.id,o.entity[i],r)})}var ge;(function(t){t.InitialSyncBatch="InitialSyncBatch",t.InitialSyncComplete="InitialSyncComplete",t.LoadFromStorage="LoadFromStorage",t.SyncTransaction="SyncTransaction",t.Error="Error"})(ge||(ge={}));class au{constructor(e,n,r,i,s,o){this.callbacks={},this.idToHash={},this.trySend=e,this.config=r,this.log=i,this.createStore=s,this.getAttrs=o,this.subs=new Wt({persister:n,merge:iu,serialize:ru,parse:(u,a)=>nu(a,this.config.useDateObjects),objectSize:u=>{var a;return((a=u.values)===null||a===void 0?void 0:a.entities.length)||0},logger:i,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,n){const r=K(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(n),this.initSubscription(e,r,n),i=>{this.unsubscribe(r,n,i==null?void 0:i.keepSubscription)}}unsubscribe(e,n,r){const i=(this.callbacks[e]||[]).filter(s=>s!==n);if(this.callbacks[e]=i,!i.length){delete this.callbacks[e];const s=this.subs.currentValue[e];s!=null&&s.state&&this.clearSubscriptionData(s.state.subscriptionId,!!r),r||this.subs.updateInPlace(o=>{delete o[e]})}}sendStart(e){this.trySend(z(),{op:"start-sync",q:e})}sendResync(e,n,r){this.idToHash[n.subscriptionId]=e.hash,this.trySend(n.subscriptionId,{op:"resync-table","subscription-id":n.subscriptionId,"tx-id":r,token:n.token})}sendRemove(e,n){this.trySend(z(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":n})}initSubscription(e,n,r){return kr(this,void 0,void 0,function*(){var i,s,o,u;yield this.subs.waitForKeyToLoad(n);const a=this.subs.currentValue[n];if(a&&a.state&&a.state.txId){this.sendResync(a,a.state,a.state.txId),!((i=a.values)===null||i===void 0)&&i.entities&&r&&r({type:ge.LoadFromStorage,data:ut(a,(s=a.values)===null||s===void 0?void 0:s.entities)});return}const d=Object.keys(e)[0],c=((u=(o=e[d])===null||o===void 0?void 0:o.$)===null||u===void 0?void 0:u.order)||{serverCreatedAt:"asc"},[f,l]=Object.entries(c)[0];this.subs.updateInPlace(p=>{p[n]={query:e,hash:n,table:d,orderDirection:l,orderField:f,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)})}flushPending(){return kr(this,void 0,void 0,function*(){for(const e of Object.keys(this.callbacks)){yield this.subs.waitForKeyToLoad(e);const n=this.subs.currentValue[e];n?yield this.initSubscription(n.query,n.hash):this.log.error("Missing sub for hash in flushPending",e)}})}onStartSyncOk(e){const n=e["subscription-id"],r=e.q,i=K(r);this.idToHash[n]=i,this.subs.updateInPlace(s=>{const o=s[i];if(!o)return this.log.error("Missing sub for hash",i,"subscription-id",n,"query",r),s;o.state={subscriptionId:n,token:e.token}})}notifyCbs(e,n){for(const r of this.callbacks[e]||[])r(n)}onSyncLoadBatch(e){var n;const r=e["subscription-id"],i=e["join-rows"],s=this.idToHash[r];if(!s){this.log.error("Missing hash for subscription",e);return}const o=[],u=this.subs.currentValue[s];if(!u){this.log.error("Missing sub for hash",s,e);return}const a=(n=u.values)!==null&&n!==void 0?n:{entities:[],attrsStore:this.getAttrs()};u.values=a;const d=a.entities;for(const c of i){const f=this.createStore(c),l=Gt(u,f,a.attrsStore);d.push({store:f,entity:l,serverCreatedAt:jr(u,f,a.attrsStore,l.id)}),o.push(l)}this.subs.updateInPlace(c=>{c[s]=u,c[s].updatedAt=Date.now()}),u.values&&this.notifyCbs(s,{type:ge.InitialSyncBatch,data:ut(u,u.values.entities),batch:o})}onSyncInitFinish(e){var n;const r=e["subscription-id"],i=this.idToHash[r];if(!i){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const u=o[i];if(!u){this.log.error("Missing sub for hash",i,e);return}const a=u.state;if(!a)return this.log.error("Sub never set init, missing result",u,e),o;a.txId=e["tx-id"],u.updatedAt=Date.now()});const s=this.subs.currentValue[i];s&&this.notifyCbs(i,{type:ge.InitialSyncComplete,data:ut(s,((n=s.values)===null||n===void 0?void 0:n.entities)||[])})}onSyncUpdateTriples(e){var n,r,i;const s=e["subscription-id"],o=this.idToHash[s];if(!o){this.log.error("Missing hash for subscription",e);return}const u=this.subs.currentValue[o];if(!u){this.log.error("Missing sub for hash",o,e);return}const a=u.state;if(!a){this.log.error("Missing state for sub",u,e);return}for(const d of e.txes){if(a.txId&&a.txId>=d["tx-id"])continue;a.txId=d["tx-id"];const c=[],f={};for(const _ of d.changes){const v=(n=f[_.triple[0]])!==null&&n!==void 0?n:[];f[_.triple[0]]=v,v.push(_)}const l=(r=u.values)!==null&&r!==void 0?r:{entities:[],attrsStore:this.getAttrs()},p=l.entities;u.values=l;const y=[];e:for(const[_,v]of Object.entries(f))for(let A=0;A<p.length;A++){const S=p[A];if(Ni(S.store,_)){Cr(S.store,l.attrsStore,v);const I=Gt(u,S.store,l.attrsStore),U=su(S.store,l.attrsStore,v)[_];I?(y.push({oldEntity:S.entity,newEntity:I,changedFields:U||{}}),S.entity=I):c.push(A),delete f[_];continue e}}const b=[];for(const[_,v]of Object.entries(f)){const A=this.createStore([]);Cr(A,l.attrsStore,v);const S=Gt(u,A,l.attrsStore);if(!S){this.log.error("No entity found after applying change",{sub:u,changes:v,store:A});continue}p.push({store:A,entity:S,serverCreatedAt:jr(u,A,l.attrsStore,S.id)}),b.push(S)}const g=[];for(const _ of c.sort().reverse())g.push(p[_].entity),p.splice(_,1);const w=ou(u,this.getAttrs);uu(u,w,p),this.notifyCbs(o,{type:ge.SyncTransaction,data:ut(u,(i=u.values)===null||i===void 0?void 0:i.entities),added:b,removed:g,updated:y})}this.subs.updateInPlace(d=>{d[o]=u,d[o].updatedAt=Date.now()})}clearSubscriptionData(e,n){const r=this.idToHash[e];if(r){delete this.idToHash[e];const i=this.subs.currentValue[r];if(i.state&&this.sendRemove(i.state,n),n?this.subs.unloadKey(r):this.subs.updateInPlace(s=>{delete s[r]}),i)return i}}onStartSyncError(e){const n=K(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},i=Object.keys(e["original-event"].q)[0];this.notifyCbs(n,{type:ge.Error,data:{[i]:[]},error:r})}onResyncError(e){const n=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(n,!1);r&&this.initSubscription(r.query,r.hash)}}var x=function(t,e,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function u(c){try{d(r.next(c))}catch(f){o(f)}}function a(c){try{d(r.throw(c))}catch(f){o(f)}}function d(c){c.done?s(c.value):i(c.value).then(u,a)}d((r=r.apply(t,e||[])).next())})},Ir=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n};const de={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},cu=3e4,du=3e4,fu=200,lu=1e3*60,hu={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},Ht="_instant_oauth_redirect",qe="currentUser";function pu({transportType:t,appId:e,apiURI:n,wsURI:r,EventSourceImpl:i}){if(!i)return new Er(`${r}?app_id=${e}`);switch(t){case"ws":return new Er(`${r}?app_id=${e}`);case"sse":return new tu(i,`${n}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+t)}}function yu(){return typeof window<"u"||typeof chrome<"u"}const Pr={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function bu(t,e){var n;const r=typeof t=="string"?JSON.parse(t):t;if(!((n=r==null?void 0:r.result)===null||n===void 0)&&n.store){const i=In(r.result.attrsStore,r.result.store);if(i){const s=r.result.store;r.result.store=Cn(i,Object.assign(Object.assign({},s),{useDateObjects:e})),r.result.attrsStore=i}}return r}function _u(t,e){const{result:n}=e,i=Ir(e,["result"]);if(n){const s=Object.assign(Object.assign({},n),{store:jn(n.store),attrsStore:n.attrsStore.toJSON()});i.result=s}return i}function gu(t,e){switch(t){case"pendingMutations":return new Map(typeof e=="string"?JSON.parse(e):e);default:return e}}function Tu(t,e){switch(t){case"pendingMutations":return[...e.entries()];default:return e}}function wu(t,e,n){const r=e==null?void 0:e.result,i=n==null?void 0:n.result;return r&&!i&&n&&(n.result=r),n||e}function Mr(t){return[...t].sort((e,n)=>{const[r,i]=e,[s,o]=n,u=i.order||0,a=o.order||0;return u==a?r<s?-1:r>s?1:0:u-a})}class mu{constructor(e,n=rr,r=ir,i,s){var o,u,a;if(this._isOnline=!0,this._isShutdown=!1,this.status=de.CONNECTING,this.queryCbs={},this.queryOnceDfds={},this.authCbs=[],this.attrsCbs=[],this.mutationErrorCbs=[],this.connectionStatusCbs=[],this.mutationDeferredStore=new Map,this._reconnectTimeoutId=null,this._reconnectTimeoutMs=0,this._transportType="ws",this._wsOk=null,this._localIdPromises={},this._errorMessage=null,this._oauthCallbackResponse=null,this._linkIndex=null,this._rooms={},this._roomsPendingLeave={},this._presence={},this._broadcastQueue=[],this._broadcastSubs={},this._currentUserCached={isLoading:!0,error:void 0,user:void 0},this._beforeUnloadCbs=[],this._dataForQueryCache={},this._inFlightMutationEventIds=new Set,this._onMergeKv=(d,c,f)=>{var l,p;switch(d){case"pendingMutations":{const y=(l=c==null?void 0:c.entries())!==null&&l!==void 0?l:[],b=(p=f==null?void 0:f.entries())!==null&&p!==void 0?p:[],g=new Map([...y,...b]);return(c?this._rewriteMutationsSorted(this.attrs,c):[]).forEach(([_,v])=>{var A;!(!((A=f==null?void 0:f.pendingMutations)===null||A===void 0)&&A.has(_))&&!v["tx-id"]&&this._sendMutation(_,v)}),g}default:return f||c}},this.getPreviousResult=d=>{var c;const f=K(d);return(c=this.dataForQuery(f))===null||c===void 0?void 0:c.data},this.notifyOne=d=>{var c,f;const l=(c=this.queryCbs[d])!==null&&c!==void 0?c:[],p=(f=this._dataForQueryCache[d])===null||f===void 0?void 0:f.data,y=this.dataForQuery(d);y!=null&&y.data&&(this._dataForQueryCache[d]=y,!Xe(y.data,p)&&l.forEach(b=>b.cb(y.data)))},this.notifyOneQueryOnce=d=>{var c,f;const l=(c=this.queryOnceDfds[d])!==null&&c!==void 0?c:[],p=(f=this.dataForQuery(d))===null||f===void 0?void 0:f.data;l.forEach(y=>{this._completeQueryOnce(y.q,d,y.dfd),y.dfd.resolve(p)})},this.notifyQueryError=(d,c)=>{(this.queryCbs[d]||[]).forEach(l=>l.cb({error:c}))},this.pushTx=d=>{this.config.disableValidation||eu(d,this.config.schema);try{const c=vo({attrsStore:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(f=>{var l;return(l=f==null?void 0:f.result)===null||l===void 0?void 0:l.store}),useDateObjects:this.config.useDateObjects},d);return this.pushOps(c)}catch(c){return this.pushOps([],c)}},this.pushOps=(d,c)=>{const f=z(),l=[...this._pendingMutations().values()],p=Math.max(0,...l.map(g=>g.order||0))+1,y={op:"transact","tx-steps":d,created:Date.now(),error:c,order:p};this._updatePendingMutations(g=>{g.set(f,y)});const b=new cr;return this.mutationDeferredStore.set(f,b),this._sendMutation(f,y),this.notifyAll(),b.promise},this._transportOnOpen=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][open]",c.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(de.OPENED),this.getCurrentUser().then(f=>{var l;this._trySend(z(),{op:"init","app-id":this.config.appId,"refresh-token":(l=f.user)===null||l===void 0?void 0:l.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(f=>{this._log.error("[socket][error]",c.id,f)})},this._transportOnMessage=d=>{const c=d.target,f=d.message;if(this._transport!==c){this._log.info("[socket][message]",c.id,f,"skip; this is no longer the current transport");return}if(!this._wsOk&&c.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(d.message))for(const l of d.message)this._handleReceive(c.id,l);else this._handleReceive(c.id,d.message)},this._transportOnError=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][error]",c.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",c.id,d)},this._scheduleReconnect=()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)},this._transportOnClose=d=>{const c=d.target;if(this._transport!==c){this._log.info("[socket][close]",c.id,"skip; this is no longer the current transport");return}this._setStatus(de.CLOSED);for(const f of Object.values(this._rooms))f.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",c.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",c.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()},this._EventSource=s,this.config=Object.assign(Object.assign({},hu),e),this.queryCacheLimit=(o=this.config.queryCacheLimit)!==null&&o!==void 0?o:10,this._pendingTxCleanupTimeout=(u=this.config.pendingTxCleanupTimeout)!==null&&u!==void 0?u:du,this._pendingMutationCleanupThreshold=(a=this.config.pendingMutationCleanupThreshold)!==null&&a!==void 0?a:fu,this._log=Wo(e.verbose||Qt||or,()=>this._reactorStats()),this.versions=Object.assign(Object.assign({},i||{}),{"@instantdb/core":hr}),this.config.schema&&(this._linkIndex=lr(this.config.schema)),!!yu()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!Oe(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",d=>x(this,void 0,void 0,function*(){var c;try{if(((c=d.data)===null||c===void 0?void 0:c.type)==="auth"){const f=yield this.getCurrentUser();this.updateUser(f.user)}}catch(f){this._log.error("[error] handle broadcast channel",f)}}))),this._initStorage(n),this._syncTable=new au(this._trySendAuthed.bind(this),new n(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,d=>Le(this.ensureAttrs(),d,this.config.enableCardinalityInference,this.config.useDateObjects),()=>this.ensureAttrs()),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser().then(d=>{this.syncUserToEndpoint(d.user)}),setInterval(()=>x(this,void 0,void 0,function*(){const d=yield this.getCurrentUser();this.syncUserToEndpoint(d.user)}),lu),r.getIsOnline().then(d=>{this._isOnline=d,this._startSocket(),r.listen(c=>{c!==this._isOnline&&(this._log.info("[network] online =",c),this._isOnline=c,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",de.CLOSED),this._setStatus(de.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}ensureAttrs(){if(!this.attrs)throw new Error("attrs have not loaded.");return this.attrs}updateSchema(e){this.config=Object.assign(Object.assign({},this.config),{schema:e,cardinalityInference:!!e}),this._linkIndex=e?lr(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new Wt({persister:new e(this.config.appId,"querySubs"),merge:wu,serialize:_u,parse:(n,r)=>bu(r,this.config.useDateObjects),objectSize:n=>{var r,i,s,o;return(o=(s=(i=(r=n==null?void 0:n.result)===null||r===void 0?void 0:r.store)===null||i===void 0?void 0:i.triples)===null||s===void 0?void 0:s.length)!==null&&o!==void 0?o:0},logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=n=>this._onQuerySubLoaded(n),this.kv=new Wt({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:Tu,parse:gu,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=n=>{n==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(qe),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,n,r){const i=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const s=e!=="error"&&e!=="timeout";if(!i&&!s&&console.error("Mutation failed",Object.assign({status:e,eventId:n},r)),!!i)if(s)i.resolve({status:e,eventId:n});else if(r!=null&&r.type){const{status:o}=r,u=Ir(r,["status"]);i.reject(new ot({body:u,status:o??0}))}else i.reject(new Ee((r==null?void 0:r.message)||"Unknown error",r==null?void 0:r.hint))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var n,r;const i=(r=(n=this._presence[e])===null||n===void 0?void 0:n.result)===null||r===void 0?void 0:r.user,s=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],i&&this._trySetPresence(e,i),s)for(const o of s){const{topic:u,roomType:a,data:d}=o;this._tryBroadcast(e,a,u,d)}}_addQueryData(e,n,r){if(!this.attrs)throw new Error("Attrs in reactor have not been set");const i=K(e),s=this.ensureAttrs(),o=Le(this.attrs,n.triples,r,this.config.useDateObjects);this.querySubs.updateInPlace(u=>{u[i]={result:{store:o,attrsStore:s,pageInfo:n.pageInfo,processedTxId:void 0,isExternal:!0},q:e}}),this._cleanupPendingMutationsQueries(),this.notifyOne(i),this.notifyOneQueryOnce(i),this._cleanupPendingMutationsTimeout()}_handleReceive(e,n){var r,i,s,o,u,a;const d=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(Pr[n.op]||this._log.info("[receive]",e,n.op,n),n.op){case"init-ok":{this._setStatus(de.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const l of Object.keys(this._rooms)){const p=(i=(r=this._presence[l])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.user;this._tryJoinRoom(l,p)}break}case"add-query-exists":{this.notifyOneQueryOnce(K(n.q));break}case"add-query-ok":{const{q:l,result:p}=n,y=K(l);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[y])break;const b=(o=(s=p==null?void 0:p[0])===null||s===void 0?void 0:s.data)===null||o===void 0?void 0:o["page-info"],g=(a=(u=p==null?void 0:p[0])===null||u===void 0?void 0:u.data)===null||a===void 0?void 0:a.aggregate,w=fr(p),_=this.ensureAttrs(),v=Le(_,w,d,this.config.useDateObjects);this.querySubs.updateInPlace(A=>{if(!A[y]){this._log.info("Missing value in querySubs",{hash:y,q:l});return}A[y].result={store:v,attrsStore:_,pageInfo:b,aggregate:g,processedTxId:n["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(y),this.notifyOneQueryOnce(y),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(n);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(n);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(n);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(n);break}case"refresh-ok":{const{computations:l,attrs:p}=n,y=n["processed-tx-id"];p&&this._setAttrs(p),this._cleanupPendingMutationsTimeout();const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations(),y);b!==this._pendingMutations()&&this.kv.updateInPlace(_=>{_.pendingMutations=b});const g=Mr(b.entries()),w=l.map(_=>{var v,A,S,I;const U=_["instaql-query"],D=_["instaql-result"],We=K(U),ct=fr(D),dt=this.ensureAttrs(),Zt=Le(dt,ct,d,this.config.useDateObjects),{store:ft,attrsStore:se}=this._applyOptimisticUpdates(Zt,dt,g,y),fe=(A=(v=D==null?void 0:D[0])===null||v===void 0?void 0:v.data)===null||A===void 0?void 0:A["page-info"],we=(I=(S=D==null?void 0:D[0])===null||S===void 0?void 0:S.data)===null||I===void 0?void 0:I.aggregate;return{q:U,hash:We,store:ft,attrsStore:se,pageInfo:fe,aggregate:we}});w.forEach(({hash:_,q:v,store:A,attrsStore:S,pageInfo:I,aggregate:U})=>{this.querySubs.updateInPlace(D=>{if(!D[_]){this._log.error("Missing value in querySubs",{hash:_,q:v});return}D[_].result={store:A,attrsStore:S,pageInfo:I,aggregate:U,processedTxId:y}})}),this._cleanupPendingMutationsQueries(),w.forEach(({hash:_})=>{this.notifyOne(_)});break}case"transact-ok":{const{"client-event-id":l,"tx-id":p}=n;this._inFlightMutationEventIds.delete(l);const b=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations()).get(l);if(!b)break;this._updatePendingMutations(w=>{w.set(l,Object.assign(Object.assign({},w.get(l)),{"tx-id":p,confirmed:Date.now()}))});const g=[];for(const w of b["tx-steps"])if(w[0]==="add-attr"){const _=w[1];g.push(_)}if(g.length){const w=Object.values(this.ensureAttrs().attrs);this._setAttrs([...w,...g])}this._finishTransaction("synced",l),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._patchPresencePeers(l,n.edits),this._notifyPresenceSubs(l);break}case"refresh-presence":{const l=n["room-id"];this._trySetRoomConnected(l,!0),this._setPresencePeers(l,n.data),this._notifyPresenceSubs(l);break}case"server-broadcast":{const l=n["room-id"],p=n.topic;this._trySetRoomConnected(l,!0),this._notifyBroadcastSubs(l,p,n);break}case"join-room-ok":{const l=n["room-id"];if(!this._rooms[l]){this._roomsPendingLeave[l]&&(this._tryLeaveRoom(l),delete this._roomsPendingLeave[l]);break}this._trySetRoomConnected(l,!0),this._flushEnqueuedRoomData(l);break}case"leave-room-ok":{const l=n["room-id"];this._trySetRoomConnected(l,!1);break}case"join-room-error":const c=n["room-id"],f=this._rooms[c];f&&(f.error=n.error),this._notifyPresenceSubs(c);break;case"error":this._handleReceiveError(n);break;default:this._log.info("Uknown op",n.op,n);break}}_pendingMutations(){var e;return(e=this.kv.currentValue.pendingMutations)!==null&&e!==void 0?e:new Map}_updatePendingMutations(e){this.kv.updateInPlace(n=>{var r;const i=(r=n.pendingMutations)!==null&&r!==void 0?r:new Map;n.pendingMutations=i,e(i)})}_handleMutationError(e,n,r){const i=this._pendingMutations().get(n);if(i&&(e!=="timeout"||!i["tx-id"])){this._updatePendingMutations(o=>(o.delete(n),o)),this._inFlightMutationEventIds.delete(n);const s={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(s),this._finishTransaction(e,n,r)}}_handleReceiveError(e){var n,r,i,s,o,u,a;console.log("error",e);const d=e["client-event-id"];this._inFlightMutationEventIds.delete(d);const c=this._pendingMutations().get(d),f={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(f.hint=e.hint),c){this._handleMutationError("error",d,e);return}if(!((n=e["original-event"])===null||n===void 0)&&n.hasOwnProperty("q")&&((r=e["original-event"])===null||r===void 0?void 0:r.op)==="add-query"){const y=(i=e["original-event"])===null||i===void 0?void 0:i.q,b=K(y);this.notifyQueryError(K(y),f),this.notifyQueryOnceError(y,b,d,f);return}if(((s=e["original-event"])===null||s===void 0?void 0:s.op)==="init"){if(e.type==="record-not-found"&&((o=e.hint)===null||o===void 0?void 0:o["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(de.ERRORED,f),this.notifyAll();return}if(((u=e["original-event"])===null||u===void 0?void 0:u.op)==="resync-table"){this._syncTable.onResyncError(e);return}if(((a=e["original-event"])===null||a===void 0?void 0:a.op)==="start-sync"){this._syncTable.onStartSyncError(e);return}const p=Object.assign({},e);delete p.message,delete p.hint,console.error(e.message,p),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,i){var s;const o=(s=this.queryOnceDfds[n])===null||s===void 0?void 0:s.find(u=>u.eventId===r);o&&(o.dfd.reject(i),this._completeQueryOnce(e,n,o.dfd))}_setAttrs(e){this.attrs=new be(e.reduce((n,r)=>(n[r.id]=r,n),{}),this._linkIndex),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=z();return this.querySubs.updateInPlace(i=>{i[n]=i[n]||{q:e,result:null,eventId:r},i[n].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,n){return this._syncTable.subscribe(e,n)}subscribeQuery(e,n,r){var i;this.config.disableValidation||gr(e,this.config.schema),r&&"ruleParams"in r&&(e=Object.assign({$$ruleParams:r.ruleParams},e));const s=K(e),o=this.getPreviousResult(e);return o&&n(o),this.queryCbs[s]=(i=this.queryCbs[s])!==null&&i!==void 0?i:[],this.queryCbs[s].push({q:e,cb:n}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,n)}}queryOnce(e,n){var r;this.config.disableValidation||gr(e,this.config.schema),n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const i=new cr;if(!this._isOnline)return i.reject(new Error("We can't run `queryOnce`, because the device is offline.")),i.promise;if(!this.querySubs)return i.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),i.promise;const s=K(e),o=this._startQuerySub(e,s);return this.queryOnceDfds[s]=(r=this.queryOnceDfds[s])!==null&&r!==void 0?r:[],this.queryOnceDfds[s].push({q:e,dfd:i,eventId:o}),setTimeout(()=>i.reject(new Error("Query timed out")),cu),i.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(i=>i.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(i=>i.cb!==r),this._cleanupQuery(e,n))}_hasQueryListeners(e){var n,r;return!!(!((n=this.queryCbs[e])===null||n===void 0)&&n.length||!((r=this.queryOnceDfds[e])===null||r===void 0)&&r.length)}_cleanupQuery(e,n){this._hasQueryListeners(n)||(delete this.queryCbs[n],delete this.queryOnceDfds[n],delete this._dataForQueryCache[n],this.querySubs.unloadKey(n),this._trySendAuthed(z(),{op:"remove-query",q:e}))}_rewriteMutations(e,n,r){if(!e)return n;if(!n)return new Map;const i=c=>{const[f,l,p]=c["forward-identity"];return F(e,l,p)},s=c=>{const[f,l,p]=c["forward-identity"];return _e(e,l,p)},o={attrIdMap:{},refSwapAttrIds:new Set};let u=!1;const a=(c,f)=>{const l=[];for(const p of c){const[y]=p;if(y==="add-attr"){const[g,w]=p,_=i(w);if(_&&w.id!==_.id){o.attrIdMap[w.id]=_.id,u=!0;continue}if(w["value-type"]==="ref"){const v=s(w);if(v){o.attrIdMap[w.id]=v.id,o.refSwapAttrIds.add(w.id),u=!0;continue}}}if(r&&f&&r>=f&&y==="add-attr"||y==="update-attr"||y==="delete-attr"){u=!0;continue}const b=u?Ys(o,p):p;l.push(b)}return u?l:c},d=new Map;for(const[c,f]of n.entries())d.set(c,Object.assign(Object.assign({},f),{"tx-steps":a(f["tx-steps"],f["tx-id"])}));return u?d:n}_rewriteMutationsSorted(e,n){return Mr(this._rewriteMutations(e,n).entries())}optimisticAttrs(){var e,n;const r=[...this._pendingMutations().values()].flatMap(u=>u["tx-steps"]),i=new Set(r.filter(([u,a])=>u==="delete-attr").map(([u,a])=>a)),s=[];for(const[u,a]of r)if(u==="add-attr")s.push(a);else if(u==="update-attr"&&a.id&&(!((e=this.attrs)===null||e===void 0)&&e.getAttr(a.id))){const d=Object.assign(Object.assign({},this.attrs.getAttr(a.id)),a);s.push(d)}if(!i.size&&!s.length)return this.attrs||new be({},this._linkIndex);const o=Object.assign({},((n=this.attrs)===null||n===void 0?void 0:n.attrs)||{});for(const u of s)o[u.id]=u;for(const u of i)delete o[u];return new be(o,this._linkIndex)}dataForQuery(e,n=!0){const r=this._errorMessage;if(r)return{error:r};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const i=this.querySubs.version(),s=this.querySubs.currentValue,o=this.kv.version(),u=this._pendingMutations(),{q:a,result:d}=s[e]||{};if(!d)return;const c=this._dataForQueryCache[e];if(c&&i===c.querySubVersion&&o===c.pendingMutationsVersion)return c;let f=d.store,l=d.attrsStore;const{pageInfo:p,aggregate:y,processedTxId:b}=d,g=this._rewriteMutationsSorted(l,u);if(n){const _=this._applyOptimisticUpdates(f,l,g,b);f=_.store,l=_.attrsStore}return{data:Hn({store:f,attrsStore:l,pageInfo:p,aggregate:y},a),querySubVersion:i,pendingMutationsVersion:o}}_applyOptimisticUpdates(e,n,r,i){for(const[s,o]of r)if(!o["tx-id"]||i&&o["tx-id"]>i){const u=Zi(e,n,o["tx-steps"]);e=u.store,n=u.attrsStore}return{store:e,attrsStore:n}}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}shutdown(){var e;this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,(e=this._transport)===null||e===void 0||e.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{message:n.error.message});return}if(this.status!==de.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(i=>this.querySubs.currentValue[i]).filter(i=>i).forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:i,q:s})=>{this._trySendAuthed(i,{op:"add-query",q:s})}),this._rewriteMutationsSorted(this.ensureAttrs(),this._pendingMutations()).forEach(([i,s])=>{s["tx-id"]||this._sendMutation(i,s)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:n}of Object.values(this.querySubs.currentValue))n!=null&&n.processedTxId&&(e=Math.min(e,n==null?void 0:n.processedTxId));this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i["tx-id"]&&i["tx-id"]<=e&&n.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(n=>{for(const[r,i]of Array.from(n.entries()))i.confirmed&&i.confirmed+this._pendingTxCleanupTimeout<e&&n.delete(r)})}_trySendAuthed(...e){this.status===de.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){if(this._transport.isOpen()){switch(Pr[n.op]||this._log.info("[send]",this._transport.id,n.op,n),n.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send(Object.assign({"client-event-id":e},n))}}_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=pu({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e!=null&&e.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}getLocalId(e){return x(this,void 0,void 0,function*(){const n=`localToken_${e}`;if(this.kv.currentValue[n])return this.kv.currentValue[n];const r=yield this.kv.waitForKeyToLoad(n);if(r)return r;const i=z();return this.kv.updateInPlace(s=>{s[n]||(s[n]=i)}),yield this.kv.waitForKeyToLoad(n)})}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(Ht)){const n=e.toString();e.searchParams.delete(Ht),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let i=!1;const s=o=>{var u;i||(i=!0,navigation.removeEventListener("navigate",s),!o.userInitiated&&o.navigationType==="replace"&&((u=o.destination)===null||u===void 0?void 0:u.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",s)}}}_oauthLoginInit(){return x(this,void 0,void 0,function*(){var e,n,r,i;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const s=new URLSearchParams(window.location.search);if(!s.get(Ht))return null;const o=s.get("error");if(o)return this._replaceUrlAfterOAuth(),{error:{message:o}};const u=s.get("code");if(!u)return null;this._replaceUrlAfterOAuth();try{const a=yield this._getCurrentUser(),d=(a==null?void 0:a.type)==="guest",{user:c}=yield sr({apiURI:this.config.apiURI,appId:this.config.appId,code:u,refreshToken:d?a.refresh_token:void 0});return this.setCurrentUser(c),null}catch(a){return((e=a==null?void 0:a.body)===null||e===void 0?void 0:e.type)==="record-not-found"&&((r=(n=a==null?void 0:a.body)===null||n===void 0?void 0:n.hint)===null||r===void 0?void 0:r["record-type"])==="app-oauth-code"&&(yield this._hasCurrentUser())?null:{error:{message:((i=a==null?void 0:a.body)===null||i===void 0?void 0:i.message)||"Error logging in."}}}})}_waitForOAuthCallbackResponse(){return x(this,void 0,void 0,function*(){return yield this._oauthCallbackResponse})}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(i=>{r||Xe(i,n)||e(i)}),()=>{r=!0,this.authCbs=this.authCbs.filter(i=>i!==e)}}getAuth(){return x(this,void 0,void 0,function*(){const{user:e,error:n}=yield this.getCurrentUser();if(n)throw new Ee("Could not get current user: "+n.message);return e})}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e.attrs))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}setCurrentUser(e){return x(this,void 0,void 0,function*(){this.kv.updateInPlace(n=>{n[qe]=e}),yield this.kv.waitForKeyToLoad(qe)})}getCurrentUserCached(){return this._currentUserCached}_getCurrentUser(){return x(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(qe);return typeof e=="string"?JSON.parse(e):e})}getCurrentUser(){return x(this,void 0,void 0,function*(){const e=yield this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const n={error:e.error,user:void 0};return this._currentUserCached=Object.assign({isLoading:!1},n),n}try{const r={user:yield this._getCurrentUser(),error:void 0};return this._currentUserCached=Object.assign({isLoading:!1},r),r}catch(n){return{user:void 0,isLoading:!1,error:{message:(n==null?void 0:n.message)||"Error loading user"}}}})}_hasCurrentUser(){return x(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(qe);return typeof e=="string"?JSON.parse(e)!=null:e!=null})}changeCurrentUser(e){return x(this,void 0,void 0,function*(){var n;const{user:r}=yield this.getCurrentUser();if(!Xe(r,e)){yield this.setCurrentUser(e),this.updateUser(e);try{(n=this._broadcastChannel)===null||n===void 0||n.postMessage({type:"auth"})}catch(i){console.error("Error posting message to broadcast channel",i)}}})}syncUserToEndpoint(e){return x(this,void 0,void 0,function*(){if(this.config.firstPartyPath)try{fetch(this.config.firstPartyPath+"/",{method:"POST",body:JSON.stringify({type:"sync-user",appId:this.config.appId,user:e}),headers:{"Content-Type":"application/json"}})}catch(n){this._log.error("Error syncing user with external endpoint",n)}})}updateUser(e){this.syncUserToEndpoint(e);const n={error:void 0,user:e};this._currentUserCached=Object.assign({isLoading:!1},n),this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(i=>{delete r[i].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return Mo({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}signInWithMagicCode(e){return x(this,arguments,void 0,function*({email:n,code:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",u=yield Ro({apiURI:this.config.apiURI,appId:this.config.appId,email:n,code:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(u.user),u})}signInWithCustomToken(e){return x(this,void 0,void 0,function*(){const n=yield xo({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return yield this.changeCurrentUser(n.user),n})}signInAsGuest(){return x(this,void 0,void 0,function*(){const e=yield Do({apiURI:this.config.apiURI,appId:this.config.appId});return yield this.changeCurrentUser(e.user),e})}potentiallyInvalidateToken(e,n){var r;const i=(r=e==null?void 0:e.user)===null||r===void 0?void 0:r.refresh_token;if(!i)return;if(n.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}Uo({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:i}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}signOut(e){return x(this,void 0,void 0,function*(){const n=yield this.getCurrentUser();this.potentiallyInvalidateToken(n,e),yield this.changeCurrentUser(null)})}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:i}=this.config;return`${r}/runtime/oauth/start?app_id=${i}&client_name=${e}&redirect_uri=${n}`}exchangeCodeForToken(e){return x(this,arguments,void 0,function*({code:n,codeVerifier:r}){var i;const s=yield this.getCurrentUser(),o=((i=s==null?void 0:s.user)===null||i===void 0?void 0:i.type)==="guest",u=yield sr({apiURI:this.config.apiURI,appId:this.config.appId,code:n,codeVerifier:r,refreshToken:o?s.user.refresh_token:void 0});return yield this.changeCurrentUser(u.user),u})}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}signInWithIdToken(e){return x(this,arguments,void 0,function*({idToken:n,clientName:r,nonce:i}){var s;const o=yield this.getCurrentUser(),u=(s=o==null?void 0:o.user)===null||s===void 0?void 0:s.refresh_token,a=yield $o({apiURI:this.config.apiURI,appId:this.config.appId,idToken:n,clientName:r,nonce:i,refreshToken:u});return yield this.changeCurrentUser(a.user),a})}joinRoom(e,n){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const i=this._presence[e].result;return n&&!i&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=n,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,n),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,i,s;if(!(!((r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0)&&r.length)&&!Object.keys((i=this._broadcastSubs[e])!==null&&i!==void 0?i:{}).length){const o=(s=this._rooms[e])===null||s===void 0?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],o?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const i=this._rooms[n],s=this._presence[n];return!i||!s||!s.result?null:Object.assign(Object.assign({},Vo(s.result,r,this._sessionId)),{isLoading:!i.isConnected,error:i.error})}publishPresence(e,n,r){const i=this._rooms[n],s=this._presence[n];if(!i||!s)return;s.result=s.result||{};const o=Object.assign(Object.assign({},s.result.user),r);s.result.user=o,i.isConnected&&(this._trySetPresence(n,o),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(z(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e,n){this._trySendAuthed(z(),{op:"join-room","room-id":e,data:n}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(z(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,n){const r=this._rooms[e];r&&(r.isConnected=n)}subscribePresence(e,n,r,i){const s=this.joinRoom(n,r.initialPresence||r.initialData),o=Object.assign(Object.assign({},r),{roomId:n,cb:i,prev:null});return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(o),this._notifyPresenceSub(n,o),()=>{var u,a,d;this._presence[n].handlers=(d=(a=(u=this._presence[n])===null||u===void 0?void 0:u.handlers)===null||a===void 0?void 0:a.filter(c=>c!==o))!==null&&d!==void 0?d:[],s()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0||r.forEach(i=>{this._notifyPresenceSub(e,i)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!qo(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){var r,i,s;const o=((i=(r=this._presence[e])===null||r===void 0?void 0:r.result)===null||i===void 0?void 0:i.peers)||{};let u=Object.fromEntries(Object.entries(o).map(([d,c])=>[d,{data:c}]));(s=this._presence[e])===null||s===void 0||s.result;const a=Ze(u,d=>{for(let[c,f,l]of n)switch(f){case"+":wi(d,c,l);break;case"r":On(d,c,l);break;case"-":An(d,c);break}delete d[this._sessionId]});this._setPresencePeers(e,a)}_setPresencePeers(e,n){const r=Object.assign({},n);delete r[this._sessionId];const i=Object.fromEntries(Object.entries(r).map(([s,o])=>[s,o.data]));this._presence=Ze(this._presence,s=>{On(s,[e,"result","peers"],i)})}publishTopic({roomType:e,roomId:n,topic:r,data:i}){var s;const o=this._rooms[n];if(o){if(!o.isConnected){this._broadcastQueue[n]=(s=this._broadcastQueue[n])!==null&&s!==void 0?s:[],this._broadcastQueue[n].push({topic:r,roomType:e,data:i});return}this._tryBroadcast(n,e,r,i)}}_tryBroadcast(e,n,r,i){this._trySendAuthed(z(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:i})}subscribeTopic(e,n,r){const i=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(s=>s!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],i()}}_notifyBroadcastSubs(e,n,r){var i,s,o;(o=(s=(i=this._broadcastSubs)===null||i===void 0?void 0:i[e])===null||s===void 0?void 0:s[n])===null||o===void 0||o.forEach(u=>{var a,d,c,f,l,p;const y=(a=r.data)===null||a===void 0?void 0:a.data,b=r.data["peer-id"]===this._sessionId?(c=(d=this._presence[e])===null||d===void 0?void 0:d.result)===null||c===void 0?void 0:c.user:(p=(l=(f=this._presence[e])===null||f===void 0?void 0:f.result)===null||l===void 0?void 0:l.peers)===null||p===void 0?void 0:p[r.data["peer-id"]];return u(y,b)})}uploadFile(e,n,r){return x(this,void 0,void 0,function*(){var i;const s=yield this.getCurrentUser(),o=(i=s==null?void 0:s.user)===null||i===void 0?void 0:i.refresh_token;return Lo(Object.assign(Object.assign({},r),{apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:o}))})}deleteFile(e){return x(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield Fo({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}upload(e,n){return x(this,void 0,void 0,function*(){var r;const i=yield this.getCurrentUser(),s=(r=i==null?void 0:i.user)===null||r===void 0?void 0:r.refresh_token,o=e||n.name,u=yield No({apiURI:this.config.apiURI,appId:this.config.appId,fileName:o,refreshToken:s});return yield Ko(u,n)})}getDownloadUrl(e){return x(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),i=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield zo({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:i})})}}let at;function vu(t,e){at==null||at.dispose();const n=ju(e),r=Au(e,u),i=Ou(Su(t));function s(c){var f;c.source===i.element.contentWindow&&((f=c.data)===null||f===void 0?void 0:f.type)==="close"&&n.isVisible()&&u()}function o(c){const f=c.shiftKey&&c.ctrlKey&&c.key==="0",l=c.key==="Escape"||c.key==="Esc";(f||l&&n.isVisible())&&u()}function u(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(i.element)||n.element.appendChild(i.element))}function a(){n.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",s)}function d(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",s),at={dispose:a}}return d()}function Su(t){return`${Qt||ur?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function Ou(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function Au(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,Object.assign(Object.assign({position:"fixed"},Eu(t.position)),{height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"})),r.addEventListener("click",e),{element:r}}function Eu(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function ku(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function ju(t){const e=document.createElement("div");Object.assign(e.style,Object.assign(Object.assign({position:"fixed"},ku(t.position)),{display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"})),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const Cu={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function Iu(){var t;return globalThis.__instantDbSchemaHashStore=(t=globalThis.__instantDbSchemaHashStore)!==null&&t!==void 0?t:new WeakMap,globalThis.__instantDbSchemaHashStore}function Pu(){var t;return globalThis.__instantDbStore=(t=globalThis.__instantDbStore)!==null&&t!==void 0?t:{},globalThis.__instantDbStore}function Yt(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+t.useDateObjects}const Jt=Pu(),Rr=Iu();class Mu{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.signInAsGuest=()=>this.db.signInAsGuest(),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(n={invalidateToken:!0})=>this.db.signOut(n)}}class Ru{constructor(e){this.db=e,this.uploadFile=(n,r,i={})=>this.db.uploadFile(n,r,i),this.delete=n=>this.db.deleteFile(n),this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n)}}function xu(t){return JSON.parse(JSON.stringify(t))}class Du{constructor(e){this.tx=Kt(),this._reactor=e,this.auth=new Mu(this._reactor),this.storage=new Ru(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(n,r==null?void 0:r.initialPresence),subscribeTopic:(s,o)=>this._reactor.subscribeTopic(n,s,o),subscribePresence:(s,o)=>this._reactor.subscribePresence(e,n,s,o),publishTopic:(s,o)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:s,data:o}),publishPresence:s=>this._reactor.publishPresence(e,n,s),getPresence:s=>this._reactor.getPresence(e,n,s)}}shutdown(){delete Jt[Yt(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}_syncTableExperimental(e,n){return this._reactor.subscribeTable(e,n)}}function xr(t){if(!t)return"0";const e=Rr.get(t);if(e)return e;const n=K(t);return Rr.set(t,n),n}function $u(t,e){return xr(t._reactor.config.schema)!==xr(e)}function Uu(t,e,n,r,i){var s,o;const u=Object.assign(Object.assign({},t),{appId:(s=t.appId)===null||s===void 0?void 0:s.trim(),useDateObjects:(o=t.useDateObjects)!==null&&o!==void 0?o:!1}),a=Jt[Yt(u)];if(a)return $u(a,u.schema)&&a._reactor.updateSchema(u.schema),a;const d=new mu(Object.assign(Object.assign(Object.assign({},Cu),u),{cardinalityInference:!!u.schema}),e||rr,n||ir,Object.assign(Object.assign({},r||{}),{"@instantdb/core":hr}),i),c=new Du(d);return Jt[Yt(u)]=c,Lu(u.appId,u.devtool),c}function Lu(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n=Object.assign({position:"bottom-right",allowedHosts:["localhost"]},typeof e=="object"?e:{});n.allowedHosts.includes(window.location.hostname)&&vu(t,n)}const Fu={isLoading:!0,data:void 0,pageInfo:void 0,error:void 0};function Dr(t){return{isLoading:!t,data:void 0,pageInfo:void 0,error:void 0,...t||{}}}function Nu(t,e,n){e&&n&&"ruleParams"in n&&(e={$$ruleParams:n.ruleParams,...e});const r=e?xu(e):null,i=K(r),s=j.useRef(Dr(t._reactor.getPreviousResult(r))),o=j.useCallback(a=>(s.current=Dr(t._reactor.getPreviousResult(r)),a(),r?t.subscribeQuery(r,c=>{s.current={isLoading:!c,data:void 0,pageInfo:void 0,error:void 0,...c},a()}):()=>{}),[i]);return{state:j.useSyncExternalStore(o,()=>s.current,()=>Fu),query:r}}function Ku(){const t=j.useRef(null);j.useEffect(()=>{n()},[]);function e(r,i){n(),t.current=setTimeout(i,r)}function n(){t.current&&clearTimeout(t.current)}return{set:e,clear:n}}const zu=1e3;function Vu(t,e,n){const r=j.useRef(n);r.current=n,j.useEffect(()=>t.core._reactor.subscribeTopic(t.id,e,(s,o)=>{r.current(s,o)}),[t.id,e])}function qu(t,e){return j.useEffect(()=>t.core._reactor.joinRoom(t.id),[t.id]),j.useCallback(r=>{t.core._reactor.publishTopic({roomType:t.type,roomId:t.id,topic:e,data:r})},[t.id,e])}function Wu(t,e={}){var o,u;const[n,r]=j.useState(()=>t.core._reactor.getPresence(t.type,t.id,e)??{peers:{},isLoading:!0});j.useEffect(()=>t.core._reactor.subscribePresence(t.type,t.id,e,d=>{r(d)}),[t.id,e.user,(o=e.peers)==null?void 0:o.join(),(u=e.keys)==null?void 0:u.join()]);const i=j.useCallback(a=>{t.core._reactor.publishPresence(t.type,t.id,a)},[t.type,t.id]);return j.useMemo(()=>({...n,publishPresence:i}),[n,i])}function Qu(t,e,n){j.useEffect(()=>t.core._reactor.joinRoom(t.id,e),[t.id]),j.useEffect(()=>t.core._reactor.publishPresence(t.type,t.id,e),[t.type,t.id,n??JSON.stringify(e)])}function Bu(t,e,n={}){const r=Ku(),i=Te.usePresence(t,{keys:[e]}),s=j.useMemo(()=>{const c=t._core._reactor.getPresence(t.type,t.id);return n!=null&&n.writeOnly?[]:Object.values((c==null?void 0:c.peers)??{}).filter(f=>f[e]===!0)},[n==null?void 0:n.writeOnly,i]),o=j.useCallback(c=>{t.core._reactor.publishPresence(t.type,t.id,{[e]:c}),c&&((n==null?void 0:n.timeout)===null||(n==null?void 0:n.timeout)===0||r.set((n==null?void 0:n.timeout)??zu,()=>{t.core._reactor.publishPresence(t.type,t.id,{[e]:null})}))},[t.type,t.id,e,n==null?void 0:n.timeout,r]),u=j.useCallback(c=>{const l=!((n==null?void 0:n.stopOnEnter)&&c.key==="Enter");o(l)},[n.stopOnEnter,o]),a=j.useCallback(()=>{o(!1)},[o]),d=j.useMemo(()=>({onKeyDown:u,onBlur:a}),[u,a]);return{active:s,setActive:o,inputProps:d}}const Te={useTopicEffect:Vu,usePublishTopic:qu,usePresence:Wu,useSyncPresence:Qu,useTypingIndicator:Bu};class Gu{constructor(e,n,r){this.useTopicEffect=(i,s)=>{Te.useTopicEffect(this,i,s)},this.usePublishTopic=i=>Te.usePublishTopic(this,i),this.usePresence=(i={})=>Te.usePresence(this,i),this.useSyncPresence=(i,s)=>Te.useSyncPresence(this,i,s),this.useTypingIndicator=(i,s={})=>Te.useTypingIndicator(this,i,s),this.core=e,this._core=this.core,this.type=n,this.id=r}}const Hu={isLoading:!0,user:void 0,error:void 0};class Yu{constructor(e,n){this.tx=Kt(),this.getLocalId=r=>this.core.getLocalId(r),this.useLocalId=r=>{const[i,s]=j.useState(null);return j.useEffect(()=>{(async()=>{const u=await this.getLocalId(r);s(u)})()},[r]),i},this.rooms=Te,this.transact=r=>this.core.transact(r),this.useQuery=(r,i)=>Nu(this.core,r,i).state,this.useAuth=()=>this._useAuth(),this.useUser=()=>{const{user:r}=this.useAuth();if(!r)throw new Ee("useUser must be used within an auth-protected route");return r},this.useConnectionStatus=()=>{const r=j.useRef(this.core._reactor.status),i=j.useCallback(o=>this.core.subscribeConnectionStatus(a=>{a!==r.current&&(r.current=a,o())}),[]);return j.useSyncExternalStore(i,()=>r.current,()=>"connecting")},this.queryOnce=(r,i)=>this.core.queryOnce(r,i),this.SignedIn=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||!i.user?null:Be.jsx(Be.Fragment,{children:r})},this.SignedOut=({children:r})=>{const i=this.useAuth();return i.isLoading||i.error||i.user?null:Be.jsx(Be.Fragment,{children:r})},this.core=Uu(e,this.constructor.Storage,this.constructor.NetworkListener,n,this.constructor.EventSourceImpl),this._core=this.core,this.auth=this.core.auth,this.storage=this.core.storage}room(e="_defaultRoomType",n="_defaultRoomId"){return new Gu(this.core,e,n)}_useAuth(){const e=j.useRef(this.core._reactor._currentUserCached),n=j.useCallback(i=>this.core.subscribeAuth(o=>{e.current={isLoading:!1,...o},i()}),[]);return j.useSyncExternalStore(n,()=>e.current,()=>Hu)}getAuth(){return this.core.getAuth()}}le.InstantReactAbstractDatabase=Yu,Object.defineProperty(le,Symbol.toStringTag,{value:"Module"})});
